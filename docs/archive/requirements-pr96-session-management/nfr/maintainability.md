# 非機能要件: 保守性

## 概要

本ドキュメントは、セッション管理の包括的改善における保守性要件を定義します。これらの要件は、コードの可読性、テスト容易性、拡張性、ドキュメント品質を保証するために設定されます。

## 保守性要件（EARS記法）

### コード品質

#### NFR-MAINT-001: コードの複雑度
- 関数を実装する時、システムは循環的複雑度を15以下に保たなければならない

**測定方法**: ESLint complexity ruleによる測定

**目標値**:
- 平均複雑度: <8
- 最大複雑度: <15
- 複雑度>20の関数: 0

#### NFR-MAINT-002: 関数の長さ
- 関数を実装する時、システムは1関数あたり50行以下に保たなければならない

**測定方法**: ESLint max-lines-per-function ruleによる測定

**目標値**:
- 平均関数長: <30行
- 最大関数長: <50行
- 100行超の関数: 0

#### NFR-MAINT-003: ファイルの長さ
- ファイルを作成する時、システムは1ファイルあたり500行以下に保たなければならない

**測定方法**: 行数カウント

**目標値**:
- 平均ファイル長: <300行
- 最大ファイル長: <500行
- 1000行超のファイル: 0

#### NFR-MAINT-004: コードの重複
- コードを実装する時、システムは重複コードを5%以下に抑えなければならない

**測定方法**: jscpdによる重複検出

**目標値**:
- 重複率: <5%
- 連続重複行: <10行

### テスト容易性

#### NFR-MAINT-005: テストカバレッジ
- コードを実装する時、システムは80%以上のテストカバレッジを達成しなければならない

**測定方法**: Vitestのカバレッジレポート

**目標値**:
- 総カバレッジ: >80%
- ステートメントカバレッジ: >85%
- ブランチカバレッジ: >75%
- 関数カバレッジ: >90%

#### NFR-MAINT-006: 単体テストの実行時間
- 単体テストを実行する時、システムは30秒以内にすべてのテストを完了しなければならない

**測定方法**: Vitest実行時間

**目標値**:
- 総実行時間: <30秒
- 平均テスト実行時間: <100ms

#### NFR-MAINT-007: テストの独立性
- テストを実行する時、システムはテスト間の依存関係を持ってはならない

**測定方法**: ランダム順序でのテスト実行成功率

**目標値**:
- ランダム順序での成功率: 100%
- テスト間の依存: 0

#### NFR-MAINT-008: モック可能性
- クラスやモジュールを設計する時、システムはモック可能なインターフェースを提供しなければならない

**測定方法**: モック可能なクラス/関数の割合

**目標値**:
- モック可能率: >90%
- ハードコードされた依存: <10%

### ドキュメント

#### NFR-MAINT-009: コメントの適切性
- 複雑なロジックを実装する時、システムは適切なコメントを含まなければならない

**測定方法**: コメント密度（コメント行 / コード行）

**目標値**:
- コメント密度: 10-30%
- 複雑な関数のコメント率: 100%
- 不要なコメント: 0

#### NFR-MAINT-010: API ドキュメント
- 公開APIを提供する時、システムはJSDoc形式のドキュメントを含まなければならない

**測定方法**: JSDocカバレッジ

**目標値**:
- 公開APIのJSDocカバレッジ: 100%
- 内部APIのJSDocカバレッジ: >70%

#### NFR-MAINT-011: READMEの完全性
- 新しいモジュールを追加する時、システムはREADME.mdを含まなければならない

**測定方法**: 主要モジュールのREADME存在率

**目標値**:
- README存在率: 100%（主要モジュール）
- 記載内容: 目的、使用方法、例、API

### 拡張性

#### NFR-MAINT-012: モジュールの独立性
- モジュールを設計する時、システムはモジュール間の結合度を低く保たなければならない

**測定方法**: 依存関係グラフの解析

**目標値**:
- モジュール間依存数: <5（平均）
- 循環依存: 0

#### NFR-MAINT-013: インターフェースの安定性
- インターフェースを設計する時、システムは後方互換性を維持しなければならない

**測定方法**: API変更の影響範囲

**目標値**:
- 破壊的変更: 0（メジャーバージョン変更時のみ）
- 非推奨期間: >6ヶ月

#### NFR-MAINT-014: 設定の外部化
- ハードコードされた値を使用する時、システムは環境変数または設定ファイルで外部化しなければならない

**測定方法**: ハードコードされた設定値の数

**目標値**:
- ハードコードされた設定: 0
- 外部化率: 100%

### エラーメッセージ

#### NFR-MAINT-015: エラーメッセージの明確性
- エラーが発生した時、システムは問題の特定と解決に必要な情報を含むエラーメッセージを出力しなければならない

**測定方法**: エラーメッセージのレビュー評価

**目標値**:
- 明確性スコア: >4/5（ユーザー評価）
- 必須情報の含有率: 100%（何が、なぜ、どうする）

#### NFR-MAINT-016: スタックトレースの保持
- エラーが発生した時、システムは完全なスタックトレースをログに記録しなければならない

**測定方法**: スタックトレース記録率

**目標値**:
- スタックトレース記録率: 100%
- スタックトレースの深さ: 完全（トップレベルまで）

### ログ

#### NFR-MAINT-017: ログレベルの適切性
- ログを出力する時、システムは適切なログレベル（debug, info, warn, error）を使用しなければならない

**測定方法**: ログレベルの使用分布

**目標値**:
- error: 重大なエラーのみ
- warn: 潜在的な問題
- info: 重要なイベント
- debug: 詳細な診断情報

#### NFR-MAINT-018: ログの構造化
- ログを出力する時、システムは構造化されたログ（JSON形式）を使用しなければならない

**測定方法**: 構造化ログの割合

**目標値**:
- 構造化ログ率: 100%
- 必須フィールド: timestamp, level, message, context

#### NFR-MAINT-019: ログのトレーサビリティ
- ログを出力する時、システムはセッションIDやリクエストIDを含めなければならない

**測定方法**: トレース情報の含有率

**目標値**:
- トレース情報含有率: 100%
- 必須トレース情報: sessionId, requestId, userId（該当する場合）

### デバッグ容易性

#### NFR-MAINT-020: デバッグモード
- システムは、詳細なデバッグ情報を出力するモードを提供しなければならない

**測定方法**: デバッグモードの実装状況

**目標値**:
- デバッグモード実装率: 100%（主要コンポーネント）
- デバッグ情報の詳細度: 十分（状態、パラメータ、フロー）

#### NFR-MAINT-021: 状態の可視化
- システムは、実行時の内部状態を確認できる手段を提供しなければならない

**測定方法**: 状態確認APIの実装状況

**目標値**:
- 状態確認API実装率: 100%（主要コンポーネント）
- 確認可能な状態: セッション、接続、リソース

### ツール

#### NFR-MAINT-022: Linterの使用
- コードを実装する時、システムはESLintでリンティングを行わなければならない

**測定方法**: Lintエラー・警告の数

**目標値**:
- Lintエラー: 0
- Lint警告: <10（プロジェクト全体）

#### NFR-MAINT-023: 型チェックの使用
- コードを実装する時、システムはTypeScriptの厳格な型チェックを使用しなければならない

**測定方法**: TypeScriptコンパイラエラーの数

**目標値**:
- 型エラー: 0
- `any`型の使用: <5%

#### NFR-MAINT-024: 自動フォーマット
- コードを実装する時、システムはPrettierで自動フォーマットを行わなければならない

**測定方法**: フォーマット一貫性

**目標値**:
- フォーマット一貫性: 100%
- 手動フォーマット: 0

## 保守性テスト戦略

### コード品質テスト

#### テスト1: 静的解析
- **ツール**: ESLint, TypeScript, jscpd
- **実行タイミング**: コミット前、PR作成時
- **合格基準**: すべての品質指標が目標値内

#### テスト2: 複雑度チェック
- **ツール**: ESLint complexity plugin
- **実行タイミング**: PR作成時
- **合格基準**: 複雑度>15の関数が存在しない

### テストカバレッジテスト

#### テスト3: カバレッジ測定
- **ツール**: Vitest coverage
- **実行タイミング**: PR作成時、マージ前
- **合格基準**: カバレッジ>80%

#### テスト4: カバレッジ低下検出
- **方法**: mainブランチとの比較
- **実行タイミング**: PR作成時
- **合格基準**: カバレッジが5%以上低下していない

### ドキュメントテスト

#### テスト5: JSDocチェック
- **ツール**: eslint-plugin-jsdoc
- **実行タイミング**: PR作成時
- **合格基準**: すべての公開APIにJSDocが存在

#### テスト6: リンク切れチェック
- **ツール**: markdown-link-check
- **実行タイミング**: PR作成時
- **合格基準**: リンク切れが存在しない

### 依存関係テスト

#### テスト7: 循環依存検出
- **ツール**: madge
- **実行タイミング**: PR作成時
- **合格基準**: 循環依存が存在しない

#### テスト8: 未使用依存検出
- **ツール**: depcheck
- **実行タイミング**: 週次
- **合格基準**: 未使用依存が存在しない

## コードレビューチェックリスト

### 機能
- [ ] 要件を満たしている
- [ ] エッジケースが考慮されている
- [ ] エラーハンドリングが適切

### コード品質
- [ ] 複雑度が低い（<15）
- [ ] 関数が短い（<50行）
- [ ] 重複がない

### テスト
- [ ] テストが追加されている
- [ ] カバレッジが維持されている（>80%）
- [ ] テストが独立している

### ドキュメント
- [ ] JSDocが追加されている
- [ ] READMEが更新されている
- [ ] 複雑なロジックにコメントがある

### セキュリティ
- [ ] 入力検証がある
- [ ] SQLインジェクション対策がある
- [ ] XSS対策がある

### パフォーマンス
- [ ] 不要な処理がない
- [ ] メモリリークがない
- [ ] リソースが適切に解放される

## リファクタリングガイドライン

### いつリファクタリングするか
1. **複雑度が15を超えた時**: 関数を分割
2. **重複コードが見つかった時**: 共通化
3. **テストが書きにくい時**: 設計を見直し
4. **バグが頻発する箇所**: 設計を見直し

### リファクタリングの手順
1. **テストの作成**: リファクタリング前に既存動作のテストを作成
2. **小さな変更**: 一度に1つの変更のみ
3. **テストの実行**: 各変更後にテストを実行
4. **コミット**: 動作確認後に小さくコミット

### 禁止事項
- テストなしでのリファクタリング
- 機能追加とリファクタリングの混在
- 大規模な一括変更

## ツール設定

### ESLint設定
```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:@typescript-eslint/recommended-requiring-type-checking"
  ],
  "rules": {
    "complexity": ["error", 15],
    "max-lines-per-function": ["error", 50],
    "max-depth": ["error", 4],
    "@typescript-eslint/no-explicit-any": "error"
  }
}
```

### TypeScript設定
```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  }
}
```

### Vitest設定
```typescript
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      lines: 80,
      functions: 90,
      branches: 75,
      statements: 85
    }
  }
})
```

## 継続的改善

### 定期レビュー
- **週次**: テストカバレッジレポート確認
- **月次**: コード品質メトリクスレビュー
- **四半期**: リファクタリング対象の選定

### メトリクス収集
- コード品質メトリクス（複雑度、重複率）
- テストメトリクス（カバレッジ、実行時間）
- ドキュメントメトリクス（JSDocカバレッジ）

### 改善活動
- 複雑な箇所の優先リファクタリング
- テストカバレッジの向上
- ドキュメントの充実

## 検証

- [ ] すべての保守性要件が定義されている
- [ ] 各要件に測定方法が記載されている
- [ ] 各要件に目標値が設定されている
- [ ] コードレビューチェックリストが策定されている
- [ ] リファクタリングガイドラインが記載されている
- [ ] ツール設定が定義されている
- [ ] 継続的改善プロセスが定義されている

## 関連ドキュメント

- [パフォーマンス要件](performance.md) @nfr/performance.md
- [信頼性要件](reliability.md) @nfr/reliability.md
- [要件定義書](../index.md) @index.md
