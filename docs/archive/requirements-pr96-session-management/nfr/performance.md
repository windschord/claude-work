# 非機能要件: パフォーマンス

## 概要

本ドキュメントは、セッション管理の包括的改善におけるパフォーマンス要件を定義します。これらの要件は、システムの応答性、スループット、リソース効率を保証するために設定されます。

## パフォーマンス要件（EARS記法）

### WebSocket通信

#### NFR-PERF-001: メッセージ配信遅延
- PTYから出力データを受信した時、システムは100ms以内に全WebSocket接続にデータを配信しなければならない

**測定方法**: PTY出力時刻とWebSocket送信時刻の差を計測

**目標値**:
- 平均: 50ms
- 95パーセンタイル: 100ms
- 最大: 200ms

#### NFR-PERF-002: 接続確立時間
- WebSocket接続要求を受信した時、システムは500ms以内に接続を確立しなければならない

**測定方法**: 接続要求受信からWebSocket確立までの時間

**目標値**:
- 平均: 200ms
- 95パーセンタイル: 500ms
- 最大: 1000ms

#### NFR-PERF-003: スクロールバックバッファ送信
- 新しいWebSocket接続が確立された時、システムは2秒以内にスクロールバックバッファを送信しなければならない

**測定方法**: 接続確立からバッファ送信完了までの時間

**目標値**:
- 小バッファ（<10KB）: 500ms
- 中バッファ（10-100KB）: 1秒
- 大バッファ（>100KB）: 2秒

### セッション管理

#### NFR-PERF-004: セッション作成時間
- セッション作成要求を受信した時、システムは以下の時間内にセッションを作成しなければならない
  - HOST環境: 3秒以内
  - DOCKER環境: 30秒以内（コンテナ起動含む）

**測定方法**: 作成要求受信からPTY利用可能までの時間

**目標値（HOST環境）**:
- 平均: 1秒
- 95パーセンタイル: 3秒
- 最大: 5秒

**目標値（DOCKER環境）**:
- 平均: 10秒
- 95パーセンタイル: 30秒
- 最大: 60秒

#### NFR-PERF-005: セッション破棄時間
- セッション破棄要求を受信した時、システムは5秒以内にセッションを破棄しなければならない

**測定方法**: 破棄要求受信からリソース解放完了までの時間

**目標値**:
- 平均: 2秒
- 95パーセンタイル: 5秒
- 最大: 10秒

### 状態管理

#### NFR-PERF-006: 状態更新時間
- セッション状態が変化した時、システムは100ms以内にデータベースに状態を記録しなければならない

**測定方法**: 状態変化検出からDB更新完了までの時間

**目標値**:
- 平均: 50ms
- 95パーセンタイル: 100ms
- 最大: 200ms

#### NFR-PERF-007: 状態復元時間
- サーバー起動時、システムは10秒以内にセッション状態を復元しなければならない

**測定方法**: サーバー起動からセッション復元完了までの時間

**目標値**:
- セッション数<10: 5秒
- セッション数10-50: 10秒
- セッション数>50: 20秒

### リソース効率

#### NFR-PERF-008: メモリ使用量
- セッションが実行中の時、システムはセッションあたり100MB以下のメモリを使用しなければならない

**測定方法**: プロセスのメモリ使用量をモニタリング

**目標値**:
- 平均: 50MB/セッション
- 最大: 100MB/セッション

#### NFR-PERF-009: CPU使用率
- システムがアイドル状態の時、CPU使用率は5%以下でなければならない
- システムが負荷下にある時、CPU使用率は80%以下でなければならない

**測定方法**: プロセスのCPU使用率をモニタリング

**目標値**:
- アイドル時: <5%
- 通常時: <50%
- 負荷時: <80%

#### NFR-PERF-010: ディスクI/O
- セッション状態を更新する時、システムは100IOPS以下のディスクI/Oで動作しなければならない

**測定方法**: ディスクI/O統計を取得

**目標値**:
- 平均: 50 IOPS
- 最大: 100 IOPS

### スケーラビリティ

#### NFR-PERF-011: 同時セッション数
- システムは、パフォーマンス劣化なしに50個の同時セッションを処理できなければならない

**測定方法**: 50セッション同時実行時のパフォーマンス指標

**目標値**:
- 50セッション時のメッセージ配信遅延: <200ms（2倍以内）
- 50セッション時のCPU使用率: <80%

#### NFR-PERF-012: 同時WebSocket接続数
- システムは、パフォーマンス劣化なしに200個の同時WebSocket接続を処理できなければならない

**測定方法**: 200接続同時確立時のパフォーマンス指標

**目標値**:
- 200接続時のメッセージ配信遅延: <150ms（1.5倍以内）
- 200接続時のCPU使用率: <70%

### Docker環境

#### NFR-PERF-013: コンテナ起動時間
- Dockerコンテナを起動する時、システムは30秒以内にコンテナを起動しなければならない

**測定方法**: `docker run`実行から起動完了までの時間

**目標値**:
- イメージ既存: 10秒
- イメージpull必要: 30秒

#### NFR-PERF-014: コンテナ停止時間
- Dockerコンテナを停止する時、システムは5秒以内にコンテナを停止しなければならない

**測定方法**: `docker stop`実行から停止完了までの時間

**目標値**:
- 正常停止: 2秒
- 強制停止: 5秒

## パフォーマンステスト戦略

### 負荷テスト

#### テスト1: 通常負荷
- **条件**: 10セッション、各セッションに2接続
- **実行時間**: 1時間
- **測定項目**: すべてのパフォーマンス指標
- **合格基準**: すべての目標値を満たす

#### テスト2: 高負荷
- **条件**: 50セッション、各セッションに4接続（計200接続）
- **実行時間**: 30分
- **測定項目**: すべてのパフォーマンス指標
- **合格基準**: すべての目標値を満たす（許容範囲内の劣化）

#### テスト3: ピーク負荷
- **条件**: 100セッションを5分間で順次作成・破棄
- **実行時間**: 10分
- **測定項目**: セッション作成・破棄時間、メモリ使用量
- **合格基準**: メモリリークなし、目標値の2倍以内

### ストレステスト

#### テスト4: 長時間稼働
- **条件**: 10セッションを24時間稼働
- **測定項目**: メモリ使用量、CPU使用率
- **合格基準**: メモリリークなし、CPU使用率安定

#### テスト5: 接続の繰り返し
- **条件**: 1セッションに対して100回接続・切断を繰り返す
- **測定項目**: メモリ使用量、接続確立時間
- **合格基準**: メモリリークなし、接続時間の増加なし

### ベンチマークテスト

#### テスト6: メッセージスループット
- **条件**: 1セッションで10MB/秒のデータ出力
- **測定項目**: メッセージ配信遅延、パケットロス
- **合格基準**: 遅延<100ms、パケットロスなし

#### テスト7: 並行処理
- **条件**: 100セッションで同時にコマンド実行
- **測定項目**: 実行完了時間、エラー発生率
- **合格基準**: 完了時間<10秒、エラー率<1%

## モニタリング

### リアルタイムメトリクス

システムは以下のメトリクスをリアルタイムで収集・記録しなければなりません：

1. **WebSocket**:
   - アクティブ接続数
   - メッセージ送信レート（msg/秒）
   - メッセージ配信遅延

2. **セッション**:
   - アクティブセッション数
   - セッション作成・破棄レート
   - セッション状態別カウント

3. **システム**:
   - CPU使用率
   - メモリ使用量
   - ディスクI/O

### パフォーマンスアラート

以下の条件でアラートを発行しなければなりません：

- メッセージ配信遅延 > 200ms（5分間継続）
- CPU使用率 > 90%（1分間継続）
- メモリ使用量 > 80%（5分間継続）
- エラー率 > 5%（1分間）

## 最適化ガイドライン

### WebSocket最適化
1. **バッファリング**: 小さなメッセージをバッファリングして一括送信
2. **圧縮**: 大きなメッセージを圧縮（オプション）
3. **バックプレッシャー**: クライアント側の受信速度を考慮

### データベース最適化
1. **インデックス**: session_id、status、destroy_atにインデックス
2. **バッチ更新**: 状態更新を非同期バッチ処理
3. **接続プール**: Prisma接続プールの最適化

### メモリ最適化
1. **スクロールバックバッファ**: 最大サイズ制限（100KB）
2. **イベントリスナー**: 使用後の確実なクリーンアップ
3. **WeakMap使用**: GC可能な参照の使用

## 検証

- [ ] すべてのパフォーマンス要件が定義されている
- [ ] 各要件に測定方法が記載されている
- [ ] 各要件に目標値が設定されている
- [ ] パフォーマンステスト計画が策定されている
- [ ] モニタリング項目が定義されている
- [ ] 最適化ガイドラインが記載されている

## 関連ドキュメント

- [信頼性要件](reliability.md) @nfr/reliability.md
- [保守性要件](maintainability.md) @nfr/maintainability.md
- [要件定義書](../index.md) @index.md
