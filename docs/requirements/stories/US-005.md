# US-005: 既存プロジェクトの扱い

## ユーザーストーリー

**As a** 既存ユーザー
**I want to** 既存のプロジェクトが引き続き正常に動作する
**So that** 新機能導入後も中断なく作業を継続できる

## 背景・動機

ハイブリッド設計の導入により、Projectテーブルに新しいフィールド（cloneLocation、dockerVolumeId）が追加される。既存のプロジェクト（これらのフィールドが未定義）は、すべてホスト環境として扱い、マイグレーション不要で継続使用できるようにする必要がある。

## 受入基準

### AC-001: 既存プロジェクトのcloneLocation自動設定
**Given** 既存のプロジェクト（cloneLocationフィールドが未定義）が存在する時、
**When** システムがプロジェクトを読み込む時、
**Then** システムはcloneLocation='host'として扱わなければならない

### AC-002: 既存プロジェクトのセッション作成
**Given** 既存のプロジェクトが存在する時、
**When** ユーザーがセッションを作成する時、
**Then** システムは以下の動作をしなければならない:
- ホスト環境のリポジトリ（data/repos/<project>/）を使用
- worktreeを.worktrees/<session-name>/に作成
- 新機能導入前と同じ動作を維持

### AC-003: 既存セッションの継続動作
**Given** 既存のプロジェクトに既存のセッションがある時、
**When** ユーザーがセッションを開く時、
**Then** システムは既存のworktreeを正常に使用しなければならない

### AC-004: データベースマイグレーション不要
**Given** 既存のプロジェクトが存在する時、
**When** 新機能が導入される時、
**Then** システムは手動のデータベースマイグレーションを必要としないようにしなければならない

### AC-005: UI表示の互換性
**Given** 既存のプロジェクトが存在する時、
**When** プロジェクト一覧を表示する時、
**Then** システムはcloneLocation='host'としてバッジを表示しなければならない

## 機能要件

### REQ-001: cloneLocationのデフォルト値
プロジェクトのcloneLocationフィールドが未定義またはnullの時、システムは'host'として扱わなければならない。

### REQ-002: dockerVolumeIdのデフォルト値
プロジェクトのdockerVolumeIdフィールドが未定義またはnullの時、システムはnullとして扱わなければならない。

### REQ-003: 既存プロジェクトのセッション作成
cloneLocation='host'のプロジェクトに対してセッションを作成する時、システムはホスト環境のリポジトリを使用しなければならない。

### REQ-004: UI表示のフォールバック
プロジェクト一覧でcloneLocationが未定義のプロジェクトを表示する時、システムは「ホスト」バッジを表示しなければならない。

## 非機能要件

### NFR-001: 互換性
システムは既存プロジェクトに対して100%の後方互換性を維持しなければならない。

### NFR-002: 透明性
システムは既存プロジェクトの自動的なホスト環境扱いをユーザーに通知しなければならない（オプション）。

### NFR-003: データ整合性
システムは既存プロジェクトのデータを破壊しないようにしなければならない。

## 技術的ノート

### データベーススキーマ変更

```sql
-- Projectテーブルに新しいフィールドを追加
ALTER TABLE Project ADD COLUMN cloneLocation TEXT DEFAULT 'docker';
ALTER TABLE Project ADD COLUMN dockerVolumeId TEXT;
```

**注意**: 既存レコードにはDEFAULT値が適用されないため、アプリケーションレイヤーでフォールバック処理が必要。

### アプリケーションレイヤーのフォールバック

```typescript
// プロジェクト読み込み時のフォールバック
const cloneLocation = project.cloneLocation ?? 'host';
const dockerVolumeId = project.dockerVolumeId ?? null;
```

### GitServiceの変更

既存のGitService.cloneRepository()とGitService.createWorktree()は、cloneLocation='host'の場合にそのまま使用できる。

## 依存関係

### 依存するストーリー
- US-001: プロジェクト登録時の保存場所選択（スキーマ変更）
- US-002: ホスト環境でのプロジェクトclone（既存実装の維持）

### ブロックするストーリー
なし

## テストシナリオ

### シナリオ1: 既存プロジェクトの読み込み
1. 既存のプロジェクト（cloneLocation未定義）を選択
2. プロジェクト詳細を表示
3. 検証: cloneLocation='host'として扱われる
4. 検証: dockerVolumeId=nullとして扱われる

### シナリオ2: 既存プロジェクトでのセッション作成
1. 既存のプロジェクトを選択
2. セッションを作成
3. 検証: ホスト環境のリポジトリが使用される
4. 検証: worktreeが.worktrees/に作成される
5. 検証: セッションが正常に起動する

### シナリオ3: 既存セッションの継続動作
1. 既存のプロジェクトに既存のセッションがある
2. セッションを開く
3. 検証: セッションが正常に動作する
4. 検証: Claude Codeが既存のworktreeを使用する

### シナリオ4: プロジェクト一覧でのUI表示
1. プロジェクト一覧を表示
2. 既存のプロジェクトを確認
3. 検証: 「ホスト」バッジが表示される

### シナリオ5: 新規プロジェクトとの混在
1. 既存プロジェクト（cloneLocation='host'）が存在
2. 新規プロジェクト（cloneLocation='docker'）を登録
3. 両方のプロジェクトでセッションを作成
4. 検証: 既存プロジェクトはホスト環境を使用
5. 検証: 新規プロジェクトはDocker環境を使用
6. 検証: 両方とも正常に動作する

## 優先度の根拠

**優先度**: 中

既存ユーザーへの影響を最小限に抑えるために重要だが、技術的には比較的シンプルな実装。

## 見積もり

- **ストーリーポイント**: 2
- **実装時間**: 0.5日
- **テスト時間**: 0.5日
- **合計**: 1日

## ノート

### 設計上の決定事項
- 既存プロジェクトはすべてcloneLocation='host'として扱う
- データベースマイグレーションスクリプトは不要（アプリケーションレイヤーでフォールバック）
- UI表示でcloneLocationが未定義の場合、「ホスト」バッジを表示

### 後方互換性の保証
- 既存のGitService実装をそのまま使用
- 既存のworktree構造を維持
- 既存のセッションデータを変更しない

### 将来の改善案
- 既存プロジェクトのcloneLocationをデータベースに明示的に保存（データクリーンアップ）
- マイグレーションコマンドの提供（オプション）
