# US-001: WebSocket接続管理の統一

## ユーザーストーリー

**As a** 開発者
**I want** 複数のブラウザから同じセッションにアクセスしても同一のターミナル内容が表示される
**So that** 異なるデバイスやブラウザから作業を継続でき、一貫した開発体験を得られる

## 背景

### 現状の問題
現在、ClaudeWorkでは以下の3種類のWebSocketサーバーが存在します：
- Session WebSocket (`/ws/sessions/:id`): ConnectionManagerで適切に管理 ✓
- Claude WebSocket (`/ws/claude/:id`): 独自の接続数管理のみ
- Terminal WebSocket (`/ws/terminal/:id`): 独自の接続数管理のみ

Session WebSocketのみConnectionManagerを使用しており、Claude/Terminal WebSocketは独自の接続管理を行っています。その結果：

1. **イベントハンドラーの重複登録**: 各WebSocket接続が独立したイベントハンドラーをPTYセッションに登録
2. **メモリリーク**: 接続が切断されてもハンドラーが残留
3. **データ重複送信**: 同じデータが複数回送信される
4. **ブラウザごとに異なる表示**: スクロールバックバッファの送信タイミングが不整合

### 根本原因
PTYセッション（1つ）とWebSocket接続（N個）の1:N関係が適切に管理されていないため、各接続が独立してPTYにイベントハンドラーを登録してしまいます。

## 受入基準（EARS記法）

### 機能要件

#### REQ-001-001: 接続プールの管理
- セッションIDに対して新しいWebSocket接続が確立された時、システムは当該セッションの接続プールに接続を追加しなければならない

#### REQ-001-002: イベントハンドラーの単一登録
- PTYセッションが作成された時、システムはPTYセッションごとに1つのイベントハンドラーのみを登録しなければならない

#### REQ-001-003: ブロードキャスト配信
- PTYから出力データを受信した時、システムは当該セッションの全WebSocket接続にデータをブロードキャストしなければならない

#### REQ-001-004: スクロールバックバッファの送信
- 新しいWebSocket接続が確立された時、システムは既存のスクロールバックバッファを当該接続に送信しなければならない

#### REQ-001-005: 接続の削除
- WebSocket接続が切断された時、システムは接続プールから当該接続を削除しなければならない

#### REQ-001-006: ハンドラーのクリーンアップ
- セッションの全WebSocket接続が切断された時、システムはPTYセッションのイベントハンドラーを削除しなければならない

#### REQ-001-007: ConnectionManagerの統一使用
- Claude WebSocketおよびTerminal WebSocketが接続を管理する時、システムはConnectionManagerを使用しなければならない

### 非機能要件

#### NFR-001-001: 同期性
- 複数のブラウザから同じセッションに接続した場合、システムは100ms以内に同一のターミナル内容を表示しなければならない

#### NFR-001-002: メモリ効率
- WebSocket接続が切断された時、システムは関連するイベントハンドラーを即座に解放しなければならない

## テストシナリオ

### シナリオ1: 複数ブラウザでの同時接続
**Given**: セッションが作成されている
**When**: Chrome、Firefox、Safariから同じセッションに接続する
**Then**:
- 3つのブラウザで同一のターミナル内容が表示される
- PTYセッションにイベントハンドラーが1つだけ登録されている
- 入力がすべてのブラウザで反映される

### シナリオ2: 接続の切断と再接続
**Given**: 2つのブラウザから同じセッションに接続している
**When**: 1つのブラウザを閉じ、その後再度開く
**Then**:
- 再接続したブラウザにスクロールバックバッファが表示される
- 他のブラウザは影響を受けない
- メモリリークが発生しない

### シナリオ3: スクロールバックバッファの送信
**Given**: セッションで既に大量の出力がある
**When**: 新しいブラウザから接続する
**Then**:
- 既存の出力（スクロールバックバッファ）が表示される
- 新しい出力も継続して表示される
- 既存の接続に影響がない

### シナリオ4: イベントハンドラーの重複防止
**Given**: セッションが作成されている
**When**: 5つのブラウザから接続する
**Then**:
- PTYセッションのイベントハンドラーが1つだけである
- すべてのブラウザが同一の出力を受信する
- 出力の重複送信がない

## 影響を受けるコンポーネント

### 修正が必要なファイル
1. **src/lib/websocket/claude-ws.ts**
   - ConnectionManagerの使用
   - 接続プール管理の実装
   - イベントハンドラーのセッション単位登録

2. **src/lib/websocket/terminal-ws.ts**
   - ConnectionManagerの使用
   - 接続プール管理の実装
   - イベントハンドラーのセッション単位登録

3. **src/lib/websocket/connection-manager.ts**
   - 接続プール管理機能の拡張
   - ブロードキャスト機能の追加
   - セッション単位のハンドラー管理

### 影響を受けるが修正不要なファイル
- **src/lib/websocket/session-ws.ts**: 既にConnectionManagerを使用（参考実装）
- **src/lib/websocket/scrollback-buffer.ts**: 既存実装を再利用
- **server.ts**: WebSocketサーバーの構成は変更なし

## 依存関係

### 前提条件
- なし（最優先の独立タスク）

### 後続タスク
- US-002: PTYセッションマネージャーの導入（本USの実装基盤を使用）
- US-003: Docker環境の安定化（本USの実装基盤を使用）

## 実装のガイドライン

### アーキテクチャ設計
```
[PTYセッション] ----1:N----> [接続プール] ----1:N----> [WebSocket接続]
       |                            |
       |                            |
       +-- イベントハンドラー（1つ）  +-- ブロードキャスト
```

### 主要な設計決定
1. **ConnectionManagerの拡張**: セッションIDをキーとした接続プールを管理
2. **イベントハンドラーの登録タイミング**: PTYセッション作成時に1度だけ
3. **ブロードキャストの実装**: 接続プールの全クライアントにデータ送信
4. **スクロールバックバッファ**: 既存のScrollbackBufferクラスを再利用

### 実装の順序
1. ConnectionManagerに接続プール管理機能を追加
2. claude-ws.tsをConnectionManager使用に変更
3. terminal-ws.tsをConnectionManager使用に変更
4. 単体テストの作成
5. 統合テストの作成

## 検証方法

### 単体テスト
- [ ] ConnectionManagerが接続プールを正しく管理する
- [ ] イベントハンドラーが1つだけ登録される
- [ ] ブロードキャストが全接続に送信される
- [ ] 接続切断時にクリーンアップが行われる

### 統合テスト
- [ ] 複数WebSocket接続の同時管理
- [ ] スクロールバックバッファの正しい送信
- [ ] メモリリークの検出

### E2Eテスト（Playwright）
- [ ] 複数ブラウザでの同時接続テスト
- [ ] ターミナル内容の一貫性確認
- [ ] 入力の全ブラウザ反映確認

### 手動テスト
- [ ] Chrome, Firefox, Safariでの動作確認
- [ ] 開発者ツールでのメモリ使用量確認
- [ ] 長時間稼働でのメモリリーク確認

## リスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| ConnectionManager変更による既存機能の破壊 | 高 | Session WebSocketの動作をテストで保護 |
| レースコンディション | 中 | スクロールバックバッファ送信を同期的に実行 |
| パフォーマンス低下 | 低 | ブロードキャストの効率的な実装 |

## 見積もり

- **設計**: 4時間
- **実装**: 12時間
- **テスト**: 8時間
- **合計**: 24時間（3日）

## 参照

- 元の実装計画: セッション管理の包括的改善計画 - ステップ1
- 関連Issue: ブラウザごとに異なるターミナル内容の問題
- 既存実装: src/lib/websocket/session-ws.ts（参考実装）
