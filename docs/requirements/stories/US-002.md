# US-002: ホスト環境でのプロジェクトclone

## ユーザーストーリー

**As a** 開発者
**I want to** ホスト環境でプロジェクトをcloneできる
**So that** 既存の実装を維持し、ホスト環境で問題なく動作するユーザーは引き続き使用できる

## 背景・動機

現在の実装では、プロジェクト登録時にホスト環境（data/repos/）でgit cloneを実行している。この動作は多くのユーザーにとって問題なく動作しており、既存の実装を維持することで互換性を保つ必要がある。

## 受入基準

### AC-001: ホスト環境でのgit clone実行
**Given** ユーザーがホスト環境を選択してプロジェクトを登録する時、
**When** 登録ボタンをクリックした時、
**Then** システムは以下の動作をしなければならない:
- data/repos/<project-name>/ ディレクトリにgit cloneを実行
- cloneLocationフィールドに'host'を設定
- dockerVolumeIdフィールドはnull

### AC-002: SSH認証の使用
**Given** ユーザーがホスト環境でプロジェクトをcloneする時、
**When** git cloneが実行される時、
**Then** システムはホスト環境のSSH設定を使用しなければならない:
- ~/.sshの鍵を使用
- $SSH_AUTH_SOCKのSSH Agentを使用
- ~/.gitconfigの設定を使用

### AC-003: clone成功時の処理
**Given** ユーザーがホスト環境でプロジェクトをcloneする時、
**When** git cloneが成功した時、
**Then** システムは以下の動作をしなければならない:
- データベースにプロジェクト情報を保存
- cloneLocation='host'を設定
- ユーザーにプロジェクト登録成功を通知

### AC-004: clone失敗時の処理
**Given** ユーザーがホスト環境でプロジェクトをcloneする時、
**When** git cloneが失敗した時、
**Then** システムは以下の動作をしなければならない:
- エラーメッセージをユーザーに表示
- 部分的にcloneされたディレクトリを削除
- データベースにプロジェクト情報を保存しない

### AC-005: 既存プロジェクトの継続動作
**Given** 既存のプロジェクト（PR#96以前に登録）が存在する時、
**When** セッションを作成する時、
**Then** システムは引き続きホスト環境のリポジトリを使用しなければならない

## 機能要件

### REQ-001: ホスト環境でのgit clone実行
ユーザーがホスト環境を選択してプロジェクトを登録した時、システムはdata/repos/<project-name>/にgit cloneを実行しなければならない。

### REQ-002: SSH認証の使用
ホスト環境でgit cloneを実行する時、システムはホスト環境のSSH設定（~/.ssh、$SSH_AUTH_SOCK、~/.gitconfig）を使用しなければならない。

### REQ-003: clone成功時のデータベース保存
git clone成功時、システムはcloneLocation='host'でプロジェクト情報をデータベースに保存しなければならない。

### REQ-004: clone失敗時のクリーンアップ
git clone失敗時、システムは部分的にcloneされたディレクトリを削除しなければならない。

### REQ-005: 既存プロジェクトの互換性
システムは既存プロジェクト（cloneLocationフィールドがnullまたは未定義）をcloneLocation='host'として扱わなければならない。

## 非機能要件

### NFR-001: パフォーマンス
システムはホスト環境でのgit cloneをデフォルトタイムアウト（5分）以内に完了しなければならない。

### NFR-002: セキュリティ
システムはパストラバーサル攻撃を防ぐため、プロジェクト名を検証しなければならない。

### NFR-003: 信頼性
システムはgit clone失敗時に部分的なデータを残さないようにクリーンアップしなければならない。

## 技術的ノート

### 既存の実装
- ファイル: src/app/api/projects/clone/route.ts
- 既存のgit clone実装を維持
- GitService.cloneRepository() メソッドを使用

### エラーハンドリング
- git cloneのstderrを適切にユーザーに表示
- 認証失敗、タイムアウト、ネットワークエラーを区別

### パストラバーサル対策
- プロジェクト名に `../` や絶対パスを含めない
- 既存のバリデーションを継続使用

## 依存関係

### 依存するストーリー
- US-001: プロジェクト登録時の保存場所選択

### ブロックするストーリー
- US-004: セッション作成時のworktree作成

## テストシナリオ

### シナリオ1: ホスト環境でプロジェクトを正常にclone
1. プロジェクト登録フォームを開く
2. ホスト環境を選択
3. 有効なリポジトリURL（SSH）を入力
4. プロジェクト名を入力
5. 登録ボタンをクリック
6. 検証: data/repos/<project-name>/ にリポジトリがcloneされる
7. 検証: cloneLocation='host' でプロジェクトが作成される

### シナリオ2: SSH認証失敗時のエラーハンドリング
1. プロジェクト登録フォームを開く
2. ホスト環境を選択
3. 認証が必要なリポジトリURLを入力（SSH Agentなし）
4. プロジェクト名を入力
5. 登録ボタンをクリック
6. 検証: エラーメッセージが表示される
7. 検証: data/repos/<project-name>/ は削除される
8. 検証: データベースにプロジェクトが作成されない

### シナリオ3: 既存プロジェクトの継続動作
1. 既存プロジェクト（cloneLocation未定義）を選択
2. セッションを作成
3. 検証: ホスト環境のリポジトリが使用される
4. 検証: worktreeが正常に作成される

## 優先度の根拠

**優先度**: 高

既存の実装を維持し、互換性を保つために必須。また、US-004（worktree作成）の前提条件となる。

## 見積もり

- **ストーリーポイント**: 1（既存実装の維持）
- **実装時間**: 0.25日
- **テスト時間**: 0.5日
- **合計**: 0.75日

## ノート

### 設計上の決定事項
- 既存の実装を最大限活用
- エラーハンドリングを改善（stderrの適切な表示）
- 既存プロジェクトの自動マイグレーション（cloneLocation='host'）

### 既存機能との関係
- GitService.cloneRepository() の使用を継続
- 既存のパストラバーサル対策を維持
- 既存のタイムアウト設定を使用
