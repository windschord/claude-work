# US-006: タイムアウト設定の管理

## ユーザーストーリー

**As a** 開発者
**I want to** git clone処理のタイムアウト値を設定できる
**So that** 大規模リポジトリのcloneに十分な時間を確保できる

## 背景・動機

git clone処理は、リポジトリのサイズやネットワーク速度によって完了時間が大きく異なる。デフォルトのタイムアウト値（5分）では不十分な場合もあるため、ユーザーが設定で変更できるようにする必要がある。

## 受入基準

### AC-001: デフォルトタイムアウト値
**Given** ユーザーがタイムアウト設定を変更していない時、
**When** プロジェクトをcloneする時、
**Then** システムは5分のタイムアウト値を使用しなければならない

### AC-002: タイムアウト設定の変更
**Given** ユーザーが設定画面を開いている時、
**When** タイムアウト値を変更する時、
**Then** システムは以下の動作をしなければならない:
- 変更されたタイムアウト値を保存
- 次回のclone処理から新しいタイムアウト値を使用

### AC-003: タイムアウト発生時の処理
**Given** git clone処理が実行されている時、
**When** タイムアウト値を超えた時、
**Then** システムは以下の動作をしなければならない:
- git clone処理を中断
- タイムアウトエラーメッセージを表示
- 部分的にcloneされたデータをクリーンアップ（ホスト環境: ディレクトリ削除、Docker環境: ボリューム削除）

### AC-004: タイムアウト値のバリデーション
**Given** ユーザーがタイムアウト値を変更する時、
**When** 無効な値を入力した時、
**Then** システムはバリデーションエラーを表示しなければならない:
- 最小値: 1分
- 最大値: 30分
- 単位: 分

### AC-005: ホスト環境とDocker環境で同じタイムアウト値
**Given** ユーザーがタイムアウト値を設定した時、
**When** ホスト環境またはDocker環境でcloneする時、
**Then** システムは同じタイムアウト値を使用しなければならない

## 機能要件

### REQ-001: デフォルトタイムアウト値
システムはgit clone処理のデフォルトタイムアウト値として5分を使用しなければならない。

### REQ-002: タイムアウト設定の保存
ユーザーがタイムアウト値を変更した時、システムは設定ファイルまたはデータベースに保存しなければならない。

### REQ-003: タイムアウト値の取得
git clone処理を開始する時、システムは保存されたタイムアウト値を取得しなければならない。

### REQ-004: タイムアウト処理
git clone処理がタイムアウト値を超えた時、システムは処理を中断し、クリーンアップを実行しなければならない。

### REQ-005: タイムアウト値のバリデーション
システムはタイムアウト値を1分から30分の範囲でバリデーションしなければならない。

## 非機能要件

### NFR-001: ユーザビリティ
システムはタイムアウト設定をわかりやすく提供し、推奨値（5分）を明示しなければならない。

### NFR-002: パフォーマンス
システムはタイムアウト値の取得をキャッシュし、パフォーマンスへの影響を最小限に抑えなければならない。

### NFR-003: 設定の永続化
システムはタイムアウト設定をサーバー再起動後も維持しなければならない。

## 技術的ノート

### 設定ファイルの実装

**オプション1**: 環境変数
```bash
# .envファイル
GIT_CLONE_TIMEOUT_MINUTES=5
```

**オプション2**: データベース
```sql
-- Settingsテーブルに保存
INSERT INTO Settings (key, value) VALUES ('git_clone_timeout_minutes', '5');
```

**オプション3**: 設定ファイル（推奨）
```json
// data/settings.json
{
  "git_clone_timeout_minutes": 5
}
```

### タイムアウト実装

```typescript
// ホスト環境
const timeout = getTimeoutMinutes() * 60 * 1000; // ミリ秒に変換
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), timeout);

try {
  await execFile('git', ['clone', url, path], {
    signal: controller.signal
  });
} catch (error) {
  if (error.name === 'AbortError') {
    // タイムアウト処理
  }
} finally {
  clearTimeout(timeoutId);
}

// Docker環境
docker run --rm \
  --timeout ${timeout}s \
  ...
```

### UI実装

設定画面に以下を追加：
- タイムアウト値の入力フィールド（数値）
- 単位: 分
- デフォルト値: 5分
- 推奨範囲: 1-30分
- 説明テキスト: 「大規模リポジトリの場合は、より長いタイムアウト値を設定してください。」

## 依存関係

### 依存するストーリー
- US-002: ホスト環境でのプロジェクトclone
- US-003: Docker環境でのプロジェクトclone

### ブロックするストーリー
なし

## テストシナリオ

### シナリオ1: デフォルトタイムアウト値の使用
1. タイムアウト設定を変更しない
2. プロジェクトを登録
3. 検証: 5分のタイムアウト値が使用される

### シナリオ2: タイムアウト値の変更
1. 設定画面を開く
2. タイムアウト値を10分に変更
3. 設定を保存
4. プロジェクトを登録
5. 検証: 10分のタイムアウト値が使用される

### シナリオ3: タイムアウト発生時の処理
1. タイムアウト値を1分に設定
2. 大規模リポジトリを登録
3. 1分待機
4. 検証: タイムアウトエラーが表示される
5. 検証: 部分的にcloneされたデータが削除される

### シナリオ4: タイムアウト値のバリデーション
1. 設定画面を開く
2. タイムアウト値に0を入力
3. 設定を保存
4. 検証: バリデーションエラーが表示される
5. タイムアウト値に31を入力
6. 設定を保存
7. 検証: バリデーションエラーが表示される

### シナリオ5: サーバー再起動後の設定維持
1. タイムアウト値を10分に設定
2. サーバーを再起動
3. プロジェクトを登録
4. 検証: 10分のタイムアウト値が使用される

## 優先度の根拠

**優先度**: 中

タイムアウト設定は、大規模リポジトリを扱うユーザーにとって重要だが、デフォルト値（5分）で多くのケースをカバーできる。

## 見積もり

- **ストーリーポイント**: 3
- **実装時間**: 0.5日
- **テスト時間**: 0.5日
- **合計**: 1日

## ノート

### 設計上の決定事項
- デフォルトタイムアウト値は5分（ユーザーの回答に基づく）
- 設定は環境変数または設定ファイルで管理（推奨: 設定ファイル）
- ホスト環境とDocker環境で同じタイムアウト値を使用
- バリデーション範囲: 1-30分

### ユーザビリティの考慮事項
- デフォルト値（5分）を明示
- 大規模リポジトリの場合の推奨値を提示
- タイムアウトエラー時に設定変更へのリンクを提供

### 将来の拡張性
- プロジェクトごとのタイムアウト設定（スコープ外）
- 自動的なタイムアウト値の調整（リポジトリサイズに基づく）
