# 非機能要件: 性能

## 概要

ハイブリッド設計において、ホスト環境とDocker環境の両方で許容可能なパフォーマンスを提供する必要がある。Docker環境ではコンテナ起動オーバーヘッドが発生するため、適切なタイムアウト設定とパフォーマンス期待値の設定が重要である。

## 性能要件

### NFR-PERF-001: git clone処理時間（ホスト環境）
**Given** ユーザーがホスト環境でプロジェクトをcloneする時、
**When** 中規模リポジトリ（100MB以下）をcloneする時、
**Then** システムは2分以内にcloneを完了しなければならない

**測定方法**: 実際のリポジトリ（例: ClaudeWork自身）でのclone時間を測定

### NFR-PERF-002: git clone処理時間（Docker環境）
**Given** ユーザーがDocker環境でプロジェクトをcloneする時、
**When** 中規模リポジトリ（100MB以下）をcloneする時、
**Then** システムは3分以内にcloneを完了しなければならない

**測定方法**: 実際のリポジトリでのclone時間を測定（初回イメージpullを含む）

**注意**: Docker環境では以下のオーバーヘッドが発生する：
- alpine/gitイメージのpull（初回のみ、約10-30秒）
- コンテナ起動（約2-5秒）
- ボリュームI/O（ホスト環境と同等）

### NFR-PERF-003: worktree作成時間（ホスト環境）
**Given** ユーザーがホスト環境でセッションを作成する時、
**When** worktreeを作成する時、
**Then** システムは5秒以内にworktreeを作成しなければならない

**測定方法**: worktree作成の開始から完了までの時間を測定

### NFR-PERF-004: worktree作成時間（Docker環境）
**Given** ユーザーがDocker環境でセッションを作成する時、
**When** worktreeを作成する時、
**Then** システムは10秒以内にworktreeを作成しなければならない

**測定方法**: worktree作成の開始から完了までの時間を測定（コンテナ起動を含む）

### NFR-PERF-005: タイムアウト設定のデフォルト値
システムはgit clone処理のデフォルトタイムアウト値として5分を使用しなければならない。

**根拠**:
- 中規模リポジトリのcloneに十分
- Docker環境でのオーバーヘッドを考慮
- ユーザーフィードバックに基づく

### NFR-PERF-006: タイムアウト設定の範囲
システムはタイムアウト値を1分から30分の範囲で設定可能にしなければならない。

**根拠**:
- 最小値（1分）: 小規模リポジトリの高速フィードバック
- 最大値（30分）: 大規模リポジトリ（1GB以上）のcloneに対応

### NFR-PERF-007: UI応答性
**Given** ユーザーがプロジェクト登録フォームを操作している時、
**When** 保存場所を選択する時、
**Then** システムは100ms以内に選択を反映しなければならない

**測定方法**: React DevToolsのProfilerで測定

### NFR-PERF-008: Dockerボリューム作成時間
**Given** ユーザーがDocker環境でプロジェクトを登録する時、
**When** Dockerボリュームを作成する時、
**Then** システムは5秒以内にボリュームを作成しなければならない

**測定方法**: `docker volume create` の実行時間を測定

### NFR-PERF-009: Dockerボリューム削除時間
**Given** ユーザーがプロジェクトを削除する時、
**When** Dockerボリュームを削除する時、
**Then** システムは10秒以内にボリュームを削除しなければならない

**測定方法**: `docker volume rm` の実行時間を測定

### NFR-PERF-010: 設定ファイルの読み込み
**Given** システムが起動する時、
**When** タイムアウト設定やデバッグモード設定を読み込む時、
**Then** システムは100ms以内に設定を読み込みなければならない

**測定方法**: 設定ファイル読み込みの処理時間を測定

## パフォーマンス目標

### ホスト環境

| 操作 | 目標時間 | 最大許容時間 |
|-----|---------|-------------|
| git clone（100MB） | 1分 | 2分 |
| worktree作成 | 3秒 | 5秒 |
| プロジェクト削除 | 5秒 | 10秒 |

### Docker環境

| 操作 | 目標時間 | 最大許容時間 |
|-----|---------|-------------|
| git clone（100MB、初回） | 2分 | 3分 |
| git clone（100MB、2回目以降） | 1.5分 | 2.5分 |
| worktree作成 | 5秒 | 10秒 |
| Dockerボリューム作成 | 3秒 | 5秒 |
| Dockerボリューム削除 | 5秒 | 10秒 |
| プロジェクト削除 | 10秒 | 15秒 |

## パフォーマンステスト

### テストシナリオ1: 中規模リポジトリのclone（ホスト環境）
1. ホスト環境を選択
2. 中規模リポジトリURL（例: ClaudeWork）を入力
3. 登録ボタンをクリック
4. 測定: clone開始から完了までの時間
5. 期待値: 2分以内

### テストシナリオ2: 中規模リポジトリのclone（Docker環境、初回）
1. alpine/gitイメージが存在しない状態にする（docker rmi）
2. Docker環境を選択
3. 中規模リポジトリURL（例: ClaudeWork）を入力
4. 登録ボタンをクリック
5. 測定: clone開始から完了までの時間（イメージpullを含む）
6. 期待値: 3分以内

### テストシナリオ3: 中規模リポジトリのclone（Docker環境、2回目以降）
1. alpine/gitイメージが存在する状態
2. Docker環境を選択
3. 中規模リポジトリURL（例: ClaudeWork）を入力
4. 登録ボタンをクリック
5. 測定: clone開始から完了までの時間
6. 期待値: 2.5分以内

### テストシナリオ4: worktree作成（両環境）
1. プロジェクトを登録（ホストまたはDocker）
2. セッション作成ボタンをクリック
3. 測定: worktree作成開始から完了までの時間
4. 期待値: ホスト環境5秒以内、Docker環境10秒以内

### テストシナリオ5: 大規模リポジトリのタイムアウト設定
1. タイムアウト値を10分に設定
2. 大規模リポジトリURL（500MB以上）を入力
3. 登録ボタンをクリック
4. 測定: clone完了時間
5. 期待値: 10分以内に完了、またはタイムアウト

## パフォーマンス監視

### ログ出力
システムは以下の処理時間をログに記録しなければならない：
- git clone処理時間
- worktree作成時間
- Dockerボリューム作成・削除時間
- タイムアウト発生頻度

### メトリクス
システムは以下のメトリクスを収集しなければならない（将来の改善）：
- 平均clone時間（ホスト環境/Docker環境別）
- タイムアウト発生率
- Docker環境の使用率

## パフォーマンス改善策

### 短期的な改善
- alpine/gitイメージの事前pull（インストールスクリプトで実行）
- タイムアウト設定のUI改善（推奨値の表示）

### 長期的な改善
- Dockerボリュームのキャッシュ戦略
- 並列clone処理のサポート
- clone進捗表示の改善

## 制約と注意事項

### ネットワーク速度の影響
パフォーマンス要件は、一般的なブロードバンド接続（10Mbps以上）を前提とする。低速なネットワーク環境では、タイムアウト値の調整が必要。

### リポジトリサイズの影響
パフォーマンス要件は、中規模リポジトリ（100MB以下）を前提とする。大規模リポジトリ（1GB以上）では、タイムアウト値の調整が必要。

### Dockerのバージョン
Docker環境のパフォーマンス要件は、Docker 20.10以降を前提とする。古いバージョンではパフォーマンスが低下する可能性がある。
