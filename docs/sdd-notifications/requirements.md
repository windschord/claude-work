# 要件定義書: ブラウザ通知

## 概要

ブラウザ通知機能（OS通知とアプリ内toast通知）の要件を定義します。

## 関連ストーリー

- ストーリー16: ブラウザ通知
- ストーリー22: ユーザーアクション要求時のブラウザ通知強化
- ストーリー26: アクション要求時ブラウザ通知の修正

---

## ストーリー16: ブラウザ通知

**私は** 開発者として
**〜したい** Claude Codeのイベント発生時にブラウザ通知を受け取りたい
**なぜなら** 他のタブで作業中でもセッションの状態変化に気づきたいから

### 背景

- 長時間実行されるタスクの完了を見逃すことがある
- 権限要求に気づかずセッションが待機状態のままになることがある
- 複数セッションを並列で実行する場合、すべてを監視し続けるのは困難

### 受入基準（EARS記法）

- **REQ-084**: ユーザーが初めてセッションページにアクセスした時、システムはブラウザ通知の許可を要求しなければならない
- **REQ-085**: Claude Codeプロセスが完了した時、システムはOS通知「タスク完了: [セッション名]」を送信しなければならない
- **REQ-086**: Claude Codeが権限確認を要求した時、システムはOS通知「アクション要求: [セッション名]」を送信しなければならない
- **REQ-087**: Claude Codeプロセスがエラーで終了した時、システムはOS通知「エラー発生: [セッション名]」を送信しなければならない
- **REQ-088**: ブラウザタブがアクティブな場合、システムはOS通知の代わりにアプリ内toast通知を表示しなければならない
- **REQ-089**: ブラウザタブがバックグラウンドの場合、システムはOS通知を送信しなければならない
- **REQ-090**: ユーザーがOS通知をクリックした時、システムは該当セッションのページにフォーカスしなければならない
- **REQ-091**: システムは通知設定（イベント別オン/オフ）をローカルストレージに保存しなければならない
- **REQ-092**: ユーザーが通知設定を変更した時、システムは即座に設定を適用しなければならない
- **REQ-093**: 通知設定において、システムはタスク完了/権限要求/エラーそれぞれのオン/オフを個別に設定できなければならない

---

## ストーリー22: ユーザーアクション要求時のブラウザ通知強化

**私は** 開発者として
**〜したい** Claudeがユーザーアクションを求めているときに確実にブラウザ通知を受け取りたい
**なぜなら** 現状の通知が機能していないため、他のタブで作業中にClaudeからの要求に気付けないから

### 背景

- REQ-086 で「権限確認を要求した時」の通知が定義されているが、実際には機能していない
- Claude CLIの出力からアクション要求パターンを検出する必要がある
- ターミナル出力のパターンマッチングで検出を行う

### 受入基準（EARS記法）

- **REQ-137**: Claudeターミナルの出力に許可要求パターンが検出された時、システムはブラウザ通知を送信しなければならない
- **REQ-138**: 許可要求パターンとして、システムは以下を検出しなければならない:
  - 「Allow」「Deny」の選択肢表示
  - ツール実行の確認プロンプト（「Do you want to」等）
  - ユーザー入力待ち状態（プロンプト表示）
- **REQ-139**: パターン検出は、システムはターミナル出力のANSIエスケープシーケンスを除去した後に行わなければならない
- **REQ-140**: 同一パターンが連続して検出された場合、システムは通知の重複を防ぐために5秒以内の再通知を抑制しなければならない
- **REQ-141**: 通知設定で「権限要求時」がオフの場合、システムは通知を送信してはならない

---

## ストーリー26: アクション要求時ブラウザ通知の修正

**私は** 開発者として
**〜したい** Claudeがユーザーアクションを求めている時にブラウザ通知が確実に届くこと
**なぜなら** 現在の実装では通知が発火せず、他のタブで作業中にClaudeからの要求に気付けないから

### 背景

- ストーリー22（REQ-137〜141）でアクション要求通知が定義されているが、実装が不完全
- 現在のパターン検出ロジックが実際のClaude CLI出力にマッチしていない
- ANSIエスケープシーケンスの処理が不十分

### 受入基準（EARS記法）

- **REQ-156**: Claude CLIがユーザー入力を待機している時（プロンプト表示）、システムはブラウザ通知を送信しなければならない
- **REQ-157**: Claude CLIの出力において、システムは以下のパターンを検出しなければならない:
  - "Yes to confirm" または "Yes/no" を含むプロンプト
  - カスタムプロンプト記号（$、>、#など）のユーザー入力待ち
- **REQ-158**: パターン検出において、システムはANSIエスケープシーケンス（`\x1b[...m`等）を完全に除去した後にマッチングを行わなければならない
- **REQ-159**: ブラウザタブがバックグラウンドの時のみ、システムはOS通知を送信しなければならない（REQ-089と同様）
- **REQ-160**: 通知クールダウン期間（5秒）内に同一パターンが検出された場合、システムは通知を抑制しなければならない

---

## 非機能要件

### パフォーマンス

- **NFR-001**: システムはClaude Codeの出力を500ms以内にブラウザに表示しなければならない
