# 要件定義書: コア機能（プロジェクト・セッション基盤）

## 概要

ClaudeWorkの基盤となるプロジェクト管理とセッション管理機能の要件を定義します。

## 関連ストーリー

- ストーリー1: プロジェクト管理
- ストーリー2: セッション作成と管理
- ストーリー3: プロンプト履歴
- ストーリー14: Claude Code CLIの自動検出

---

## ストーリー1: プロジェクト管理

**私は** 開発者として
**〜したい** 複数のGitリポジトリをプロジェクトとして登録・管理
**なぜなら** 様々なプロジェクトでClaude Codeを活用したいから

### 受入基準（EARS記法）

- **REQ-001**: ユーザーが「プロジェクト追加」をクリックした時、システムはローカルGitリポジトリのパスを入力するフォームを表示しなければならない
- **REQ-002**: 指定されたパスがGitリポジトリでない場合、システムは「Gitリポジトリではありません」とエラーメッセージを表示しなければならない
- **REQ-003**: プロジェクトが正常に追加された時、システムはプロジェクト一覧に新しいプロジェクトを表示しなければならない
- **REQ-004**: ユーザーがプロジェクトを選択した時、システムはそのプロジェクトのセッション一覧を表示しなければならない
- **REQ-005**: ユーザーがプロジェクトを削除した時、システムは関連するworktreeを削除せず、プロジェクト登録のみを解除しなければならない
- **REQ-006**: ユーザーがプロジェクト設定を開いた時、システムはランスクリプト（テスト・ビルドコマンド）の設定フォームを表示しなければならない
- **REQ-007**: ユーザーがランスクリプトを保存した時、システムはそのプロジェクトの全セッションで使用可能なコマンドとして登録しなければならない

---

## ストーリー2: セッション作成と管理

**私は** 開発者として
**〜したい** プロンプトを入力してClaude Codeセッションを新しいGit worktreeで開始
**なぜなら** 複数のタスクを並列で進めたいから

### 受入基準（EARS記法）

- **REQ-008**: ユーザーが「新規セッション」をクリックした時、システムはセッション名とプロンプトを入力するフォームを表示しなければならない
- **REQ-009**: セッション作成フォームにおいて、システムは作成するセッション数（1〜10）を選択できるオプションを提供しなければならない
- **REQ-010**: 複数セッション作成が選択された時、システムは番号付きセッション名（例: feature-1, feature-2, feature-3）を自動生成しなければならない
- **REQ-011**: セッション作成が実行された時、システムは新しいGit worktreeを作成し、そのworktree内でClaude Codeを起動しなければならない
- **REQ-012**: worktree作成に失敗した場合、システムはエラーメッセージを表示し、セッションを作成しないでなければならない
- **REQ-013**: セッションが作成された時、システムはセッション一覧に新しいセッションをステータス「初期化中」で表示しなければならない
- **REQ-014**: ユーザーがセッションを選択した時、システムはそのセッションのClaude Code出力をリアルタイムで表示しなければならない
- **REQ-015**: セッション一覧において、システムは各セッションのステータス（初期化中/実行中/入力待ち/完了/エラー）をアイコンで表示しなければならない
- **REQ-016**: セッション一覧において、システムは各セッションのGit状態（未コミット変更あり/クリーン）をインジケーターで表示しなければならない
- **REQ-112**: セッションが作成された時、システムは作成されたセッションの詳細ページに自動的に遷移しなければならない
- **REQ-113**: セッションが削除された時、システムはセッション一覧を即座に更新して削除されたセッションを非表示にしなければならない

---

## ストーリー3: プロンプト履歴

**私は** 開発者として
**〜したい** 過去に使用したプロンプトを保存・再利用
**なぜなら** 効率的にセッションを作成したいから

### 受入基準（EARS記法）

- **REQ-017**: セッション作成時、システムは使用されたプロンプトをプロンプト履歴に保存しなければならない
- **REQ-018**: ユーザーがプロンプト入力フィールドをクリックした時、システムは過去のプロンプト履歴をドロップダウンで表示しなければならない
- **REQ-019**: ユーザーが履歴からプロンプトを選択した時、システムはそのプロンプトを入力フィールドに挿入しなければならない
- **REQ-020**: ユーザーがプロンプト履歴を削除した時、システムは選択されたプロンプトを履歴から削除しなければならない

---

## ストーリー14: Claude Code CLIの自動検出

**私は** システム管理者として
**〜したい** claude コマンドのパスを自動検出してほしい
**なぜなら** 環境変数を手動で設定する手間を省きたいから

### 受入基準（EARS記法）

- **REQ-070**: サーバー起動時、CLAUDE_CODE_PATH環境変数が設定されていない場合、システムはPATH環境変数からclaudeコマンドのパスを自動検出しなければならない
- **REQ-071**: サーバー起動時、CLAUDE_CODE_PATH環境変数が既に設定されている場合、システムはそのパスの有効性を検証しなければならない
- **REQ-072**: claudeコマンドが見つからない場合、システムはエラーメッセージを表示してサーバー起動を停止しなければならない
- **REQ-073**: CLAUDE_CODE_PATHが無効なパスの場合、システムはエラーメッセージを表示してサーバー起動を停止しなければならない
- **REQ-074**: claudeコマンドが正常に検出された時、システムは検出されたパスをログに出力しなければならない
- **REQ-075**: システムはmacOSとLinuxでwhichコマンドを使用してclaude コマンドを検出しなければならない
- **REQ-076**: システムはWindows環境での動作をサポートしなければならない（将来的な拡張のため、現状はエラーで停止）

---

## 非機能要件

### パフォーマンス

- **NFR-002**: システムは10個の並列セッションを同時に管理できなければならない
- **NFR-003**: APIレスポンスは95パーセンタイルで200ms以内でなければならない
- **NFR-019**: セッションワンクリック作成は1秒以内にレスポンスを返さなければならない

### 可用性

- **NFR-007**: システムはサーバー再起動後も既存のworktree情報を復元できなければならない
- **NFR-008**: システムはClaude Codeプロセスがクラッシュした場合、セッションステータスを「エラー」に更新しなければならない

### 運用性

- **NFR-009**: システムは`npx claude-work`コマンドで簡単に起動できなければならない
- **NFR-010**: システムは環境変数で主要な設定を変更できなければならない
- **NFR-011**: システムはログをJSON形式で出力しなければならない

### 互換性

- **NFR-023**: 既存のセッションは新機能導入後も正常に動作しなければならない
- **NFR-024**: 既存のAPIエンドポイントは後方互換性を維持しなければならない

---

## 用語定義

| 用語 | 定義 |
|------|------|
| プロジェクト | 管理対象のGitリポジトリ |
| セッション | 1つのGit worktreeに紐づくClaude Codeプロセスとその会話履歴 |
| worktree | Git worktree機能で作成された独立した作業ディレクトリ |
| ランスクリプト | プロジェクトに設定されたテスト・ビルドなどの実行コマンド |
