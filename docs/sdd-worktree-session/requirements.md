# Worktreeベースセッション管理 - 要件定義書

## 概要

リポジトリを事前登録し、セッションごとにWorktree（ローカル）またはブランチ（リモート）を作成する新しいセッション管理システム。

## ユーザーストーリー

### US-001: リポジトリを登録したい

**ペルソナ**: 開発者
**目的**: 頻繁に使用するリポジトリを事前に登録し、セッション作成を効率化する
**価値**: 毎回URLやパスを入力する手間を省き、一貫した作業環境を維持できる

**受入基準**:
- [ ] サイドバーにリポジトリセクションが表示される
- [ ] ローカルリポジトリを登録できる（パスを指定）
- [ ] リモートリポジトリを登録できる（URLを指定）
- [ ] 登録したリポジトリを一覧で確認できる
- [ ] 登録したリポジトリを削除できる

---

### US-002: 登録済みリポジトリからセッションを作成したい

**ペルソナ**: 開発者
**目的**: 登録済みリポジトリを選択し、新しいブランチで作業を開始する
**価値**: 親ブランチを選択してWorktreeを作成することで、並行開発が容易になる

**受入基準**:
- [ ] セッション作成時に登録済みリポジトリを選択できる
- [ ] 親ブランチを選択できる
- [ ] セッション名を入力するとブランチ名が自動生成される（session/<セッション名>）
- [ ] ローカルリポジトリの場合、Worktreeが作成される
- [ ] リモートリポジトリの場合、Docker volume内にcloneされる

---

## 機能要件

### REQ-001: リポジトリ登録機能

サイドバーのリポジトリセクションにおいて、システムはローカルまたはリモートリポジトリを登録する機能を提供しなければならない。

**詳細**:
- リポジトリ名（表示名）
- タイプ: local または remote
- パス（local）またはURL（remote）
- デフォルトブランチ（自動検出）
  - コミットが存在しない空リポジトリでも登録可能
  - 空リポジトリの場合、現在のHEAD参照ブランチ名を使用（通常 "main" または "master"）

### REQ-002: リポジトリ一覧表示

サイドバーにおいて、システムは登録済みリポジトリの一覧を表示しなければならない。

**詳細**:
- リポジトリ名とタイプ（アイコンで区別）
- 各リポジトリから作成されたセッション数
- 削除ボタン

### REQ-002-1: リポジトリタイプの視覚的区別

リポジトリ一覧において、システムはローカルとリモートリポジトリを視覚的に区別しなければならない。

**詳細**:
- タイプ別のアイコン表示（ローカル: フォルダアイコン、リモート: 地球アイコン）
- タイプを示すバッジまたはラベル（"Local" / "Remote"）
- 視覚的に一目で区別できること

### REQ-002-2: リポジトリ詳細表示

リポジトリ一覧において、システムはリポジトリの詳細情報（URLまたはPATH）を確認できる手段を提供しなければならない。

**詳細**:
- ローカルリポジトリ: ファイルシステムパスを表示
- リモートリポジトリ: Git URLを表示
- 長いパス/URLは省略表示し、ホバーまたはクリックで全体を確認可能

### REQ-003: セッション作成フロー

セッション作成モーダルを開いた時、システムは以下のフローでセッションを作成しなければならない。

**ステップ**:
1. 登録済みリポジトリを選択（ドロップダウン）
2. 親ブランチを選択（リポジトリのブランチ一覧から）
3. セッション名を入力
4. ブランチ名が自動表示（session/<セッション名>）
5. 作成ボタンでセッションを作成

### REQ-004: ローカルリポジトリのWorktree作成

ローカルリポジトリを選択してセッションを作成した時、システムは以下の処理を実行しなければならない。

**詳細**:
- `~/.claudework/worktrees/<repo-name>-<session-name>/` にWorktreeを作成
- `git worktree add` コマンドで新しいブランチを作成
- Worktreeディレクトリをコンテナの `/workspace` にbind mount

### REQ-005: リモートリポジトリのブランチ作成

リモートリポジトリを選択してセッションを作成した時、システムは以下の処理を実行しなければならない。

**詳細**:
- Docker volumeを作成（従来通り）
- volume内にリポジトリをclone
- 指定された親ブランチから新しいブランチを作成（session/<セッション名>）
- bind mountは使用しない

### REQ-006: セッション名の自動生成

セッション作成モーダルを開いた時、システムはセッション名をDocker風の形式（形容詞-動物名）で自動生成しなければならない。

**詳細**:
- モーダル表示時に自動生成（例: "gentle-panda", "swift-falcon"）
- 再生成ボタンで新しい名前を生成可能
- ユーザーが手動で編集することも可能

### REQ-006-1: ブランチ名の自動生成

セッション名を入力した時、システムはブランチ名を `session/<セッション名>` の形式で自動生成しなければならない。

**詳細**:
- セッション名に使用できない文字（スペース等）は自動的にハイフンに変換
- ブランチ名のプレビューを表示

### REQ-007: セッション削除時のWorktreeクリーンアップ

ローカルリポジトリから作成されたセッションを削除した時、システムは対応するWorktreeを削除しなければならない。

**詳細**:
- `git worktree remove` コマンドでWorktreeを削除
- Worktreeディレクトリを削除
- ブランチは削除しない（オプションで削除可能）

---

## 非機能要件

### NFR-001: UI統一

ローカル/リモートリポジトリにおいて、システムは同一のUIフローでセッションを作成できなければならない。

**詳細**:
- タイプによる分岐はシステム内部で処理
- ユーザーには統一されたUIを提供

### NFR-002: 後方互換性

既存のセッションデータにおいて、システムはすべてリセットしてよい。

**詳細**:
- 既存のセッションは削除
- 新しいスキーマに移行

### NFR-003: エラーハンドリング

Worktree作成に失敗した時、システムは明確なエラーメッセージを表示しなければならない。

**詳細**:
- 同名のWorktreeが既に存在する場合
- ディスク容量不足の場合
- Git操作に失敗した場合

---

## 制約事項

1. **Worktree制限**: ローカルリポジトリでのみWorktreeを使用
2. **ブランチ名制約**: `session/` プレフィックスは必須
3. **配置場所**: Worktreeは `~/.claudework/worktrees/` に固定

---

## 用語集

| 用語 | 定義 |
|------|------|
| Worktree | 同一リポジトリから複数のワーキングディレクトリを作成するGitの機能 |
| 親ブランチ | 新しいWorktreeの作成元となるブランチ |
| bind mount | ホストのディレクトリをコンテナ内にマップする機能 |
