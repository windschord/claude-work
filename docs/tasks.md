# タスク

> このドキュメントはAIエージェント（Claude Code等）が実装を行うことを前提としています。
> タスクは具体的なファイルパス、技術仕様、検証可能な受入基準を含めて記載してください。

## 実装計画概要

### MVP範囲（フェーズ1〜4）

以下の機能をMVPとして実装:
- プロジェクト管理（CRUD）
- セッション作成と管理（単一セッション）
- Claude Codeとの対話（入出力、権限確認）
- 変更差分の確認（基本diff）
- Git操作（worktree作成/削除、rebase、squash merge）
- 認証（トークンベース）
- 基本的なレスポンシブ対応
- Docker Composeによるデプロイ

### 拡張機能（フェーズ5〜7）

MVP後に実装:
- セッションテンプレート（一括作成）
- プロンプト履歴
- ランスクリプト実行
- コミット履歴と復元
- リッチ出力（マークダウン/シンタックスハイライト）
- ターミナル統合（XTerm.js）
- サブエージェント出力の可視化
- モデル選択
- ライト/ダークモード

---

## 完了済みフェーズ一覧

以下のフェーズは完了済みです。詳細は各検証レポートを参照してください。

| フェーズ | 内容 | 検証レポート |
|---------|------|-------------|
| Phase 1-4 | MVP基盤構築（Next.js、認証、WebSocket） | - |
| Phase 5-7 | 拡張機能（セッション管理、ターミナル、UI/UX） | - |
| Phase 8-10 | バグ修正（PR#2対応、マージ後修正） | - |
| Phase 19-20 | Critical Issue修正、SSRエラー修正 | verification-report-phase19.md |
| Phase 21 | UI/UX改善（ロゴナビゲーション） | verification-report-comprehensive-phase21.md |
| Phase 22 | Claude CLI自動検出機能 | - |
| Phase 23 | 環境変数ロード・Prisma認証修正 | - |
| Phase 24 | High Priority UIコンポーネント実装 | - |
| Phase 25 | Medium Priority機能改善 | - |
| Phase 30 | E2Eテスト環境変数修正 | - |
| Phase 31 | セッション再起動機能 | verification-report-phase31.md |
| Phase 33 | プロセス再起動・Diff表示修正 | verification-report-phase33.md |
| Phase 34 | ブラウザ通知システム | - |
| Phase 35 | 網羅的検証で発見された不具合修正 | verification-report-phase35.md |
| Phase 38 | 包括的UI検証で発見された不具合修正 | - |
| Phase 39 | ターミナル表示不具合修正 | - |
| Phase 40 | プロセスライフサイクル管理 | - |
| Phase 41 | JSON表示問題修正（stream-jsonフィルタリング） | - |

---

## タスクステータスの凡例

- `TODO` - 未着手
- `IN_PROGRESS` - 作業中
- `BLOCKED` - 依存関係や問題によりブロック中
- `REVIEW` - レビュー待ち
- `DONE` - 完了

## リスクと軽減策

### リスク1: Claude Code CLIの仕様変更

**影響度**: 高
**発生確率**: 中
**軽減策**:
- Claude Code出力パーサーを抽象化し、仕様変更に対応しやすくする
- バージョン固定と定期的な互換性確認

### リスク2: WebSocket接続の不安定性

**影響度**: 中
**発生確率**: 中
**軽減策**:
- 自動再接続機能の実装
- REST APIへのフォールバック機能

### リスク3: 並列セッションによるリソース枯渇

**影響度**: 高
**発生確率**: 低
**軽減策**:
- 最大セッション数の制限（10セッション）
- リソース監視とアラート

### リスク4: Gitコンフリクトの複雑化

**影響度**: 中
**発生確率**: 中
**軽減策**:
- コンフリクト発生時の明確な通知
- 手動解決を促すUI（ターミナル統合で対応可能）

---

## セキュリティ・品質改善タスク

以下はCodeRabbitレビュー（#3574391877）で指摘された技術的負債・改善項目です。
優先度に応じて別PRで対応してください。

### タスク: パストラバーサル対策の強化
**優先度**: 高
**ファイル**: `src/app/api/projects/route.ts` (124-145行)

**問題**:
現在は`resolve()`で絶対パス化しているが、許可ベースディレクトリの検証がない。
任意のディレクトリをプロジェクトとして登録できる状態。

**実装内容**:
1. 環境変数`ALLOWED_PROJECT_BASE_DIRS`を追加（カンマ区切り）
2. リクエストされたパスが許可ディレクトリ配下にあることを検証
3. 許可外のパスの場合は403エラーを返す

**受入基準**:
- 許可ディレクトリ外のパスでプロジェクト作成を試みると403エラー
- 許可ディレクトリ内のパスでは正常に作成できる
- テストケースを追加

### タスク: Git操作の非同期化とタイムアウト設定
**優先度**: 中
**ファイル**: `src/app/api/projects/route.ts` (127-136行), `src/services/git-service.ts`

**問題**:
`spawnSync`はイベントループをブロックし、大規模リポジトリで応答が遅延する。

**実装内容**:
1. GitServiceの全メソッドを非同期化（`spawn` + Promise化）
2. タイムアウト設定を追加（デフォルト30秒、環境変数で調整可能）
3. API Routeを`async/await`に対応

**受入基準**:
- 全てのGit操作がノンブロッキングで実行される
- タイムアウト時にエラーが返される
- 既存テストが全て通る

### タスク: プロジェクト所有権チェックの実装
**優先度**: 高
**ファイル**: `src/app/api/projects/[project_id]/route.ts` (53-60, 132-138行)

**問題**:
認証済みユーザーなら誰でも全てのプロジェクトを更新・削除できる。
マルチユーザー環境でセキュリティリスク。

**実装内容**:
1. Prismaスキーマで`Project`モデルに`owner_id`フィールドを追加
2. `AuthSession`と`Project`の関連を定義
3. PUT/DELETEハンドラーで所有権チェックを実装（所有者のみ許可）
4. プロジェクト作成時に`owner_id`を自動設定

**受入基準**:
- 他人のプロジェクトを更新/削除しようとすると403エラー
- 自分のプロジェクトは正常に更新/削除できる
- GET /api/projectsは自分のプロジェクトのみ返す
- テストケースを追加

### タスク: ログ出力の機密情報対策
**優先度**: 低
**ファイル**: `src/app/api/sessions/[id]/merge/route.ts` (103-109行)

**問題**:
`commitMessage`全体をログ出力しており、意図せず機密情報が含まれる可能性。

**実装内容**:
1. ログ出力時にcommitMessageを先頭80文字に制限
2. 全体の文字数も記録（デバッグ用）

**受入基準**:
- ログに出力されるcommitMessageが80文字以内
- 文字数情報が記録される

---

## Phase 42: セッション操作後のUI自動更新

**関連要件**: REQ-112, REQ-113

### 概要

セッション操作後のユーザー体験を改善:
1. セッション削除後にセッション一覧を即座に更新
2. セッション作成後に作成したセッションの詳細ページに自動遷移

### タスク42.1: deleteSession関数の修正

**ステータス**: `DONE`
**推定工数**: 15分

**説明**:
- `src/store/index.ts`の`deleteSession`関数を修正
- API削除成功後、ローカルの`sessions`配列から該当セッションを削除

**受入基準**:
- [ ] deleteSession成功後にsessions配列が更新される
- [ ] UIが即座に更新され、削除されたセッションが非表示になる
- [ ] 既存テストが通る

### タスク42.2: createSession関数の修正

**ステータス**: `DONE`
**推定工数**: 15分

**説明**:
- `src/store/index.ts`の`createSession`関数を修正
- 作成されたセッションのIDを返すように変更

**受入基準**:
- [ ] createSessionがセッションIDを返す
- [ ] 既存の動作（sessions配列への追加）が維持される
- [ ] 既存テストが通る

### タスク42.3: セッション作成後の自動遷移

**ステータス**: `DONE`
**推定工数**: 20分

**説明**:
- `src/app/projects/[id]/page.tsx`の`handleSessionCreated`を修正
- 作成されたセッションIDを受け取り、詳細ページに遷移

**受入基準**:
- [ ] セッション作成後に`/sessions/{id}`に自動遷移する
- [ ] 遷移先でセッション詳細が正しく表示される
- [ ] エラー時は遷移せずエラーメッセージを表示

### タスク42.4: テストの追加・更新

**ステータス**: `DONE`
**推定工数**: 20分

**説明**:
- 新しい動作に対応したテストを追加
- `src/store/__tests__/index.test.ts`の更新
- `src/components/sessions/__tests__/SessionCard.test.tsx`の確認

**受入基準**:
- [ ] deleteSession後のsessions更新テスト
- [ ] createSessionの戻り値テスト
- [ ] 全テストが通る

---

## 今後の改善予定

現時点で実装予定の新規フェーズはありません。
新しい機能要望やバグ報告があれば、このセクションにタスクを追加してください。

**検証レポート**: `docs/verification-issues.md`
