# タスク

> このドキュメントはAIエージェント（Claude Code等）が実装を行うことを前提としています。
> タスクは具体的なファイルパス、技術仕様、検証可能な受入基準を含めて記載してください。
> **不明な情報が1つでもある場合は、実装前に必ず確認を取ってください。**

## 情報の明確性チェック（全体）

### ユーザーから明示された情報

- [x] 実装対象のディレクトリ構造: Next.js App Router構成（`src/app/`, `src/components/`, `src/lib/`, `src/services/`）
- [x] 使用するパッケージマネージャー: npm
- [x] テストフレームワーク: Vitest + React Testing Library
- [x] リンター/フォーマッター: ESLint
- [x] コーディング規約: TypeScript strict mode、Tailwind CSS
- [x] ブランチ戦略: GitHub Flow（main + feature branches）

### 不明/要確認の情報（全体）

| 項目 | 現状の理解 | 確認状況 |
|------|-----------|----------|
| E2Eテストフレームワーク | Playwright | [x] 確認済み |
| デプロイ先 | ローカル実行（npx claude-work） | [x] 確認済み |

### 実装前に確認すべき質問

*すべての情報が確認済みのため、追加の確認事項はありません。*

---

## 実装計画概要

### MVP範囲（完了済み）

以下の機能はMVPとして実装完了:
- プロジェクト管理（CRUD）
- セッション作成と管理
- Claude Codeとの対話（入出力、権限確認）
- 変更差分の確認（基本diff）
- Git操作（worktree作成/削除、rebase、squash merge）
- 基本的なレスポンシブ対応

### 拡張機能（完了済み）

- セッションテンプレート（一括作成）
- ランスクリプト実行
- ターミナル統合（XTerm.js）
- ライト/ダークモード
- ブラウザ通知
- セッションTree表示

---

## 完了済みフェーズ一覧

詳細は `docs/archive/completed-phases.md` を参照してください。

| フェーズ | 内容 | ステータス |
|---------|------|-----------|
| Phase 1-4 | MVP基盤構築 | 完了 |
| Phase 5-7 | 拡張機能 | 完了 |
| Phase 8-10 | バグ修正 | 完了 |
| Phase 19-25 | UI/UX改善・機能修正 | 完了 |
| Phase 30-41 | 各種不具合修正 | 完了 |
| Phase 42 | セッション操作後のUI自動更新 | 完了 |
| Phase 43 | UX改善機能（ターミナルリサイズ、Tree表示等） | 完了 |
| Phase 45 | 認証機能の削除 | 完了 |
| Phase 47 | Terminal WebSocketのDocker環境対応 | 完了 |

---

## タスクステータスの凡例

- `TODO` - 未着手
- `IN_PROGRESS` - 作業中
- `BLOCKED` - 依存関係や問題によりブロック中
- `REVIEW` - レビュー待ち
- `DONE` - 完了

---

## Phase 48: 左メニューUI改善

**推定期間**: 4時間（AIエージェント作業時間）

**関連要件**: REQ-178〜REQ-197, NFR-033〜NFR-034

### 概要

左メニュー（サイドバー）のUIを改善し、以下の機能を追加:
1. リポジトリの追加削除（サイドバー内ボタン + モーダル）
2. リポジトリの設定変更（コンテキストメニュー + モーダル）
3. セッションの削除（ホバー時アイコン + 確認ダイアログ）
4. セッションのPR番号表示（番号 + ステータス色）

### 変更サマリ

| カテゴリ | 対象 | 数量 |
|---------|------|------|
| 新規コンポーネント | AddProjectButton, AddProjectModal, ProjectSettingsModal, DeleteConfirmDialog | 4 |
| 修正コンポーネント | Sidebar, ProjectTreeItem, SessionTreeItem | 3 |
| 新規テスト | 各コンポーネントのテスト | 4 |

---

### フェーズ1: リポジトリ追加機能

#### タスク48.1: AddProjectButtonコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/layout/AddProjectButton.tsx`
- サイドバー上部に配置するリポジトリ追加ボタン
- Lucide ReactのFolderPlusアイコンを使用

**技術的文脈**:
- Tailwind CSSでスタイリング
- onClickでモーダルを開く

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | サイドバー内に追加ボタン |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/layout/__tests__/AddProjectButton.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [x] ボタンがレンダリングされる
- [x] クリックでonClickが呼ばれる
- [x] 全テストが通る

**依存関係**: なし
**推定工数**: 15分
**ステータス**: `DONE`

---

#### タスク48.2: AddProjectModalコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/layout/AddProjectModal.tsx`
- リポジトリパスと名前の入力フォーム
- バリデーション、API呼び出し

**技術的文脈**:
- Headless UI Dialog
- react-hook-form
- POST /api/projects API呼び出し

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | パスと名前の入力、モーダル形式 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/layout/__tests__/AddProjectModal.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [x] モーダルが開閉できる
- [x] パス入力フィールドがある
- [x] 名前入力フィールドがある（パスから自動推定）
- [x] 空の場合にエラー表示
- [x] API呼び出しが行われる
- [x] 成功時にモーダルが閉じる
- [x] 全テストが通る

**依存関係**: なし
**推定工数**: 30分
**ステータス**: `DONE`

---

#### タスク48.3: Sidebarにリポジトリ追加ボタンを配置

**説明**:
- 対象ファイル: `src/components/layout/Sidebar.tsx`
- AddProjectButtonとAddProjectModalを統合
- 追加成功時にプロジェクト一覧を更新

**技術的文脈**:
- useAppStoreのfetchProjects

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | サイドバー内にボタン配置 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [x] サイドバーにボタンが表示される
- [x] クリックでモーダルが開く
- [x] 追加成功後に一覧が更新される

**依存関係**: タスク48.1, タスク48.2
**推定工数**: 15分
**ステータス**: `DONE`

---

### フェーズ2: プロジェクト設定・削除機能

#### タスク48.4: ProjectSettingsModalコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/layout/ProjectSettingsModal.tsx`
- プロジェクト名、パス、ランスクリプトの編集
- PUT /api/projects/[id] API呼び出し

**技術的文脈**:
- Headless UI Dialog
- react-hook-form
- 動的フィールド配列（ランスクリプト）

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 全設定項目（名前、パス、スクリプト）を編集可能 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/layout/__tests__/ProjectSettingsModal.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [x] モーダルが開閉できる
- [x] プロジェクト名を編集できる
- [x] パスを編集できる
- [x] ランスクリプトを追加・編集・削除できる
- [x] 保存時にAPI呼び出しが行われる
- [x] 成功時にモーダルが閉じる
- [x] 全テストが通る

**依存関係**: なし
**推定工数**: 45分
**ステータス**: `DONE`

---

#### タスク48.5: DeleteConfirmDialogコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/layout/DeleteConfirmDialog.tsx`
- 汎用的な削除確認ダイアログ
- プロジェクト削除とセッション削除で共用

**技術的文脈**:
- Headless UI Dialog
- Escキーでキャンセル

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 確認ダイアログ、Escでキャンセル |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/layout/__tests__/DeleteConfirmDialog.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [x] ダイアログが開閉できる
- [x] タイトルとメッセージが表示される
- [x] 削除ボタンで確認コールバックが呼ばれる
- [x] キャンセルボタンで閉じる
- [x] Escキーで閉じる
- [x] 全テストが通る

**依存関係**: なし
**推定工数**: 20分
**ステータス**: `DONE`

---

#### タスク48.6: ProjectTreeItemにコンテキストメニューを追加

**説明**:
- 対象ファイル: `src/components/layout/ProjectTreeItem.tsx`
- 右クリックでコンテキストメニュー表示
- 「設定」と「削除」オプション

**技術的文脈**:
- onContextMenuイベント
- カスタムコンテキストメニューコンポーネント
- Headless UI Menu

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 右クリックでメニュー、設定と削除オプション |
| 不明/要確認の情報 | なし |

**受入基準**:
- [x] 右クリックでコンテキストメニューが表示される
- [x] 「設定」クリックでProjectSettingsModalが開く
- [x] 「削除」クリックでDeleteConfirmDialogが開く
- [x] 削除確認後にAPIが呼ばれる
- [x] 削除成功後に一覧が更新される

**依存関係**: タスク48.4, タスク48.5
**推定工数**: 30分
**ステータス**: `DONE`

---

### フェーズ3: セッション削除機能

#### タスク48.7: SessionTreeItemに削除アイコンを追加

**説明**:
- 対象ファイル: `src/components/layout/SessionTreeItem.tsx`
- ホバー時にゴミ箱アイコン表示
- クリックでDeleteConfirmDialogを開く

**技術的文脈**:
- Lucide ReactのTrash2アイコン
- onMouseEnter/onMouseLeaveでホバー状態管理
- DELETE /api/sessions/[id] API呼び出し

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | ホバー時にアイコン表示 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [x] ホバー時にゴミ箱アイコンが表示される
- [x] 非ホバー時はアイコンが非表示
- [x] アイコンクリックでDeleteConfirmDialogが開く
- [x] 削除確認後にAPIが呼ばれる
- [x] 削除成功後に一覧が更新される
- [x] 現在表示中のセッションを削除した場合、/にリダイレクト

**依存関係**: タスク48.5
**推定工数**: 25分
**ステータス**: `DONE`

---

### フェーズ4: PR番号表示機能

#### タスク48.8: SessionTreeItemにPR番号表示を追加

**説明**:
- 対象ファイル: `src/components/layout/SessionTreeItem.tsx`
- PR番号とステータスバッジの表示
- クリックでGitHubページを新規タブで開く

**技術的文脈**:
- session.pr_number, session.pr_url, session.pr_status
- ステータスに応じた色分け（open=緑、merged=紫、closed=赤）

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 番号+ステータス表示、クリックでGitHubへ |
| 不明/要確認の情報 | なし |

**受入基準**:
- [x] PRがある場合にPR番号が表示される
- [x] PRがない場合は何も表示されない
- [x] ステータスに応じて色が変わる（open=緑、merged=紫、closed=赤）
- [x] クリックでGitHubページが新規タブで開く
- [x] セッションノードのクリックとは独立して動作する

**依存関係**: なし
**推定工数**: 20分
**ステータス**: `DONE`

---

### フェーズ5: 統合テスト

#### タスク48.9: 全機能の統合テスト

**説明**:
- 全機能のE2Eテストを実施
- ブラウザでの動作確認

**技術的文脈**:
- Playwright E2Eテスト
- 手動での動作確認

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 全機能の動作確認 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] リポジトリ追加ボタンがサイドバーに表示される
- [ ] リポジトリ追加モーダルが正常に動作する
- [ ] プロジェクト右クリックでコンテキストメニューが表示される
- [ ] プロジェクト設定モーダルが正常に動作する
- [ ] プロジェクト削除が確認ダイアログ付きで動作する
- [ ] セッションホバー時に削除アイコンが表示される
- [ ] セッション削除が確認ダイアログ付きで動作する
- [ ] PR番号とステータスがセッションノードに表示される
- [ ] PRリンククリックでGitHubページが開く
- [ ] 全ユニットテストが通る
- [ ] Lintエラーがない

**依存関係**: タスク48.1〜48.8
**推定工数**: 45分
**ステータス**: `TODO`

---

### リスクと軽減策

| リスク | 影響度 | 確率 | 軽減策 |
|--------|--------|------|--------|
| コンテキストメニューがモバイルで使いにくい | 中 | 中 | 長押しでメニュー表示を検討 |
| 削除操作の誤クリック | 高 | 低 | 確認ダイアログを必須にする |
| PR情報の取得遅延 | 低 | 低 | キャッシュまたはプリロード |

---

## Phase 44: UI/UX改善（セッション管理強化・通知修正・PR連携）

**推定期間**: 6時間（AIエージェント作業時間）

**関連要件**: REQ-142〜REQ-170, NFR-025〜NFR-032

### 概要

以下の5つの機能を実装:
1. ストーリー23: セッション一覧ページの廃止とTree表示への統一 (REQ-142〜145)
2. ストーリー24: Tree表示のデフォルト展開 (REQ-146〜149)
3. ストーリー25: セッション詳細ページからのセッション削除 (REQ-150〜155)
4. ストーリー26: アクション要求時ブラウザ通知の修正 (REQ-156〜160)
5. ストーリー27: セッション画面からのPR作成とリンク (REQ-161〜170)

---

### フェーズ1: セッション一覧ページの廃止（ストーリー23）

#### タスク44.1: /sessions/ページのリダイレクト実装

**説明**:
- 対象ファイル: `src/app/sessions/page.tsx`
- /sessions/パスにアクセスした場合、プロジェクト一覧ページ(/)にリダイレクト

**技術的文脈**:
- Next.js 15 App Router
- `redirect()` 関数を使用

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | /sessions/を/にリダイレクト |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] /sessions/にアクセスすると/にリダイレクトされる

**依存関係**: なし
**推定工数**: 10分
**ステータス**: `TODO`

---

#### タスク44.2: ナビゲーションからSessionsリンクを削除

**説明**:
- 対象ファイル: `src/components/layout/Header.tsx`または`Navigation.tsx`
- ナビゲーションメニューから「Sessions」リンクを削除

**技術的文脈**:
- 既存のナビゲーション構造を確認して修正

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | Sessionsリンクを削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] ナビゲーションにSessionsリンクが表示されない

**依存関係**: タスク44.1
**推定工数**: 10分
**ステータス**: `TODO`

---

### フェーズ2: Tree表示のデフォルト展開（ストーリー24）

#### タスク44.3: UIストアの作成

**説明**:
- 新規ファイル: `src/store/ui.ts`
- プロジェクト展開状態を管理するZustandストア
- ローカルストレージに永続化

**技術的文脈**:
- Zustand + persist middleware
- ストレージキー: `claudework:ui-state`

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | デフォルト展開、ローカルストレージ永続化 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/store/__tests__/ui.test.ts`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装: `src/store/ui.ts`
5. 実装コミット

**受入基準**:
- [ ] `isProjectExpanded()`がデフォルトでtrueを返す
- [ ] `toggleProject()`で展開/折りたたみを切り替えられる
- [ ] 状態がローカルストレージに永続化される
- [ ] 全テストが通る

**依存関係**: なし
**推定工数**: 20分
**ステータス**: `TODO`

---

#### タスク44.4: Sidebarのデフォルト展開対応

**説明**:
- 対象ファイル: `src/components/layout/Sidebar.tsx`
- useUIStoreを使用してデフォルト展開を実現

**技術的文脈**:
- 既存のSidebarコンポーネントを修正
- useUIStoreからisProjectExpanded, toggleProjectを使用

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | デフォルト展開、クリックで切り替え |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] ページ読み込み時にプロジェクトが展開されている
- [ ] クリックで折りたたみ/展開が切り替わる
- [ ] 状態が永続化される

**依存関係**: タスク44.3
**推定工数**: 15分
**ステータス**: `TODO`

---

### フェーズ3: セッション詳細ページからの削除機能（ストーリー25）

#### タスク44.5: DeleteSessionDialogコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/sessions/DeleteSessionDialog.tsx`
- 確認ダイアログ、セッション名/パス表示、削除処理

**技術的文脈**:
- Headless UI Dialogコンポーネント
- react-hot-toastでエラー/成功通知

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 確認ダイアログ、セッション名/パス表示、削除後リダイレクト |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/sessions/__tests__/DeleteSessionDialog.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [ ] 確認ダイアログが表示される
- [ ] セッション名とworktreeパスが表示される
- [ ] Escキーでキャンセルできる
- [ ] 削除ボタンでDELETE APIが呼ばれる
- [ ] 削除成功後にプロジェクトページにリダイレクト
- [ ] エラー時にトースト通知が表示される
- [ ] 全テストが通る

**依存関係**: なし
**推定工数**: 30分
**ステータス**: `TODO`

---

#### タスク44.6: DeleteSessionButtonコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/sessions/DeleteSessionButton.tsx`
- 削除ボタンとダイアログの制御

**技術的文脈**:
- Lucide Reactのゴミ箱アイコン使用
- DeleteSessionDialogとの連携

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 赤色の削除ボタン、クリックで確認ダイアログ |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] 削除ボタンが赤色で表示される
- [ ] クリックで確認ダイアログが開く

**依存関係**: タスク44.5
**推定工数**: 15分
**ステータス**: `TODO`

---

#### タスク44.7: セッション詳細ページに削除ボタンを追加

**説明**:
- 対象ファイル: `src/app/sessions/[id]/page.tsx`
- ヘッダー部分にDeleteSessionButtonを追加

**技術的文脈**:
- 既存のセッション詳細ページのヘッダー領域

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | ヘッダーに削除ボタン配置 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] セッション詳細ページに削除ボタンが表示される
- [ ] 削除が正常に動作する

**依存関係**: タスク44.6
**推定工数**: 15分
**ステータス**: `TODO`

---

### フェーズ4: アクション要求時ブラウザ通知の修正（ストーリー26）

#### タスク44.8: action-detector.tsのパターン改善

**説明**:
- 対象ファイル: `src/lib/action-detector.ts`
- ANSIエスケープ除去の強化
- 検出パターンの追加

**技術的文脈**:
- CSI, OSC, DCS等のANSIエスケープシーケンス
- Claude CLI実際の出力パターン

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | Allow/Denyパターン検出、ANSIエスケープ除去 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/lib/__tests__/action-detector.test.ts`を拡張
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [ ] `stripAnsi()`がCSI, OSC, DCS等を除去できる
- [ ] `Allow|Deny`パターンを検出できる
- [ ] `Yes to confirm`パターンを検出できる
- [ ] 短すぎる出力は無視される
- [ ] 全テストが通る

**依存関係**: なし
**推定工数**: 25分
**ステータス**: `TODO`

---

#### タスク44.9: useClaudeTerminalの通知統合確認

**説明**:
- 対象ファイル: `src/hooks/useClaudeTerminal.ts`
- detectActionRequestとsendNotificationの統合確認

**技術的文脈**:
- 既存のuseClaudeTerminalフック
- notificationCooldownRefによる重複抑制

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | アクション要求検出時に通知、5秒クールダウン |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] アクション要求パターン検出時に通知が送信される
- [ ] 5秒以内の重複通知が抑制される
- [ ] バックグラウンド時のみOS通知が送信される

**依存関係**: タスク44.8
**推定工数**: 15分
**ステータス**: `TODO`

---

### フェーズ5: PR作成機能（ストーリー27）

#### タスク44.10: Prismaスキーマ更新（PR関連フィールド追加）

**説明**:
- 対象ファイル: `prisma/schema.prisma`
- Sessionモデルにpr_url, pr_number, pr_status, pr_updated_atを追加

**技術的文脈**:
- Prisma ORM
- SQLite

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | pr_url, pr_number, pr_status, pr_updated_atフィールド |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] Sessionモデルにpr_url, pr_number, pr_status, pr_updated_atが追加される
- [ ] マイグレーションが成功する

**依存関係**: なし
**推定工数**: 15分
**ステータス**: `TODO`

---

#### タスク44.11: PR作成APIエンドポイントの実装

**説明**:
- 新規ファイル: `src/app/api/sessions/[id]/pr/route.ts`
- POST: PR作成（gh pr create）
- GET: PRステータス取得

**技術的文脈**:
- GitHub CLI (gh) を使用
- child_process.execで実行

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | gh pr createでPR作成、ステータスをDBに保存 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/app/api/sessions/[id]/pr/__tests__/route.test.ts`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [ ] POST /api/sessions/{id}/prでPRが作成される
- [ ] PRのURLとnumberがDBに保存される
- [ ] gh CLI未インストール時に503エラーが返る
- [ ] GET /api/sessions/{id}/prでPRステータスが取得できる
- [ ] 全テストが通る

**依存関係**: タスク44.10
**推定工数**: 40分
**ステータス**: `TODO`

---

#### タスク44.12: PRSectionコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/sessions/PRSection.tsx`
- PRリンク表示、ステータスバッジ、作成ボタン

**技術的文脈**:
- Lucide ReactのGitPullRequestアイコン
- ステータスバッジ（open=緑、merged=紫、closed=赤）

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | PRリンク表示、ステータスバッジ、作成ボタン |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/sessions/__tests__/PRSection.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [ ] PR未作成時に「PRを作成」ボタンが表示される
- [ ] PR作成済み時にPRリンクが表示される
- [ ] PRステータス（open/merged/closed）がバッジで表示される
- [ ] gh CLI未利用時にボタンが無効化される
- [ ] 全テストが通る

**依存関係**: タスク44.11
**推定工数**: 30分
**ステータス**: `TODO`

---

#### タスク44.13: CreatePRDialogコンポーネントの作成

**説明**:
- 新規ファイル: `src/components/sessions/CreatePRDialog.tsx`
- タイトル・説明入力フォーム、ブランチ名表示

**技術的文脈**:
- Headless UI Dialog
- react-hot-toast

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | タイトル必須、説明任意、ブランチ名表示 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `src/components/sessions/__tests__/CreatePRDialog.test.tsx`
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装
5. 実装コミット

**受入基準**:
- [ ] タイトル入力フィールドがある
- [ ] 説明入力フィールドがある
- [ ] ソースブランチ名が表示される
- [ ] タイトル未入力時にエラーが表示される
- [ ] 作成中はローディング表示
- [ ] 全テストが通る

**依存関係**: タスク44.11
**推定工数**: 30分
**ステータス**: `TODO`

---

#### タスク44.14: セッション詳細ページにPRSectionを追加

**説明**:
- 対象ファイル: `src/app/sessions/[id]/page.tsx`
- PRSectionコンポーネントを配置

**技術的文脈**:
- 既存のセッション詳細ページ

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | セッション詳細ページにPRセクション配置 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] セッション詳細ページにPRセクションが表示される
- [ ] PR作成・リンク表示が正常に動作する

**依存関係**: タスク44.12, タスク44.13
**推定工数**: 15分
**ステータス**: `TODO`

---

### 統合タスク

#### タスク44.15: 全機能の統合テスト

**説明**:
- 全機能のE2Eテストを実施
- ブラウザでの動作確認

**技術的文脈**:
- Playwright E2Eテスト
- 手動での動作確認

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | 全機能の動作確認 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] /sessions/が/にリダイレクトされる
- [ ] ナビゲーションにSessionsリンクがない
- [ ] サイドバーがデフォルトで展開されている
- [ ] 折りたたみ状態がリロード後も維持される
- [ ] セッション削除が確認ダイアログ付きで動作する
- [ ] 削除後にプロジェクトページにリダイレクトされる
- [ ] アクション要求時に通知が届く（バックグラウンド時）
- [ ] PRを作成できる（gh CLI利用可能時）
- [ ] PRリンクとステータスが表示される
- [ ] 全ユニットテストが通る
- [ ] Lintエラーがない

**依存関係**: タスク44.1〜44.14
**推定工数**: 60分
**ステータス**: `TODO`

---

## Phase 47: Terminal WebSocketのDocker環境対応

**推定期間**: 3時間（AIエージェント作業時間）

**関連設計**: docs/design.md - Terminal WebSocket環境切替セクション

### 概要

Terminal WebSocketが常にHOST環境（ptyManager）を使用している問題を修正し、Claude WebSocketと同様にセッションの実行環境設定に応じてアダプターを切り替える。

**問題**:
- Terminal WebSocketは常にptyManager（HOST）を使用
- Docker環境のセッションでもホスト側シェルが開いてしまう
- Claude WebSocketとの不一致

**解決策**:
- Terminal WebSocketにclaude-ws.tsと同様のアダプター切替パターンを適用
- Docker環境の場合は`docker exec`で既存コンテナにbashシェルを起動

### 変更サマリ

| カテゴリ | 対象 | 数量 |
|---------|------|------|
| 修正ファイル | terminal-ws.ts, docker-adapter.ts, host-adapter.ts, environment-adapter.ts, docker/Dockerfile | 5 |
| 新規/修正テスト | terminal-ws.test.ts, docker-adapter.test.ts, host-adapter.test.ts | 3 |

---

### フェーズ1: DockerAdapterのシェル対応

#### タスク47.1: DockerAdapterにシェルモードを追加

**説明**:
- `CreateSessionOptions`にシェルモード用オプションを追加
- `docker exec`で既存コンテナにbashシェルを起動するロジックを追加

**対象ファイル**:
- `src/services/environment-adapter.ts`
- `src/services/adapters/docker-adapter.ts`

**技術的文脈**:
- 現在のDockerAdapterは`docker run --entrypoint claude`でClaude Codeを起動
- シェルモードでは`docker exec`で既存コンテナにbashシェルを接続
- Claudeと同一コンテナでコマンド実行が可能
- initialPromptは不要（シェルでは使わない）

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | シェルモード時はdocker execでbashを起動 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `docker-adapter.test.ts`にシェルモードテストを追加
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装: `CreateSessionOptions`に`shellMode: boolean`を追加
5. 実装: shellMode時に`docker exec`でbashを起動
6. 実装コミット

**受入基準**:
- [x] `CreateSessionOptions`に`shellMode?: boolean`が追加されている
- [x] shellMode=trueの場合、`docker exec`でbashが起動される
- [x] shellMode=falseまたは未指定の場合、`docker run --entrypoint claude`が使用される
- [x] テストが追加されている

**依存関係**: なし
**推定工数**: 30分
**ステータス**: `DONE`

---

### フェーズ2: Terminal WebSocketのアダプター対応

#### タスク47.2: Terminal WebSocketに環境取得ロジックを追加

**説明**:
- セッションの`environment_id`を確認
- `environmentService`と`AdapterFactory`をインポート
- 環境タイプに応じたアダプター取得

**対象ファイル**:
- `src/lib/websocket/terminal-ws.ts`

**技術的文脈**:
- claude-ws.tsの環境切替ロジックを参考に実装
- HostAdapter使用時は既存のptyManagerをラップ
- DockerAdapter使用時はshellMode=trueでセッション作成

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | claude-ws.tsと同様のパターンを適用 |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `terminal-ws.test.ts`に環境切替テストを追加
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装: 環境取得ロジックを追加
5. 実装: アダプター切替を実装
6. 実装コミット

**受入基準**:
- [x] Docker環境のセッションでDockerAdapterが使用される
- [x] HOST環境のセッションでptyManagerが使用される
- [x] 環境未指定時はデフォルト環境（HOST）が使用される
- [x] テストが追加されている

**依存関係**: タスク47.1
**推定工数**: 45分
**ステータス**: `DONE`

---

#### タスク47.3: HostAdapterのシェルモード対応

**説明**:
- HostAdapterがシェルセッションを作成できるようにする
- ptyManagerをラップして統一インターフェースを提供

**対象ファイル**:
- `src/services/adapters/host-adapter.ts`

**技術的文脈**:
- 現在のHostAdapterはclaudePtyManagerをラップ
- シェルモード用にptyManagerもラップする必要がある
- またはTerminal用に別のメソッドを追加

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | HostAdapterでもシェルセッションを作成可能にする |
| 不明/要確認の情報 | なし |

**実装手順（TDD）**:
1. テスト作成: `host-adapter.test.ts`にシェルモードテストを追加
2. テスト実行: 失敗を確認
3. テストコミット
4. 実装: shellMode時にptyManagerを使用
5. 実装コミット

**受入基準**:
- [x] shellMode=trueの場合、ptyManagerでシェルを起動
- [x] shellMode=falseの場合、claudePtyManagerでClaude Codeを起動
- [x] テストが追加されている

**依存関係**: タスク47.1
**推定工数**: 30分
**ステータス**: `DONE`

---

### フェーズ3: 統合テスト

#### タスク47.4: 環境切替の統合テスト

**説明**:
- Docker環境とHOST環境での動作確認
- Terminal WebSocketの接続・入出力テスト

**対象ファイル**:
- `src/lib/websocket/__tests__/terminal-ws.test.ts`

**技術的文脈**:
- モック環境でのテスト
- 実際のDockerコンテナは使用しない（ユニットテスト）

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | ユニットテストでモックを使用 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [x] Docker環境セッションでDockerAdapterが選択されることをテスト
- [x] HOST環境セッションでptyManagerが選択されることをテスト
- [x] 全テストがパス

**依存関係**: タスク47.2, タスク47.3
**推定工数**: 45分
**ステータス**: `DONE`

---

### リスクと軽減策

| リスク | 影響度 | 確率 | 軽減策 |
|--------|--------|------|--------|
| DockerAdapterのシェル起動が失敗 | 中 | 低 | 手動でdocker runコマンドをテスト |
| 既存のTerminal機能への影響 | 高 | 低 | HOST環境のテストを優先実施 |
| アダプター切替のタイミング問題 | 中 | 中 | claude-ws.tsの実装パターンを踏襲 |

---

## Phase 46: モデル選択機能の削除

**推定期間**: 3時間（AIエージェント作業時間）

**関連要件**: Claude Codeでモデル選択を行うため、フロントエンドのモデル選択UIとバックエンドのモデル関連ロジックを削除

### 概要

Claude Code自体がモデル選択機能を持つため、本アプリケーションのモデル選択機能は不要になった。

### 変更サマリ

| カテゴリ | 対象 | 数量 |
|---------|------|------|
| 削除ファイル | ModelSelector.tsx、関連テスト、settings.ts | 5 |
| 修正ファイル | CreateSessionForm、APIルート、schema.prisma、ストア | 約15 |

---

### フェーズ1: フロントエンドUI削除

#### タスク46.1: ModelSelectorコンポーネントの削除

**説明**:
- 削除対象:
  - `src/components/common/ModelSelector.tsx`
  - `src/components/common/__tests__/ModelSelector.test.tsx`

**技術的文脈**:
- ファイル削除のみ

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | ModelSelector関連ファイルを削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] ModelSelector.tsxが削除される
- [ ] 関連テストファイルも削除される

**依存関係**: なし
**推定工数**: 5分
**ステータス**: `TODO`

---

#### タスク46.2: CreateSessionFormからモデル選択を削除

**説明**:
- 対象ファイル: `src/components/sessions/CreateSessionForm.tsx`
- モデル選択ドロップダウンを削除
- 関連state（model）を削除

**技術的文脈**:
- React useState
- フォームからmodelフィールドを削除

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | モデル選択UIを削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] モデル選択UIが表示されない
- [ ] セッション作成が正常に動作する

**依存関係**: タスク46.1
**推定工数**: 15分
**ステータス**: `TODO`

---

#### タスク46.3: settings.tsの削除

**説明**:
- 削除対象:
  - `src/store/settings.ts`
  - `src/store/__tests__/settings.test.ts`

**技術的文脈**:
- ファイル削除のみ

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | settings.ts関連ファイルを削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] settings.tsが削除される
- [ ] 関連テストファイルも削除される

**依存関係**: なし
**推定工数**: 10分
**ステータス**: `TODO`

---

#### タスク46.4: QuickCreateButtonからモデル参照を削除

**説明**:
- 対象ファイル: `src/components/sessions/QuickCreateButton.tsx`
- defaultModel参照を削除
- createSession呼び出しからmodelパラメータを削除

**技術的文脈**:
- useSettingsStore参照を削除

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | モデル参照を削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] defaultModel参照が削除される
- [ ] セッション作成が正常に動作する

**依存関係**: タスク46.3
**推定工数**: 10分
**ステータス**: `TODO`

---

### フェーズ2: バックエンド・データベース変更

#### タスク46.5: Prismaスキーマからmodelフィールドを削除

**説明**:
- 対象ファイル: `prisma/schema.prisma`
- 削除するフィールド:
  - `Project.default_model`
  - `Session.model`

**技術的文脈**:
- Prisma ORM
- npx prisma db push

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | model関連フィールドを削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] modelフィールドがスキーマから削除される
- [ ] マイグレーションが成功する

**依存関係**: なし
**推定工数**: 15分
**ステータス**: `TODO`

---

#### タスク46.6: セッション作成APIからmodel処理を削除

**説明**:
- 対象ファイル: `src/app/api/projects/[project_id]/sessions/route.ts`
- リクエストボディからmodelパラメータ処理を削除
- データベース保存からmodelフィールドを削除

**技術的文脈**:
- Next.js API Routes
- Prisma client

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | model処理を削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] modelパラメータが無視される
- [ ] セッション作成が正常に動作する

**依存関係**: タスク46.5
**推定工数**: 15分
**ステータス**: `TODO`

---

#### タスク46.7: プロジェクトAPIからdefault_model処理を削除

**説明**:
- 対象ファイル:
  - `src/app/api/projects/route.ts`
  - `src/app/api/projects/[project_id]/route.ts`
- リクエストボディからdefault_modelパラメータ処理を削除

**技術的文脈**:
- Next.js API Routes
- Prisma client

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | default_model処理を削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] default_modelパラメータが無視される
- [ ] プロジェクト作成・更新が正常に動作する

**依存関係**: タスク46.5
**推定工数**: 15分
**ステータス**: `TODO`

---

### フェーズ3: テスト・クリーンアップ

#### タスク46.8: ストアテストの更新

**説明**:
- 対象ファイル: `src/store/__tests__/index.test.ts`
- model関連のモックデータを更新

**技術的文脈**:
- Vitest
- モックデータの更新

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | model参照をテストから削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] modelフィールドの参照が削除される
- [ ] テストが通る

**依存関係**: タスク46.1〜46.7
**推定工数**: 20分
**ステータス**: `TODO`

---

#### タスク46.9: APIルートテストの更新

**説明**:
- 対象ファイル:
  - `src/app/api/projects/__tests__/route.test.ts`
  - `src/app/api/projects/[project_id]/__tests__/route.test.ts`
  - `src/app/api/projects/[project_id]/sessions/__tests__/route.test.ts`
  - `src/app/api/sessions/[id]/__tests__/route.test.ts`
- modelフィールド関連のテストを削除・更新

**技術的文脈**:
- Vitest
- API Routeテスト

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | model参照をテストから削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] modelフィールドの参照が削除される
- [ ] 全テストが通る

**依存関係**: タスク46.5〜46.7
**推定工数**: 25分
**ステータス**: `TODO`

---

#### タスク46.10: コンポーネントテストの更新

**説明**:
- 対象ファイル:
  - `src/components/sessions/__tests__/CreateSessionForm.test.tsx`
  - `src/components/sessions/__tests__/QuickCreateButton.test.tsx`
- model関連のテストを削除・更新

**技術的文脈**:
- Vitest + React Testing Library

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | model参照をテストから削除 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] modelフィールドの参照が削除される
- [ ] 全テストが通る

**依存関係**: タスク46.1〜46.4
**推定工数**: 20分
**ステータス**: `TODO`

---

#### タスク46.11: ビルドとLint確認

**説明**:
- ビルドが成功することを確認
- Lintエラーがないことを確認
- 未使用インポートを削除

**技術的文脈**:
- npm run lint
- npm run build
- npm test

**情報の明確性**:

| 分類 | 内容 |
|------|------|
| 明示された情報 | ビルド・テスト・Lint確認 |
| 不明/要確認の情報 | なし |

**受入基準**:
- [ ] `npm run lint`がエラーなし
- [ ] `npm run build`が成功
- [ ] `npm test`が全て通る

**依存関係**: タスク46.8〜46.10
**推定工数**: 10分
**ステータス**: `TODO`

---

## リスクと軽減策

### リスク1: Claude Code CLIの仕様変更

**影響度**: 高
**発生確率**: 中
**軽減策**:
- Claude Code出力パーサーを抽象化し、仕様変更に対応しやすくする
- バージョン固定と定期的な互換性確認

### リスク2: WebSocket接続の不安定性

**影響度**: 中
**発生確率**: 中
**軽減策**:
- 自動再接続機能の実装
- REST APIへのフォールバック機能

### リスク3: 並列セッションによるリソース枯渇

**影響度**: 高
**発生確率**: 低
**軽減策**:
- 最大セッション数の制限（10セッション）
- リソース監視とアラート

### リスク4: Gitコンフリクトの複雑化

**影響度**: 中
**発生確率**: 中
**軽減策**:
- コンフリクト発生時の明確な通知
- 手動解決を促すUI（ターミナル統合で対応可能）

---

## 備考

- 完了済みフェーズの詳細は `docs/archive/completed-phases.md` を参照
- 検証レポートは `docs/verification-*.md` を参照

---

## タスク管理のガイド

### AIエージェント向けタスクの粒度

適切なタスクサイズの目安（AIエージェント作業時間）：
- **シンプルな実装**: 10-20分（単一ファイル、基本的な関数、設定ファイル）
- **標準的な実装**: 20-40分（複数ファイル、APIエンドポイント、データモデル、基本テスト）
- **複雑な実装**: 40-90分（複数コンポーネント統合、複雑なロジック、包括的テスト）
- **非常に複雑**: 90分以上 → さらに分解を検討

### AIエージェント向け良いタスク定義の特徴

1. **具体的**: ファイルパス、関数名、クラス名を明記
2. **測定可能**: 検証可能な受入基準（テスト通過、ファイル存在など）
3. **達成可能**: AIエージェントが実行可能な粒度
4. **文脈提供**: 技術スタック、参照コード、コーディング規約を明記
5. **期限付き**: AIエージェント作業時間の見積もりを明記
6. **情報の明確性**: 明示された情報と不明/要確認の情報を明確に分離

### 情報の明確性チェックの重要性

**AIエージェントが自律的に作業するためには、以下の原則を守る必要があります：**

1. **情報の分類**
   - ユーザーから「明示されている情報」と「不明な情報」を明確に分ける
   - 「おそらく〜だろう」という推測は「不明」として扱う
   - 推測に基づく実装は行わない

2. **不明な情報がある場合**
   - 不明な情報が1つでもあれば、実装前に必ず確認する
   - 確認なしに推測で進めない
   - 確認事項はチェックリスト形式で管理する

3. **確認の取り方**
   ```text
   このタスクの実装を開始する前に、以下の点を確認させてください：

   1. [不明点1]: [選択肢A] / [選択肢B] / その他
   2. [不明点2]: [具体的な質問]

   上記について教えていただけますか？
   ```

### AIエージェント向け受入基準の書き方

- チェックボックス形式で記載
- AIエージェントが検証可能な基準（ファイル存在、テスト通過、エラーゼロなど）
- 具体的なファイルパスやコマンドを含める
- 技術的に測定可能な条件を明記

### 依存関係の管理

- **前提タスク**: このタスクの開始前に完了が必要
- **並行可能**: 同時に進められるタスク
- **後続タスク**: このタスクの完了後に開始可能

### ステータス遷移のルール

```text
TODO → IN_PROGRESS → REVIEW → DONE
         ↓
      BLOCKED
         ↓
    IN_PROGRESS
```

### フェーズ分けの考え方

1. **基盤構築**: 環境設定、基本構造
2. **コア機能**: 主要な機能の実装
3. **拡張機能**: 追加機能、改善
4. **統合・テスト**: 結合、品質保証
5. **リリース準備**: デプロイ、文書化

### リスク評価のマトリクス

|  | 低影響 | 中影響 | 高影響 |
|---|--------|--------|--------|
| **高確率** | 注意 | 対策必要 | 最優先対応 |
| **中確率** | 監視 | 注意 | 対策必要 |
| **低確率** | 受容 | 監視 | 注意 |

### AIエージェント作業時間の見積もり

- 基本的な実装: 楽観的見積もり × 1.2-1.5
- 不確実性が高い場合: × 1.5-2.0
- 新しいライブラリや複雑な統合: × 2.0-2.5
- AIエージェントの能力範囲内のタスクに限定すること

### 進捗管理のヒント

- 毎日ステータスを更新
- ブロッカーは即座に報告
- 見積もりと実績の差を記録
- 振り返りで改善点を特定
