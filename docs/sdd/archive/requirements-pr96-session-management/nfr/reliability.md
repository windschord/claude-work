# 非機能要件: 信頼性

## 概要

本ドキュメントは、セッション管理の包括的改善における信頼性要件を定義します。これらの要件は、システムの可用性、耐障害性、復旧能力を保証するために設定されます。

## 信頼性要件（EARS記法）

### 可用性

#### NFR-REL-001: システム稼働時間
- システムは、計画メンテナンスを除き、99%以上の稼働時間を維持しなければならない

**測定方法**: 月間稼働時間 / 月間総時間

**目標値**:
- 月間稼働率: 99%以上
- 月間ダウンタイム: 7.2時間以内
- 計画外ダウンタイム: 3時間以内

#### NFR-REL-002: セッション可用性
- セッションが実行中の時、システムは99.9%以上の可用性を提供しなければならない

**測定方法**: (総セッション時間 - エラー時間) / 総セッション時間

**目標値**:
- セッション可用性: 99.9%以上
- 月間エラー時間: 43分以内/セッション

#### NFR-REL-003: WebSocket接続の安定性
- WebSocket接続が確立された時、システムは意図しない切断を1%以下に抑えなければならない

**測定方法**: 意図しない切断数 / 総接続数

**目標値**:
- 意図しない切断率: <1%
- 平均接続時間: >1時間

### 耐障害性

#### NFR-REL-004: PTYクラッシュの影響範囲
- PTYセッションがクラッシュした時、システムは他のセッションに影響を与えてはならない

**測定方法**: PTYクラッシュ時の影響セッション数

**目標値**:
- 影響セッション数: 0（クラッシュしたセッションのみ）
- 他セッションの継続率: 100%

#### NFR-REL-005: Dockerコンテナクラッシュの検出
- Dockerコンテナがクラッシュした時、システムは5秒以内にクラッシュを検出しなければならない

**測定方法**: コンテナクラッシュからシステム検出までの時間

**目標値**:
- 検出時間: <5秒
- 検出率: 100%

#### NFR-REL-006: エラーからの自動復旧
- エラーが発生した時、システムは可能な場合に自動復旧を試みなければならない

**測定方法**: 自動復旧成功率

**目標値**:
- 自動復旧率: >80%（復旧可能なエラー）
- 復旧時間: <10秒

### データ整合性

#### NFR-REL-007: セッション状態の整合性
- セッション状態を更新する時、システムはメモリとデータベースの整合性を保証しなければならない

**測定方法**: 不整合検出テストの合格率

**目標値**:
- 整合性保証率: 100%
- 不整合発生率: 0%

#### NFR-REL-008: トランザクションの原子性
- 複数のデータベース操作を実行する時、システムはトランザクションを使用して原子性を保証しなければならない

**測定方法**: トランザクション失敗時のロールバック成功率

**目標値**:
- ロールバック成功率: 100%
- データ不整合発生率: 0%

#### NFR-REL-009: データ損失の防止
- システムがクラッシュした時、システムは進行中のセッションデータを失ってはならない

**測定方法**: クラッシュ時のデータ損失率

**目標値**:
- データ損失率: <1%
- 重要データ（セッションメタデータ）の損失率: 0%

### 障害復旧

#### NFR-REL-010: サーバー再起動後の復旧時間
- サーバーが再起動した時、システムは10秒以内に正常動作を再開しなければならない

**測定方法**: サーバー起動からサービス利用可能までの時間

**目標値**:
- 復旧時間: <10秒
- セッション復元時間: <20秒

#### NFR-REL-011: 孤立リソースのクリーンアップ
- サーバーが再起動した時、システムは孤立したリソースを5分以内にクリーンアップしなければならない

**測定方法**: サーバー起動からクリーンアップ完了までの時間

**目標値**:
- クリーンアップ時間: <5分
- クリーンアップ成功率: >95%

#### NFR-REL-012: データベース障害時のフォールバック
- データベースが一時的に利用不可の時、システムはメモリ上で動作を継続しなければならない

**測定方法**: DB障害時のシステム継続率

**目標値**:
- システム継続率: 100%（読み取りのみ）
- DB復旧後の自動同期: 1分以内

### エラーハンドリング

#### NFR-REL-013: エラーログの記録
- エラーが発生した時、システムは詳細なエラー情報をログに記録しなければならない

**測定方法**: エラー発生時のログ記録率

**目標値**:
- ログ記録率: 100%
- ログ詳細度: スタックトレース、コンテキスト情報を含む

#### NFR-REL-014: エラー通知
- 重大なエラーが発生した時、システムはユーザーに適切なエラーメッセージを表示しなければならない

**測定方法**: エラー通知率、ユーザー理解度

**目標値**:
- 通知率: 100%
- ユーザー理解可能なメッセージ: >90%

#### NFR-REL-015: エラー伝播の防止
- エラーが発生した時、システムはエラーを適切に処理し、システム全体のクラッシュを防がなければならない

**測定方法**: エラー発生時のシステムクラッシュ率

**目標値**:
- システムクラッシュ率: <0.1%
- エラー隔離率: >99%

### リソースリーク

#### NFR-REL-016: メモリリークの防止
- セッションが破棄された時、システムはすべてのメモリリソースを解放しなければならない

**測定方法**: 24時間稼働後のメモリ増加率

**目標値**:
- メモリ増加率: <10%/24時間
- 長期稼働時のメモリ増加: <1MB/時間

#### NFR-REL-017: ファイルディスクリプタリークの防止
- セッションが破棄された時、システムはすべてのファイルディスクリプタを解放しなければならない

**測定方法**: プロセスのファイルディスクリプタ数

**目標値**:
- ファイルディスクリプタ数: <1000（通常時）
- セッション破棄後の増加: 0

#### NFR-REL-018: イベントリスナーリークの防止
- WebSocket接続が切断された時、システムはすべてのイベントリスナーを削除しなければならない

**測定方法**: イベントリスナー数のモニタリング

**目標値**:
- 接続切断後のリスナー残留: 0
- 長期稼働時のリスナー増加: 0

## 信頼性テスト戦略

### 障害注入テスト

#### テスト1: PTYクラッシュ
- **条件**: PTYプロセスを強制終了
- **期待結果**:
  - 当該セッションが適切にクリーンアップされる
  - 他のセッションに影響がない
  - ユーザーにエラーが通知される

#### テスト2: Dockerコンテナクラッシュ
- **条件**: Dockerコンテナを強制停止
- **期待結果**:
  - クラッシュが5秒以内に検出される
  - セッション状態が「ERROR」に更新される
  - ユーザーにエラーが通知される

#### テスト3: データベース障害
- **条件**: データベース接続を一時的に切断
- **期待結果**:
  - システムが読み取り専用モードで継続動作
  - DB復旧後に自動再接続
  - データ損失なし

#### テスト4: ネットワーク切断
- **条件**: WebSocket接続を強制切断
- **期待結果**:
  - 切断が即座に検出される
  - リソースがクリーンアップされる
  - 再接続が可能

### 長期稼働テスト

#### テスト5: 24時間連続稼働
- **条件**: 10セッションを24時間稼働
- **測定項目**:
  - メモリ使用量の推移
  - ファイルディスクリプタ数
  - エラー発生率
- **合格基準**:
  - メモリリークなし
  - エラー率<0.1%
  - すべてのセッションが正常動作

#### テスト6: 7日間連続稼働
- **条件**: 5セッションを7日間稼働
- **測定項目**:
  - システムリソース使用量
  - セッション可用性
  - エラーログ
- **合格基準**:
  - リソース使用量が安定
  - 可用性>99.9%
  - 重大なエラーなし

### 復旧テスト

#### テスト7: サーバー正常再起動
- **条件**: サーバーを正常に再起動
- **期待結果**:
  - 10秒以内に復旧
  - セッション状態が復元される
  - タイマーが再設定される

#### テスト8: サーバー異常終了後の復旧
- **条件**: サーバープロセスを強制終了
- **期待結果**:
  - 再起動後に孤立リソースが検出される
  - 孤立リソースがクリーンアップされる
  - データ不整合が修正される

#### テスト9: 電源断後の復旧
- **条件**: 仮想マシンの電源を強制切断
- **期待結果**:
  - 再起動後にシステムが正常動作
  - データ損失が最小限
  - 破損したセッションが検出される

### ストレステスト

#### テスト10: 大量セッション作成
- **条件**: 100セッションを短時間で作成
- **測定項目**:
  - セッション作成成功率
  - エラー発生率
  - システムリソース使用量
- **合格基準**:
  - 作成成功率>95%
  - システムクラッシュなし
  - リソース使用量が上限内

## モニタリング

### 信頼性メトリクス

システムは以下のメトリクスをリアルタイムで収集・記録しなければなりません：

1. **エラー率**:
   - セッション作成エラー率
   - WebSocket接続エラー率
   - データベースエラー率

2. **可用性**:
   - システム稼働時間
   - セッション可用性
   - WebSocket接続安定性

3. **復旧**:
   - 平均復旧時間（MTTR）
   - 障害間隔時間（MTBF）
   - 自動復旧成功率

### 信頼性アラート

以下の条件でアラートを発行しなければなりません：

- エラー率 > 5%（5分間）
- システムダウン検出
- データベース接続失敗
- メモリリーク検出（使用量が連続増加）
- ファイルディスクリプタリーク検出

## 障害対応手順

### 手順1: PTYクラッシュ
1. クラッシュを検出（onExitイベント）
2. セッション状態を「ERROR」に更新
3. 接続中のWebSocketにエラー通知
4. セッションをクリーンアップ
5. エラーログを記録

### 手順2: Dockerコンテナクラッシュ
1. クラッシュを検出（docker inspect）
2. セッション状態を「ERROR」に更新
3. 接続中のWebSocketにエラー通知
4. コンテナとセッションをクリーンアップ
5. エラーログを記録

### 手順3: データベース障害
1. 障害を検出（接続エラー）
2. 読み取り専用モードに切り替え
3. メモリ上で動作継続
4. 定期的に接続再試行
5. 復旧後にデータ同期
6. エラーログを記録

### 手順4: メモリリーク検出
1. メモリ使用量の異常増加を検出
2. ヒープダンプを取得
3. リーク箇所を特定
4. 影響セッションを特定
5. 必要に応じてサーバー再起動をスケジュール

## 検証

- [ ] すべての信頼性要件が定義されている
- [ ] 各要件に測定方法が記載されている
- [ ] 各要件に目標値が設定されている
- [ ] 障害注入テスト計画が策定されている
- [ ] 長期稼働テスト計画が策定されている
- [ ] 復旧テスト計画が策定されている
- [ ] モニタリング項目が定義されている
- [ ] 障害対応手順が記載されている

## 関連ドキュメント

- [パフォーマンス要件](performance.md) @nfr/performance.md
- [保守性要件](maintainability.md) @nfr/maintainability.md
- [要件定義書](../index.md) @index.md
