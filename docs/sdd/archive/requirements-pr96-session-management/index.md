# 要件定義書: セッション管理の包括的改善

## プロジェクト概要

ClaudeWorkは、ブラウザインターフェースを通じて複数のClaude Codeセッションを管理するWebベースツールです。本要件定義書は、現在発生している以下の3つの主要な問題を解決するための包括的改善を定義します：

1. **ブラウザごとに異なるターミナル内容が表示される**
2. **Processが予期せず停止する**
3. **Docker環境で表示や入力が正しく動作しない**

## 目的

### ビジネス目標
- ClaudeWorkの安定性と信頼性を向上させる
- 複数ブラウザからの同時アクセス時の一貫性を保証する
- Docker環境でのセッション管理を安定化させる
- サーバー再起動時の状態維持を実現する
- コードの保守性を向上させ、将来の拡張を容易にする

### 技術的目標
- WebSocket接続管理の統一化
- PTYセッションとWebSocket接続の関係を明確化
- Docker環境の複合的な問題の解決
- 状態管理の一元化

## 対象ユーザー

### プライマリユーザー
- **開発者**: Claude Codeを使用して開発作業を行う技術者
  - 複数のプロジェクトを同時に管理する必要がある
  - ブラウザを複数開いて作業する
  - Docker環境での開発を行う

### セカンダリユーザー
- **システム管理者**: ClaudeWorkサーバーの運用・保守を担当
  - サーバーの再起動や障害対応を行う
  - セッション状態の監視と管理を行う

## 根本原因の分析

調査の結果、以下の4つの根本原因が特定されました：

1. **WebSocket接続管理の不整合**
   - Session WebSocketのみConnectionManagerを使用
   - Claude/Terminal WebSocketは独自の接続数管理のみ
   - イベントハンドラーが接続ごとに重複登録され、メモリリークとデータ重複送信が発生

2. **PTYインスタンスとWebSocket接続の1:N関係の不完全な実装**
   - 1つのPTYセッションに複数のWebSocket接続が接続
   - 各接続が独立したイベントハンドラーを登録
   - スクロールバックバッファ送信とハンドラー登録間のレースコンディション
   - 初回プロンプト送信のタイミング不整合

3. **Docker環境での複合的な問題**
   - コンテナ起動オーバーヘッド（初回出力まで数秒、リサイズ無効化）
   - `docker stop`がバックグラウンド実行でエラーハンドリング不完全
   - `onExit`遅延発火時に新セッションが削除される可能性
   - 親コンテナID管理がメモリ優先でサーバー再起動後に失われる

4. **状態管理の分散**
   - `activeConnections`, `creatingSessionPromises`, `destroyTimers`がメモリ上に分散
   - データベースにもセッションメタデータとcontainer_id
   - サーバー再起動時に状態が失われ、不整合が発生

## ユーザーストーリー

| ID | タイトル | 優先度 | 状態 | リンク |
|----|---------|---------|----|---------|
| US-001 | WebSocket接続管理の統一 | 最高 | 未着手 | [詳細](stories/US-001.md) @stories/US-001.md |
| US-002 | PTYセッションマネージャーの導入 | 高 | 未着手 | [詳細](stories/US-002.md) @stories/US-002.md |
| US-003 | Docker環境の安定化 | 高 | 未着手 | [詳細](stories/US-003.md) @stories/US-003.md |
| US-004 | 状態管理の統一 | 中 | 未着手 | [詳細](stories/US-004.md) @stories/US-004.md |

## 非機能要件

| カテゴリ | ドキュメント |
|---------|-------------|
| パフォーマンス | [詳細](nfr/performance.md) @nfr/performance.md |
| 信頼性 | [詳細](nfr/reliability.md) @nfr/reliability.md |
| 保守性 | [詳細](nfr/maintainability.md) @nfr/maintainability.md |

## 成功基準

本プロジェクトは、以下のすべての基準を満たした場合に成功とみなされます：

1. ✅ 複数ブラウザで同一のターミナル内容が表示される
2. ✅ Docker環境でProcessが予期せず停止しない
3. ✅ Docker環境でリサイズ操作が正しく動作する
4. ✅ サーバー再起動後もセッション状態が維持される
5. ✅ 全ての自動テストが通過する
6. ✅ メモリリークがない（24時間稼働テストで確認）
7. ✅ コードの保守性が向上し、将来の拡張が容易になる

## 制約条件

### 技術的制約
- 既存のnode-ptyライブラリを継続使用
- 既存のPrismaデータベーススキーマとの互換性を維持（追加は可）
- Next.js 15 App Routerアーキテクチャを維持

### スケジュール制約
- Phase 1（SDD設計）: 1日
- Phase 2（実装）: 7-10日
- 合計: 8-11日

### リソース制約
- 既存のClaudeWorkコードベースをベースに改善
- 既存のテストインフラ（Vitest, Playwright）を活用

## スコープ

### スコープ内
- WebSocket接続管理の統一化
- PTYセッション管理の改善
- Docker環境の安定化
- 状態管理の一元化
- 既存機能のテストカバレッジ向上

### スコープ外
- UI/UXの大幅な変更
- 新機能の追加（認証、権限管理など）
- パフォーマンス最適化（問題解決に必要な範囲を除く）
- 他の環境タイプ（SSH環境）の実装

## 依存関係

### 外部依存
- node-pty: PTYセッション管理
- ws: WebSocketサーバー
- Prisma: データベースアクセス
- Docker: コンテナ実行環境

### 内部依存
- ユーザーストーリーの依存関係:
  - US-002はUS-001に依存（PTYマネージャーはWebSocket統一後に実装）
  - US-003はUS-001に依存（Docker環境もWebSocket統一が必要）
  - US-004はUS-002に依存（状態管理はPTYマネージャー統合後）

## リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| 既存機能の破壊 | 高 | TDDで既存機能のテストを先に作成、段階的リファクタリング |
| Docker環境での予期しない挙動 | 中 | Docker環境での手動テスト強化、ログ出力充実 |
| サーバー再起動後の状態不整合 | 中 | データベースへの状態永続化、復元処理実装 |
| 実装期間の長期化 | 低 | SDDで設計明確化、各ステップを独立したPRで管理 |

## 文書管理

- **作成日**: 2026-02-11
- **最終更新日**: 2026-02-11
- **バージョン**: 1.0
- **承認状態**: レビュー待ち

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|-----|----------|---------|--------|
| 2026-02-11 | 1.0 | 初版作成 | Claude |
