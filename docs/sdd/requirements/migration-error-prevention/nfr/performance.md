# 非機能要件: 性能要件

## 概要

マイグレーションエラー恒久対策における性能要件を定義します。

## 性能要件一覧

### NFR-001: スキーマ同期処理の性能

**要件**: スキーマ同期処理は30秒以内に完了しなければならない

**関連ストーリー**: [US-001](../stories/US-001.md) @../stories/US-001.md（スキーママイグレーションの自動化）

**根拠**:
- アプリケーション起動時に実行されるため、起動時間に直接影響する
- Systemd環境ではタイムアウト設定（デフォルト90秒）を考慮する必要がある
- 30秒は起動プロセス全体（DB初期化、HTTPサーバー起動含む）の1/3以下に抑える目安

**検証方法**:
- `drizzle-kit push`の実行時間を計測
- 最大規模のスキーマ変更（全テーブル追加）でテスト
- タイムアウト時のエラーハンドリングを確認

---

### NFR-003: スキーマ検証処理の性能

**要件**: スキーマ検証処理は5秒以内に完了しなければならない

**関連ストーリー**: [US-002](../stories/US-002.md) @../stories/US-002.md（スキーマ整合性の早期検出）

**根拠**:
- サーバー起動時の必須チェックであり、起動を大幅に遅延させてはならない
- 全テーブル（7テーブル）に対する`PRAGMA table_info`クエリは軽量
- SQLiteローカルアクセスのため、ネットワーク遅延は発生しない

**検証方法**:
- `validateSchemaIntegrity()`の実行時間を計測
- 全7テーブルに対する検証時間を測定
- 最悪ケース（全カラム不足）でのリストアップ時間を確認

**測定対象テーブル**:
- projects
- sessions
- executionEnvironments
- messages
- prompts
- runScripts
- githubPats

---

### NFR-005: ヘルスチェック処理の性能

**要件**: ヘルスチェック処理は2秒以内に完了しなければならない

**関連ストーリー**: [US-003](../stories/US-003.md) @../stories/US-003.md（システムヘルスチェックの提供）

**根拠**:
- 外部監視ツール（Prometheus、Datadog等）のポーリング間隔は通常10-30秒
- 監視ツールのタイムアウト設定（デフォルト5秒）を下回る必要がある
- Systemdの`ExecStartPost`での使用を想定し、起動完了判定を迅速化

**検証方法**:
- `/api/health`のレスポンスタイムを計測
- 負荷テスト（100 req/sec）でのp99レイテンシを確認
- スキーマ不一致時のレスポンスタイムも検証

**監視ツール連携例**:
```yaml
# Prometheus設定例
scrape_configs:
  - job_name: 'claudework'
    scrape_interval: 30s
    scrape_timeout: 5s
    metrics_path: '/api/health'
```

---

## パフォーマンステスト計画

### テストシナリオ

1. **正常系テスト**:
   - スキーマ一致時の各処理の実行時間計測
   - ベースライン性能の確立

2. **異常系テスト**:
   - スキーマ不一致時の検証・報告処理時間
   - エラーメッセージ生成のオーバーヘッド確認

3. **負荷テスト**:
   - `/api/health`への連続リクエスト（100 req/sec、60秒間）
   - 並列起動時のスキーマ同期競合テスト

### 計測ツール

- Node.js標準: `console.time()` / `console.timeEnd()`
- Systemd: `systemd-analyze blame`
- 負荷テスト: Apache Bench (`ab`)、Autocannon

### 性能劣化時の対応

もし要件を満たせない場合：
1. **NFR-001違反**: `drizzle-kit push`の代替検討（直接SQL実行）
2. **NFR-003違反**: 検証対象テーブルの段階的チェック
3. **NFR-005違反**: キャッシュ機構の導入（最終チェック時刻から5秒以内は再検証スキップ）
