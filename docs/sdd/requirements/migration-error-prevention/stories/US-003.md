# US-003: システムヘルスチェックの提供

## ユーザーストーリー

**私は** システム管理者として
**〜したい** システムのヘルスステータスをAPI経由で確認できるようにしたい
**なぜなら** 外部監視ツールやSystemdの`ExecStartPost`で自動的に正常性を確認し、問題を早期に検出するため

## 受入基準（EARS記法）

### 機能要件

- **REQ-004**: システムは`/api/health`エンドポイントでGETリクエストを受け付けなければならない
- **REQ-005**: `/api/health`へのリクエスト時、システムはスキーマ整合性チェックを実行しなければならない
- **REQ-006**: もしスキーマが整合している場合、システムはHTTP 200とステータス`"healthy"`を返さなければならない
- **REQ-007**: もしスキーマ不一致がある場合、システムはHTTP 503とステータス`"unhealthy"`を返さなければならない
- **REQ-008**: レスポンスには、タイムスタンプと不足カラムのリストを含めなければならない

### レスポンスフォーマット

```json
{
  "status": "healthy" | "unhealthy",
  "timestamp": "2026-02-17T12:34:56.789Z",
  "checks": {
    "database": {
      "status": "pass" | "fail",
      "missingColumns": [
        {"table": "Session", "column": "active_connections"}
      ]
    }
  }
}
```

### 非機能要件

- **NFR-005**: ヘルスチェック処理は2秒以内に完了しなければならない（性能要件）

## 技術要件

### 実装対象ファイル

- `src/app/api/health/route.ts`: 新規作成、GETハンドラーを実装

### 実装詳細

1. **GET /api/health**
   - US-002の`validateSchemaIntegrity()`を再利用
   - 結果をJSON形式で返却
   - ステータスコードを200または503に設定

2. **統合ポイント**
   - Systemd: `ExecStartPost=/usr/bin/curl -sf http://localhost:3000/api/health || exit 1`
   - 外部モニタリング: Prometheus、Datadog等で定期ポーリング
   - Kubernetes: liveness/readiness probeとして使用可能

## 関連ストーリー

- [US-002](US-002.md) @US-002.md: スキーマ整合性の早期検出（同じ検証ロジックを再利用）

## 備考

### 設計上の決定事項

- サーバーが起動しないとアクセスできないため、起動時チェック（US-002）と併用する
- スキーマチェック以外のヘルス項目（ディスク容量、メモリ使用率等）は将来拡張として除外
