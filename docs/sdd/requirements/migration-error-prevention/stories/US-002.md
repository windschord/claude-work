# US-002: スキーマ整合性の早期検出

## ユーザーストーリー

**私は** 開発者として
**〜したい** サーバー起動時にスキーマ不一致があれば即座に検出されるようにしたい
**なぜなら** 実行時エラーが発生する前に問題を発見し、修復方法を明示的に提示することで、トラブルシューティング時間を短縮するため

## 受入基準（EARS記法）

### 機能要件

- **REQ-002**: サーバー起動時、システムはDrizzleスキーマで定義された全カラムがデータベースに存在することを検証しなければならない
- **REQ-003**: もしカラムが不足している場合、システムは不足しているテーブル名とカラム名をリストアップしなければならない
- **REQ-004**: もしスキーマ不一致がある場合、システムは修復方法（`npx drizzle-kit push`の実行手順）を表示しなければならない
- **REQ-005**: もしスキーマ不一致がある場合、システムはHTTPサーバーを起動せず、プロセスを終了コード1で終了しなければならない
- **REQ-006**: スキーマ検証中、システムはSQLiteの`PRAGMA table_info`を使用して実際のテーブル構造を取得しなければならない

### 非機能要件

- **NFR-003**: スキーマ検証処理は5秒以内に完了しなければならない（性能要件）
- **NFR-004**: スキーマ検証は読み取り専用操作であり、データベースを変更してはならない（保守性要件）

## 技術要件

### 実装対象ファイル

- `src/lib/schema-check.ts`: 新規作成、`validateSchemaIntegrity()`関数を実装
- `server.ts`: 起動処理にスキーマチェックを組み込み

### 実装詳細

1. **validateSchemaIntegrity()関数**
   - Drizzleの全テーブル定義をループ
   - `getTableName()`でテーブル名を取得
   - `getTableColumns()`で期待されるカラム一覧を取得
   - `PRAGMA table_info`で実際のカラム一覧を取得
   - 不足カラムをリストアップして返却

2. **server.tsへの組み込み**
   - データベース初期化後、HTTPサーバー起動前に実行
   - 不一致検出時は明確なエラーメッセージを表示
   - `process.exit(1)`で起動を中断

## 関連ストーリー

- [US-001](US-001.md) @US-001.md: スキーママイグレーションの自動化（本ストーリーと組み合わせて再発防止を強化）
- [US-003](US-003.md) @US-003.md: システムヘルスチェックの提供（本ストーリーと同じ検証ロジックを再利用）

## 備考

### 検証対象テーブル

- projects
- sessions
- executionEnvironments
- messages
- prompts
- runScripts
- githubPats

### エラーメッセージ例

```
[FATAL] Database schema is out of sync with application code.
Missing columns:
  - Session.active_connections
  - Session.destroy_at
  - Session.session_state

To fix, run: npx drizzle-kit push
Or restart with: npx claude-work (auto-migration enabled)
```
