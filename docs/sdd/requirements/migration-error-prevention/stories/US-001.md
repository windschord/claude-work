# US-001: スキーママイグレーションの自動化

## ユーザーストーリー

**私は** システム管理者として
**〜したい** アプリケーション起動時にデータベーススキーマが自動的に同期されるようにしたい
**なぜなら** 手動でのマイグレーション実行忘れによるエラーを防止し、デプロイの信頼性を向上させるため

## 受入基準（EARS記法）

### 機能要件

- **REQ-001**: `npx claude-work`の起動時、システムは`drizzle-kit push`を自動実行しなければならない
- **REQ-002**: drizzle-kit pushが成功した時、システムはサーバー起動を継続しなければならない
- **REQ-003**: drizzle-kit pushが失敗した時、システムは明確なエラーメッセージを表示して起動を中断しなければならない
- **REQ-004**: スキーマ同期中、システムは進捗メッセージをコンソールに出力しなければならない
- **REQ-005**: システムは`src/db/schema.ts`をスキーマ定義の唯一の情報源（Single Source of Truth）として使用しなければならない

### 非機能要件

- **NFR-001**: スキーマ同期処理は30秒以内に完了しなければならない（性能要件）
- **NFR-002**: `CURRENT_DB_VERSION`による手動マイグレーション管理を完全に廃止しなければならない（保守性要件）

## 技術要件

### 実装対象ファイル

- `src/bin/cli-utils.ts`: `migrateDatabase()`を`syncSchema()`に置換
- `src/bin/cli.ts`: `setupDatabase()`から`syncSchema()`を呼び出し

### 実装詳細

1. **syncSchema()関数の実装**
   - `spawnSync`を使用して`drizzle-kit push`を実行
   - 標準出力/エラー出力をリアルタイムで表示（`stdio: 'inherit'`）
   - 終了コードをチェックして成功/失敗を判定

2. **廃止する関数**
   - `migrateDatabase()`
   - `createInitialTables()`
   - `addClaudeCodeOptionsColumns()`
   - `createGitHubPATTable()`
   - `safeAddColumn()`等のヘルパー関数

3. **廃止する定数**
   - `CURRENT_DB_VERSION`

## 関連ストーリー

- [US-002](US-002.md) @US-002.md: スキーマ整合性の早期検出（本ストーリーと組み合わせて再発防止を強化）

## 備考

### 設計上の決定事項

- `drizzle-kit migrate`ではなく`drizzle-kit push`を使用する理由：
  - SQLite単一ユーザーツールであり、マイグレーション履歴管理は不要
  - `push`は開発環境で既に使用されており、同じツールで統一できる
  - `push`は非破壊的操作（カラム追加のみ、削除は確認が必要）

### 参考資料

- 統合レポート: `docs/migration-error-fix.md`
- 恒久対策提案書: `docs/proposals/migration-prevention-proposal.md`
