# 要件定義: マイグレーションエラー恒久対策

## 概要

### 背景

Systemd環境でのアプリケーション起動時に、データベーススキーマの不一致により`SqliteError: no such column: "active_connections"`エラーが発生しました。根本原因は、スキーマ定義が2箇所（Drizzle Kit マイグレーションとCLI手動マイグレーション）に分散しており、同期されていないことです。

### 目的

- スキーマ定義を`src/db/schema.ts`に一元化する
- スキーマ不一致エラーの再発を防止する
- システムの信頼性と保守性を向上させる

### 対象ユーザー

- システム管理者（Systemd環境でのデプロイ・運用）
- 開発者（スキーマ変更・機能追加）

## ユーザーストーリー一覧

| ID | タイトル | 優先度 | ステータス | 詳細リンク |
|----|---------|--------|-----------|------------|
| US-001 | スキーママイグレーションの自動化 | 高（P0） | 作成中 | [詳細](stories/US-001.md) @stories/US-001.md |
| US-002 | スキーマ整合性の早期検出 | 高（P1） | 作成中 | [詳細](stories/US-002.md) @stories/US-002.md |
| US-003 | システムヘルスチェックの提供 | 中（P3） | 作成中 | [詳細](stories/US-003.md) @stories/US-003.md |

## 機能要件サマリ

| 要件ID | 概要 | 関連ストーリー | ステータス |
|--------|------|---------------|-----------|
| REQ-001 | CLIマイグレーションをdrizzle-kit pushに置換 | US-001 | 定義済 |
| REQ-002 | 起動時にDrizzleスキーマとDB実態の整合性を検証 | US-002 | 定義済 |
| REQ-003 | スキーマ不一致時に明確なエラーメッセージを表示 | US-002 | 定義済 |
| REQ-004 | /api/healthエンドポイントでスキーマ整合性を返す | US-003 | 定義済 |
| REQ-005 | ヘルスチェックで不一致時にHTTP 503を返す | US-003 | 定義済 |

## 非機能要件一覧

| カテゴリ | 詳細リンク | 要件数 |
|----------|------------|--------|
| 性能要件 | [詳細](nfr/performance.md) @nfr/performance.md | 2件 |
| 保守性要件 | [詳細](nfr/maintainability.md) @nfr/maintainability.md | 3件 |

## 依存関係

### 外部依存

- **Drizzle ORM**: スキーマ定義、drizzle-kit pushの実行
- **better-sqlite3**: SQLiteデータベースへのアクセス（PRAGMA table_info）
- **Node.js**: spawnSyncによるdrizzle-kit pushの実行

### 前提条件

- `src/db/schema.ts`が正（Source of Truth）として維持されること
- `drizzle-kit`が実行時にインストールされていること（npx経由）
- データベースファイルのパスが環境変数`DATABASE_URL`で指定されること

## スコープ外

### 今回実装しない項目

- **P2（Systemdユニットファイル改善）**: P0実装後は不要となるため除外
- **P4（CI/CDパイプライン統合）**: 任意項目のため除外
- **ロールバック機能**: drizzle-kit pushは非破壊的操作のため不要
- **マイグレーション履歴管理**: drizzle-kit migrateは使用せず、pushのみ使用
- **短期対策（手動SQL実行）**: 緊急対応として別途実施済み

### 将来検討事項

- CI/CDでのスキーマdrift検出
- マイグレーション履歴の可視化UI

---

## ドキュメント構成

```
docs/sdd/requirements/migration-error-prevention/
├── index.md                 # このファイル（目次）
├── stories/
│   ├── US-001.md           # スキーママイグレーションの自動化
│   ├── US-002.md           # スキーマ整合性の早期検出
│   └── US-003.md           # システムヘルスチェックの提供
└── nfr/
    ├── performance.md      # 性能要件
    └── maintainability.md  # 保守性要件
```

## EARS記法クイックリファレンス

| パターン | 形式 | 使用場面 |
|---------|------|----------|
| 基本形 | システムは[振る舞い]しなければならない | 常時適用される要件 |
| イベント | [イベント]の時、システムは[振る舞い]しなければならない | イベント駆動要件 |
| 条件付き | もし[条件]ならば、システムは[振る舞い]しなければならない | 状態依存要件 |
| 継続的 | [状態]の間、システムは[振る舞い]しなければならない | 継続的要件 |
| 場所 | [場所]において、システムは[振る舞い]しなければならない | コンテキスト固有要件 |
