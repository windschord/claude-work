# US-003: Docker環境でのプロジェクトclone

## ユーザーストーリー

**As a** 開発者（SSH Agent問題を抱える）
**I want to** Docker環境でプロジェクトをcloneできる
**So that** SSH認証問題を回避してプロジェクトを登録できる

## 背景・動機

ホスト環境の1Password SSH Agentとの通信失敗により、プロジェクト登録が失敗するケースがある。Docker環境では既にSSH Agent転送が実装済みで正常動作しているため、Docker環境でプロジェクトをcloneすることでSSH認証問題を回避できる。

## 受入基準

### AC-001: Dockerボリュームの作成
**Given** ユーザーがDocker環境を選択してプロジェクトを登録する時、
**When** 登録ボタンをクリックした時、
**Then** システムは以下の動作をしなければならない:
- `claude-repo-<project-id>` という名前のDockerボリュームを作成
- ボリューム作成に失敗した場合、エラーメッセージを表示

### AC-002: 一時コンテナでのgit clone実行
**Given** Dockerボリュームが作成された時、
**When** git cloneを実行する時、
**Then** システムは以下の動作をしなければならない:
- alpine/gitイメージを使用した一時コンテナを起動
- Dockerボリュームを /repo にマウント
- SSH認証情報をマウント（~/.ssh、$SSH_AUTH_SOCK、~/.gitconfig、~/.config/gh）
- git clone <url> /repo を実行
- コンテナ終了後に自動削除（--rmフラグ）

### AC-003: SSH認証情報のマウント
**Given** 一時コンテナでgit cloneを実行する時、
**When** コンテナが起動する時、
**Then** システムは以下を読み取り専用でマウントしなければならない:
- ~/.ssh を /root/.ssh:ro
- $SSH_AUTH_SOCK を /ssh-agent
- ~/.gitconfig を /root/.gitconfig:ro
- ~/.config/gh を /root/.config/gh:ro

### AC-004: clone成功時の処理
**Given** 一時コンテナでgit cloneが成功した時、
**When** cloneが完了した時、
**Then** システムは以下の動作をしなければならない:
- データベースにプロジェクト情報を保存
- cloneLocation='docker'を設定
- dockerVolumeIdに作成したボリューム名を保存
- ユーザーにプロジェクト登録成功を通知

### AC-005: clone失敗時の処理
**Given** 一時コンテナでgit cloneが失敗した時、
**When** cloneが失敗した時、
**Then** システムは以下の動作をしなければならない:
- エラーメッセージをユーザーに表示
- 作成したDockerボリュームを自動削除（デフォルト）
- デバッグモードが有効な場合、ボリュームを保持
- データベースにプロジェクト情報を保存しない

### AC-006: タイムアウト設定
**Given** 一時コンテナでgit cloneを実行する時、
**When** cloneに時間がかかる時、
**Then** システムはデフォルト5分でタイムアウトしなければならない

## 機能要件

### REQ-001: Dockerボリュームの作成
ユーザーがDocker環境を選択してプロジェクトを登録した時、システムは`claude-repo-<project-id>`という名前のDockerボリュームを作成しなければならない。

### REQ-002: 一時コンテナでのgit clone実行
Dockerボリューム作成後、システムはalpine/gitイメージを使用した一時コンテナでgit cloneを実行しなければならない。

### REQ-003: SSH認証情報のマウント
一時コンテナ起動時、システムはSSH認証情報（~/.ssh、$SSH_AUTH_SOCK、~/.gitconfig、~/.config/gh）を読み取り専用でマウントしなければならない。

### REQ-004: clone成功時のデータベース保存
git clone成功時、システムはcloneLocation='docker'、dockerVolumeId=<volume-name>でプロジェクト情報をデータベースに保存しなければならない。

### REQ-005: clone失敗時のボリューム削除
git clone失敗時、システムは作成したDockerボリュームを自動削除しなければならない（デバッグモードが無効の場合）。

### REQ-006: デバッグモードでのボリューム保持
デバッグモードが有効な場合、システムはclone失敗時にDockerボリュームを保持しなければならない。

### REQ-007: タイムアウト処理
システムはgit clone処理をデフォルト5分でタイムアウトしなければならない。

### REQ-008: プロジェクトのデフォルト環境IDの使用
システムはDocker環境でcloneする際、プロジェクトのデフォルト環境ID（environment_id）を使用しなければならない。

## 非機能要件

### NFR-001: パフォーマンス
システムはDocker環境でのgit cloneを、ホスト環境と比較して許容可能なパフォーマンスで実行しなければならない（初回起動時のオーバーヘッドを含む）。

### NFR-002: セキュリティ
システムはSSH認証情報を読み取り専用でマウントし、コンテナ内での改変を防がなければならない。

### NFR-003: 信頼性
システムはgit clone失敗時に孤立したDockerボリュームを残さないようにクリーンアップしなければならない（デバッグモード無効時）。

## 技術的ノート

### Dockerコマンドの実装

```bash
# Dockerボリューム作成
docker volume create claude-repo-<project-id>

# 一時コンテナでgit clone
docker run --rm \
  -v claude-repo-<project-id>:/repo \
  -v ~/.ssh:/root/.ssh:ro \
  -v $SSH_AUTH_SOCK:/ssh-agent \
  -v ~/.gitconfig:/root/.gitconfig:ro \
  -v ~/.config/gh:/root/.config/gh:ro \
  -e SSH_AUTH_SOCK=/ssh-agent \
  alpine/git clone <url> /repo

# 失敗時のボリューム削除
docker volume rm claude-repo-<project-id>
```

### エラーハンドリング
- Dockerボリューム作成失敗
- alpine/gitイメージのpull失敗
- git clone失敗（認証、タイムアウト、ネットワークエラー）
- Dockerボリューム削除失敗

### ログ出力
- git cloneのstdoutとstderrをログに記録
- Dockerボリュームの作成・削除をログに記録
- タイムアウト発生時のログ

## 依存関係

### 依存するストーリー
- US-001: プロジェクト登録時の保存場所選択
- US-002: ホスト環境でのプロジェクトclone（理解のため）

### ブロックするストーリー
- US-004: セッション作成時のworktree作成

### 外部依存
- Docker: ボリューム管理、コンテナ実行
- alpine/gitイメージ: Docker Hubから取得

## テストシナリオ

### シナリオ1: Docker環境でプロジェクトを正常にclone
1. プロジェクト登録フォームを開く
2. Docker環境を選択（デフォルト）
3. 有効なリポジトリURL（SSH）を入力
4. プロジェクト名を入力
5. 登録ボタンをクリック
6. 検証: Dockerボリューム `claude-repo-<project-id>` が作成される
7. 検証: ボリューム内にリポジトリがcloneされる
8. 検証: cloneLocation='docker' でプロジェクトが作成される
9. 検証: dockerVolumeIdが保存される

### シナリオ2: SSH認証が正常に動作する
1. Docker環境でプロジェクトを登録
2. プライベートリポジトリURL（SSH）を入力
3. 登録ボタンをクリック
4. 検証: SSH Agent転送が正常に動作する
5. 検証: git cloneが成功する

### シナリオ3: clone失敗時のボリューム自動削除
1. Docker環境でプロジェクトを登録
2. 無効なリポジトリURLを入力
3. 登録ボタンをクリック
4. 検証: エラーメッセージが表示される
5. 検証: 作成したDockerボリュームが削除される
6. 検証: データベースにプロジェクトが作成されない

### シナリオ4: デバッグモードでのボリューム保持
1. デバッグモードを有効にする
2. Docker環境でプロジェクトを登録
3. 無効なリポジトリURLを入力
4. 登録ボタンをクリック
5. 検証: エラーメッセージが表示される
6. 検証: Dockerボリュームが保持される（削除されない）

### シナリオ5: タイムアウト処理
1. Docker環境でプロジェクトを登録
2. 非常に大きなリポジトリURLを入力
3. 登録ボタンをクリック
4. 5分待機
5. 検証: タイムアウトエラーが表示される
6. 検証: 作成したDockerボリュームが削除される

## 優先度の根拠

**優先度**: 高

SSH認証問題を解決するための主要な新機能であり、今回のプロジェクトの中核となる実装。

## 見積もり

- **ストーリーポイント**: 8
- **実装時間**: 2日
- **テスト時間**: 1日
- **合計**: 3日

## ノート

### 設計上の決定事項
- alpine/gitイメージを使用（軽量、Git操作に特化）
- SSH認証情報は読み取り専用でマウント（セキュリティ）
- デフォルトで失敗時にボリューム削除（クリーンな状態を保つ）
- デバッグモードでボリューム保持可能（トラブルシューティング用）
- タイムアウトはデフォルト5分、設定で可変（US-006で実装）

### セキュリティ考慮事項
- SSH Agent socketの安全なマウント
- 認証情報の読み取り専用マウント
- コンテナの自動削除（--rmフラグ）

### パフォーマンス考慮事項
- 初回実行時のalpine/gitイメージのpullに時間がかかる可能性
- Dockerボリュームへの書き込みは、ホスト環境と同等のパフォーマンス
- タイムアウト設定で長時間のcloneを制限
