# US-007: エラー時のDockerボリュームクリーンアップ

## ユーザーストーリー

**As a** 開発者
**I want to** Docker環境でのclone失敗時にボリュームクリーンアップ動作を制御できる
**So that** 本番環境ではストレージを圧迫せず、開発環境ではデバッグできる

## 背景・動機

Docker環境でgit clone失敗時、作成されたDockerボリュームが孤立する可能性がある。本番環境ではストレージを圧迫しないよう自動削除が望ましいが、開発環境ではトラブルシューティングのためにボリュームを保持したい場合がある。

## 受入基準

### AC-001: デフォルト動作（自動削除）
**Given** ユーザーがデバッグモード設定を変更していない時、
**When** Docker環境でgit cloneが失敗した時、
**Then** システムは以下の動作をしなければならない:
- 作成したDockerボリュームを自動削除
- ボリューム削除のログを記録
- ユーザーにクリーンアップ完了を通知

### AC-002: デバッグモードでの保持
**Given** ユーザーがデバッグモードを有効にしている時、
**When** Docker環境でgit cloneが失敗した時、
**Then** システムは以下の動作をしなければならない:
- 作成したDockerボリュームを保持
- ボリューム保持のログを記録
- ユーザーにボリューム名を通知

### AC-003: デバッグモード設定の変更
**Given** ユーザーが設定画面を開いている時、
**When** デバッグモード設定を変更する時、
**Then** システムは以下の動作をしなければならない:
- 変更されたデバッグモード設定を保存
- 次回のclone処理から新しい設定を使用

### AC-004: 手動クリーンアップコマンドの提供
**Given** デバッグモードでボリュームが保持されている時、
**When** ユーザーが手動でクリーンアップしたい時、
**Then** システムは孤立ボリュームをクリーンアップするコマンドを提供しなければならない

### AC-005: ボリューム削除失敗時の処理
**Given** git clone失敗後にボリューム削除を試みる時、
**When** ボリューム削除に失敗した時、
**Then** システムは以下の動作をしなければならない:
- エラーログを記録
- ユーザーに手動クリーンアップが必要であることを通知
- ボリューム名を含む詳細なエラーメッセージを表示

## 機能要件

### REQ-001: デフォルト動作
Docker環境でgit cloneが失敗した時、システムは作成したDockerボリュームを自動削除しなければならない（デバッグモードが無効の場合）。

### REQ-002: デバッグモードでの保持
デバッグモードが有効な場合、システムはgit clone失敗時にDockerボリュームを保持しなければならない。

### REQ-003: デバッグモード設定の保存
ユーザーがデバッグモード設定を変更した時、システムは設定ファイルまたは環境変数に保存しなければならない。

### REQ-004: ボリューム削除の実行
Dockerボリューム削除時、システムは `docker volume rm <volume-name>` を実行しなければならない。

### REQ-005: ボリューム削除のログ記録
Dockerボリューム削除時、システムは削除結果（成功/失敗）をログに記録しなければならない。

### REQ-006: 手動クリーンアップコマンド
システムは孤立ボリュームをクリーンアップするコマンド（例: `npx claude-work cleanup-volumes`）を提供しなければならない。

## 非機能要件

### NFR-001: ストレージ管理
システムはDocker環境でのclone失敗時に、ストレージを無駄に消費しないようにしなければならない（デバッグモード無効時）。

### NFR-002: トラブルシューティング支援
システムはデバッグモード有効時に、ユーザーがボリューム内容を調査できるようにしなければならない。

### NFR-003: 安全性
システムは誤って使用中のDockerボリュームを削除しないようにしなければならない。

## 技術的ノート

### デバッグモード設定の実装

**オプション1**: 環境変数
```bash
# .envファイル
DEBUG_MODE_KEEP_VOLUMES=false
```

**オプション2**: 設定ファイル（推奨）
```json
// data/settings.json
{
  "debug_mode_keep_volumes": false
}
```

### ボリューム削除の実装

```typescript
async function cleanupDockerVolume(volumeId: string, keepVolumes: boolean): Promise<void> {
  if (keepVolumes) {
    logger.info(`[DEBUG MODE] Keeping Docker volume: ${volumeId}`);
    return;
  }

  try {
    await execFile('docker', ['volume', 'rm', volumeId]);
    logger.info(`Docker volume deleted: ${volumeId}`);
  } catch (error) {
    logger.error(`Failed to delete Docker volume: ${volumeId}`, error);
    throw new Error(`Failed to delete Docker volume: ${volumeId}. Please run: docker volume rm ${volumeId}`);
  }
}
```

### 手動クリーンアップコマンドの実装

```bash
#!/bin/bash
# scripts/cleanup-volumes.sh

# ClaudeWorkの孤立ボリュームを検出
ORPHANED_VOLUMES=$(docker volume ls --filter "name=claude-repo-" --format "{{.Name}}")

if [ -z "$ORPHANED_VOLUMES" ]; then
  echo "No orphaned volumes found."
  exit 0
fi

echo "Found orphaned volumes:"
echo "$ORPHANED_VOLUMES"
echo ""
read -p "Delete these volumes? (y/N): " confirm

if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
  echo "$ORPHANED_VOLUMES" | xargs docker volume rm
  echo "Volumes deleted."
else
  echo "Canceled."
fi
```

### UI実装

設定画面に以下を追加：
- デバッグモード設定のチェックボックス
- 説明テキスト: 「有効にすると、clone失敗時にDockerボリュームを保持します（トラブルシューティング用）」
- 警告テキスト: 「デバッグモードを有効にすると、ストレージを消費する可能性があります」

## 依存関係

### 依存するストーリー
- US-003: Docker環境でのプロジェクトclone

### ブロックするストーリー
なし

## テストシナリオ

### シナリオ1: デフォルト動作（自動削除）
1. デバッグモードを無効にする（デフォルト）
2. Docker環境でプロジェクトを登録
3. 無効なリポジトリURLを入力
4. 登録ボタンをクリック
5. 検証: エラーメッセージが表示される
6. 検証: 作成されたDockerボリュームが削除される
7. 検証: ログに削除記録が残る

### シナリオ2: デバッグモードでの保持
1. デバッグモードを有効にする
2. Docker環境でプロジェクトを登録
3. 無効なリポジトリURLを入力
4. 登録ボタンをクリック
5. 検証: エラーメッセージが表示される
6. 検証: Dockerボリュームが保持される
7. 検証: ボリューム名がエラーメッセージに含まれる
8. 検証: ログに保持記録が残る

### シナリオ3: 手動クリーンアップコマンド
1. デバッグモードで複数のclone失敗を発生させる
2. 孤立ボリュームが複数存在する状態にする
3. `npx claude-work cleanup-volumes` を実行
4. 検証: 孤立ボリュームの一覧が表示される
5. 削除を確認
6. 検証: すべての孤立ボリュームが削除される

### シナリオ4: ボリューム削除失敗時の処理
1. Docker環境でプロジェクトを登録
2. clone中にDockerボリュームをマウントする（別プロセス）
3. cloneを失敗させる
4. 検証: ボリューム削除失敗のエラーメッセージが表示される
5. 検証: ログに削除失敗が記録される
6. 検証: 手動削除コマンドがエラーメッセージに含まれる

### シナリオ5: 設定の永続化
1. デバッグモードを有効にする
2. サーバーを再起動
3. Docker環境でclone失敗を発生させる
4. 検証: ボリュームが保持される

## 優先度の根拠

**優先度**: 中

ストレージ管理とトラブルシューティング支援の両立は重要だが、デフォルトの自動削除で多くのケースをカバーできる。

## 見積もり

- **ストーリーポイント**: 3
- **実装時間**: 0.5日
- **テスト時間**: 0.5日
- **合計**: 1日

## ノート

### 設計上の決定事項
- デフォルトは自動削除（ユーザーの回答に基づく）
- デバッグモード設定で保持も可能（ユーザーの回答に基づく）
- 手動クリーンアップコマンドを提供
- ボリューム削除失敗時の適切なエラーハンドリング

### セキュリティ考慮事項
- 手動クリーンアップコマンドは、ClaudeWorkが作成したボリュームのみを対象
- 誤って他のアプリケーションのボリュームを削除しないよう、名前フィルタリング（`claude-repo-*`）

### 運用上の考慮事項
- 本番環境: デバッグモード無効（自動削除）
- 開発環境: デバッグモード有効（保持）
- 定期的な手動クリーンアップの実行を推奨
