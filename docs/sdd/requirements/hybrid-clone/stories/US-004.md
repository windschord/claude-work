# US-004: セッション作成時のworktree作成

## ユーザーストーリー

**As a** 開発者
**I want to** セッション作成時にgit worktreeが正しく作成される
**So that** ホスト環境とDocker環境の両方で複数セッションを並列実行できる

## 背景・動機

Git Worktreeは、1つのリポジトリから複数の作業ディレクトリを作成できる機能で、ClaudeWorkでは複数セッションの並列実行に使用されている。ハイブリッド設計では、ホスト環境とDocker環境の両方でworktreeを適切に作成する必要がある。

## 受入基準

### AC-001: ホスト環境でのworktree作成
**Given** プロジェクトがホスト環境でcloneされている時、
**When** ユーザーがセッションを作成する時、
**Then** システムは以下の動作をしなければならない:
- data/repos/<project>/ ベースリポジトリからworktreeを作成
- .worktrees/<session-name>/ にworktreeを配置
- セッション用のブランチを作成（session/<session-name>）

### AC-002: Docker環境でのworktree作成
**Given** プロジェクトがDocker環境でcloneされている時、
**When** ユーザーがセッションを作成する時、
**Then** システムは以下の動作をしなければならない:
- Dockerボリューム内のベースリポジトリからworktreeを作成
- 一時コンテナで `git worktree add` を実行
- worktreeディレクトリをセッション起動時にマウント

### AC-003: Docker環境でのworktreeディレクトリマウント
**Given** Docker環境でworktreeが作成された時、
**When** Claude Codeセッションを起動する時、
**Then** システムは以下の動作をしなければならない:
- Dockerボリューム全体（または worktreeディレクトリ）を /workspace にマウント
- Claude Codeのworking directoryをworktreeディレクトリに設定

### AC-004: worktree作成失敗時の処理
**Given** worktree作成が失敗した時、
**When** エラーが発生した時、
**Then** システムは以下の動作をしなければならない:
- エラーメッセージをユーザーに表示
- セッションを作成しない
- 部分的に作成されたworktreeを削除

### AC-005: 既存セッションとの並列実行
**Given** プロジェクトに既存のセッションがある時、
**When** 新しいセッションを作成する時、
**Then** システムは独立したworktreeを作成し、並列実行を可能にしなければならない

## 機能要件

### REQ-001: ホスト環境でのworktree作成
プロジェクトのcloneLocation='host'の時、システムはdata/repos/<project>/からworktreeを.worktrees/<session-name>/に作成しなければならない。

### REQ-002: Docker環境でのworktree作成
プロジェクトのcloneLocation='docker'の時、システムは一時コンテナでgit worktree addを実行しなければならない。

### REQ-003: Docker環境でのworktreeマウント
Docker環境でセッション起動時、システムはDockerボリューム内のworktreeディレクトリを/workspaceにマウントしなければならない。

### REQ-004: セッション用ブランチの作成
worktree作成時、システムはsession/<session-name>という名前のブランチを作成しなければならない。

### REQ-005: worktree削除
セッション削除時、システムはworktreeディレクトリとgit worktreeメタデータを削除しなければならない。

## 非機能要件

### NFR-001: パフォーマンス
システムはworktree作成を10秒以内に完了しなければならない（Docker環境でのオーバーヘッドを含む）。

### NFR-002: 信頼性
システムはworktree作成失敗時に部分的なデータを残さないようにクリーンアップしなければならない。

### NFR-003: 一貫性
システムはホスト環境とDocker環境の両方で同じworktree構造を維持しなければならない。

## 技術的ノート

### ホスト環境の実装（既存）

```bash
# ベースリポジトリからworktreeを作成
cd data/repos/<project>
git worktree add ../../.worktrees/<session-name> -b session/<session-name>
```

### Docker環境の実装（新規）

```bash
# 一時コンテナでworktree作成
docker run --rm \
  -v claude-repo-<project-id>:/repo \
  alpine/git -C /repo worktree add /repo/.worktrees/<session-name> -b session/<session-name>

# セッション起動時のマウント
docker run \
  -v claude-repo-<project-id>:/repo \
  -w /repo/.worktrees/<session-name> \
  ...
```

### worktree構造

```text
ホスト環境:
  data/repos/<project>/.git     ← ベースリポジトリ
  .worktrees/
    ├── session-1/              ← worktree
    └── session-2/              ← worktree

Docker環境（Dockerボリューム内）:
  /repo/.git                    ← ベースリポジトリ
  /repo/.worktrees/
    ├── session-1/              ← worktree
    └── session-2/              ← worktree
```

### エラーハンドリング
- ブランチ名の衝突
- worktreeディレクトリの既存
- Docker環境での一時コンテナ実行失敗
- ボリュームマウント失敗

## 依存関係

### 依存するストーリー
- US-002: ホスト環境でのプロジェクトclone
- US-003: Docker環境でのプロジェクトclone

### ブロックするストーリー
なし（最終実装）

## テストシナリオ

### シナリオ1: ホスト環境でworktreeを作成
1. ホスト環境でプロジェクトを登録
2. セッションを作成
3. 検証: .worktrees/<session-name>/ にworktreeが作成される
4. 検証: session/<session-name> ブランチが作成される
5. 検証: セッションが正常に起動する

### シナリオ2: Docker環境でworktreeを作成
1. Docker環境でプロジェクトを登録
2. セッションを作成
3. 検証: Dockerボリューム内にworktreeが作成される
4. 検証: session/<session-name> ブランチが作成される
5. 検証: セッションが正常に起動する
6. 検証: Claude CodeがworktreeディレクトリをCWDとして使用する

### シナリオ3: 複数セッションの並列実行
1. プロジェクトを登録（ホストまたはDocker）
2. セッション1を作成
3. セッション2を作成
4. 検証: 2つの独立したworktreeが作成される
5. 検証: 両方のセッションが並列実行できる
6. 検証: 各セッションは独立したブランチを持つ

### シナリオ4: worktree作成失敗時のクリーンアップ
1. プロジェクトを登録
2. 既存のブランチ名と同じセッション名を指定
3. セッションを作成
4. 検証: エラーメッセージが表示される
5. 検証: 部分的なworktreeが削除される

### シナリオ5: セッション削除時のworktreeクリーンアップ
1. プロジェクトを登録
2. セッションを作成
3. セッションを削除
4. 検証: worktreeディレクトリが削除される
5. 検証: git worktreeメタデータが削除される
6. 検証: ブランチは保持される（オプション）

## 優先度の根拠

**優先度**: 高

セッション作成の核となる機能であり、US-002とUS-003の実装後に実装する必要がある。

## 見積もり

- **ストーリーポイント**: 5
- **実装時間**: 1.5日
- **テスト時間**: 0.5日
- **合計**: 2日

## ノート

### 設計上の決定事項
- worktree構造を両方の環境で統一（.worktrees/ディレクトリ）
- Docker環境ではDockerボリューム内にworktreeを作成（ストレージ効率）
- セッション削除時はworktreeディレクトリを削除、ブランチは保持（データ損失防止）

### Git Worktreeの利点
- ストレージ効率: .gitディレクトリは共有
- 高速なセッション作成: git cloneではなくworktree add
- 並列実行: 複数のworktreeを同時に使用可能

### Docker環境での注意事項
- Dockerボリューム全体をマウントするため、パフォーマンスへの影響は最小限
- working directoryを正しく設定することが重要
