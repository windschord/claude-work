# 要件定義: ハイブリッド設計（ホスト環境/Docker環境でのプロジェクトclone）

## プロジェクト概要

### 背景
PR#96（セッション管理の包括的改善）完了後、プロジェクト登録時のSSH認証失敗問題が発見された。具体的には、ホスト環境の1Password SSH Agentとの通信失敗により、プロジェクトのgit cloneが失敗するケースがある。

一方、Docker環境では既にSSH Agent転送が実装済みで正常動作している。

### 目的

#### ビジネス目標
- プロジェクト登録時のSSH認証問題を解決し、ユーザーエクスペリエンスを向上させる
- Docker環境での開発をよりアクセスしやすくする
- Git Worktreeの利点を維持しつつ、柔軟な保存場所選択を実現する

#### 技術的目標
- プロジェクト登録時にリポジトリの保存場所（ホスト環境/Docker環境）を選択可能にする
- Docker環境でのプロジェクトcloneとworktree管理を実装する
- 既存の実装との互換性を維持する
- gh CLI認証を含む包括的な認証情報のマウントを実現する

### 対象ユーザー

#### プライマリユーザー
- **開発者（SSH Agent問題を抱えるユーザー）**:
  - ホスト環境で1Password SSH Agentとの通信問題がある
  - Docker環境を利用してSSH認証問題を回避したい
  - 複数のプロジェクトを異なる環境で管理したい

#### セカンダリユーザー
- **開発者（既存ユーザー）**:
  - 現在ホスト環境で問題なく動作している
  - 既存のプロジェクトを継続して使用したい

## スコープ

### スコープ内
- プロジェクト登録時の保存場所選択UI
- Docker環境でのプロジェクトclone（Dockerボリューム内）
- セッション作成時のgit worktree作成（両方の環境）
- gh CLI認証のマウント（~/.config/gh）
- タイムアウト設定の管理（デフォルト5分、設定で可変）
- エラー時のDockerボリュームクリーンアップ設定（自動削除/保持）

### スコープ外
- 既存プロジェクトのマイグレーション（すべてホスト環境として扱う）
- プロジェクト削除機能の追加実装
- SSH鍵の生成や管理
- 保存場所の事後変更機能

## ユーザーストーリー

| ID | タイトル | 優先度 | ステータス | 詳細 |
|---|---|---|---|---|
| US-001 | プロジェクト登録時の保存場所選択 | 高 | 作成中 | [詳細](stories/US-001.md) @stories/US-001.md |
| US-002 | ホスト環境でのプロジェクトclone | 高 | 作成中 | [詳細](stories/US-002.md) @stories/US-002.md |
| US-003 | Docker環境でのプロジェクトclone | 高 | 作成中 | [詳細](stories/US-003.md) @stories/US-003.md |
| US-004 | セッション作成時のworktree作成 | 高 | 作成中 | [詳細](stories/US-004.md) @stories/US-004.md |
| US-005 | 既存プロジェクトの扱い | 中 | 作成中 | [詳細](stories/US-005.md) @stories/US-005.md |
| US-006 | タイムアウト設定の管理 | 中 | 作成中 | [詳細](stories/US-006.md) @stories/US-006.md |
| US-007 | エラー時のDockerボリュームクリーンアップ | 中 | 作成中 | [詳細](stories/US-007.md) @stories/US-007.md |

## 非機能要件

| カテゴリ | 詳細 |
|---------|------|
| 性能 | [performance.md](nfr/performance.md) @nfr/performance.md |
| セキュリティ | [security.md](nfr/security.md) @nfr/security.md |
| 保守性 | [maintainability.md](nfr/maintainability.md) @nfr/maintainability.md |

## データベーススキーマ変更

### Projectテーブル

| フィールド | 型 | 説明 | デフォルト値 | マイグレーション |
|----------|---|------|------------|-------------|
| cloneLocation | 'host' \| 'docker' | リポジトリの保存場所 | 'docker' (新規プロジェクト) | 既存: 'host' |
| dockerVolumeId | string? | Dockerボリューム名（Docker環境の場合のみ） | null | 既存: null |

**マイグレーション方針**:
- 既存プロジェクトはすべて `cloneLocation='host'` として扱う
- `dockerVolumeId` は既存プロジェクトでは null
- 新規プロジェクトのデフォルトは `cloneLocation='docker'` （SSH Agent問題を初期回避）

## 成功基準

本プロジェクトは、以下のすべての基準を満たした場合に成功とみなされます：

1. ✅ プロジェクト登録時に保存場所（ホスト/Docker）を選択できる
2. ✅ Docker環境でのプロジェクトcloneが正常に動作する
3. ✅ 両方の環境でセッション作成時にworktreeが正常に作成される
4. ✅ gh CLI認証が正しくマウントされ、GitHub操作が可能
5. ✅ タイムアウト設定が正しく動作し、設定で変更可能
6. ✅ エラー時のDockerボリュームクリーンアップ設定が正しく動作する
7. ✅ 既存プロジェクトが引き続き正常に動作する
8. ✅ 全ての自動テストが通過する
9. ✅ GitHub Actionsのテストが通過する

## 制約条件

### 技術的制約
- 既存のPrismaデータベーススキーマとの互換性を維持（追加は可）
- 既存のDockerAdapter実装を活用
- Git Worktreeの仕組みを維持
- 既存のプロジェクトに影響を与えない

### ビジネス制約
- 既存プロジェクトのマイグレーションは行わない
- ユーザーに複雑な設定を強いない

## 依存関係

### 外部依存
- Docker: Dockerボリューム管理、一時コンテナでのGit操作
- Git: worktree管理
- alpine/git: Docker環境でのGit操作用イメージ

### 内部依存
- PR#96の完了（完了済み）
- DockerAdapter: SSH Agent転送、認証情報マウント機能
- ユーザーストーリーの依存関係:
  - US-003はUS-002に依存（Docker環境の実装はホスト環境の理解が必要）
  - US-004はUS-002とUS-003に依存（worktree作成は両方の実装完了後）

## リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| Docker環境でのcloneパフォーマンス低下 | 中 | タイムアウト設定を適切に設定、ユーザーに事前通知 |
| Dockerボリュームの孤立 | 低 | 自動削除機能、手動クリーンアップコマンド提供 |
| 既存プロジェクトの破壊 | 高 | マイグレーション方針で既存プロジェクトはすべてホスト環境扱い、TDDで既存機能テスト |
| UI/UXの複雑化 | 中 | シンプルな選択UI、デフォルト値を適切に設定、ヘルプテキスト提供 |

## 承認記録

| 日付 | 承認者 | コメント |
|-----|-------|---------|
| 2026-02-13 | - | 初版作成 |

## 変更履歴

| バージョン | 日付 | 変更内容 |
|----------|------|---------|
| 0.1 | 2026-02-13 | 初版作成 |
