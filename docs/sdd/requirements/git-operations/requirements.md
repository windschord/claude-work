# 要件定義書: Git操作・差分・PR連携

## 概要

Git操作（コミット履歴、差分表示、rebase、merge）およびPR作成・リンク機能の要件を定義します。

## 関連ストーリー

- ストーリー7: コミット履歴と復元
- ストーリー8: 変更差分の確認
- ストーリー9: Git操作
- ストーリー27: セッション画面からのPR作成とリンク

---

## ストーリー7: コミット履歴と復元

**私は** 開発者として
**〜したい** セッション内のコミット履歴を確認し、任意のコミットに戻る
**なぜなら** Claude Codeの変更を段階的にレビューし、必要に応じて戻りたいから

### 受入基準（EARS記法）

- **REQ-039**: ユーザーがコミット履歴タブを開いた時、システムはworktree内の全コミットを時系列で表示しなければならない
- **REQ-040**: コミット一覧において、システムは各コミットのハッシュ、メッセージ、日時、変更ファイル数を表示しなければならない
- **REQ-041**: ユーザーがコミットを選択した時、システムはそのコミットの変更内容（diff）を表示しなければならない
- **REQ-042**: ユーザーが「このコミットに戻る」をクリックした時、システムは確認ダイアログを表示しなければならない
- **REQ-043**: ユーザーが確認した時、システムはgit resetを実行し、worktreeを選択したコミットの状態に戻さなければならない

---

## ストーリー8: 変更差分の確認

**私は** 開発者として
**〜したい** Claude Codeが行った変更のdiffを確認
**なぜなら** マージ前にコード変更を確認したいから

### 受入基準（EARS記法）

- **REQ-044**: ユーザーが「Diff表示」をクリックした時、システムはworktreeとmainブランチの差分を表示しなければならない
- **REQ-045**: diff表示中、システムは追加行を緑色、削除行を赤色でハイライトしなければならない
- **REQ-046**: ユーザーがファイルを選択した時、システムはそのファイルのdiffのみを表示しなければならない
- **REQ-047**: diff表示において、システムは変更されたファイル一覧をサイドバーに表示しなければならない

---

## ストーリー9: Git操作

**私は** 開発者として
**〜したい** worktreeの変更をmainブランチにマージ
**なぜなら** 完成した機能を統合したいから

### 受入基準（EARS記法）

- **REQ-048**: ユーザーが「mainから取り込み」をクリックした時、システムはmainブランチの最新変更をworktreeにrebaseしなければならない
- **REQ-049**: rebase中にコンフリクトが発生した場合、システムはコンフリクトの発生を通知し、手動解決を促さなければならない
- **REQ-050**: ユーザーが「スカッシュしてマージ」をクリックした時、システムはコミットメッセージ入力フォームを表示しなければならない
- **REQ-051**: マージが実行された時、システムはworktree内の全コミットをスカッシュし、mainブランチにマージしなければならない
- **REQ-052**: マージが成功した時、システムはworktreeを削除するかどうかユーザーに確認しなければならない
- **REQ-053**: ユーザーがworktree削除を確認した時、システムはworktreeとセッションを削除しなければならない

---

## ストーリー27: セッション画面からのPR作成とリンク

**私は** 開発者として
**〜したい** セッション詳細ページからPRを作成し、作成済みPRへのリンクを表示したい
**なぜなら** セッションでの作業完了後、シームレスにPRワークフローに移行したいから

### 背景

- 現状、PRの作成はターミナルからgh CLIを使用する必要がある
- セッションとPRの関連付けが行われていない
- UIからPR操作できることでワークフローが効率化される

### 受入基準（EARS記法）

- **REQ-161**: セッション詳細ページにおいて、システムは「PR作成」ボタンを表示しなければならない
- **REQ-162**: 「PR作成」ボタンをクリックした時、システムはPR作成フォームを表示しなければならない
- **REQ-163**: PR作成フォームにおいて、システムはタイトルと説明文の入力フィールドを提供しなければならない
- **REQ-164**: PR作成フォームにおいて、システムはセッションのブランチ名をソースブランチとして自動設定しなければならない
- **REQ-165**: PR作成が実行された時、システムはgh pr createコマンドを実行してPRを作成しなければならない
- **REQ-166**: PRが正常に作成された時、システムはPRのURLをセッションに保存しなければならない
- **REQ-167**: セッションにPRが関連付けられている場合、システムはセッション詳細ページにPRへのリンクを表示しなければならない
- **REQ-168**: PRリンクをクリックした時、システムは新しいタブでGitHub PRページを開かなければならない
- **REQ-169**: PRのステータス（Open/Merged/Closed）を、システムはセッション詳細ページに表示しなければならない
- **REQ-170**: gh CLIが利用できない場合、システムは「PR作成」ボタンを無効化し、その理由を表示しなければならない

---

## 非機能要件

### パフォーマンス

- **NFR-027**: PR作成APIは30秒のタイムアウトを設定しなければならない（gh CLIの実行時間を考慮）

### ユーザビリティ

- **NFR-030**: PR作成中はローディングインジケーターを表示しなければならない

---

## 依存関係

- **Git**: Gitがインストールされていること
- **GitHub CLI (gh)**: PR作成機能を使用する場合に必要（オプション）
