# US-003: SSH 鍵ペアの登録・管理

## ユーザーストーリー

**私は** ClaudeWork の利用者として
**〜したい** SSH 秘密鍵と公開鍵のペアを登録・管理したい
**なぜなら** プライベート Git リポジトリにアクセスするために SSH 認証を使用したいから

## 受入基準（EARS記法）

### 機能要件

- **REQ-003-001**: ユーザーが SSH 秘密鍵ファイルをアップロードした時、システムは AES-256 で暗号化してデータベースに保存しなければならない
- **REQ-003-002**: ユーザーが SSH 公開鍵ファイルをアップロードした時、システムはそのままデータベースに保存しなければならない
- **REQ-003-003**: システムは SSH 鍵に一意の名前（識別子）を付与しなければならない
- **REQ-003-004**: ユーザーが SSH 鍵一覧を表示した時、システムは鍵の名前、公開鍵の内容、登録日時を表示しなければならない
- **REQ-003-005**: システムは秘密鍵の内容を画面に表示してはならない
- **REQ-003-006**: ユーザーが SSH 鍵を削除した時、システムはデータベースから完全に削除しなければならない
- **REQ-003-007**: もし SSH 鍵にパスフレーズが設定されている場合、システムはパスフレーズ入力欄を表示しなければならない
- **REQ-003-008**: システムは OpenSSH 形式（PEM/RFC4716）の鍵をサポートしなければならない
- **REQ-003-009**: もし無効な鍵ファイルがアップロードされた場合、システムはエラーメッセージを表示しなければならない

## 画面/UI要件

### SSH 鍵管理セクション（/settings/developer）

**SSH 鍵追加フォーム**:
- 鍵の名前（テキスト入力、例: "GitHub Personal", "Work Bitbucket"）
- 秘密鍵ファイルアップロード（ファイル選択）
- 公開鍵ファイルアップロード（ファイル選択、オプション - 秘密鍵から自動生成も可）
- パスフレーズ入力（パスワード入力、オプション）
- 追加ボタン

**SSH 鍵一覧テーブル**:
| 鍵の名前 | 公開鍵（プレビュー） | 登録日時 | アクション |
|---------|-------------------|---------|----------|
| GitHub Personal | ssh-rsa AAAAB3... | 2024-01-15 | 削除 |

**公開鍵プレビュー**: 先頭30文字 + "..." で省略表示、クリックで全文モーダル表示

## データ要件

### SshKey テーブル（新規）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | String | PRIMARY KEY, UUID | SSH鍵ID |
| name | String | NOT NULL, UNIQUE | 鍵の識別名 |
| public_key | Text | NOT NULL | SSH公開鍵（平文） |
| private_key_encrypted | Text | NOT NULL | SSH秘密鍵（AES-256暗号化） |
| encryption_iv | String | NOT NULL | 暗号化初期化ベクトル（IV） |
| has_passphrase | Boolean | NOT NULL, DEFAULT false | パスフレーズ保護の有無 |
| created_at | DateTime | NOT NULL | 作成日時 |
| updated_at | DateTime | NOT NULL | 更新日時 |

### 暗号化仕様

- **アルゴリズム**: AES-256-CBC
- **鍵導出**: アプリケーションのマスターキー（環境変数 `ENCRYPTION_MASTER_KEY` から取得）
- **IV**: 鍵ごとにランダム生成し、`encryption_iv` カラムに保存

## 関連ストーリー

- [US-004](US-004.md) @US-004.md: Docker 環境でこの SSH 鍵が使用される

## 備考

### セキュリティ考慮事項

1. **暗号化マスターキー管理**:
   - マスターキーは環境変数で管理
   - `.env.local` に保存し、リポジトリにコミットしない
   - 本番環境では専用のシークレット管理サービス使用を推奨

2. **パスフレーズ保護された鍵**:
   - パスフレーズはデータベースに保存しない
   - Docker 環境使用時にユーザーに入力を求める（オプション機能）

3. **鍵の削除**:
   - 削除時は確認ダイアログを表示
   - データベースから物理削除（論理削除ではない）

### サポートする鍵形式

- RSA (2048/4096 bit)
- Ed25519
- ECDSA

### 制限事項

- SSH 鍵のパスフレーズ変更機能は含まれません（スコープ外）
- ssh-agent への自動登録は含まれません（スコープ外）

---

## EARS記法ガイド

### パターン選択
| パターン | キーワード | 使用場面 |
|---------|-----------|----------|
| 基本形 | (なし) | 常時適用される要件 |
| イベント | 〜の時 | 特定イベントで発動 |
| 条件付き | もし〜ならば | 条件成立時のみ適用 |
| 継続的 | 〜の間 | 状態が続く間適用 |
| 場所 | 〜において | 特定コンテキストで適用 |
