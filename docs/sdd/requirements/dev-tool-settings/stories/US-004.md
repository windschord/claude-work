# US-004: Docker 環境への設定自動適用

## ユーザーストーリー

**私は** ClaudeWork の利用者として
**〜したい** Docker 環境のセッション起動時に Git 設定と SSH 鍵が自動的に適用されてほしい
**なぜなら** 毎回手動で設定するのは面倒で、すぐに開発を開始したいから

## 受入基準（EARS記法）

### 機能要件

#### Git 設定の自動適用

- **REQ-004-001**: Docker コンテナが起動する時、システムは有効な Git username を `git config --global user.name` で設定しなければならない
- **REQ-004-002**: Docker コンテナが起動する時、システムは有効な Git email を `git config --global user.email` で設定しなければならない
- **REQ-004-003**: もしプロジェクト別設定が存在する場合、システムはプロジェクト設定を優先して適用しなければならない
- **REQ-004-004**: もし Git 設定が未設定の場合、システムは git config を設定せずに警告ログを出力しなければならない

#### SSH 鍵の自動マウント

- **REQ-004-005**: Docker コンテナが起動する時、システムは登録済み SSH 秘密鍵を復号化して一時ファイルに書き込まなければならない
- **REQ-004-006**: システムは SSH 秘密鍵ファイルのパーミッションを 0600 に設定しなければならない
- **REQ-004-007**: システムは SSH 秘密鍵ファイルをコンテナの `/root/.ssh/` ディレクトリにマウントしなければならない
- **REQ-004-008**: システムは SSH 公開鍵ファイルをコンテナの `/root/.ssh/` ディレクトリにマウントしなければならない
- **REQ-004-009**: システムは `/root/.ssh/config` ファイルを生成して適切な SSH 設定を記述しなければならない
- **REQ-004-010**: Docker コンテナが停止した時、システムは一時的に作成した SSH 鍵ファイルを削除しなければならない

#### HOST 環境での動作

- **REQ-004-011**: もし実行環境が HOST の場合、システムは Git 設定のみを適用し、SSH 鍵マウントは行わないしなければならない
- **REQ-004-012**: HOST 環境では、システムはユーザーの既存 `~/.ssh/` を使用しなければならない

## 画面/UI要件

このストーリーに UI は含まれません（バックグラウンド処理）。

ただし、以下のログ/フィードバックが必要です：
- セッション作成画面で「Git 設定が未設定です」という警告（該当する場合）
- Docker コンテナ起動ログに Git 設定適用の成功メッセージ

## データ要件

### 既存テーブルの参照

- **DeveloperSettings** (US-001, US-002): Git 設定を読み取る
- **SshKey** (US-003): SSH 鍵を読み取る
- **ExecutionEnvironment**: 実行環境タイプ（DOCKER/HOST）を判定
- **Project**: プロジェクト ID からプロジェクト設定を取得

## 技術要件

### Docker Adapter の拡張

`DockerAdapter` クラスに以下のメソッドを追加：

```typescript
async injectDeveloperSettings(projectId: string, containerId: string): Promise<void>
```

**処理フロー**:
1. `DeveloperSettings` から有効な Git 設定を取得（プロジェクト優先）
2. `docker exec` で `git config --global user.name` と `user.email` を実行
3. `SshKey` から SSH 鍵を取得
4. 秘密鍵を復号化して `data/environments/<env-id>/ssh/<key-name>` に一時保存
5. Docker ボリュームマウント設定を更新（既存のマウントに追加）
6. `/root/.ssh/config` を生成してコンテナにコピー

### SSH 設定ファイルの生成

`/root/.ssh/config` の内容例:
```
Host *
  StrictHostKeyChecking accept-new
  IdentityFile /root/.ssh/id_rsa
  IdentityFile /root/.ssh/id_ed25519
```

### パーミッション管理

```bash
chmod 0600 /root/.ssh/id_rsa
chmod 0644 /root/.ssh/id_rsa.pub
chmod 0700 /root/.ssh
```

## 関連ストーリー

- [US-001](US-001.md) @US-001.md: グローバル Git 設定を適用
- [US-002](US-002.md) @US-002.md: プロジェクト別 Git 設定を優先適用
- [US-003](US-003.md) @US-003.md: SSH 鍵を適用

## 備考

### セキュリティ考慮事項

1. **一時ファイルの管理**:
   - SSH 鍵は `data/environments/<env-id>/ssh/` に一時保存
   - コンテナ停止時に確実に削除（クリーンアップ処理）
   - ホスト上のファイルパーミッションも 0600 に設定

2. **read-only マウント**:
   - SSH 鍵は read-only でマウント（コンテナ内での改変を防止）

3. **パスフレーズ保護された鍵**:
   - 現バージョンでは、パスフレーズなし鍵のみサポート
   - パスフレーズ付き鍵の場合は警告を表示し、スキップ

### エラーハンドリング

- SSH 鍵の復号化に失敗した場合: エラーログを出力し、その鍵をスキップ
- Git 設定の適用に失敗した場合: エラーログを出力し、セッション起動は続行
- 一時ファイルの削除に失敗した場合: 次回起動時にクリーンアップを再試行

### 既存機能との互換性

- 既存の `~/.ssh/` マウント機能（リモートリポジトリクローン用）と併用可能
- GitHubPAT 認証と SSH 鍵認証は独立しており、両方設定されている場合は Git が自動的に選択

---

## EARS記法ガイド

### パターン選択
| パターン | キーワード | 使用場面 |
|---------|-----------|----------|
| 基本形 | (なし) | 常時適用される要件 |
| イベント | 〜の時 | 特定イベントで発動 |
| 条件付き | もし〜ならば | 条件成立時のみ適用 |
| 継続的 | 〜の間 | 状態が続く間適用 |
| 場所 | 〜において | 特定コンテキストで適用 |
