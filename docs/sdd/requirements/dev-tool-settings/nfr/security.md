# セキュリティ要件

> 非機能要件カテゴリ: セキュリティ

## 概要

開発ツール設定管理機能は、SSH 秘密鍵という機密情報を扱うため、セキュリティが最優先事項です。暗号化、アクセス制御、ファイルパーミッション管理を厳格に行う必要があります。

## 要件一覧

### NFR-SEC-001: SSH 秘密鍵の暗号化保存

**EARS記法**: SSH 秘密鍵をデータベースに保存する時、システムは AES-256-GCM アルゴリズムで暗号化しなければならない

**測定基準**:
- 指標: データベース内の秘密鍵データが暗号化されているか
- 目標値: 100% の秘密鍵が暗号化されていること
- 測定方法:
  - データベースの `SshKey.private_key_encrypted` カラムを直接確認し、平文でないことを確認
  - 暗号化ライブラリのテストコードで暗号化処理を検証

**関連する機能要件**: REQ-003-001

**優先度**: 高（必須）

**検証方法**:
- [ ] データベースに保存された秘密鍵データを SQL で直接読み取り、暗号化されていることを確認
- [ ] 暗号化鍵（マスターキー）を変更した場合、既存の秘密鍵が復号化できなくなることを確認（暗号化の有効性）
- [ ] 暗号化された秘密鍵を正しいマスターキーで復号化し、元の秘密鍵と一致することを確認

---

### NFR-SEC-002: 暗号化マスターキーの管理

**EARS記法**: システムは暗号化マスターキーを環境変数から読み込み、コードやリポジトリに含めてはならない

**測定基準**:
- 指標: マスターキーがハードコードされていないか
- 目標値: コードレビューで 0 件のハードコード
- 測定方法:
  - 静的コード解析（grep で "ENCRYPTION_MASTER_KEY" を検索）
  - `.env` ファイルが `.gitignore` に含まれているか確認

**関連する機能要件**: REQ-003-001

**優先度**: 高（必須）

**検証方法**:
- [ ] `.gitignore` に `.env` と `.env.local` が含まれていることを確認
- [ ] リポジトリ履歴に `ENCRYPTION_MASTER_KEY` の値が含まれていないことを確認
- [ ] 本番環境で環境変数が正しく設定されていることを確認

---

### NFR-SEC-003: SSH 鍵ファイルのパーミッション管理

**EARS記法**: システムは SSH 秘密鍵ファイルを作成する時、ファイルパーミッションを 0600（所有者のみ読み書き可能）に設定しなければならない

**測定基準**:
- 指標: 作成された SSH 鍵ファイルのパーミッション
- 目標値: すべての秘密鍵ファイルが 0600
- 測定方法:
  - `ls -l` コマンドでファイルパーミッションを確認
  - テストコードでパーミッション設定を検証

**関連する機能要件**: REQ-004-006

**優先度**: 高（必須）

**検証方法**:
- [ ] Docker 環境の一時鍵ファイルが 0600 であることを `docker exec ls -l` で確認
- [ ] ホスト上の一時鍵ファイル（`data/environments/<env-id>/ssh/`）が 0600 であることを確認
- [ ] 不適切なパーミッション（0644, 0777 など）では SSH が鍵を拒否することをテストで確認

---

### NFR-SEC-004: Docker 環境への read-only マウント

**EARS記法**: システムは SSH 鍵を Docker コンテナにマウントする時、read-only フラグを設定しなければならない

**測定基準**:
- 指標: Docker ボリュームマウントの read-only フラグ
- 目標値: すべての SSH 鍵マウントが read-only
- 測定方法:
  - `docker inspect` コマンドでマウント設定を確認
  - Docker API でマウントオプションを検証

**関連する機能要件**: REQ-004-007, REQ-004-008

**優先度**: 中

**検証方法**:
- [ ] `docker inspect <container-id>` の `Mounts` セクションで `"RW": false` を確認
- [ ] コンテナ内で SSH 鍵ファイルへの書き込みを試行し、エラーが発生することを確認

---

### NFR-SEC-005: 一時ファイルのクリーンアップ

**EARS記法**: Docker コンテナが停止した時、システムは作成した一時 SSH 鍵ファイルを削除しなければならない

**測定基準**:
- 指標: コンテナ停止後の一時ファイルの残存数
- 目標値: 0 件（すべて削除されていること）
- 測定方法:
  - コンテナ停止後に `data/environments/<env-id>/ssh/` ディレクトリを確認
  - 定期的なクリーンアップスクリプトでの監視

**関連する機能要件**: REQ-004-010

**優先度**: 高

**検証方法**:
- [ ] セッション削除後、対応する SSH 鍵ファイルが削除されていることを確認
- [ ] 異常終了（Docker デーモンクラッシュ等）後も、次回起動時に古いファイルがクリーンアップされることを確認
- [ ] `data/environments/` ディレクトリに孤立した SSH 鍵ファイルがないことを定期的に確認

---

## セキュリティベストプラクティス

### 認証・認可

- SSH 鍵の閲覧・編集・削除は、ログイン済みユーザーのみに許可
- 将来的に複数ユーザー対応する場合、ユーザーごとの SSH 鍵隔離を実装

### 監査ログ

- SSH 鍵の登録・削除操作をログに記録（誰が、いつ、何をしたか）
- 設定変更の履歴を保持（オプション）

### エラーメッセージ

- SSH 鍵の復号化失敗時、詳細なエラー情報を外部に漏らさない
- セキュリティ関連のエラーは、一般的なメッセージのみ表示（例: "処理に失敗しました"）
