# US-002: ボリュームマウントの設定

## ユーザーストーリー

**私は** ClaudeWorkの管理者として
**〜したい** Docker環境にホストボリュームマウントを追加・削除
**なぜなら** ホスト上のファイルやディレクトリをDocker環境内から参照・編集する必要があるため

## 受入基準（EARS記法）

### 環境作成時

- REQ-101: ユーザーがDocker環境の作成フォームを開いた時、システムはボリュームマウント設定セクションを表示しなければならない
- REQ-102: ユーザーが「ボリュームを追加」ボタンをクリックした時、システムはホストパス、コンテナパス、アクセスモード（rw/ro）の入力行を追加しなければならない
- REQ-103: ユーザーがボリュームマウント行の削除ボタンをクリックした時、システムは該当行を削除しなければならない
- REQ-104: ユーザーが環境を作成した時、システムは設定したボリュームマウントをconfig JSONの`volumeMounts`フィールドに保存しなければならない

### 環境編集時

- REQ-105: ユーザーが既存のDocker環境の編集フォームを開いた時、システムは保存済みのボリュームマウント設定を復元して表示しなければならない
- REQ-106: ユーザーが編集フォームでボリュームマウントを追加・削除して保存した時、システムはconfig JSONの`volumeMounts`フィールドを更新しなければならない

### バリデーション

- REQ-107: もしホストパスが空の場合、システムは環境の保存を拒否しなければならない
- REQ-108: もしコンテナパスが空の場合、システムは環境の保存を拒否しなければならない
- REQ-109: ユーザーが同一コンテナパスを重複して設定した時、システムは重複エラーを表示しなければならない
- REQ-110: もしホストパスが絶対パスでない場合、システムはバリデーションエラーを表示しなければならない
- REQ-111: もしコンテナパスが絶対パスでない場合、システムはバリデーションエラーを表示しなければならない

### 危険パスの警告

- REQ-112: ユーザーが危険なホストパス（/etc, /proc, /sys, /dev, /root, /boot, /sbin, /bin, /usr/sbin）を入力した時、システムは警告ダイアログを表示しなければならない
- REQ-113: 警告ダイアログにおいて、ユーザーが「同意して設定」を選択した時、システムは該当パスの設定を許可しなければならない
- REQ-114: 警告ダイアログにおいて、ユーザーが「キャンセル」を選択した時、システムは該当パスの設定を取り消さなければならない

### docker run への反映

- REQ-115: Docker環境でセッションを作成した時、システムは設定された各ボリュームマウントを`-v {hostPath}:{containerPath}[:ro]`形式でdocker runコマンドに追加しなければならない
- REQ-116: もしアクセスモードが`ro`の場合、システムは`:ro`サフィックスをボリュームマウント引数に付与しなければならない
- REQ-117: もしアクセスモードが`rw`の場合、システムはサフィックスなし（デフォルト動作）でボリュームマウント引数を構築しなければならない

### システム管理ボリュームとの共存

- REQ-118: カスタムボリュームマウントは、システムが自動的にマウントするボリューム（ワークスペース、認証ディレクトリ、SSH鍵、Git設定）の後に追加しなければならない
- REQ-119: もしカスタムボリュームマウントのコンテナパスがシステムボリュームのコンテナパス（/workspace, /home/node/.claude, /home/node/.config/claude, /home/node/.ssh, /home/node/.gitconfig）と重複する場合、システムはバリデーションエラーを表示しなければならない

## データ構造

### volumeMountsの形式

```typescript
interface VolumeMount {
  hostPath: string;        // ホスト側の絶対パス
  containerPath: string;   // コンテナ側の絶対パス
  accessMode: 'rw' | 'ro'; // アクセスモード（デフォルト: 'rw'）
}
```

### config JSONの例

```json
{
  "imageSource": "existing",
  "imageName": "ghcr.io/windschord/claude-work",
  "imageTag": "latest",
  "skipPermissions": false,
  "volumeMounts": [
    { "hostPath": "/home/user/data", "containerPath": "/data", "accessMode": "rw" },
    { "hostPath": "/home/user/config", "containerPath": "/config", "accessMode": "ro" }
  ]
}
```

## 危険パスのブロックリスト

以下のホストパスは警告対象とする:

| パス | 理由 |
|------|------|
| `/etc` | システム設定ファイル |
| `/proc` | プロセス情報の仮想ファイルシステム |
| `/sys` | カーネルパラメータの仮想ファイルシステム |
| `/dev` | デバイスファイル |
| `/root` | rootユーザーのホームディレクトリ |
| `/boot` | ブートローダー・カーネル |
| `/sbin` | システム管理用バイナリ |
| `/bin` | 基本コマンドバイナリ |
| `/usr/sbin` | システム管理用バイナリ |

## 優先度

高

## ステータス

TODO
