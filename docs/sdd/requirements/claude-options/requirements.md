# 要件定義書: Claude Code 実行オプション・環境変数設定機能

## 1. 概要

Claude Code実行時にCLIオプション（`--model`, `--allowedTools`, `--permission-mode`等）および
カスタム環境変数をプロジェクト・セッション単位で指定可能にする機能。

## 2. ユーザーストーリー

### US-001: プロジェクトレベルのデフォルト設定

**ストーリー**: プロジェクト管理者として、プロジェクト全体のClaude Code実行デフォルト設定を定義したい。
これにより、新規セッション作成時に毎回同じ設定を入力する手間を省ける。

**受入基準**:
- AC-001-1: プロジェクト設定画面でCLIオプションとカスタム環境変数を設定できる
- AC-001-2: 設定はDBに永続化される
- AC-001-3: 新規セッション作成時にプロジェクトのデフォルト設定が自動的に適用される

### US-002: セッション単位の設定オーバーライド

**ストーリー**: 開発者として、セッション作成時にプロジェクトデフォルトを上書きしてClaude Code実行設定を変更したい。
これにより、特定のタスクに最適なモデルやツールを使い分けられる。

**受入基準**:
- AC-002-1: セッション作成フォームでCLIオプションと環境変数を指定できる
- AC-002-2: セッション固有の設定がプロジェクトデフォルトをオーバーライドする
- AC-002-3: 未指定の項目はプロジェクトデフォルトが適用される

## 3. 機能要件（EARS記法）

### FR-001: CLIオプション設定

| ID | パターン | 要件 |
|----|---------|------|
| FR-001-1 | 条件 | もしユーザーがmodelオプションを指定したならば、システムはClaude Code起動時に`--model <value>`引数を付与しなければならない |
| FR-001-2 | 条件 | もしユーザーがallowedToolsオプションを指定したならば、システムはClaude Code起動時に`--allowedTools <value>`引数を付与しなければならない |
| FR-001-3 | 条件 | もしユーザーがpermission-modeオプションを指定したならば、システムはClaude Code起動時に`--permission-mode <value>`引数を付与しなければならない |
| FR-001-4 | 条件 | もしユーザーが追加フラグを指定したならば、システムはClaude Code起動時にそのフラグを引数として付与しなければならない |
| FR-001-5 | 基本 | システムは`--resume`フラグとユーザー指定のCLIオプションを共存させなければならない |

### FR-002: カスタム環境変数設定

| ID | パターン | 要件 |
|----|---------|------|
| FR-002-1 | 条件 | もしユーザーがカスタム環境変数を指定したならば、システムはClaude Code PTYプロセスの環境にそれらの変数を追加しなければならない |
| FR-002-2 | 基本 | システムは既存の安全リスト環境変数（PATH, HOME等）を常に含めなければならない |
| FR-002-3 | 基本 | システムはカスタム環境変数が安全リスト環境変数を上書きすることを許可しなければならない |

### FR-003: プロジェクトデフォルト設定

| ID | パターン | 要件 |
|----|---------|------|
| FR-003-1 | イベント | プロジェクト設定が保存された時、システムはCLIオプションとカスタム環境変数をDBに永続化しなければならない |
| FR-003-2 | イベント | セッションが作成された時、もしセッション固有設定がなければ、システムはプロジェクトのデフォルト設定を適用しなければならない |

### FR-004: セッション設定オーバーライド

| ID | パターン | 要件 |
|----|---------|------|
| FR-004-1 | イベント | セッションが作成された時、もしセッション固有のCLIオプションが指定されていれば、システムはプロジェクトデフォルトではなくセッション固有の設定を使用しなければならない |
| FR-004-2 | イベント | セッションが作成された時、もしセッション固有の環境変数が指定されていれば、システムはプロジェクトデフォルトの環境変数にセッション固有の環境変数をマージしなければならない |

### FR-005: UI

| ID | パターン | 要件 |
|----|---------|------|
| FR-005-1 | 基本 | セッション作成フォームはCLIオプション設定用のUIを提供しなければならない |
| FR-005-2 | 基本 | セッション作成フォームはカスタム環境変数入力用のUIを提供しなければならない |
| FR-005-3 | 基本 | プロジェクト設定画面はデフォルトのCLIオプション・環境変数設定用のUIを提供しなければならない |

## 4. 非機能要件

| ID | カテゴリ | 要件 |
|----|---------|------|
| NFR-001 | セキュリティ | 環境変数のvalueはログに出力してはならない（keyのみ記録可） |
| NFR-002 | 互換性 | 既存のセッション（設定なし）は変更なしで動作し続けなければならない |
| NFR-003 | パフォーマンス | 設定のマージ処理はセッション起動時間に影響を与えてはならない（< 10ms） |

## 5. データモデル

### 設定の保存形式

CLIオプションとカスタム環境変数はJSON文字列としてDBに保存する。

```typescript
// CLIオプション
interface ClaudeCodeOptions {
  model?: string;                  // --model
  allowedTools?: string;           // --allowedTools
  permissionMode?: string;         // --permission-mode
  additionalFlags?: string;        // 追加フラグ（スペース区切り）
}

// カスタム環境変数
interface CustomEnvVars {
  [key: string]: string;           // key=value ペア
}
```

### マージ戦略

```
最終設定 = プロジェクトデフォルト + セッション固有設定（セッションが優先）
```

- CLIオプション: セッション側で指定されたフィールドのみオーバーライド
- 環境変数: セッション側の環境変数がプロジェクトデフォルトにマージ（同一キーはセッション優先）
