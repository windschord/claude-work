# US-004: 共通PTYロジック抽出

## ユーザーストーリー

**私は** ClaudeWorkの開発者・メンテナーとして
**〜したい** HOST環境とDOCKER環境で共通のPTYロジックをbase-adapter.tsに抽出したい
**なぜなら** コード重複を防ぎ、両環境で同じバグ修正が自動的に適用されるようにするため

## 受入基準(EARS記法)

### 機能要件

- **REQ-004-001**: base-adapter.tsを作成する時、システムはPTY spawn共通処理(環境変数、TERM設定)を含まなければならない
- **REQ-004-002**: base-adapter.tsを作成する時、システムはcols/rows初期化ロジックを含まなければならない
- **REQ-004-003**: base-adapter.tsを作成する時、システムはデータハンドリング(ScrollbackBuffer統合)を含まなければならない
- **REQ-004-004**: base-adapter.tsを作成する時、システムはエラーハンドリングとクリーンアップ処理を含まなければならない
- **REQ-004-005**: HostAdapterとDockerAdapterの両方が、システムはbase-adapterの共通ロジックを利用しなければならない

### 検証要件

- **REQ-004-006**: 共通ロジック抽出後、システムはHOST環境とDOCKER環境の両方でPTYセッションを正常に作成できなければならない
- **REQ-004-007**: HostAdapterとDockerAdapterのコード行数が、システムは共通化前より30%以上削減されなければならない
- **REQ-004-008**: base-adapterのユニットテストが、システムは80%以上のコードカバレッジを達成しなければならない

## 技術要件

### base-adapter.tsの設計

```typescript
// base-adapter.ts の想定インターフェース
export abstract class BasePTYAdapter implements EnvironmentAdapter {
  // 共通ロジック
  protected spawnPTY(command: string, args: string[], options: SpawnOptions): IPty;
  protected setupDataHandlers(pty: IPty, sessionId: string): void;
  protected setupErrorHandlers(pty: IPty, sessionId: string): void;
  protected cleanupPTY(pty: IPty): Promise<void>;

  // 環境固有の実装は継承クラスで定義
  abstract createSession(options: SessionOptions): Promise<SessionInfo>;
  abstract destroySession(sessionId: string): Promise<void>;
}
```

### 抽出する共通機能

1. **PTY spawn共通処理**
   - 環境変数設定(TERM, COLORTERM)
   - PTYオプション設定(name: 'xterm-256color')

2. **cols/rows初期化ロジック**
   - デフォルト値処理(80x24)
   - options.cols/rowsの検証と適用

3. **データハンドリング**
   - ScrollbackBufferへの書き込み
   - ConnectionManagerへのブロードキャスト
   - EventEmitterイベント発火

4. **エラーハンドリング**
   - PTYエラーのログ記録
   - セッション状態の更新
   - クリーンアップ処理

5. **クリーンアップ処理**
   - ptyProcess.kill()
   - ScrollbackBufferのクリア
   - イベントリスナーの削除

## 関連ストーリー

- [US-001](US-001.md) @US-001.md: Circular delegation解消 - HostAdapterがbase-adapterを使用
- [US-002](US-002.md) @US-002.md: destroySession無限再帰解消 - base-adapterのクリーンアップ処理を使用
- [US-003](US-003.md) @US-003.md: cols/rows伝播の欠落解消 - base-adapterのcols/rows初期化を使用

## 関連ドキュメント

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則 A1: 各レイヤーは1つの責務のみを持つ
  - 原則 A3: レイヤー間のインターフェースは明示的に定義する

## 備考

- risk-evaluatorの推奨: 共通ヘルパー抽出によりコード重複を防ぐ
- 両環境で同じバグ修正が適用される利点
- テストカバレッジ向上: base-adapterの共通テストスイートを作成
- 将来のSSH環境追加時にも、base-adapterを再利用可能
- 抽象基底クラスパターンを使用することで、環境固有の実装を強制
