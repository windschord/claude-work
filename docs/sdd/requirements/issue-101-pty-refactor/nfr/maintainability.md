# 保守性要件

> 非機能要件カテゴリ: 保守性

## 概要

PTYアーキテクチャリファクタリングにより、コードの保守性を向上させ、将来の変更を容易にする。過去11個のPRで同じ問題が再発する"whack-a-mole"パターンを防止し、持続可能なコードベースを実現する。

## 要件一覧

### NFR-MNT-001: コード重複の削減

**EARS記法**: システムはHOST環境とDOCKER環境のPTYロジックで、コード重複率30%以下を維持しなければならない

**測定基準**:
- 指標: 重複コード行数 / 総コード行数
- 目標値: 30%以下
- 測定方法: jscpdまたは類似のコード重複検出ツールを使用

**関連する機能要件**: REQ-004-001, REQ-004-002, REQ-004-003

**優先度**: 高

**検証方法**:
- [ ] base-adapter.ts作成後、jscpdでコード重複率を測定
- [ ] HostAdapterとDockerAdapterの共通ロジックが全てbase-adapterに移動されたことを確認
- [ ] 環境固有のロジック以外に重複コードが残っていないことを確認

---

### NFR-MNT-002: テストカバレッジの向上

**EARS記法**: PTYアーキテクチャリファクタリング完了後、システムはbase-adapter.ts、host-adapter.ts、docker-adapter.tsのテストカバレッジ80%以上を維持しなければならない

**測定基準**:
- 指標: カバレッジ率(行カバレッジ、分岐カバレッジ)
- 目標値: 80%以上
- 測定方法: Vitestのカバレッジレポート(c8/istanbul)

**関連する機能要件**: REQ-004-008

**優先度**: 高

**検証方法**:
- [ ] `npm test -- --coverage`でカバレッジレポートを生成
- [ ] base-adapter.tsのユニットテストを作成
- [ ] HostAdapterとDockerAdapterの統合テストを作成
- [ ] エッジケース(エラーハンドリング、クリーンアップ)をテスト

---

### NFR-MNT-003: 設計原則への準拠

**EARS記法**: システムはdocs/design-principles-pty-session-management.mdに定義された設計原則(A1-A3, C1-C3, E1-E4, L1-L5)に準拠しなければならない

**測定基準**:
- 指標: 設計原則チェックリストの準拠率
- 目標値: 100%
- 測定方法: コードレビューによる手動チェック

**関連する機能要件**: REQ-001-001, REQ-001-004, REQ-007

**優先度**: 高

**検証方法**:
- [ ] 原則A1: 各レイヤーの責務が単一であることを確認
- [ ] 原則A2: 依存が上位から下位への一方向であることを確認
- [ ] 原則A3: レイヤー間のインターフェースが明示的に定義されていることを確認
- [ ] 原則C1: 呼び出しチェーンが文書化されていることを確認
- [ ] 原則C2: レイヤー境界が明確であることを確認
- [ ] 原則C3: EventEmitterによる逆方向通信が適切に実装されていることを確認

---

### NFR-MNT-004: ドキュメント整合性

**EARS記法**: コード変更時、システムは関連ドキュメント(CLAUDE.md、API.md、設計原則)を同時に更新しなければならない

**測定基準**:
- 指標: コードとドキュメントの整合性
- 目標値: 不整合0件
- 測定方法: PRレビュー時のチェックリスト

**関連する機能要件**: 全ての機能要件

**優先度**: 中

**検証方法**:
- [ ] CLAUDE.mdのアーキテクチャ図を更新
- [ ] API.mdのアダプターインターフェース説明を更新
- [ ] 設計原則ドキュメントに今回の変更を反映
- [ ] README.mdのプロジェクト構造を更新
