# 要件定義: Prisma から Drizzle ORM への移行

## 情報の明確性チェック

### ユーザーから明示された情報

- [x] 技術スタック: Drizzle ORM + better-sqlite3
- [x] アーキテクチャパターン: 既存パターンを維持（シングルトン）
- [x] フレームワーク: Next.js 15 App Router（既存）
- [x] データベース: SQLite（継続使用）
- [x] 移行方式: 完全置換（Prismaを完全削除）
- [x] データ移行: 不要（リセット可の確認済み）
- [x] クエリスタイル: Relational queries（Prismaに近い宣言的API）
- [x] 既存スキーマ: 6つのモデル（Project, Session, Message, Prompt, RunScript, ExecutionEnvironment）

### 不明/要確認の情報

なし（すべて確認済み）

---

## 概要

ClaudeWorkプロジェクトにおいて、現在使用しているPrisma ORMをDrizzle ORMに完全置換する。
SQLiteデータベースは継続使用し、既存のスキーマ構造を維持しながら、より軽量でタイプセーフなORMへの移行を実現する。

## ユーザーストーリー

### ストーリー1: ORM移行による開発体験の向上

**私は** 開発者として
**〜したい** Drizzle ORMを使用してデータベース操作を行いたい
**なぜなら** より軽量で、SQLに近い直感的なAPIと、優れた型推論を活用できるから

#### 受入基準（EARS記法）

- **REQ-001**: システムはDrizzle ORMを使用してSQLiteデータベースに接続しなければならない
- **REQ-002**: システムは既存の6つのモデル（Project, Session, Message, Prompt, RunScript, ExecutionEnvironment）をDrizzleスキーマとして定義しなければならない
- **REQ-003**: システムはRelational queriesスタイル（findMany, findFirst等）でクエリを実行できなければならない
- **REQ-004**: アプリケーション起動時、開発/テスト環境ではシステムは自動的にデータベーススキーマを同期しなければならない（本番環境では明示的なマイグレーション手順で同期する）
- **REQ-005**: すべてのAPIエンドポイントがDrizzle ORMを使用してデータベース操作を行わなければならない

### ストーリー2: 型安全性の維持

**私は** 開発者として
**〜したい** Prismaと同等以上の型安全性を維持したい
**なぜなら** コンパイル時にエラーを検出し、ランタイムエラーを防ぎたいから

#### 受入基準（EARS記法）

- **REQ-006**: システムはDrizzleのスキーマから型を自動生成し、エクスポートしなければならない
- **REQ-007**: リレーション（Project-Session, Session-Message等）が型レベルで定義されなければならない
- **REQ-008**: クエリ結果が適切な型で返却されなければならない

### ストーリー3: 既存機能の完全互換

**私は** ユーザーとして
**〜したい** ORM移行後も既存機能がすべて動作することを保証したい
**なぜなら** サービス中断なく移行を完了したいから

#### 受入基準（EARS記法）

- **REQ-009**: すべての既存テストがDrizzle移行後もパスしなければならない
- **REQ-010**: Prismaに依存するコードがすべてDrizzleに置き換えられなければならない
- **REQ-011**: prisma/ディレクトリとPrisma関連の依存関係が完全に削除されなければならない

## 非機能要件

### 性能要件

- **NFR-001**: クエリパフォーマンスはPrisma使用時と同等以上でなければならない

### 保守性要件

- **NFR-002**: スキーマ定義は単一のファイルで管理されなければならない
- **NFR-003**: マイグレーション機能（drizzle-kit）が利用可能でなければならない

### 開発体験要件

- **NFR-004**: Drizzle Studioでデータベースを視覚的に確認できなければならない

## 依存関係

- drizzle-orm: Drizzle ORM本体
- drizzle-kit: マイグレーション・スキーマ管理ツール
- better-sqlite3: SQLiteドライバー（既存）
- @types/better-sqlite3: 型定義（既存）

## 技術的制約

- **SQLite**: データベースエンジンはSQLiteを継続使用
- **Next.js 15 App Router**: 既存のフレームワーク構成を維持
- **better-sqlite3**: SQLiteドライバーは既存のものを使用
- **TypeScript**: 型安全性を維持

## スコープ外

- データベースエンジンの変更（SQLiteを継続使用）
- 既存データの移行（リセット可の確認済み）
- APIレスポンス形式の変更
- 新規機能の追加

## 成功指標

1. **完全移行**: Prisma関連のコードとファイルが完全に削除されている
2. **テスト通過**: 全ての既存テストがDrizzle移行後もパスする
3. **性能維持**: クエリパフォーマンスがPrisma使用時と同等以上
4. **型安全性**: TypeScriptの型推論が正しく機能し、コンパイルエラーがない
5. **開発体験向上**: Drizzle Studioで視覚的なデータベース確認が可能

## リスク管理

### リスク1: クエリ変換の漏れ

**影響度**: 高
**発生確率**: 中
**軽減策**:
- `grep -r "prisma" src/` で残存箇所を確認
- TypeScriptコンパイルエラーで検出
- 全テストの実行で動作確認

### リスク2: リレーションクエリの動作差異

**影響度**: 中
**発生確率**: 中
**軽減策**:
- 既存テストでカバー
- 手動での動作確認
- Drizzle Relational queriesの十分な理解

### リスク3: エラーハンドリングの変更

**影響度**: 中
**発生確率**: 低
**軽減策**:
- Prismaエラーコード（P2002等）をDrizzleエラーメッセージに変換
- エラーハンドリングのテストを追加
- 既存のバリデーションロジックを維持

### リスク4: パフォーマンスの劣化

**影響度**: 中
**発生確率**: 低
**軽減策**:
- better-sqlite3のWALモード有効化
- インデックスの維持
- 必要に応じてクエリの最適化

## 用語集

- **ORM (Object-Relational Mapping)**: オブジェクト指向プログラミング言語とリレーショナルデータベース間のデータ変換を行うプログラミング技法
- **Prisma**: Node.js/TypeScript用の次世代ORM
- **Drizzle ORM**: 軽量でタイプセーフなTypeScript ORM
- **Relational queries**: リレーションを含むクエリを宣言的に記述できるDrizzleのクエリAPI
- **drizzle-kit**: Drizzle ORMのマイグレーション・スキーマ管理ツール
- **better-sqlite3**: Node.js用の高速なSQLite3バインディング
- **WALモード (Write-Ahead Logging)**: SQLiteのパフォーマンスを向上させる機能
- **スキーマ同期**: データベーススキーマを定義ファイルと同期する操作
