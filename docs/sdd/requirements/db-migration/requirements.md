# 要件定義書: SQLite DBマイグレーション機能

## 1. 概要

### 1.1 目的

npx経由でデプロイされるClaudeWorkにおいて、スキーマ変更時に既存DBを自動的にマイグレーションする機能を実装する。

### 1.2 背景

- 現状: `CREATE TABLE IF NOT EXISTS` のみで、既存テーブルへのカラム追加は行われない
- 問題: スキーマに新カラムを追加した際、既存DBにカラムが追加されず `SQLITE_ERROR` が発生
- 解決策: SQLite `PRAGMA user_version` を使ったコード内マイグレーション

### 1.3 ユーザーストーリー

> 開発者として、スキーマを変更した際に、既存ユーザーのDBが自動的にマイグレーションされることで、手動介入なしにアプリが正常に動作してほしい。

## 2. 機能要件

### REQ-001: バージョン管理

> アプリケーション起動時、システムは `PRAGMA user_version` を使用してDBのスキーマバージョンを管理しなければならない

- DBファイル内にバージョン番号を永続化
- コード内で期待バージョン（`CURRENT_DB_VERSION`）を定義

### REQ-002: バージョン比較

> アプリケーション起動時、システムはDBのバージョンとコードの期待バージョンを比較しなければならない

- DBバージョン >= 期待バージョン → マイグレーション不要
- DBバージョン < 期待バージョン → マイグレーション実行

### REQ-003: 段階的マイグレーション

> マイグレーション実行時、システムは各バージョン間の差分を順番に適用しなければならない

- バージョン 0 → 1: 初期テーブル作成
- バージョン 1 → 2: カラム追加（claude_code_options, custom_env_vars）
- 各バージョンのマイグレーションは独立して定義

### REQ-004: トランザクション保護

> マイグレーション実行時、システムはトランザクション内で全ての変更を実行しなければならない

- マイグレーション途中でエラーが発生した場合、ロールバック
- 部分的に適用された状態を防止

### REQ-005: バージョン更新

> マイグレーション成功時、システムは `PRAGMA user_version` を新しいバージョンに更新しなければならない

- トランザクション内でバージョン番号を更新
- 次回起動時に同じマイグレーションが再実行されないことを保証

### REQ-006: 冪等性

> システムは何度実行しても同じ結果になるマイグレーションを提供しなければならない

- 既に存在するカラムの追加はエラーハンドリング
- バージョンチェックにより重複実行を防止

## 3. 非機能要件

### NFR-001: npx互換性

> システムは `npx github:windschord/claude-work` での実行環境で正常に動作しなければならない

- 外部ファイル（.sqlファイル等）への依存なし
- コード内にマイグレーションロジックを含める

### NFR-002: パフォーマンス

> システムはマイグレーション不要時に起動遅延を発生させてはならない

- バージョンチェックのみ（PRAGMA user_version の読み取り）
- SQLiteの特性により低コスト

### NFR-003: 後方互換性

> システムは既存のDBファイル（user_version = 0）を正しくマイグレーションしなければならない

- 初期状態（バージョン0）からの全マイグレーションを順次適用

### NFR-004: ログ出力

> システムはマイグレーション実行時にログを出力しなければならない

- 現在のDBバージョンと期待バージョンを表示
- 各マイグレーションステップの実行状況を表示

## 4. 制約事項

### 4.1 技術的制約

- SQLite better-sqlite3 ライブラリを使用
- Drizzle ORM のスキーマ定義と整合性を維持
- cli-utils.ts 内に実装

### 4.2 運用制約

- マイグレーションはアプリ起動時に自動実行
- 手動でのマイグレーション実行は不要

## 5. 受入基準

| 要件ID | 受入基準 |
|--------|----------|
| REQ-001 | `PRAGMA user_version` でバージョン番号を取得・設定できる |
| REQ-002 | バージョン比較ロジックが正しく動作する |
| REQ-003 | 各バージョン間のマイグレーションが順次実行される |
| REQ-004 | エラー時にロールバックされる |
| REQ-005 | マイグレーション後にバージョン番号が更新される |
| REQ-006 | 複数回実行しても問題が発生しない |
| NFR-001 | npx経由で正常に動作する |
| NFR-002 | マイグレーション不要時の起動が高速 |
| NFR-003 | 既存DBからのマイグレーションが成功する |
| NFR-004 | マイグレーションログが出力される |
