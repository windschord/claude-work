# 要件定義書: Claude Code連携・プロセス管理

## 概要

Claude Codeとの対話、プロセス管理、セッション復帰機能の要件を定義します。

## 関連ストーリー

- ストーリー4: Claude Codeとの対話
- ストーリー15: 既存セッションのClaude Codeプロセス再起動
- ストーリー17: プロセスライフサイクル管理
- ストーリー19: Claudeセッション復帰機能

---

## ストーリー4: Claude Codeとの対話

**私は** 開発者として
**〜したい** ブラウザからClaude Codeに追加の指示を送信
**なぜなら** 対話的に開発を進めたいから

### 受入基準（EARS記法）

- **REQ-021**: セッションが実行中の間、システムはユーザーからの入力をClaude Codeプロセスに送信できなければならない
- **REQ-022**: Claude Codeが応答を出力した時、システムは500ms以内にブラウザに表示しなければならない
- **REQ-023**: Claude Codeの出力において、システムはマークダウン形式でレンダリングし、コードブロックにはシンタックスハイライトを適用しなければならない
- **REQ-024**: Claude Codeがサブエージェントタスクを実行した時、システムはサブエージェントの出力を折りたたみ可能なセクションで表示しなければならない
- **REQ-025**: Claude Codeが権限確認を要求した時、システムはユーザーに承認/拒否のUIを表示しなければならない
- **REQ-026**: ユーザーが承認/拒否を選択した時、システムはその選択をClaude Codeプロセスに送信しなければならない
- **REQ-027**: セッションが終了した時、システムはセッションステータスを「完了」に更新しなければならない
- **REQ-028**: Claude Codeプロセスが異常終了した時、システムはセッションステータスを「エラー」に更新し、エラー内容を表示しなければならない
- **REQ-109**: Claude Codeから`user`タイプのstream-jsonメッセージを受信した時、システムはそれをチャット画面に表示してはならない
- **REQ-110**: Claude Codeから認識されないタイプのstream-jsonメッセージを受信した時、システムはJSON文字列をチャット画面に表示してはならない
- **REQ-111**: 認識されないメッセージタイプはデバッグログに記録しなければならない（トラブルシューティングのため）

---

## ストーリー15: 既存セッションのClaude Codeプロセス再起動

**私は** 開発者として
**〜したい** 既存セッションでClaude Codeプロセスが停止している場合に再起動できるようにしたい
**なぜなら** サーバー再起動後も既存セッションで作業を継続したいから

### 背景

- Claude Codeプロセスはセッション作成時のみ起動される
- サーバー再起動後、既存セッションにアクセスしてもプロセスは自動的には再起動されない
- プロセスがないセッションにメッセージを送信しても何も起きない（エラーも出ない）

### 受入基準（EARS記法）

- **REQ-077**: セッション詳細ページを表示した時、システムはClaude Codeプロセスの状態（実行中/停止）をUIで表示しなければならない
- **REQ-078**: Claude Codeプロセスが停止している場合、システムは「プロセス再起動」ボタンを表示しなければならない
- **REQ-079**: ユーザーが「プロセス再起動」ボタンをクリックした時、システムはそのセッションのworktree_pathを使用してClaude Codeプロセスを起動しなければならない
- **REQ-080**: プロセスが正常に起動した時、システムはプロセス状態表示を「実行中」に更新しなければならない
- **REQ-081**: プロセスの起動に失敗した場合、システムはエラーメッセージをユーザーに表示しなければならない
- **REQ-082**: メッセージ送信時にプロセスが停止している場合、システムはエラーメッセージを表示し、プロセス再起動を促さなければならない
- **REQ-083**: セッション詳細ページでWebSocket接続が確立された時、システムはプロセス状態を自動的に確認しなければならない

---

## ストーリー17: プロセスライフサイクル管理

**私は** システム管理者として
**〜したい** Claude Codeプロセスが自動的に停止・再開されるようにしたい
**なぜなら** サーバーリソースを効率的に管理し、孤児プロセスの発生を防ぎたいから

### 背景

- サーバー停止時にClaude Codeプロセスの残存問題が発生している
- 長時間使用されていないプロセスがリソースを消費し続ける
- セッション復帰時にプロセスを手動で再起動する必要がある

### 受入基準（EARS記法）

#### サーバー停止時の自動クリーンアップ

- **REQ-094**: サーバーがSIGTERM/SIGINTシグナルを受信した時、システムは管理しているすべてのClaude Codeプロセスを終了しなければならない
- **REQ-095**: サーバーシャットダウン時、システムはプロセス終了を最大10秒間待機し、タイムアウトした場合はSIGKILLで強制終了しなければならない
- **REQ-096**: サーバーシャットダウン時、システムは終了したプロセス数をログに記録しなければならない

#### アイドルタイムアウトによる自動停止

- **REQ-097**: システムはPROCESS_IDLE_TIMEOUT_MINUTES環境変数でアイドルタイムアウト時間（分）を設定できなければならない（デフォルト: 30分）
- **REQ-098**: セッションが最後のアクティビティからPROCESS_IDLE_TIMEOUT_MINUTES分経過した時、システムはそのClaude Codeプロセスを自動停止しなければならない
- **REQ-099**: アクティビティとは、メッセージ送信、WebSocket接続中のハートビート、またはプロセス出力の受信を指す
- **REQ-100**: プロセスが自動停止された時、システムはセッションのステータスを「一時停止」に更新しなければならない
- **REQ-101**: プロセスが自動停止される前に、システムはWebSocket経由で接続中のクライアントに警告通知を送信しなければならない

#### セッション復帰時の自動再開

- **REQ-102**: ユーザーが一時停止中のセッションにアクセスした時、システムは「セッションを再開」ボタンを表示しなければならない
- **REQ-103**: ユーザーが「セッションを再開」をクリックした時、システムはClaude Codeの--resumeオプションを使用してプロセスを再起動しなければならない
- **REQ-104**: --resumeオプションでの再起動時、システムはworktree_pathとsession_idを使用してClaude Codeの会話を復元しなければならない
- **REQ-105**: セッション再開が成功した時、システムはセッションのステータスを「実行中」に更新しなければならない
- **REQ-106**: セッション再開に失敗した場合、システムはエラーメッセージを表示し、通常の再起動オプションを提示しなければならない

#### 状態管理

- **REQ-107**: システムは各セッションの最終アクティビティ時刻をメモリ上で管理しなければならない
- **REQ-108**: システムは1分ごとにアイドルチェックを実行し、タイムアウトしたプロセスを停止しなければならない

---

## ストーリー19: Claudeセッション復帰機能

**私は** 開発者として
**〜したい** セッションを再開したときに以前のClaudeの会話状態に復帰できること
**なぜなら** ブラウザを閉じたり、セッションを一時停止しても、続きから作業を再開したいから

### 背景

- Claude CLI には `--resume <session-id>` オプションがある
- セッションDBには `resume_session_id` フィールドが存在する
- 現状、セッション再開時にこのオプションが使用されていない

### 受入基準（EARS記法）

- **REQ-119**: セッションが再開された時、セッションに `resume_session_id` が存在する場合、システムはClaude CLIの `--resume` オプションを使用して以前の会話を復帰しなければならない
- **REQ-120**: セッションの初回起動時、システムは新規セッションとしてClaude CLIを起動しなければならない
- **REQ-121**: Claude CLIが正常に起動した時、システムはセッションの `resume_session_id` をClaude CLIのセッションIDで更新しなければならない
- **REQ-122**: Claude CLIのセッションIDは、システムはClaude CLIの出力から抽出しなければならない

---

## 非機能要件

### パフォーマンス

- **NFR-001**: システムはClaude Codeの出力を500ms以内にブラウザに表示しなければならない

### 可用性

- **NFR-007**: システムはサーバー再起動後も既存のworktree情報を復元できなければならない
- **NFR-008**: システムはClaude Codeプロセスがクラッシュした場合、セッションステータスを「エラー」に更新しなければならない

---

## 用語定義

| 用語 | 定義 |
|------|------|
| アイドルタイムアウト | 最後のアクティビティから一定時間経過後にプロセスを自動停止する機能 |
| アクティビティ | メッセージ送信、WebSocket接続中のハートビート、プロセス出力の受信 |
| サブエージェント | Claude Codeが内部で起動する補助的なAIタスク |
| PTY | 疑似端末（Pseudo Terminal）、ターミナルエミュレータとシェル間の通信を提供 |
