# US-004: 環境管理UI強化

## ユーザーストーリー

**私は** ClaudeWorkユーザーとして
**〜したい** 環境管理画面でデフォルト環境を設定・確認
**なぜなら** 自分の好みに応じてDocker/HOSTを選択したい

## 受入基準（EARS記法）

### 環境管理画面

- **REQ-042**: 環境管理画面において、システムは各環境に「デフォルト」ラベルを表示しなければならない
- **REQ-043**: ユーザーが環境の「デフォルトに設定」ボタンをクリックした時、システムはその環境をデフォルトに設定しなければならない
- **REQ-044**: デフォルト環境が変更された時、システムは「デフォルト環境を変更しました」と通知しなければならない
- **REQ-045**: システムは常に1つの環境がデフォルトであることを保証しなければならない

### プロジェクト作成フォーム

- **REQ-046**: プロジェクト作成フォームにおいて、システムはデフォルト環境を事前選択しなければならない
- **REQ-047**: ユーザーがプロジェクトごとのデフォルト環境を設定した時、システムはプロジェクトの`default_environment_id`に保存しなければならない
- **REQ-048**: もしプロジェクトにデフォルト環境が設定されている場合、システムはセッション作成時にその環境を優先しなければならない

### リモートプロジェクトの表示

- **REQ-049**: プロジェクト一覧において、システムはリモートリポジトリから登録されたプロジェクトに「Remote」バッジを表示しなければならない
- **REQ-050**: リモートプロジェクトのカードにおいて、システムは「更新」ボタンを表示しなければならない
- **REQ-051**: ユーザーが「更新」ボタンをクリックした時、システムはDocker内でgit pullを実行しなければならない
- **REQ-052**: 更新処理中、システムはローディング表示をしなければならない
- **REQ-053**: 更新完了時、システムは「最新の状態に更新しました」と通知しなければならない

### セッション作成フォーム

- **REQ-054**: セッション作成フォームにおいて、システムは環境選択ドロップダウンを表示しなければならない
- **REQ-055**: 各環境について、システムはタイプバッジ（HOST/DOCKER/SSH）を表示しなければならない
- **REQ-056**: Docker環境において、システムは緑色のバッジで「DOCKER」と表示しなければならない
- **REQ-057**: HOST環境において、システムは灰色のバッジで「HOST」と表示しなければならない

## 技術的背景

### データベーススキーマ変更

```prisma
model Project {
  id                     String    @id @default(uuid())
  name                   String
  path                   String    @unique
  remote_url             String?
  default_environment_id String?   // 新規追加
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt
  sessions               Session[]
  scripts                RunScript[]
}

model ExecutionEnvironment {
  id          String  @id @default(uuid())
  name        String
  type        String  // HOST, DOCKER, SSH
  is_default  Boolean @default(false) // 新規追加
  config      Json
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  sessions    Session[]
}
```

### 変更が必要な箇所

1. **環境管理画面** (`src/app/settings/environments/page.tsx`):
   - デフォルト環境の表示とトグル機能

2. **プロジェクト作成フォーム** (`src/components/projects/AddProjectModal.tsx`):
   - デフォルト環境の事前選択
   - プロジェクトごとのデフォルト環境設定（オプション）

3. **プロジェクトカード** (`src/components/projects/ProjectCard.tsx`):
   - リモートバッジの表示
   - 更新ボタンの追加

4. **セッション作成フォーム** (`src/components/sessions/CreateSessionModal.tsx`):
   - 環境選択ドロップダウンのデフォルト値設定
   - 環境タイプバッジの表示

## テストシナリオ

### シナリオ1: デフォルト環境の設定

1. 環境管理画面を開く
2. Docker環境の「デフォルトに設定」ボタンをクリック
3. Docker環境に「デフォルト」ラベルが表示されることを確認
4. セッション作成フォームを開く
5. Docker環境が事前選択されていることを確認

### シナリオ2: リモートプロジェクトの表示

1. リモートリポジトリをプロジェクト登録
2. プロジェクト一覧を確認
3. 「Remote」バッジが表示されることを確認
4. 「更新」ボタンが表示されることを確認

### シナリオ3: プロジェクト更新

1. リモートプロジェクトの「更新」ボタンをクリック
2. ローディング表示がされることを確認
3. 更新完了後、成功通知が表示されることを確認

### シナリオ4: プロジェクトごとのデフォルト環境

1. プロジェクト作成時にデフォルト環境を設定
2. そのプロジェクトでセッション作成フォームを開く
3. プロジェクトのデフォルト環境が選択されていることを確認

## 非機能要件

- UI操作は即座に反応すること（100ms以内）
- バッジの色は既存のデザインシステムに準拠すること
- 環境選択ドロップダウンは最大20環境まで表示できること

## 依存関係

- ExecutionEnvironment（環境管理）
- EnvironmentService（CRUD操作）
- US-002（リモートプロジェクトの表示）

## 関連ストーリー

- US-001: デフォルト環境のDocker化（デフォルト環境の概念）
- US-002: リモートリポジトリのクローン機能（リモートバッジ、更新ボタン）

## ステータス

- [x] 要件定義完了
- [ ] 設計完了
- [ ] 実装完了
- [ ] テスト完了
- [ ] ドキュメント更新完了
