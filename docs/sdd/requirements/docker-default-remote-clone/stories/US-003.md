# US-003: Docker内でのGit操作

## ユーザーストーリー

**私は** システム管理者として
**〜したい** Docker環境内でGit操作（clone、pull、branch取得）を実行
**なぜなら** リモートリポジトリ機能を完全に隔離された環境で提供したい

## 受入基準（EARS記法）

### Git Clone

- **REQ-028**: DockerAdapter経由でGit cloneコマンドを実行する時、システムはSSH認証を使用できなければならない
- **REQ-029**: Clone処理中、システムは標準出力・標準エラーをキャプチャしなければならない
- **REQ-030**: Clone完了時、システムはクローンされたリポジトリのパスを返さなければならない
- **REQ-031**: もしCloneに失敗した場合、システムはエラー理由を含むメッセージを返さなければならない

### Git Pull

- **REQ-032**: リモートプロジェクトの更新時、システムはDocker内でgit pullを実行しなければならない
- **REQ-033**: Pull実行時、システムはfast-forward onlyモードを使用しなければならない
- **REQ-034**: もしローカル変更がある場合、システムはpullを中止してエラーを返さなければならない
- **REQ-035**: Pull完了時、システムは更新の有無を返さなければならない

### ブランチ取得

- **REQ-036**: ブランチ一覧取得時、システムはローカルブランチとリモート追跡ブランチの両方を返さなければならない
- **REQ-037**: 各ブランチについて、システムは名前、デフォルトフラグ、リモートフラグを返さなければならない
- **REQ-038**: デフォルトブランチの判定時、システムはgit symbolic-refを使用しなければならない

### SSH認証

- **REQ-039**: Docker内でSSH認証を使用する時、システムはホストの`~/.ssh`ディレクトリをマウントしなければならない
- **REQ-040**: SSH_AUTH_SOCK環境変数が設定されている場合、システムはSSHエージェントソケットもマウントしなければならない
- **REQ-041**: Git実行時、システムはGIT_TERMINAL_PROMPT=0を設定してインタラクティブプロンプトを無効化しなければならない

## 技術的背景

### DockerAdapterの拡張

既存のDockerAdapterに以下のメソッドを追加:

```typescript
interface GitOperations {
  // リポジトリをクローン
  gitClone(url: string, targetPath: string): Promise<GitResult>;

  // リポジトリを更新（fast-forward only）
  gitPull(repoPath: string): Promise<GitResult>;

  // ブランチ一覧を取得
  gitGetBranches(repoPath: string): Promise<Branch[]>;

  // デフォルトブランチを取得
  gitGetDefaultBranch(repoPath: string): Promise<string>;
}
```

### SSH設定のマウント

```typescript
// Dockerコンテナ起動時のボリュームマウント
volumes: [
  `${os.homedir()}/.ssh:/root/.ssh:ro`,  // SSH秘密鍵（読み取り専用）
  // SSH_AUTH_SOCKが設定されている場合
  `${process.env.SSH_AUTH_SOCK}:/ssh-agent:ro`
]

// 環境変数
environment: {
  SSH_AUTH_SOCK: '/ssh-agent',
  GIT_TERMINAL_PROMPT: '0'
}
```

## テストシナリオ

### シナリオ1: Docker内でのpublicリポジトリclone

1. DockerAdapterを初期化
2. `gitClone`メソッドでpublicリポジトリをclone
3. クローン成功を確認
4. Docker内のファイルシステムにリポジトリが存在することを確認

### シナリオ2: Docker内でのprivateリポジトリclone（SSH）

1. ホストにSSH鍵が設定されていることを確認
2. DockerAdapterを初期化
3. `gitClone`メソッドでprivateリポジトリをclone
4. SSH認証が成功することを確認
5. クローン成功を確認

### シナリオ3: Git pull（fast-forward）

1. Docker内でリポジトリをクローン
2. リモートに新しいコミットをpush
3. `gitPull`メソッドで更新
4. fast-forwardで更新されることを確認
5. 更新があったことを示すフラグが返されることを確認

### シナリオ4: Git pull（競合）

1. Docker内でリポジトリをクローン
2. ローカルで変更を加える（未コミット）
3. `gitPull`メソッドで更新を試行
4. エラーが返されることを確認
5. エラーメッセージに「ローカルに未コミットの変更があります」と含まれることを確認

### シナリオ5: ブランチ一覧取得

1. Docker内でリポジトリをクローン
2. `gitGetBranches`メソッドでブランチ一覧を取得
3. ローカルブランチとリモート追跡ブランチが返されることを確認
4. デフォルトブランチに`isDefault: true`が設定されることを確認

## 非機能要件

- Git操作は通常のCLI実行と同等の速度で動作すること
- SSH認証の設定はホストと共有され、追加設定不要であること
- エラーメッセージはGitの元のエラーを含むこと

## 依存関係

- DockerAdapter（既存実装）
- Docker Engine
- ホストのSSH設定（`~/.ssh`ディレクトリ）

## 関連ストーリー

- US-001: デフォルト環境のDocker化（Docker環境の基盤）
- US-002: リモートリポジトリのクローン機能（Git操作を使用）

## セキュリティ考慮事項

1. **SSH鍵の保護**: 読み取り専用でマウント
2. **コマンドインジェクション防止**: URLやパスを配列形式でspawnに渡す
3. **環境変数の制御**: GIT_TERMINAL_PROMPT=0で不要なプロンプト防止

## ステータス

- [x] 要件定義完了
- [ ] 設計完了
- [ ] 実装完了
- [ ] テスト完了
- [ ] ドキュメント更新完了
