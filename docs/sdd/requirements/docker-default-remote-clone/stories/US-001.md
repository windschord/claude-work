# US-001: デフォルト環境のDocker化

## ユーザーストーリー

**私は** ClaudeWorkの新規ユーザーとして
**〜したい** セッション作成時にDocker環境がデフォルトで選択される
**なぜなら** セキュアで分離された環境で安全にClaude Codeを実行したい

## 受入基準（EARS記法）

### 基本要件

- **REQ-001**: 初回プロジェクト作成時、システムはデフォルトのDocker環境を自動的に作成しなければならない
- **REQ-002**: Docker環境が存在しない場合、システムは「Docker環境を初期化しています...」というメッセージを表示しなければならない
- **REQ-003**: Docker環境の初期化が完了した時、システムはプロジェクト作成処理を継続しなければならない
- **REQ-004**: セッション作成フォームにおいて、システムはDocker環境をデフォルトで選択しなければならない
- **REQ-005**: もし複数の環境が存在する場合、システムはデフォルトDocker環境を優先的に選択しなければならない

### UI要件

- **REQ-006**: セッション作成フォームにおいて、システムは環境選択ドロップダウンを表示しなければならない
- **REQ-007**: 環境選択ドロップダウンにおいて、システムは各環境のタイプ（HOST/DOCKER/SSH）をバッジで表示しなければならない
- **REQ-008**: Docker環境が選択されている時、システムは緑色のバッジで「DOCKER」と表示しなければならない
- **REQ-009**: HOST環境が選択されている時、システムは灰色のバッジで「HOST」と表示しなければならない

### エラーハンドリング

- **REQ-010**: もしDocker環境の初期化に失敗した場合、システムはエラーメッセージを表示しなければならない
- **REQ-011**: もしDockerが利用できない場合、システムはHOST環境にフォールバックしなければならない
- **REQ-012**: フォールバック時、システムは「Dockerが利用できないため、HOST環境を使用します」と警告を表示しなければならない

## 技術的背景

### 現在の実装

- `EnvironmentService`がサーバー起動時にデフォルトHOST環境を作成
- セッション作成時は`environment_id`がnullの場合にHOST環境を使用
- UIには環境選択機能が存在するが、デフォルトはHOST

### 変更が必要な箇所

1. **サーバー初期化** (`server.ts`):
   - デフォルトDocker環境の作成
   - Docker利用可能性チェック

2. **UI** (`src/components/sessions/CreateSessionModal.tsx`):
   - 環境選択のデフォルト値をDocker環境に変更
   - 環境バッジの表示強化

3. **プロジェクト作成** (`src/app/api/projects/route.ts`):
   - 初回プロジェクト作成時のDocker環境初期化

## テストシナリオ

### シナリオ1: 初回起動時のDocker環境作成

1. ClaudeWorkを初回起動する
2. プロジェクトを作成する
3. システムがDocker環境を自動作成することを確認
4. セッション作成フォームでDocker環境がデフォルト選択されていることを確認

### シナリオ2: Docker利用不可時のフォールバック

1. Dockerを停止した状態でClaudeWorkを起動する
2. プロジェクトを作成する
3. HOST環境にフォールバックすることを確認
4. 警告メッセージが表示されることを確認

### シナリオ3: 既存ユーザーの継続利用

1. 既存のHOSTセッションが存在する状態で起動する
2. 既存セッションが正常に動作することを確認
3. 新規セッション作成時はDocker環境がデフォルトであることを確認

## 非機能要件

- 初期化時間は10秒以内に完了すること
- Docker利用不可時でもサービスが起動すること
- 既存HOSTセッションに影響を与えないこと

## 依存関係

- Docker Engineがインストールされていること（推奨）
- EnvironmentServiceの既存実装
- DockerAdapterの既存実装

## 関連ストーリー

- US-003: Docker内でのGit操作（Docker環境でのGit実行が必要）
- US-004: 環境管理UI強化（環境選択UIの改善）

## 備考

- HOSTモードは削除せず、選択可能な状態を維持する
- 既存のHOSTセッションは引き続き動作する
- ドキュメントにDockerのインストールガイドを追加する

## ステータス

- [x] 要件定義完了
- [ ] 設計完了
- [ ] 実装完了
- [ ] テスト完了
- [ ] ドキュメント更新完了
