# US-002: リモートリポジトリのクローン機能

## ユーザーストーリー

**私は** ClaudeWorkユーザーとして
**〜したい** GitHub/GitLabのリモートリポジトリURLを指定してプロジェクトを登録
**なぜなら** ローカルに事前クローンする手間を省き、素早くプロジェクト作業を開始したい

## 受入基準（EARS記法）

### プロジェクト登録

- **REQ-013**: ユーザーがプロジェクト追加モーダルで「リモート」タブを選択した時、システムはリモートリポジトリURL入力フォームを表示しなければならない
- **REQ-014**: ユーザーがリモートリポジトリURLを入力して登録ボタンをクリックした時、システムはDocker内でリポジトリをクローンしなければならない
- **REQ-015**: クローン処理中、システムは進捗状況をローディング表示でユーザーに示しなければならない
- **REQ-016**: クローン完了後、システムはクローンしたリポジトリをプロジェクトとして自動的に登録しなければならない
- **REQ-017**: もしクローンに失敗した場合、システムはエラーメッセージを表示しなければならない

### URL検証

- **REQ-018**: ユーザーがURL入力フィールドにフォーカスを外した時、システムはURLの形式を検証しなければならない
- **REQ-019**: もし無効なURL形式の場合、システムは「有効なGitリポジトリURLを入力してください」と表示しなければならない
- **REQ-020**: システムはSSH形式（`git@github.com:user/repo.git`）とHTTPS形式（`https://github.com/user/repo.git`）の両方を受け入れなければならない

### プロジェクト情報

- **REQ-021**: システムはリポジトリURLからプロジェクト名を自動抽出しなければならない
- **REQ-022**: もしユーザーがプロジェクト名を手動入力した場合、システムは入力された名前を優先しなければならない
- **REQ-023**: プロジェクト登録時、システムは`remote_url`フィールドにリポジトリURLを保存しなければならない

### リモートブランチ選択

- **REQ-024**: セッション作成時、システムはリモートリポジトリのブランチ一覧を取得しなければならない
- **REQ-025**: システムはローカルブランチとリモート追跡ブランチの両方を表示しなければならない
- **REQ-026**: もしデフォルトブランチが存在する場合、システムはそれを初期選択しなければならない
- **REQ-027**: ユーザーがブランチを選択した時、システムは選択されたブランチをベースにworktreeを作成しなければならない

## 技術的背景

### Docker内でのクローン実装

- Docker内でGitコマンドを実行
- ホストのSSH設定をDockerコンテナにマウント
- クローン先は`/workspace/data/repos/`（Docker内パス）

### データベーススキーマ変更

```prisma
model Project {
  id           String    @id @default(uuid())
  name         String
  path         String    @unique
  remote_url   String?   // 新規追加
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  sessions     Session[]
  scripts      RunScript[]
}
```

## テストシナリオ

### シナリオ1: publicリポジトリのクローン

1. プロジェクト追加モーダルで「リモート」タブを選択
2. publicリポジトリのHTTPS URLを入力（例: `https://github.com/octocat/Hello-World.git`）
3. 「登録」ボタンをクリック
4. クローン処理が実行され、完了することを確認
5. プロジェクト一覧に登録されることを確認

### シナリオ2: privateリポジトリのクローン（SSH）

1. プロジェクト追加モーダルで「リモート」タブを選択
2. privateリポジトリのSSH URLを入力（例: `git@github.com:user/private-repo.git`）
3. 「登録」ボタンをクリック
4. SSH認証を使用してクローンが成功することを確認
5. プロジェクト一覧に登録されることを確認

### シナリオ3: 無効なURLの入力

1. プロジェクト追加モーダルで「リモート」タブを選択
2. 無効なURL（例: `invalid-url`）を入力
3. エラーメッセージが表示されることを確認
4. 登録ボタンが無効化されることを確認

### シナリオ4: クローン失敗（認証エラー）

1. SSH鍵が設定されていない状態でprivateリポジトリのSSH URLを入力
2. 「登録」ボタンをクリック
3. 認証エラーが発生することを確認
4. エラーメッセージに原因が示されることを確認

### シナリオ5: ブランチ選択

1. リモートリポジトリをプロジェクト登録
2. セッション作成フォームを開く
3. ブランチ一覧が表示されることを確認
4. デフォルトブランチが選択されていることを確認
5. 別のブランチを選択してセッション作成
6. 選択したブランチでworktreeが作成されることを確認

## 非機能要件

- クローン処理は大規模リポジトリ（1GB以上）でも動作すること
- ブランチ一覧の取得は5秒以内に完了すること
- SSH認証はシステムのSSH設定を利用すること（アプリ内でクレデンシャル保持なし）
- リモートURLはGit URL形式のみ許可すること

## 依存関係

- Docker環境（US-001: デフォルト環境のDocker化）
- DockerAdapterでのGit実行機能（US-003: Docker内でのGit操作）
- Prismaスキーマ変更（`remote_url`フィールド追加）

## 関連ストーリー

- US-003: Docker内でのGit操作（クローン実行に必要）
- US-004: 環境管理UI強化（リモートプロジェクトの視覚的区別）

## セキュリティ考慮事項

1. **URL検証**: Git URL形式（SSH/HTTPS）のみ許可
2. **コマンドインジェクション防止**: URLやパスを配列形式でspawnに渡す
3. **SSH認証**: システムのSSH設定を利用、アプリケーション内でのクレデンシャル保持なし
4. **パストラバーサル防止**: クローン先ディレクトリの正規化とベースディレクトリチェック

## ステータス

- [x] 要件定義完了
- [ ] 設計完了
- [ ] 実装完了
- [ ] テスト完了
- [ ] ドキュメント更新完了
