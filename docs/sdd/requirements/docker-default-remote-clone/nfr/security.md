# 非機能要件: セキュリティ（Security）

## 概要

Docker環境での実行により環境分離を強化し、リモートリポジトリへのアクセスにおいてSSH認証を適切に管理する。

## 要件

### 環境分離

- **NFR-013**: Docker環境において、システムは各セッションを独立したコンテナで実行しなければならない
- **NFR-014**: Docker環境において、システムはホストファイルシステムへのアクセスを制限しなければならない
- **NFR-015**: Docker環境において、システムはネットワークアクセスを必要最小限に制限しなければならない

### SSH認証の管理

- **NFR-016**: SSH秘密鍵をDockerコンテナにマウントする時、システムは読み取り専用でマウントしなければならない
- **NFR-017**: システムはSSH秘密鍵をアプリケーション内に保存してはならない
- **NFR-018**: SSH認証に失敗した時、システムは認証エラーをログに記録しなければならない
- **NFR-019**: SSH認証に失敗した時、システムはユーザーにSSH設定の確認を促すメッセージを表示しなければならない

### URL検証とコマンドインジェクション対策

- **NFR-020**: リモートリポジトリURLを受け取った時、システムはGit URL形式（SSH/HTTPS）のみを許可しなければならない
- **NFR-021**: システムは任意のシェルコマンドを含むURLを拒否しなければならない
- **NFR-022**: Gitコマンド実行時、システムはURLやパスを配列形式でspawnに渡さなければならない（文字列結合を避ける）

### パストラバーサル対策

- **NFR-023**: クローン先ディレクトリを受け取った時、システムはパスを正規化しなければならない
- **NFR-024**: 正規化後、システムはパスがベースディレクトリ（`data/repos/`）配下にあることを検証しなければならない
- **NFR-025**: もしパストラバーサルが検出された場合、システムは403エラーを返さなければならない

### クレデンシャル管理

- **NFR-026**: システムはPersonal Access Token（PAT）を平文でデータベースに保存してはならない。保存する場合は暗号化して保存しなければならない
- **NFR-027**: システムはパスワードやトークンをログに出力してはならない
- **NFR-028**: システムはGIT_TERMINAL_PROMPT=0を設定してインタラクティブな認証プロンプトを無効化しなければならない

## テスト基準

- Docker環境がホストから隔離されていること
- SSH秘密鍵が読み取り専用でマウントされていること
- 無効なURLが拒否されること
- パストラバーサルが防止されること
- クレデンシャルがログに出力されないこと

## 関連ストーリー

- US-001: デフォルト環境のDocker化
- US-002: リモートリポジトリのクローン機能
- US-003: Docker内でのGit操作
