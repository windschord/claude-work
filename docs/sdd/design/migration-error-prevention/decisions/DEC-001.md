# 技術的決定事項 DEC-001: マイグレーションツールの選択

## ステータス

**承認済** (2026-02-17)

## コンテキスト

Systemd起動時のマイグレーションエラー（`SqliteError: no such column`）の根本原因は、スキーマ定義が2箇所（Drizzle Kit と CLI手動マイグレーション）に分散し、同期されていないことでした。

この問題を恒久的に解決するため、マイグレーション機構を一本化する必要があります。

## 検討した選択肢

### オプション1: drizzle-kit push（推奨）

**概要**: Drizzle Kitの`push`コマンドでスキーマを同期

**メリット**:
- ✅ 開発環境で既に使用中（実績あり）
- ✅ Single Source of Truth実現（`src/db/schema.ts`のみ）
- ✅ 非破壊的操作（カラム追加は自動、削除は確認プロンプト）
- ✅ マイグレーションファイル不要（SQLite単一ユーザーツール）
- ✅ 実装がシンプル（spawnSyncで呼び出すだけ）

**デメリット**:
- ❌ マイグレーション履歴が残らない
- ❌ 複雑なスキーマ変更（型変更等）は手動SQL必要
- ❌ ロールバック機能なし

**実装例**:
```typescript
spawnSync('npx', ['drizzle-kit', 'push'], { stdio: 'inherit' });
```

---

### オプション2: drizzle-kit migrate

**概要**: Drizzle Kitの`migrate`コマンドでマイグレーションファイルを実行

**メリット**:
- ✅ マイグレーション履歴が残る（SQLファイル管理）
- ✅ 複雑なスキーマ変更に対応可能
- ✅ ロールバック可能（手動実装が必要）

**デメリット**:
- ❌ マイグレーションファイルの生成・管理が必要
- ❌ 開発者の運用負荷が増加（generate → push → migrate）
- ❌ SQLite単一ユーザーツールでは履歴管理のメリットが薄い
- ❌ 今回のエラー原因（二重管理）を根本的に解決しない

**実装例**:
```typescript
spawnSync('npx', ['drizzle-kit', 'generate'], { stdio: 'inherit' });
spawnSync('npx', ['drizzle-kit', 'migrate'], { stdio: 'inherit' });
```

---

### オプション3: 手動マイグレーションの継続（現状維持）

**概要**: `CURRENT_DB_VERSION`ベースの手動マイグレーション機構を維持

**メリット**:
- ✅ 既存コードの変更不要
- ✅ きめ細かな制御が可能

**デメリット**:
- ❌ 今回のエラー原因を解決しない（二重管理が継続）
- ❌ 開発者の認知負荷が高い（バージョン番号管理、ALTER TABLE手動実装）
- ❌ Drizzle ORMの型安全性を活かせない
- ❌ 保守性が低い（新規メンバーのオンボーディング困難）

**実装例**:
```typescript
const CURRENT_DB_VERSION = 4;
if (dbVersion < 4) {
  db.exec('ALTER TABLE Session ADD COLUMN active_connections INTEGER');
}
```

---

### オプション4: Prisma Migrate

**概要**: Prismaのマイグレーション機構を使用

**メリット**:
- ✅ マイグレーション履歴管理が成熟
- ✅ ロールバック機能あり

**デメリット**:
- ❌ Drizzle ORM移行プロジェクト（進行中）と逆行
- ❌ 二重ORM管理になる
- ❌ Prismaのオーバーヘッドが大きい
- ❌ Drizzle移行の目的（軽量化、型安全性向上）を損なう

---

## 決定

**オプション1: drizzle-kit push を採用**

### 理由

1. **Single Source of Truthの実現**
   - `src/db/schema.ts`がスキーマ定義の唯一の正となる
   - 手動マイグレーション機構との二重管理を完全排除

2. **SQLite単一ユーザーツールに適合**
   - 本番環境は単一インスタンス（Systemd管理）
   - マイグレーション履歴管理は不要（複数環境の同期問題なし）
   - ロールバックが必要なシナリオは稀（本番データ移行なし）

3. **開発環境との一貫性**
   - 開発者は既に`npx drizzle-kit push`を使用している
   - 同じツールで統一することで運用負荷を削減

4. **非破壊的操作の安全性**
   - カラム追加は自動実行
   - カラム削除・変更は確認プロンプトで安全性確保
   - 今回のスコープ（カラム追加のみ）に完全適合

5. **実装のシンプルさ**
   - 既存の手動マイグレーション関数をすべて削除可能
   - CLI起動時に`spawnSync`で呼び出すだけ

### トレードオフ

**受け入れるデメリット**:
- マイグレーション履歴が残らない
  → GitコミットログとPRで代替可能
- 複雑なスキーマ変更は手動SQL必要
  → 今回のスコープ外（カラム追加のみ対応）
- ロールバック機能なし
  → SQLiteバックアップ（data/claudework.db.bak）で代替

**軽減策**:
- スキーマ変更時はPRレビューで慎重に確認
- 本番環境への適用前にステージング環境でテスト
- 重大な変更時はデータベースバックアップを作成

## 影響範囲

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/bin/cli-utils.ts` | `syncSchema()`を追加、手動マイグレーション関数を削除 |
| `src/bin/cli.ts` | `setupDatabase()`から`syncSchema()`を呼び出し |
| `src/bin/__tests__/cli-utils.test.ts` | `syncSchema()`のテストを追加 |

### 削除対象

- `CURRENT_DB_VERSION`定数
- `migrateDatabase()`関数
- `createInitialTables()`関数
- `addClaudeCodeOptionsColumns()`関数
- `createGitHubPATTable()`関数
- `safeAddColumn()`ヘルパー関数

### 新規追加

- `syncSchema(databaseUrl: string)`関数

## 代替案の却下理由

| オプション | 却下理由 |
|-----------|---------|
| drizzle-kit migrate | マイグレーションファイル管理の運用負荷が不要に高い |
| 手動マイグレーション継続 | 今回のエラー原因を解決しない |
| Prisma Migrate | Drizzle ORM移行プロジェクトと逆行 |

## 参照

- [要件定義 US-001](../../../requirements/migration-error-prevention/stories/US-001.md) @../../../requirements/migration-error-prevention/stories/US-001.md
- [スキーマ同期コンポーネント](../components/schema-sync.md) @../components/schema-sync.md
- [統合レポート](../../../../migration-error-fix.md) @../../../../migration-error-fix.md

## 承認者

- @tsk (プロジェクトオーナー)

## 変更履歴

- 2026-02-17: 初版作成、承認
