# æŠ€è¡“çš„æ±ºå®šäº‹é … DEC-002: èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…æ–¹é‡

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

**æ‰¿èªæ¸ˆ** (2026-02-17)

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

ã‚¹ã‚­ãƒ¼ãƒåŒæœŸï¼ˆ`drizzle-kit push`ï¼‰ã‚’è‡ªå‹•åŒ–ã—ã¦ã‚‚ã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§ã‚¹ã‚­ãƒ¼ãƒä¸ä¸€è‡´ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

1. **æ‰‹å‹•ã§ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†
2. **åŒæœŸå¤±æ•—**: `drizzle-kit push`ãŒé€”ä¸­ã§å¤±æ•—
3. **å¤ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ãŸå ´åˆ

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## æ¤œè¨ã—ãŸé¸æŠè‚¢

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: server.tsçµ±åˆï¼ˆæ¨å¥¨ï¼‰

**æ¦‚è¦**: `server.ts`ã®HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‰ã«ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã‚’å®Ÿè¡Œ

**å®Ÿè£…ä½ç½®**:
```typescript
// server.ts
async function startServer() {
  console.log('ğŸ” ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­...');

  const validationResult = validateSchemaIntegrity(db.$client);
  if (!validationResult.valid) {
    console.error(formatValidationError(validationResult));
    process.exit(1);
  }

  // HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  const server = app.listen(port, () => {
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•: http://localhost:${port}`);
  });
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã™ã¹ã¦ã®èµ·å‹•ãƒ‘ã‚¹ã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆCLIã€Systemdã€Dockerç­‰ï¼‰
- âœ… HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‰ã«ã‚¨ãƒ©ãƒ¼æ¤œå‡ºï¼ˆä¸å®Œå…¨ãªçŠ¶æ…‹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ãªã„ï¼‰
- âœ… å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ï¼ˆ1ç®‡æ‰€ã«é›†ç´„ï¼‰
- âœ… `/api/health`ã¨ã®çµ±åˆãŒå®¹æ˜“ï¼ˆåŒã˜æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒã‚ãšã‹ã«é…å»¶ï¼ˆ+70msç¨‹åº¦ï¼‰

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: CLIèµ·å‹•æ™‚ã®ã¿å®Ÿè¡Œ

**æ¦‚è¦**: `src/bin/cli.ts`ã®`setupDatabase()`å†…ã§æ¤œè¨¼

**å®Ÿè£…ä½ç½®**:
```typescript
// src/bin/cli.ts
export async function setupDatabase() {
  ensureDatabaseFile(databaseUrl);
  syncSchema(databaseUrl);

  // æ¤œè¨¼ã‚’è¿½åŠ 
  const validationResult = validateSchemaIntegrity(db.$client);
  if (!validationResult.valid) {
    console.error(formatValidationError(validationResult));
    process.exit(1);
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… CLIèµ·å‹•æ™‚ã®ã¿å®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãªã—ï¼‰
- âœ… ã‚¹ã‚­ãƒ¼ãƒåŒæœŸç›´å¾Œã«æ¤œè¨¼ï¼ˆæ•´åˆæ€§ã‚’å³åº§ã«ç¢ºèªï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ Systemdèµ·å‹•æ™‚ã¯`server.ts`ãŒç›´æ¥å‘¼ã°ã‚Œã‚‹ãŸã‚æ¤œè¨¼ã•ã‚Œãªã„
- âŒ Dockerèµ·å‹•æ™‚ã‚‚æ¤œè¨¼ã•ã‚Œãªã„å¯èƒ½æ€§
- âŒ è¤‡æ•°ã®èµ·å‹•ãƒ‘ã‚¹ã§æ¤œè¨¼ãŒæ¼ã‚Œã‚‹ãƒªã‚¹ã‚¯

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦å®Ÿè£…

**æ¦‚è¦**: Next.jsãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«æ¤œè¨¼

**å®Ÿè£…ä½ç½®**:
```typescript
// src/middleware.ts
export function middleware(request: NextRequest) {
  if (!schemaValidated) {
    const result = validateSchemaIntegrity(db);
    if (!result.valid) {
      return NextResponse.json({ error: 'Schema error' }, { status: 503 });
    }
    schemaValidated = true;
  }
  return NextResponse.next();
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•è‡ªä½“ã¯æˆåŠŸï¼ˆHTTPãƒªã‚¹ãƒŠãƒ¼ã¯èµ·å‹•ï¼‰
- âœ… åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ã¿æ¤œè¨¼ï¼ˆé…å»¶åˆæœŸåŒ–ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ èµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã§ããªã„ï¼ˆFail FaståŸå‰‡ã«åã™ã‚‹ï¼‰
- âŒ åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå¢—åŠ 
- âŒ å¤–éƒ¨ç›£è¦–ãƒ„ãƒ¼ãƒ«ãŒæ­£å¸¸ã¨èª¤èªã™ã‚‹å¯èƒ½æ€§
- âŒ å®Ÿè£…ãŒè¤‡é›‘ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ç®¡ç†ã€ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯¾å¿œï¼‰

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³4: èµ·å‹•å‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦åˆ†é›¢

**æ¦‚è¦**: ç‹¬ç«‹ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ`check-schema.ts`ã‚’ä½œæˆã—ã€èµ·å‹•å‰ã«å®Ÿè¡Œ

**å®Ÿè£…ä½ç½®**:
```bash
# package.json
"scripts": {
  "start": "node dist/check-schema.js && node dist/server.js"
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… é–¢å¿ƒã®åˆ†é›¢ï¼ˆæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãŒç‹¬ç«‹ï¼‰
- âœ… CI/CDã§ã®å˜ç‹¬å®Ÿè¡ŒãŒå®¹æ˜“

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ 2ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ãŒå¿…è¦ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼‰
- âŒ Systemdè¨­å®šãŒè¤‡é›‘åŒ–ï¼ˆExecStartPreè¿½åŠ ãŒå¿…è¦ï¼‰
- âŒ ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ã‚°ãŒåˆ†æ•£ï¼ˆã©ã¡ã‚‰ã®ãƒ—ãƒ­ã‚»ã‚¹ã§å¤±æ•—ã—ãŸã‹ä¸æ˜ç­ï¼‰

---

## æ±ºå®š

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: server.tsçµ±åˆ ã‚’æ¡ç”¨**

### ç†ç”±

1. **Fail FaståŸå‰‡ã®å¾¹åº•**
   - HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‰ã«ã‚¨ãƒ©ãƒ¼æ¤œå‡º
   - ä¸å®Œå…¨ãªçŠ¶æ…‹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ãªã„
   - SystemdãŒå³åº§ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã§ãã‚‹

2. **ã™ã¹ã¦ã®èµ·å‹•ãƒ‘ã‚¹ã§ç¢ºå®Ÿã«å®Ÿè¡Œ**
   - CLIèµ·å‹•ï¼ˆ`npx claude-work`ï¼‰
   - Systemdèµ·å‹•ï¼ˆ`systemctl start claude-work`ï¼‰
   - Dockerèµ·å‹•ï¼ˆ`docker run`ï¼‰
   - æ‰‹å‹•èµ·å‹•ï¼ˆ`node dist/server.js`ï¼‰
   â†’ ã©ã®èµ·å‹•æ–¹æ³•ã§ã‚‚æ¤œè¨¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹

3. **å¤–éƒ¨ç›£è¦–ãƒ„ãƒ¼ãƒ«ã¨ã®çµ±åˆ**
   - Systemdã®ExecStartPostã§`/api/health`ã‚’å‘¼ã³å‡ºã—
   - ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‰ã«ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã™ã‚Œã°ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å‰ã«åœæ­¢
   - ç›£è¦–ãƒ„ãƒ¼ãƒ«ãŒæ­£ç¢ºãªçŠ¶æ…‹ã‚’æŠŠæ¡ã§ãã‚‹

4. **å®Ÿè£…ã®ã‚·ãƒ³ãƒ—ãƒ«ã•**
   - 1ç®‡æ‰€ã«é›†ç´„ï¼ˆ`server.ts`ã®ã¿å¤‰æ›´ï¼‰
   - æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã¯`validateSchemaIntegrity()`ã‚’å†åˆ©ç”¨
   - `/api/health`ã¨ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰

5. **æ€§èƒ½ã¸ã®å½±éŸ¿ãŒè»½å¾®**
   - æ¤œè¨¼å‡¦ç†ã¯æ¨å®š70msç¨‹åº¦ï¼ˆ7ãƒ†ãƒ¼ãƒ–ãƒ«Ã—PRAGMA table_infoã€ãƒ­ãƒ¼ã‚«ãƒ«SQLiteèª­ã¿å–ã‚Šï¼‰
   - å®Ÿæ¸¬å€¤ã¯æœªè¨ˆæ¸¬ã€‚`PRAGMA table_info`ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªSQLiteæ“ä½œã®ãŸã‚æ¥µã‚ã¦é«˜é€Ÿã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ãŸæ¨å®šå€¤
   - ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã®ç·æ™‚é–“ï¼ˆæ•°ç§’ï¼‰ã«å¯¾ã—ã¦ç„¡è¦–ã§ãã‚‹
   - NFR-003ï¼ˆ5ç§’ä»¥å†…ï¼‰ã‚’ä½™è£•ã§é”æˆ

### ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•

**å—ã‘å…¥ã‚Œã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚é–“ãŒã‚ãšã‹ã«å¢—åŠ ï¼ˆ+70msï¼‰
  â†’ è¨±å®¹ç¯„å›²å†…ï¼ˆNFR-003: 5ç§’ä»¥å†…ï¼‰

**è»½æ¸›ç­–**:
- æ¤œè¨¼å‡¦ç†ã®æœ€é©åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥ï¼‰
- ä¸¦åˆ—åŒ–ï¼ˆå°†æ¥çš„ã«è¤‡æ•°ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼‰

## å½±éŸ¿ç¯„å›²

### å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|
| `server.ts` | `startServer()`é–¢æ•°ã«æ¤œè¨¼å‡¦ç†ã‚’è¿½åŠ  |
| `src/lib/schema-check.ts` | æ–°è¦ä½œæˆï¼ˆ`validateSchemaIntegrity()`é–¢æ•°ï¼‰ |
| `src/lib/__tests__/schema-check.test.ts` | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ  |

### å®Ÿè£…è©³ç´°

```typescript
// server.ts
import { validateSchemaIntegrity, formatValidationError } from '@/lib/schema-check';
import { db } from '@/lib/db';

async function startServer() {
  console.log('ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™ä¸­...');

  // ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  console.log('ğŸ” ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­...');
  const validationResult = validateSchemaIntegrity(db.$client);

  if (!validationResult.valid) {
    // ä¸ä¸€è‡´æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
    console.error(formatValidationError(validationResult));
    process.exit(1);
  }

  console.log('âœ… ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§OK');
  console.log(`   æ¤œè¨¼ãƒ†ãƒ¼ãƒ–ãƒ«æ•°: ${validationResult.checkedTables.length}`);

  // HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  const server = app.listen(port, () => {
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•: http://localhost:${port}`);
  });

  // ... ä»¥ä¸‹çœç•¥
}
```

## èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```text
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸåŒ–
   â””â”€â†’ ensureDatabaseFile()
        â†“
2. ã‚¹ã‚­ãƒ¼ãƒåŒæœŸï¼ˆCLIèµ·å‹•æ™‚ã®ã¿ï¼‰
   â””â”€â†’ syncSchema() [src/bin/cli.ts]
        â†“
3. ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨èµ·å‹•ãƒ‘ã‚¹ï¼‰â˜…ã“ã“ã§å®Ÿè£…â˜…
   â””â”€â†’ validateSchemaIntegrity() [server.ts]
        â”œâ”€â†’ OK: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        â””â”€â†’ NG: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º + process.exit(1)
        â†“
4. HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•
   â””â”€â†’ app.listen()
        â†“
5. WebSocketã‚µãƒ¼ãƒãƒ¼èµ·å‹•
```

## ä»£æ›¿æ¡ˆã®å´ä¸‹ç†ç”±

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å´ä¸‹ç†ç”± |
|-----------|---------|
| CLIèµ·å‹•æ™‚ã®ã¿å®Ÿè¡Œ | Systemdèµ·å‹•æ™‚ã«æ¤œè¨¼ã•ã‚Œãªã„ãƒªã‚¹ã‚¯ |
| ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£… | Fail FaståŸå‰‡ã«åã™ã‚‹ã€åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é…å»¶ |
| èµ·å‹•å‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆ†é›¢ | 2ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€Systemdè¨­å®šè¤‡é›‘åŒ– |

## å‚ç…§

- [è¦ä»¶å®šç¾© US-002](../../../requirements/migration-error-prevention/stories/US-002.md) @../../../requirements/migration-error-prevention/stories/US-002.md
- [ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](../components/schema-validator.md) @../components/schema-validator.md
- [è¨­è¨ˆæ¦‚è¦](../index.md) @../index.md

## æ‰¿èªè€…

- @tsk (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼)

## å¤‰æ›´å±¥æ­´

- 2026-02-17: åˆç‰ˆä½œæˆã€æ‰¿èª
