# DEC-002: SSH鍵一時保存場所の決定

## ステータス

**ステータス**: 承認済
**決定日**: 2024-01-15
**レビュアー**: システムアーキテクト

## コンテキスト

Docker環境でSSH鍵を使用するために、秘密鍵を復号化して一時的にホスト上のファイルシステムに保存する必要があります。この一時ファイルの保存場所を決定する必要があります。

### 現状の課題
- SSH鍵は機密情報であり、セキュアな場所に保存する必要がある
- Docker コンテナにマウントするため、ホスト上のパスが必要
- 複数の環境（ExecutionEnvironment）で鍵が混在しないようにする必要がある
- コンテナ停止時に確実にクリーンアップできる場所が必要

### 制約条件
- 既存の `data/environments/<env-id>/` ディレクトリ構造と整合性を保つ
- ファイルパーミッションを適切に設定できること（0600）
- Git の履歴に含まれないこと（.gitignore で除外）
- 複数セッションで鍵が競合しないこと

## 情報の明確性

### 明示された情報
- 既存の環境ディレクトリ: `data/environments/<env-id>/`
- SSH鍵のパーミッション: 0600（秘密鍵）
- クリーンアップタイミング: コンテナ停止時

### 不明/要確認の情報

なし（すべて確認済み）

### 確認状況
- [x] ユーザー確認済み

---

## 検討した選択肢

### 選択肢A: data/environments/<env-id>/ssh/（採用）

**概要**: 既存の環境ディレクトリ配下に ssh サブディレクトリを作成

**パス構造**:
```
data/
└── environments/
    └── <env-id>/
        ├── auth/         # 既存の認証情報
        └── ssh/          # SSH鍵一時ファイル（新規）
            ├── id_GitHub_Personal
            ├── id_GitHub_Personal.pub
            ├── id_Bitbucket_Work
            └── id_Bitbucket_Work.pub
```

**メリット**:
- **既存構造との整合性**: `data/environments/<env-id>/` という既存パターンに従う
- **環境ごとの隔離**: ExecutionEnvironment ごとに鍵が分離される
- **クリーンアップが容易**: ディレクトリごと削除するだけ
- **Git 除外済み**: `data/` は既に .gitignore に含まれている
- **パス予測可能**: プログラム的にパスを生成しやすい

**デメリット**:
- 特になし

**コスト/工数**: ディレクトリ作成のみ（追加コストほぼなし）

---

### 選択肢B: /tmp/claudework-ssh/<env-id>/

**概要**: システムの一時ディレクトリに保存

**メリット**:
- **自動クリーンアップ**: システム再起動時に自動削除される
- **専用領域**: /tmp は一時ファイル用の標準的な場所

**デメリット**:
- **既存構造と不整合**: 他の環境データは `data/environments/` にあるのに、SSH鍵だけ別の場所
- **パーミッション問題**: /tmp は他のプロセスもアクセス可能（セキュリティリスク）
- **予期しない削除**: システムの自動クリーンアップで必要な鍵が削除される可能性
- **マルチユーザー環境で競合**: 複数ユーザーが同じ /tmp を使用する場合の衝突リスク

**コスト/工数**: パス生成ロジックの実装（1時間）

---

### 選択肢C: ~/.ssh/claudework/<env-id>/

**概要**: ユーザーのホームディレクトリの .ssh 配下に保存

**メリット**:
- **SSH 標準パス**: ~/.ssh は SSH 鍵の標準的な保存場所
- **パーミッション適切**: ~/.ssh は通常 0700 で保護されている

**デメリット**:
- **既存構造と不整合**: 他の環境データは `data/environments/` にあるのに、SSH鍵だけ別の場所
- **ユーザー依存**: ユーザーのホームディレクトリに依存（Docker 環境で問題）
- **クリーンアップ困難**: 他の SSH 鍵と混在する可能性
- **複数ユーザー対応困難**: 将来的に複数ユーザー対応する場合に問題

**コスト/工数**: パス生成ロジックとクリーンアップロジックの実装（2時間）

---

## 決定

**選択肢A: data/environments/<env-id>/ssh/** を採用します。

### 決定理由

1. **既存構造との整合性**: `data/environments/<env-id>/` という既存のパターンに従い、システム全体の一貫性を保つ
2. **環境ごとの隔離**: ExecutionEnvironment ごとに SSH 鍵が分離され、鍵の混在を防止
3. **クリーンアップが容易**: ディレクトリごと削除するだけでクリーンアップ完了
4. **セキュリティ**: `data/` ディレクトリは既に .gitignore に含まれており、誤ってコミットされるリスクがない
5. **シンプル**: パス生成ロジックがシンプルで保守しやすい

### 実装方針

**ディレクトリ作成**:
```typescript
const sshDir = path.join('data', 'environments', envId, 'ssh');
await fs.mkdir(sshDir, { recursive: true, mode: 0o700 });
```

**ファイルパス生成**:
```typescript
const privateKeyPath = path.join(sshDir, `id_${keyName}`);
const publicKeyPath = `${privateKeyPath}.pub`;
```

**クリーンアップ**:
```typescript
await fs.rm(sshDir, { recursive: true, force: true });
```

## 影響範囲

### 影響を受けるコンポーネント
- **DockerAdapter**: SSH鍵の一時ファイル作成・マウント・クリーンアップ
- **.gitignore**: `data/` は既に除外されているため、追加変更不要

### セキュリティ考慮事項
- ディレクトリパーミッション: `0700`（所有者のみアクセス可能）
- ファイルパーミッション: 秘密鍵 `0600`、公開鍵 `0644`
- クリーンアップ: コンテナ停止時に確実に削除

## 関連ドキュメント

- [DockerAdapter Extension](../components/docker-adapter-extension.md) @../components/docker-adapter-extension.md: 実装詳細
- [NFR-SEC-003](../../requirements/dev-tool-settings/nfr/security.md) @../../requirements/dev-tool-settings/nfr/security.md: SSH 鍵ファイルのパーミッション管理
- [NFR-SEC-005](../../requirements/dev-tool-settings/nfr/security.md) @../../requirements/dev-tool-settings/nfr/security.md: 一時ファイルのクリーンアップ
