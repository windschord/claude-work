# DEC-003: 階層的設定の優先順位ロジック実装場所

## ステータス

**ステータス**: 承認済
**決定日**: 2024-01-15
**レビュアー**: システムアーキテクト

## コンテキスト

Git設定はグローバル設定とプロジェクト別設定の2層構造を持ち、プロジェクト設定がグローバル設定を上書きします。この優先順位解決ロジックをどこに実装するかを決定する必要があります。

### 現状の課題
- 優先順位ロジックが複数箇所に散在すると、保守性が低下する
- API層、Service層、Adapter層のいずれに実装するか不明確
- フィールドごとに優先順位が異なる可能性がある（username はプロジェクト設定、email はグローバル設定など）

### 制約条件
- クリーンアーキテクチャに従う（ビジネスロジックはService層）
- 将来的な拡張性を考慮（環境別設定への拡張可能性）
- テストが容易であること

## 情報の明確性

### 明示された情報
- 優先順位: プロジェクト設定 > グローバル設定
- フィールドレベルでの優先順位解決（username とemail は独立）
- 将来的な拡張: 環境別設定の追加可能性

### 不明/要確認の情報

なし（すべて確認済み）

### 確認状況
- [x] ユーザー確認済み

---

## 検討した選択肢

### 選択肢A: Service層で実装（採用）

**概要**: DeveloperSettingsService に優先順位解決ロジックを実装

**実装イメージ**:
```typescript
class DeveloperSettingsService {
  async getEffectiveSettings(projectId: string): Promise<EffectiveSettings> {
    // プロジェクト設定を取得
    const projectSettings = await db.developerSettings.findUnique({
      where: { scope: 'PROJECT', project_id: projectId }
    });

    // グローバル設定を取得
    const globalSettings = await db.developerSettings.findUnique({
      where: { scope: 'GLOBAL', project_id: null }
    });

    // フィールドごとに優先順位解決
    return {
      git_username: projectSettings?.git_username ?? globalSettings?.git_username,
      git_email: projectSettings?.git_email ?? globalSettings?.git_email
    };
  }
}
```

**メリット**:
- **ビジネスロジックの集約**: 優先順位解決はビジネスロジックであり、Service層が適切
- **再利用性**: API、Adapter、UIなど複数箇所から利用可能
- **テスト容易性**: Service層の単体テストで優先順位ロジックを検証できる
- **拡張性**: 将来的に環境別設定を追加する場合もService層で対応可能

**デメリット**:
- 特になし

**コスト/工数**: Service層の実装（2時間）

---

### 選択肢B: データベースクエリで実装

**概要**: Prisma クエリで優先順位を解決

**実装イメージ**:
```typescript
const setting = await db.developerSettings.findFirst({
  where: {
    OR: [
      { scope: 'PROJECT', project_id: projectId },
      { scope: 'GLOBAL', project_id: null }
    ]
  },
  orderBy: { scope: 'desc' } // PROJECT > GLOBAL
});
```

**メリット**:
- **シンプル**: データベースクエリだけで優先順位解決
- **パフォーマンス**: 1回のクエリで完結

**デメリット**:
- **フィールドレベルの優先順位不可**: username はプロジェクト、email はグローバルという混在が不可能
- **拡張性低い**: 環境別設定を追加する場合、クエリが複雑化
- **ビジネスロジックの分散**: データベース層にビジネスロジックが混入

**コスト/工数**: クエリ実装（1時間）

---

### 選択肢C: API層で実装

**概要**: API Route ハンドラー内で優先順位解決

**実装イメージ**:
```typescript
export async function GET(request: NextRequest) {
  const projectSettings = await getProjectSettings(projectId);
  const globalSettings = await getGlobalSettings();

  const effective = {
    git_username: projectSettings?.git_username ?? globalSettings?.git_username,
    git_email: projectSettings?.git_email ?? globalSettings?.git_email
  };

  return NextResponse.json(effective);
}
```

**メリット**:
- **APIレスポンスに特化**: API用に最適化されたロジック

**デメリット**:
- **再利用不可**: DockerAdapterなど他のコンポーネントから利用できない
- **ビジネスロジックの分散**: API層とService層の責務が曖昧になる
- **テスト困難**: API Route のテストは統合テストが必要

**コスト/工数**: API Route 実装（3時間）

---

## 決定

**選択肢A: Service層で実装** を採用します。

### 決定理由

1. **クリーンアーキテクチャに従う**: 優先順位解決はビジネスロジックであり、Service層が責務として適切
2. **再利用性**: API、DockerAdapter、UIなど複数箇所から `getEffectiveSettings()` を呼び出せる
3. **テスト容易性**: Service層の単体テストで優先順位ロジックを網羅的に検証できる
4. **拡張性**: 将来的に環境別設定を追加する場合も、Service層のロジックを拡張するだけで対応可能
5. **フィールドレベルの柔軟性**: username とemail を個別に優先順位解決できる

### 実装方針

**DeveloperSettingsService**:
```typescript
export class DeveloperSettingsService {
  /**
   * プロジェクトの有効な設定を取得（優先順位解決済み）
   */
  async getEffectiveSettings(projectId: string): Promise<EffectiveSettings> {
    const [projectSettings, globalSettings] = await Promise.all([
      this.getProjectSettings(projectId),
      this.getGlobalSettings()
    ]);

    return {
      git_username: projectSettings?.git_username ?? globalSettings?.git_username ?? null,
      git_email: projectSettings?.git_email ?? globalSettings?.git_email ?? null,
      source: {
        git_username: projectSettings?.git_username ? 'project' : 'global',
        git_email: projectSettings?.git_email ? 'project' : 'global'
      }
    };
  }
}
```

**API での使用**:
```typescript
export async function GET(request: NextRequest, { params }: { params: { projectId: string } }) {
  const service = new DeveloperSettingsService();
  const settings = await service.getEffectiveSettings(params.projectId);
  return NextResponse.json(settings);
}
```

**DockerAdapter での使用**:
```typescript
async injectDeveloperSettings(projectId: string, containerId: string) {
  const service = new DeveloperSettingsService();
  const settings = await service.getEffectiveSettings(projectId);

  if (settings.git_username) {
    await this.dockerExec(containerId, ['git', 'config', '--global', 'user.name', settings.git_username]);
  }
  // ...
}
```

## 影響範囲

### 影響を受けるコンポーネント
- **DeveloperSettingsService**: 新規メソッド `getEffectiveSettings()` を実装
- **API Routes**: Service の `getEffectiveSettings()` を呼び出すように変更
- **DockerAdapter**: Service の `getEffectiveSettings()` を使用して設定を取得

### 将来の拡張
環境別設定を追加する場合の拡張例:
```typescript
async getEffectiveSettings(projectId: string, envId?: string): Promise<EffectiveSettings> {
  const [envProjectSettings, projectSettings, envGlobalSettings, globalSettings] = await Promise.all([
    envId ? this.getEnvProjectSettings(envId, projectId) : null,
    this.getProjectSettings(projectId),
    envId ? this.getEnvGlobalSettings(envId) : null,
    this.getGlobalSettings()
  ]);

  // 優先順位: 環境別プロジェクト > プロジェクト > 環境別グローバル > グローバル
  return {
    git_username:
      envProjectSettings?.git_username ??
      projectSettings?.git_username ??
      envGlobalSettings?.git_username ??
      globalSettings?.git_username ??
      null
  };
}
```

## 関連ドキュメント

- [DeveloperSettingsService](../components/developer-settings-service.md) @../components/developer-settings-service.md: 実装詳細
- [US-002](../../requirements/dev-tool-settings/stories/US-002.md) @../../requirements/dev-tool-settings/stories/US-002.md: プロジェクト別 Git 設定の上書き
- [NFR-EXT-002](../../requirements/dev-tool-settings/nfr/extensibility.md) @../../requirements/dev-tool-settings/nfr/extensibility.md: 環境別設定の拡張可能性
