# DEC-003: cols/rows伝播方法の統一

## ステータス

**ステータス**: 承認済
**決定日**: 2026-02-15
**レビュアー**: 7名の専門家チーム

## コンテキスト

HOST環境でcols/rowsが80x24にハードコードされており、ブラウザのターミナルサイズと一致しない問題がある。

### 現状の課題
- **HOST環境**: cols: 80, rows: 24にハードコード(claude-pty-manager.ts:145-146)
- **DOCKER環境**: options経由で正しく伝播(docker-adapter.ts:471-472、Issue #101で修正済み)
- **一貫性欠如**: 同じ機能の実装方法が環境ごとに異なる
- **ユーザー体験低下**: ブラウザでリサイズしても、HOST環境のPTYサイズが追従しない

### 制約条件
- DOCKER環境の既存実装(Issue #101の修正)を破壊しないこと
- WebSocketからのcols/rows取得ロジック(claude-ws.ts:337-352)は変更しないこと
- デフォルト値80x24は維持すること(options未指定時)

## 情報の明確性

### 明示された情報
- DOCKER環境の実装が正解パターン(docker-adapter.ts:471-489)
- CreateSessionOptionsにcols/rowsが既に定義されている(environment-adapter.ts:15-18)
- claude-ws.tsからoptions.cols/rowsが正しく渡されている(docker-adapter.ts:337-352)

### 不明/要確認の情報
なし(全ての情報が明示されている)

### 確認状況
- [x] ユーザー確認済み

---

## 検討した選択肢

### 選択肢A: options経由でcols/rows伝播(推奨)

**概要**: DOCKER環境と同じパターンをHOST環境にも適用。CreateSessionOptionsのcols/rowsをpty.spawn()に渡す。

**メリット**:
- ✅ HOST/DOCKER環境で一貫した実装
- ✅ Issue #101の修正パターンを踏襲
- ✅ 既存のCreateSessionOptions定義を活用
- ✅ デフォルト値(80x24)も同じパターンで処理
- ✅ 将来のSSH環境でも同じパターン適用可能

**デメリット**:
なし

**コスト/工数**: 低(BasePTYAdapter実装の一部)

---

### 選択肢B: 環境変数経由でcols/rows伝播

**概要**: cols/rowsを環境変数として渡し、PTY側で取得する。

**メリット**:
- ✅ 環境変数で統一的に管理

**デメリット**:
- ❌ node-ptyの標準パターンではない
- ❌ Issue #101の修正パターンと一貫性がない
- ❌ 環境変数の汚染(COLUMNS, LINES等は既存の意味がある)

**コスト/工数**: 中(環境変数設定、取得ロジック追加)

---

### 選択肢C: リサイズイベントのみで対応

**概要**: 初期サイズは80x24固定、ブラウザからのリサイズイベントのみで調整する。

**メリット**:
- ✅ 初期実装が簡単

**デメリット**:
- ❌ 初回表示時にサイズが一致しない
- ❌ リサイズイベントが発火するまで不整合状態
- ❌ Issue #101の修正パターンと一貫性がない

**コスト/工数**: 低(既存ロジック維持)

---

## 決定

**選択肢A: options経由でcols/rows伝播**

### 決定理由
1. Issue #101の修正パターン(docker-adapter.ts:471-489)を踏襲
2. HOST/DOCKER環境で一貫した実装
3. 既存のCreateSessionOptions定義を活用
4. node-ptyの標準的な使用方法

### 実装パターン

**BasePTYAdapter.spawnPTY()**:
```typescript
protected spawnPTY(command: string, args: string[], options: SpawnOptions): IPty {
  const { cols = 80, rows = 24, cwd, env = {} } = options;

  return pty.spawn(command, args, {
    name: 'xterm-256color',
    cols,  // options経由で渡される
    rows,  // options経由で渡される
    cwd,
    env: {
      ...process.env,
      ...env,
      TERM: 'xterm-256color',
      COLORTERM: 'truecolor',
    },
  });
}
```

**HostAdapter.createSession()**:
```typescript
createSession(sessionId: string, workingDir: string, initialPrompt?: string, options?: CreateSessionOptions): void {
  const cols = options?.cols ?? 80;
  const rows = options?.rows ?? 24;
  // ... ClaudePTYManagerの代わりにBasePTYAdapter.spawnPTY()を使用
  const ptyInstance = this.spawnPTY('claude', args, { cols, rows, cwd: workingDir });
}
```

### 影響範囲
- **新規**: `src/services/adapters/base-adapter.ts`(spawnPTY実装)
- **変更**: `src/services/adapters/host-adapter.ts`(cols/rowsをoptions経由で取得)
- **変更**: `src/services/adapters/docker-adapter.ts`(既存ロジックをbase-adapterへ移動)
- **変更**: `src/services/claude-pty-manager.ts`(削除対象)

## 結果

**期待される結果**:
- HOST環境でブラウザのターミナルサイズとPTYサイズが一致
- HOST/DOCKER環境で一貫したcols/rows伝播
- リサイズイベント時の即座な反映

**検証方法**:
- REQ-003-001: HOST環境でWebSocketから受信したcols/rowsがpty.spawn()に渡されること
- REQ-003-002: cols/rows未指定時、デフォルト値80x24が使用されること
- REQ-003-005: HOST環境でブラウザのターミナルサイズと同じcols/rowsでPTY初期化されること
- REQ-003-007: DOCKER環境でのcols/rows伝播が引き続き正常に動作すること(回帰防止)

## 参照

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則D2: cols/rowsを適切に初期化する
- 要件: [US-003](../../requirements/stories/US-003.md) @../../requirements/stories/US-003.md
- Issue #101: Docker環境でのPTY terminal display問題(修正済み)
- 既存実装: docker-adapter.ts:471-489(正解パターン)
