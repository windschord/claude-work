# DEC-001: ClaudePTYManager削除によるCircular Delegation解消

## ステータス

**ステータス**: 承認済
**決定日**: 2026-02-15
**レビュアー**: 7名の専門家チーム(history-investigator, risk-evaluator, architect, code-reviewer, log-analyzer, debugger, docker-investigator)

## コンテキスト

HOST環境でのPTYセッション作成時に、Circular delegationが発生し、「Session already exists」エラーとターミナル黒画面問題が発生している。

### 現状の課題
- **Circular delegation**: PTYSessionManager → HostAdapter → ClaudePTYManager → PTYSessionManager(再帰)
- **destroySession無限再帰**: サーバークラッシュの原因(pm2-error.logに複数記録)
- **過剰な委譲チェーン**: 3層の不必要なラッパー構造
- **設計原則違反**: 原則A2「依存は常に上位から下位へ(一方向)」に違反

### 制約条件
- ClaudePTYManagerの削除により、既存のextractClaudeSessionId機能を失わないこと
- 後方互換性を維持する必要はなし(ClaudePTYManagerは@deprecatedマーク済み)
- PTYSessionManagerのインターフェースは維持すること

## 情報の明確性

### 明示された情報
- ClaudePTYManagerは@deprecatedマーク済み(claude-pty-manager.ts:39)
- ClaudePTYManager自身が「PTYSessionManagerへの薄いラッパー」と自称(claude-pty-manager.ts:29)
- extractClaudeSessionId機能(20行程度)は移動可能

### 不明/要確認の情報
- [x] 他の依存コンポーネントの有無: HostAdapterのみ(確認済み)

### 確認状況
- [x] ユーザー確認済み(専門家チームによる推奨)

---

## 検討した選択肢

### 選択肢A: ClaudePTYManager削除 + HostAdapterでnode-pty直接使用(推奨)

**概要**: ClaudePTYManagerを完全に削除し、HostAdapterがBasePTYAdapter経由でnode-ptyを直接使用する。

**メリット**:
- ✅ Circular delegation完全解消
- ✅ destroySession無限再帰解消
- ✅ 設計原則A2に準拠(一方向依存)
- ✅ コード保守性向上(不要なレイヤー削減)
- ✅ 過去11個のPRで再発した問題の根本解決

**デメリット**:
- ⚠️ extractClaudeSessionId機能の移動が必要(BasePTYAdapterへ)
- ⚠️ HostAdapterの変更が必要(約80行の修正)

**コスト/工数**: 中(実装約4時間、テスト約2時間)

---

### 選択肢B: ClaudePTYManager維持 + 循環参照の部分的修正

**概要**: ClaudePTYManagerを維持し、循環参照のみを修正する。

**メリット**:
- ✅ 既存コードの変更最小
- ✅ extractClaudeSessionId機能の移動不要

**デメリット**:
- ❌ 3層の不必要なラッパー構造は維持
- ❌ 設計原則A2違反は維持
- ❌ 将来の再発リスクが高い(whack-a-moleパターン)
- ❌ コード保守性が低い

**コスト/工数**: 低(実装約2時間)

---

### 選択肢C: ClaudePTYManagerをPTYSessionManagerに統合

**概要**: ClaudePTYManagerの機能をPTYSessionManagerに統合し、ClaudePTYManagerを削除する。

**メリット**:
- ✅ Circular delegation解消
- ✅ レイヤー削減

**デメリット**:
- ❌ PTYSessionManagerの責務過多(セッション管理 + PTY固有ロジック)
- ❌ 設計原則A1「単一責任」に違反
- ❌ BasePTYAdapterパターンとの整合性が悪い

**コスト/工数**: 高(実装約6時間、テストの影響範囲が大きい)

---

## 決定

**選択肢A: ClaudePTYManager削除 + HostAdapterでnode-pty直接使用**

### 決定理由
1. 7名の専門家チーム全員が推奨
2. 設計原則(A1-A3, C1-C3)に完全準拠
3. 過去11個のPRで再発した問題の根本解決
4. コスト/メリット比が最良

### 影響範囲
- **削除**: `src/services/claude-pty-manager.ts`
- **変更**: `src/services/adapters/host-adapter.ts`
- **新規**: `src/services/adapters/base-adapter.ts`(extractClaudeSessionId移動先)

### 移行計画
1. BasePTYAdapter作成(extractClaudeSessionId含む)
2. HostAdapter変更(ClaudePTYManager依存削除)
3. テスト実施(Circular delegation解消の検証)
4. ClaudePTYManager削除

## 結果

**期待される結果**:
- HOST環境でのターミナル正常表示(黒画面解消)
- "Session already exists"エラー解消
- サーバークラッシュ(無限再帰)解消
- 設計原則準拠による将来の保守性向上

**検証方法**:
- REQ-001-005: HOST環境でセッション作成時、ターミナル画面が正常に表示されること
- REQ-001-006: "Session already exists"エラーが出力されないこと
- REQ-001-007: createSession()が1回のみ呼び出されること
- REQ-002-005: セッション破棄時、スタックオーバーフローエラーが発生しないこと

## 参照

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
- 要件: [US-001](../../requirements/stories/US-001.md) @../../requirements/stories/US-001.md
- 要件: [US-002](../../requirements/stories/US-002.md) @../../requirements/stories/US-002.md
