# DEC-002: BasePTYAdapter共通ロジック抽出による保守性向上

## ステータス

**ステータス**: 承認済
**決定日**: 2026-02-15
**レビュアー**: 7名の専門家チーム(risk-evaluator推奨、architect設計)

## コンテキスト

HOST環境とDOCKER環境のPTYロジックにコード重複が存在し、両環境で同じバグ修正が適用されない問題がある。

### 現状の課題
- **コード重複**: HOST(ClaudePTYManager)とDOCKER(DockerAdapter)で類似ロジック重複
- **保守性低下**: 同じ修正を2箇所に適用する必要がある
- **一貫性欠如**: cols/rows初期化方法がHOST(ハードコード)とDOCKER(options経由)で異なる
- **テストカバレッジ低下**: 重複コードのため、テスト作成も重複

### 制約条件
- 環境固有のロジック(Docker: コンテナ準備、HOST: shellMode)は維持すること
- 既存のEnvironmentAdapterインターフェースを維持すること
- 性能劣化させないこと

## 情報の明確性

### 明示された情報
- DockerAdapterの cols/rows 初期化ロジック(docker-adapter.ts:471-489)が正解実装
- ClaudePTYManagerのcols: 80, rows: 24ハードコードは暫定実装
- risk-evaluatorの推奨: 共通ヘルパー抽出によりコード重複を防ぐ

### 不明/要確認の情報
- [x] 共通化すべきロジックの範囲: PTY spawn, データハンドリング, エラーハンドリング, クリーンアップ(確認済み)

### 確認状況
- [x] ユーザー確認済み(専門家チームによる推奨)

---

## 検討した選択肢

### 選択肢A: BasePTYAdapter抽象基底クラスパターン(推奨)

**概要**: 抽象基底クラスBasePTYAdapterを作成し、HostAdapterとDockerAdapterが継承する。

**メリット**:
- ✅ コード重複率30%以下達成(NFR-MNT-001)
- ✅ 両環境で同じバグ修正が自動適用
- ✅ テストカバレッジ向上(共通ロジックの一元テスト)
- ✅ 将来のSSH環境追加時も再利用可能
- ✅ TypeScript抽象クラスによる型安全性

**デメリット**:
- ⚠️ 新規ファイル作成が必要(base-adapter.ts)
- ⚠️ 継承関係の理解が必要

**コスト/工数**: 中(実装約6時間、テスト約4時間)

---

### 選択肢B: ユーティリティ関数による共通化

**概要**: pty-utils.tsを作成し、共通ロジックを関数として抽出する。

**メリット**:
- ✅ シンプルで理解しやすい
- ✅ 継承不要

**デメリット**:
- ❌ EventEmitterイベント処理の共通化が困難
- ❌ 型安全性が低い(抽象メソッドの強制不可)
- ❌ 環境固有実装の強制ができない

**コスト/工数**: 中(実装約4時間)

---

### 選択肢C: 現状維持(コード重複許容)

**概要**: コード重複を許容し、必要に応じて個別修正する。

**メリット**:
- ✅ 変更不要

**デメリット**:
- ❌ NFR-MNT-001違反(コード重複率30%以下)
- ❌ 過去の"whack-a-mole"パターンが継続
- ❌ 保守性が低い

**コスト/工数**: ゼロ(短期)、高(長期の保守コスト)

---

## 決定

**選択肢A: BasePTYAdapter抽象基底クラスパターン**

### 決定理由
1. NFR-MNT-001(コード重複率30%以下)達成
2. risk-evaluatorの推奨(Medium risk軽減策)
3. TypeScript抽象クラスによる型安全性
4. 将来のSSH環境追加時の再利用性

### 共通化対象ロジック

| 機能 | 現在の場所 | 移動先 |
|------|-----------|--------|
| PTY spawn処理 | docker-adapter.ts:471-489 | BasePTYAdapter.spawnPTY() |
| cols/rows初期化 | docker-adapter.ts:471-472 | BasePTYAdapter.spawnPTY() |
| 環境変数設定(TERM, COLORTERM) | docker-adapter.ts:478 | BasePTYAdapter.spawnPTY() |
| データハンドリング | docker-adapter.ts:492-500 | BasePTYAdapter.setupDataHandlers() |
| エラーハンドリング | docker-adapter.ts:502-510 | BasePTYAdapter.setupErrorHandlers() |
| クリーンアップ | docker-adapter.ts:600-610 | BasePTYAdapter.cleanupPTY() |
| SessionID抽出 | claude-pty-manager.ts:61-68 | BasePTYAdapter.extractClaudeSessionId() |

### 影響範囲
- **新規**: `src/services/adapters/base-adapter.ts`(約200-250行)
- **変更**: `src/services/adapters/host-adapter.ts`(+50, -30行)
- **変更**: `src/services/adapters/docker-adapter.ts`(+40, -60行)

## 結果

**期待される結果**:
- コード重複率30%以下達成
- テストカバレッジ80%以上達成
- 両環境で一貫したPTY初期化
- 将来のバグ修正が両環境に自動適用

**検証方法**:
- NFR-MNT-001: jscpdでコード重複率を測定
- NFR-MNT-002: Vitestでカバレッジ80%以上を検証
- REQ-004-006: HOST/DOCKER両環境でセッション正常作成
- REQ-004-007: HostAdapter/DockerAdapterのコード行数30%以上削減

## 参照

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則A1: 各レイヤーは1つの責務のみを持つ
  - 原則A3: レイヤー間のインターフェースは明示的に定義する
- 要件: [US-004](../../requirements/stories/US-004.md) @../../requirements/stories/US-004.md
- NFR: [maintainability.md](../../requirements/nfr/maintainability.md) @../../requirements/nfr/maintainability.md
