# DEC-002: gh CLI認証を含める理由

## ステータス
承認済み

## コンテキスト

Docker環境でgit cloneやworktree作成を実行する際、どの認証情報をマウントするかを決定する必要がある。

### 既存の認証情報マウント（PR#96）
- SSH鍵（~/.ssh）
- SSH Agent socket（$SSH_AUTH_SOCK）
- Git設定（~/.gitconfig）

### 追加候補
- gh CLI認証（~/.config/gh）

## 決定事項

**gh CLI認証（~/.config/gh）をDockerコンテナにマウントする。**

すべてのDocker環境でのGit操作（clone、worktree作成）において、gh CLI認証を読み取り専用でマウントする。

## 理由

### 1. GitHub操作の包括的なサポート

**gh CLIの用途**:
- PR作成・管理
- Issue作成・管理
- リリース管理
- GitHub APIへのアクセス

**Docker環境での必要性**:
- Claude Codeがgh CLIを使用してPR作成などを行う場合がある
- Docker環境でgh認証がないと、これらの操作が失敗する

### 2. SSH認証との一貫性

**SSH認証の場合**:
- Git cloneは成功するが、gh CLIでのPR作成は失敗する
- ユーザーエクスペリエンスが損なわれる

**gh認証を含める場合**:
- SSH認証とgh認証の両方が利用可能
- 一貫した動作を提供

### 3. ユーザーの要望

ユーザーからの明示的な要望:
> gh CLI認証マウント（~/.config/gh）を含める

### 4. 既存のDockerAdapter実装との整合性

PR#96のDockerAdapterでは、既に包括的な認証情報マウントが実装されている：
- SSH鍵
- SSH Agent
- Git設定

gh CLI認証を追加することで、認証情報マウントをさらに包括的にする。

### 5. セキュリティ

**読み取り専用マウント**:
```bash
-v ~/.config/gh:/root/.config/gh:ro
```

**メリット**:
- コンテナ内での認証トークンの改変を防ぐ
- ホスト環境の認証情報を保護

## 代替案

### 案A: gh認証をマウントしない
**メリット**:
- シンプル
- マウント処理が少ない

**デメリット**:
- Docker環境でgh CLIが使用できない
- Claude CodeがPR作成などを行う場合に失敗
- ユーザーエクスペリエンスが損なわれる

**却下理由**: gh CLI認証がないと、Docker環境での GitHub操作が不完全になるため。

### 案B: gh認証をオプションにする
**メリット**:
- gh CLIを使用しないユーザーには不要

**デメリット**:
- UIが複雑になる
- 設定の手間が増える
- デフォルトで利用可能にしたほうがユーザーフレンドリー

**却下理由**: デフォルトで包括的な認証情報を提供したほうが、ユーザーエクスペリエンスが良いため。

## 影響

### ポジティブ
- Docker環境でgh CLIが正常に動作
- Claude CodeがDocker環境でPR作成などを行える
- 包括的な認証情報マウントにより、ユーザーエクスペリエンスが向上

### ネガティブ
- gh認証が設定されていないユーザーの場合、警告が表示される可能性（ただし、動作には影響しない）

### リスク緩和
- gh認証ディレクトリが存在しない場合の適切なエラーハンドリング
- gh認証がオプションであることをログに記録

## 実装

### Dockerコマンド
```bash
docker run --rm \
  -v ~/.ssh:/root/.ssh:ro \
  -v $SSH_AUTH_SOCK:/ssh-agent \
  -v ~/.gitconfig:/root/.gitconfig:ro \
  -v ~/.config/gh:/root/.config/gh:ro \
  -e SSH_AUTH_SOCK=/ssh-agent \
  alpine/git clone <url> /repo
```

### エラーハンドリング
```typescript
// gh認証ディレクトリが存在するか確認
const ghConfigDir = path.join(os.homedir(), '.config', 'gh');
if (fs.existsSync(ghConfigDir)) {
  mounts.push(`${ghConfigDir}:/root/.config/gh:ro`);
  logger.info('gh CLI認証をマウント');
} else {
  logger.warn('gh CLI認証が見つかりません（オプション）');
}
```

## 注記

### gh CLIのインストール
gh CLIがホスト環境にインストールされていない場合、~/.config/gh ディレクトリは存在しない。この場合、マウント処理をスキップし、警告ログを出力する。

### 将来の拡張
- 他の認証情報（npm、pip、など）の追加検討
- 認証情報マウントの設定をUIで管理できるようにする

## 参照

- requirements/index.md: スコープと目的（gh CLI認証を含む）
- requirements/stories/US-003.md: Docker環境でのプロジェクトclone
- requirements/nfr/security.md: 認証情報の読み取り専用マウント
- PR#96: DockerAdapter実装（SSH Agent転送、認証情報マウント）
