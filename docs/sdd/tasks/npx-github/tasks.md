# タスク: npx GitHub リポジトリ対応

> このドキュメントはAIエージェント（Claude Code等）が実装を行うことを前提としています。

## 情報の明確性チェック（全体）

### ユーザーから明示された情報

- [x] 実装対象のディレクトリ構造: 既存のプロジェクト構造に従う
- [x] 使用するパッケージマネージャー: npm
- [x] テストフレームワーク: Playwright (E2E), Vitest (Unit)
- [x] リンター/フォーマッター: ESLint
- [x] コーディング規約: 既存のプロジェクトスタイルに従う
- [x] ブランチ戦略: feature/npx-github-support ブランチで作業

### 不明/要確認の情報（全体）

なし（すべての情報が明示されている）

---

## 実装計画

### フェーズ1: prepare スクリプト追加

#### タスク1.1: package.json に prepare スクリプトを追加

**説明**:
- 対象ファイル: `package.json`
- 実装内容: `scripts` セクションに `"prepare": "node scripts/init-db.js && DATABASE_URL=file:./data/build.db npm run build"` を追加
- 目的: `npm install` 実行時に自動でDB初期化とビルドを実行させる

**技術的文脈**:
- npm のライフサイクルスクリプト `prepare` は `npm install` 後に自動実行される
- `node scripts/init-db.js` で better-sqlite3 を使用してDBを直接初期化（drizzle-kit不要）
- `DATABASE_URL` 環境変数をビルド時に設定（Next.jsビルドで環境変数検証が必要なため）
- `npm run build` は Next.js とサーバーの両方をビルドする
- GitHubからの `npx github:...` 実行時にこのスクリプトが発火する

**情報の明確性**:

| 分類               | 内容                                                                 |
|--------------------|----------------------------------------------------------------------|
| 明示された情報     | prepareスクリプトでDB初期化 + npm run buildを実行                    |
| 不明/要確認の情報  | なし                                                                 |

**受入基準**:
- [x] `package.json` の `scripts` に prepare スクリプトが追加されている
- [x] prepare スクリプトが DB初期化を実行する
- [x] prepare スクリプトが `DATABASE_URL` を設定してビルドを実行する
- [x] `npm install` 実行後にビルドが自動実行される

**依存関係**: なし
**ステータス**: `DONE`

---

### フェーズ2: E2Eテスト作成（TDD）

#### タスク2.1: npx CLI動作検証テストの作成（テストファースト）

**説明**:
- 対象ファイル: `e2e/npx-cli.spec.ts` (新規作成)
- 実装内容:
  1. `npm pack` でtarballを作成
  2. 一時ディレクトリにtarballをインストール
  3. CLIコマンドの動作を検証
- テスト対象:
  - `claude-work help` - ヘルプ表示
  - `claude-work start` - サーバー起動（バックグラウンド）
  - `claude-work status` - 状態確認
  - `claude-work stop` - サーバー停止

**技術的文脈**:
- Playwrightのテストランナーを使用（ブラウザ不要のCLIテスト）
- `npm pack` は現在のディレクトリのtarballを作成
- 一時ディレクトリは `os.tmpdir()` を使用
- tarballインストール後、`node_modules/.bin/claude-work` でCLI実行

**情報の明確性**:

| 分類               | 内容                                                               |
| ------------------ | ------------------------------------------------------------------ |
| 明示された情報     | Playwright E2Eテスト、npm packでtarball作成、一時ディレクトリで実行 |
| 不明/要確認の情報  | なし                                                               |

**受入基準**:
- [ ] `e2e/npx-cli.spec.ts` が作成されている
- [ ] テストが `npm pack` でtarballを作成する
- [ ] テストが一時ディレクトリでtarballをインストールする
- [ ] `claude-work help` の出力を検証するテストがある
- [ ] `claude-work status` の動作を検証するテストがある
- [ ] 不明なコマンドがエラーで終了することを検証するテストがある
- [ ] テスト実行後に一時ディレクトリとプロセスがクリーンアップされる
- [ ] **テストが失敗することを確認**（prepareスクリプト追加前は失敗するはず）

**依存関係**: なし（TDDのためテストを先に作成）
**ステータス**: `DONE`

---

### フェーズ3: 実装とテスト通過

#### タスク3.1: テストを通過させる

**説明**:
- タスク1.1で追加したprepareスクリプトが正しく動作することを確認
- E2Eテストを実行し、すべてのテストが通過することを確認

**技術的文脈**:
- `npm run e2e -- e2e/npx-cli.spec.ts` で対象テストのみ実行
- テストがすべて通過すれば実装完了

**情報の明確性**:

| 分類               | 内容                           |
| ------------------ | ------------------------------ |
| 明示された情報     | E2Eテストがすべて通過すること  |
| 不明/要確認の情報  | なし                           |

**受入基準**:
- [ ] `npm run e2e -- e2e/npx-cli.spec.ts` がすべて通過
- [ ] 既存のテストに影響がない（`npm test` が通過）

**依存関係**: タスク1.1, タスク2.1
**ステータス**: `DONE`

---

### フェーズ4: ドキュメント更新

#### タスク4.1: READMEの更新（必要に応じて）

**説明**:
- 対象ファイル: `README.md` または `CLAUDE.md`
- 実装内容: npx GitHub実行方法のドキュメント更新（必要な場合のみ）

**技術的文脈**:
- 既にREADMEにnpx実行方法が記載されている場合は、変更不要の可能性あり
- GitHubリポジトリ指定の例を追加する場合のみ更新

**情報の明確性**:

| 分類               | 内容                                       |
| ------------------ | ------------------------------------------ |
| 明示された情報     | READMEに既にnpx実行方法が記載されている    |
| 不明/要確認の情報  | なし                                       |

**受入基準**:
- [ ] npx github:... 形式での実行方法がドキュメントに記載されている
- [ ] または、既存のドキュメントで十分な場合は変更なし

**依存関係**: タスク3.1
**ステータス**: `DONE`

---

### フェーズ5: パッケージング修正

#### タスク5.1: .npmignore の追加（PR #71）

**説明**:
- 対象ファイル: `.npmignore` (新規作成)
- 実装内容: `.gitignore` がnpmパッケージフィルタリングに使われることで `.next/` と `dist/` が除外される問題を修正
- ユニットテスト: `src/bin/__tests__/npmignore.test.ts` を追加

**技術的文脈**:
- `.npmignore` が存在しない場合、npm は `.gitignore` をパッケージフィルタリングに使用する
- `.gitignore` には `.next/` と `dist/` が含まれているため、ビルド成果物がパッケージから除外されていた
- これにより npx 経由でインストールした際に `Module not found: Can't resolve '@/components/layout/MainLayout'` エラーが発生

**受入基準**:
- [x] `.npmignore` ファイルが作成されている
- [x] `.next/` と `dist/` がパッケージに含まれる
- [x] 不要な開発ファイルは除外されている
- [x] ユニットテストが追加・通過している

**依存関係**: なし
**ステータス**: `DONE`

---

## タスクステータスの凡例

- `TODO` - 未着手
- `IN_PROGRESS` - 作業中
- `BLOCKED` - 依存関係や問題によりブロック中
- `REVIEW` - レビュー待ち
- `DONE` - 完了

## リスクと軽減策

### リスク1: prepareスクリプトによる開発体験への影響

**影響度**: 低
**発生確率**: 中
**軽減策**:
- `npm install` のたびにビルドが走るが、開発中は `npm run dev` を使うため影響は限定的
- 必要に応じて `--ignore-scripts` オプションで回避可能

### リスク2: E2Eテストの実行時間

**影響度**: 低
**発生確率**: 高
**軽減策**:
- npx-cli.spec.ts は独立したテストファイルとして分離
- CI/CDでは必要に応じて別ジョブで実行

## 備考

- TDDアプローチ: テスト（タスク2.1）を先に作成し、実装（タスク1.1）でテストを通過させる
- ただし、prepareスクリプトの追加は単純な変更のため、先に追加しても問題なし
- テストの失敗確認は、prepareスクリプトなしの状態で一度テストを実行して確認
