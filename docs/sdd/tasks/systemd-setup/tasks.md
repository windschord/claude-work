# タスク: systemd 自動起動セットアップ

> このドキュメントは AIエージェント（Claude Code等）が実装を行うことを前提としています。

## 実装計画

### フェーズ1: systemd 設定ファイルの作成

#### タスク1.1: systemd ディレクトリの作成

**説明**:
- プロジェクトルートに `systemd/` ディレクトリを作成

**受入基準**:
- [x] `systemd/` ディレクトリが存在する

**依存関係**: なし
**ステータス**: `DONE`

---

#### タスク1.2: ユニットファイルの作成

**説明**:
- `systemd/claude-work.service` を作成
- design.md の仕様に従って設定

**受入基準**:
- [x] ユニットファイルが作成されている
- [x] セキュリティ設定が含まれている
- [x] 再起動ポリシーが設定されている

**依存関係**: タスク1.1
**ステータス**: `DONE`

---

#### タスク1.3: 環境変数テンプレートの作成

**説明**:
- `systemd/claude-work.env.example` を作成
- 必要な環境変数をコメント付きで記載

**受入基準**:
- [x] 環境変数テンプレートが作成されている
- [x] 各変数に説明コメントがある
- [x] DATABASE_URL の設定例がある

**依存関係**: タスク1.1
**ステータス**: `DONE`

---

### フェーズ2: セットアップドキュメントの作成

#### タスク2.1: SYSTEMD_SETUP.md の作成

**説明**:
- `docs/SYSTEMD_SETUP.md` を作成
- 以下のセクションを含める：
  1. 前提条件
  2. 専用ユーザーの作成
  3. アプリケーションのインストール
  4. 環境変数の設定
  5. systemd サービスの設定
  6. サービスの起動と確認
  7. トラブルシューティング
  8. アンインストール手順

**受入基準**:
- [x] 前提条件が明記されている
- [x] ユーザー作成コマンドが記載されている
- [x] インストール手順が完全である
- [x] 環境変数設定手順が記載されている
- [x] systemd 設定手順が記載されている
- [x] 起動・確認コマンドが記載されている
- [x] ログ確認方法が記載されている
- [x] トラブルシューティングセクションがある
- [x] アンインストール手順が記載されている

**依存関係**: タスク1.2, タスク1.3
**ステータス**: `DONE`

---

### フェーズ3: 検証とコミット

#### タスク3.1: ドキュメント整合性の確認

**説明**:
- 作成したファイルの内容を確認
- requirements.md の要件がすべてカバーされていることを確認

**受入基準**:
- [x] REQ-001〜REQ-005 のすべてがカバーされている
- [x] NFR-001〜NFR-003 のすべてがカバーされている
- [x] ファイルパスに誤りがない

**依存関係**: タスク2.1
**ステータス**: `DONE`

---

#### タスク3.2: コミットとPR作成

**説明**:
- 変更をコミット
- PR を作成

**受入基準**:
- [x] すべてのファイルがコミットされている
- [x] PR が作成されている
- [x] CI が通過している

**依存関係**: タスク3.1
**ステータス**: `DONE`

---

### フェーズ4: npx パッケージング修正

#### タスク4.1: .npmignore の追加（PR #71）

**説明**:
- `.npmignore` ファイルを作成し、ビルド成果物（`.next/`, `dist/`）が npx パッケージに含まれるようにする
- `.gitignore` がパッケージフィルタリングに使用される問題を解消

**受入基準**:
- [x] `.npmignore` ファイルが作成されている
- [x] `.next/` と `dist/` がパッケージに含まれる
- [x] `.next/cache/` は除外されている
- [x] テスト、ドキュメント等の開発ファイルは除外されている
- [x] `.npmignore` の内容を検証するユニットテストが追加されている

**依存関係**: タスク3.2
**ステータス**: `DONE`

---

#### タスク4.2: pnpm-lock.yaml の修正（PR #71）

**説明**:
- `pnpm-lock.yaml` が `package.json` と一致していなかった問題を修正
- drizzle-kit が dependencies から devDependencies に移動された変更をロックファイルに反映

**受入基準**:
- [x] `pnpm-lock.yaml` が `package.json` と一致している
- [x] CI の `ERR_PNPM_OUTDATED_LOCKFILE` エラーが解消されている

**依存関係**: タスク4.1
**ステータス**: `DONE`

---

### フェーズ5: Claude Code CLI パス検出修正

#### タスク5.1: detectClaudePath のコマンド名対応（PR #72）

**説明**:
- `detectClaudePath()` がコマンド名（非絶対パス）を受け付けるように修正
- コマンド名の場合は `which` で解決を試みる
- `.env.example` の `CLAUDE_CODE_PATH` をコメントアウトし、自動検出をデフォルトに変更

**受入基準**:
- [x] コマンド名指定時に `which` で解決される
- [x] `which` でも見つからない場合は適切なエラーを表示
- [x] `.env.example` で `CLAUDE_CODE_PATH` がコメントアウトされている
- [x] ユニットテストが追加されている

**依存関係**: タスク4.2
**ステータス**: `DONE`

---

#### タスク5.2: systemd 環境での動作確認

**説明**:
- systemd サービスが正常に起動することを確認
- `http://localhost:3000/` で HTTP 200 が返ることを確認
- `/api/health` で `{"status":"ok"}` が返ることを確認

**受入基準**:
- [x] `systemctl status claude-work` が `active (running)` を表示する
- [x] `curl http://localhost:3000/` が HTTP 200 を返す
- [x] `curl http://localhost:3000/api/health` が `{"status":"ok"}` を返す

**依存関係**: タスク5.1
**ステータス**: `DONE`

---

## タスクステータスの凡例

- `TODO` - 未着手
- `IN_PROGRESS` - 作業中
- `DONE` - 完了
