# 要件定義: Prisma から Drizzle ORM への移行

## 概要

ClaudeWorkプロジェクトにおいて、現在使用しているPrisma ORMをDrizzle ORMに完全置換する。
SQLiteデータベースは継続使用し、既存のスキーマ構造を維持しながら、より軽量でタイプセーフなORMへの移行を実現する。

## ユーザーストーリー

### ストーリー1: ORM移行による開発体験の向上

**私は** 開発者として
**〜したい** Drizzle ORMを使用してデータベース操作を行いたい
**なぜなら** より軽量で、SQLに近い直感的なAPIと、優れた型推論を活用できるから

#### 受入基準（EARS記法）

- **REQ-001**: システムはDrizzle ORMを使用してSQLiteデータベースに接続しなければならない
- **REQ-002**: システムは既存の6つのモデル（Project, Session, Message, Prompt, RunScript, ExecutionEnvironment）をDrizzleスキーマとして定義しなければならない
- **REQ-003**: システムはRelational queriesスタイル（findMany, findFirst等）でクエリを実行できなければならない
- **REQ-004**: アプリケーション起動時、開発/テスト環境ではシステムは自動的にデータベーススキーマを同期しなければならない（本番環境では明示的なマイグレーション手順で同期する）
- **REQ-005**: すべてのAPIエンドポイントがDrizzle ORMを使用してデータベース操作を行わなければならない

### ストーリー2: 型安全性の維持

**私は** 開発者として
**〜したい** Prismaと同等以上の型安全性を維持したい
**なぜなら** コンパイル時にエラーを検出し、ランタイムエラーを防ぎたいから

#### 受入基準（EARS記法）

- **REQ-006**: システムはDrizzleのスキーマから型を自動生成し、エクスポートしなければならない
- **REQ-007**: リレーション（Project-Session, Session-Message等）が型レベルで定義されなければならない
- **REQ-008**: クエリ結果が適切な型で返却されなければならない

### ストーリー3: 既存機能の完全互換

**私は** ユーザーとして
**〜したい** ORM移行後も既存機能がすべて動作することを保証したい
**なぜなら** サービス中断なく移行を完了したいから

#### 受入基準（EARS記法）

- **REQ-009**: すべての既存テストがDrizzle移行後もパスしなければならない
- **REQ-010**: Prismaに依存するコードがすべてDrizzleに置き換えられなければならない
- **REQ-011**: prisma/ディレクトリとPrisma関連の依存関係が完全に削除されなければならない

## 非機能要件

### 性能要件

- **NFR-001**: クエリパフォーマンスはPrisma使用時と同等以上でなければならない

### 保守性要件

- **NFR-002**: スキーマ定義は単一のファイルで管理されなければならない
- **NFR-003**: マイグレーション機能（drizzle-kit）が利用可能でなければならない

### 開発体験要件

- **NFR-004**: Drizzle Studioでデータベースを視覚的に確認できなければならない

## 依存関係

- drizzle-orm: Drizzle ORM本体
- drizzle-kit: マイグレーション・スキーマ管理ツール
- better-sqlite3: SQLiteドライバー（既存）
- @types/better-sqlite3: 型定義（既存）

## スコープ外

- データベースエンジンの変更（SQLiteを継続使用）
- 既存データの移行（リセット可の確認済み）
- APIレスポンス形式の変更
- 新規機能の追加
