# 要件定義: Docker統合機能

## 概要

Claude WorkプロジェクトにDockerコンテナ内でClaude Codeセッションを実行する機能を追加する。これにより、各セッションが隔離された環境で動作し、ホストシステムへの影響を防ぎながら、ホストの認証情報を再利用できるようにする。

### 背景と動機

1. **セキュリティ**: Claude Codeがホストシステムに直接アクセスすることを防ぐ
2. **再現性**: 各セッションが同一の環境で動作することを保証する
3. **認証情報の再利用**: コンテナごとに再認証する手間を省く
4. **MCPの不確実性回避**: MCPベースのcontainer-useと異なり、確実にコンテナ内で実行される

## ユーザーストーリー

### ストーリー1: Dockerコンテナ内でのセッション実行

**私は** Claude Workのユーザーとして
**〜したい** Claude Codeセッションを隔離されたDockerコンテナ内で実行
**なぜなら** ホストシステムへの予期しない変更を防ぎ、安全に作業したいから

#### 受入基準（EARS記法）

- REQ-D001: ユーザーがセッション作成時に「Dockerモード」を選択した時、システムはDockerコンテナ内でClaude Codeを起動しなければならない
- REQ-D002: Dockerモードのセッションにおいて、Claude Codeのファイル操作はコンテナ内のワークスペースに限定されなければならない
- REQ-D003: Dockerモードのセッションにおいて、コンテナ終了時にワークスペースの変更はホストのGit worktreeに反映されなければならない

### ストーリー2: ホスト認証情報の再利用

**私は** Claude Workのユーザーとして
**〜したい** ホストで認証済みのClaude認証情報をコンテナ内で再利用
**なぜなら** セッションごとに再認証する手間を省きたいから

#### 受入基準（EARS記法）

- REQ-D004: Dockerモードのセッション起動時、システムはホストの`~/.claude/`ディレクトリを読み取り専用でマウントしなければならない
- REQ-D005: Dockerモードのセッション起動時、システムはホストの`~/.config/claude/`ディレクトリを読み取り専用でマウントしなければならない
- REQ-D006: 環境変数`ANTHROPIC_API_KEY`がホストで設定されている場合、システムはこれをコンテナに引き継がなければならない
- REQ-D007: 認証情報のマウントに失敗した場合、システムはエラーメッセージを表示し、セッション作成を中止しなければならない

### ストーリー3: Git認証情報の共有

**私は** Claude Workのユーザーとして
**〜したい** ホストのGit認証情報（SSH鍵、gitconfig）をコンテナ内で使用
**なぜなら** コンテナ内からもGitリポジトリにpush/pullしたいから

#### 受入基準（EARS記法）

- REQ-D008: Dockerモードのセッション起動時、システムはホストの`~/.ssh/`ディレクトリを読み取り専用でマウントしなければならない
- REQ-D009: Dockerモードのセッション起動時、システムはホストの`~/.gitconfig`ファイルを読み取り専用でマウントしなければならない
- REQ-D010: SSH認証が必要なGit操作を行う場合、システムはホストのSSH Agentに接続できなければならない

### ストーリー4: Dockerイメージの管理

**私は** Claude Workの管理者として
**〜したい** Claude Code用のDockerイメージをビルド・管理
**なぜなら** セッション起動を高速化し、環境を統一したいから

#### 受入基準（EARS記法）

- REQ-D011: システムは専用のDockerイメージ（claude-code-sandboxed）を提供しなければならない
- REQ-D012: Dockerイメージが存在しない場合、システムは初回セッション作成時に自動的にビルドしなければならない
- REQ-D013: ユーザーが「イメージ再ビルド」を要求した時、システムは最新のClaude Codeでイメージを再構築しなければならない
- REQ-D014: Dockerイメージのビルド中、システムは進捗状況をユーザーに表示しなければならない

### ストーリー5: セッションのライフサイクル管理

**私は** Claude Workのユーザーとして
**〜したい** Dockerセッションの起動・停止・再開を管理
**なぜなら** 複数のセッションを効率的に運用したいから

#### 受入基準（EARS記法）

- REQ-D015: ユーザーがセッションを停止した時、システムはDockerコンテナを停止しなければならない
- REQ-D016: ユーザーがセッションを再開した時、システムは同じワークスペースで新しいコンテナを起動しなければならない
- REQ-D017: セッションが異常終了した場合、システムはエラー情報をログに記録し、ユーザーに通知しなければならない
- REQ-D018: システムは同時に実行可能なDockerセッション数を設定可能にしなければならない

### ストーリー6: 既存機能との統合

**私は** Claude Workのユーザーとして
**〜したい** Docker機能が既存のGit worktree管理機能と連携
**なぜなら** 並列開発のワークフローを維持したいから

#### 受入基準（EARS記法）

- REQ-D019: 各Git worktreeに対して、システムは対応するDockerセッションを作成できなければならない
- REQ-D020: Dockerセッション内での変更は、対応するGit worktreeに即座に反映されなければならない
- REQ-D021: Web UIからDockerセッションのターミナルに接続できなければならない
- REQ-D022: 既存のセッション管理API（REST/WebSocket）はDockerモードのセッションにも対応しなければならない
- REQ-D023: セッション一覧画面で、Dockerモードのセッションには視覚的に識別可能な「Docker」バッジを表示しなければならない
- REQ-D024: セッション詳細画面で、Dockerモードのセッションには「Docker」バッジを表示しなければならない

## 非機能要件

### 性能

- NFR-D001: Dockerセッションの起動時間は、イメージがキャッシュされている場合、10秒以内でなければならない
- NFR-D002: システムは最低5つのDockerセッションを同時に実行できなければならない

### セキュリティ

- NFR-D003: Claude認証情報（~/.claude/, ~/.config/claude/）はClaude Codeがdebug/ディレクトリに書き込むため読み書き可能でマウントされる。Git認証情報（~/.ssh/, ~/.gitconfig）は読み取り専用でマウントされなければならない
- NFR-D004: コンテナはホストのroot権限を取得できてはならない
- NFR-D005: コンテナからホストのファイルシステム（ワークスペース以外）にアクセスできてはならない

### 互換性

- NFR-D006: システムはDocker Engine 20.10以上で動作しなければならない
- NFR-D007: システムはDocker Composeなしでも単体で動作しなければならない
- NFR-D008: システムはLinux、macOS、WSL2環境で動作しなければならない

### 運用性

- NFR-D009: システムはDockerデーモンが起動していない場合、明確なエラーメッセージを表示しなければならない
- NFR-D010: Dockerイメージのサイズは2GB以下に抑えなければならない

## 制約条件

### 技術的制約

- C-D001: Anthropic利用規約に準拠し、認証情報は同一ユーザーの使用に限定する
- C-D002: MCPサーバーに依存せず、Process ManagerがDockerコンテナを直接管理する
- C-D003: 既存のClaude Work アーキテクチャ（Session Manager、Process Manager、Git Operations）と統合する

### 運用上の制約

- C-D004: Dockerがインストールされていない環境では、従来のホスト直接実行モードにフォールバックする
- C-D005: ネットワーク接続が必要（Claude APIへのアクセス）

### プラットフォーム固有の制約

- C-D006: macOSでは、Claude CodeはKeychainに認証情報を保存するため、Dockerコンテナから直接アクセスできない。macOSでDockerモードを使用する場合は、`ANTHROPIC_API_KEY`環境変数を設定する必要がある（API使用料金が別途発生）
- C-D007: Linux/WSL2では、Claude Codeは`~/.claude/.credentials.json`に認証情報を保存するため、ディレクトリマウントで認証情報を共有できる

## 用語定義

| 用語 | 定義 |
|------|------|
| Dockerモード | Claude CodeをDockerコンテナ内で実行するモード |
| ホスト直接実行モード | Claude Codeをホストシステム上で直接実行する従来モード |
| ワークスペース | Git worktreeに対応する作業ディレクトリ |
| claude-code-sandboxed | Claude Code実行用の専用Dockerイメージ |
| 認証情報 | `~/.claude/`、`~/.config/claude/`、`ANTHROPIC_API_KEY`を含むClaude認証データ |

## 優先度

| 優先度 | 要件ID | 説明 |
|--------|--------|------|
| P0（必須） | REQ-D001, REQ-D002, REQ-D004, REQ-D005, REQ-D011 | コア機能 |
| P1（重要） | REQ-D003, REQ-D006, REQ-D015, REQ-D016, REQ-D019, REQ-D020 | 主要ワークフロー |
| P2（推奨） | REQ-D007, REQ-D008, REQ-D009, REQ-D012, REQ-D013, REQ-D021, REQ-D022, REQ-D023, REQ-D024 | 利便性向上 |
| P3（将来） | REQ-D010, REQ-D014, REQ-D017, REQ-D018 | 拡張機能 |
