# 要件定義: 実行環境（Execution Environments）機能

## 概要

Claude Workプロジェクトに「実行環境」という抽象化レイヤーを導入し、Claude CodeセッションをHOST（ローカル）、Dockerコンテナ、または将来的なリモート環境（SSH）で実行できるようにする。

### 背景と動機

1. **環境分離**: セッションごとに異なる実行環境を選択し、プロジェクトの要件に応じた環境で作業可能
2. **認証情報の独立性**: Dockerコンテナごとに独立したClaude Code認証を行い、認証情報の共有を防ぐ
3. **データ永続化**: Volumeを使用してコンテナ内にデータを永続化せず、ホスト側で管理
4. **拡張性**: 将来的にSSHリモート環境をサポートできる設計
5. **環境管理**: UIから実行環境の追加・削除・設定変更が可能

### 既存Docker統合機能との関係

現在のDocker統合機能（`docker_mode`, `container_id`フィールド）は、Session単位でDocker実行を選択する簡易的な実装である。本機能では以下を拡張する：

- 「実行環境」エンティティを導入し、セッションから分離
- 環境ごとに独立した認証情報を管理
- 環境の設定（イメージ名、Volume設定等）を永続化
- 環境管理UIを提供

## ユーザーストーリー

### ストーリー1: 実行環境の選択

**私は** Claude Workのユーザーとして
**〜したい** セッション作成時に実行環境を選択
**なぜなら** プロジェクトや作業内容に応じて適切な環境で作業したいから

#### 受入基準（EARS記法）

- REQ-EE001: セッション作成時、システムは利用可能な実行環境の一覧を表示しなければならない
- REQ-EE002: ユーザーが実行環境を選択した時、システムはその環境でClaude Codeを起動しなければならない
- REQ-EE003: 実行環境が指定されない場合、システムはデフォルト環境（HOST）を使用しなければならない

### ストーリー2: Docker実行環境の認証

**私は** Claude Workのユーザーとして
**〜したい** Dockerコンテナごとに独立したClaude Code認証を行う
**なぜなら** 環境ごとに異なるアカウントや認証情報を使い分けたいから

#### 受入基準（EARS記法）

- REQ-EE004: Docker実行環境を作成した時、システムはその環境専用の認証情報ディレクトリを作成しなければならない
- REQ-EE005: Docker実行環境でClaude Codeを起動した時、システムはその環境専用の認証情報をマウントしなければならない
- REQ-EE006: Docker実行環境内でClaude Code認証を行った時、認証情報はその環境専用のディレクトリに保存されなければならない
- REQ-EE007: 認証情報ディレクトリはVolumeを使用してホスト側で永続化されなければならない

### ストーリー3: 実行環境の管理

**私は** Claude Workの管理者として
**〜したい** 実行環境を追加・編集・削除
**なぜなら** プロジェクトの要件に応じて環境を構成したいから

#### 受入基準（EARS記法）

- REQ-EE008: ユーザーが環境管理画面を開いた時、システムは登録済みの実行環境一覧を表示しなければならない
- REQ-EE009: ユーザーがDocker実行環境を追加した時、システムは環境設定（名前、イメージ名、Volume設定）を保存しなければならない
- REQ-EE010: ユーザーが実行環境を削除した時、システムは確認ダイアログを表示しなければならない
- REQ-EE011: 実行環境を削除した時、システムはその環境を使用しているセッションがあれば警告を表示しなければならない
- REQ-EE012: HOST実行環境（デフォルト環境）は削除できてはならない

### ストーリー4: Volume設定によるデータ永続化

**私は** Claude Workのユーザーとして
**〜したい** Dockerコンテナ内のデータをVolumeで永続化
**なぜなら** コンテナを再作成してもデータを保持したいから

#### 受入基準（EARS記法）

- REQ-EE013: Docker実行環境において、ワークスペース（Git worktree）はbindマウントで共有されなければならない
- REQ-EE014: Docker実行環境において、認証情報はnamed volumeまたはbindマウントで永続化されなければならない
- REQ-EE015: Docker実行環境において、コンテナ内の一時ファイルはコンテナ終了時に削除されなければならない

### ストーリー5: 実行環境の状態確認

**私は** Claude Workのユーザーとして
**〜したい** 実行環境の状態（利用可能、認証済み等）を確認
**なぜなら** 環境が正しく設定されているか把握したいから

#### 受入基準（EARS記法）

- REQ-EE016: Docker実行環境において、システムはDockerデーモンの起動状態を表示しなければならない
- REQ-EE017: Docker実行環境において、システムはイメージの存在有無を表示しなければならない
- REQ-EE018: Docker実行環境において、システムは認証状態（認証済み/未認証）を表示しなければならない
- REQ-EE019: HOST実行環境において、システムは常に「利用可能」と表示しなければならない

### ストーリー7: Dockerイメージの設定

**私は** Claude Workのユーザーとして
**〜したい** Docker環境で使用するイメージを自由に設定
**なぜなら** プロジェクトに適した環境を構築したいから

#### 受入基準（EARS記法）

- REQ-EE023: Docker環境作成時、システムはイメージソースの選択肢（既存イメージ/Dockerfileビルド）を提供しなければならない
- REQ-EE024: 既存イメージ選択時、システムはローカルに存在するDockerイメージ一覧をドロップダウンで表示しなければならない
- REQ-EE025: 既存イメージ選択時、システムはカスタムイメージ名の直接入力も許可しなければならない
- REQ-EE026: Dockerfileビルド選択時、システムはDockerfileをブラウザからアップロードできるフォームを提供しなければならない
- REQ-EE027: Dockerfileビルド選択時、環境作成時にシステムはアップロードされたDockerfileからイメージをビルドしなければならない
- REQ-EE028: 環境カードにおいて、システムは使用中のイメージ名（またはDockerfileアップロード済みの表示）を表示しなければならない
- REQ-EE030: アップロードされたDockerfileは環境専用ディレクトリ（data/environments/<env-id>/Dockerfile）に保存されなければならない
- REQ-EE031: 環境削除時、アップロードされたDockerfileも一緒に削除されなければならない
- REQ-EE029: イメージソースの変更（既存イメージ/Dockerfile）は排他的でなければならない

### ストーリー6: 将来的なSSHリモート環境のサポート

**私は** Claude Workの開発者として
**〜したい** 将来的にSSHリモート環境をサポートできる設計
**なぜなら** リモートサーバーでClaude Codeを実行したいユーザーがいるから

#### 受入基準（EARS記法）

- REQ-EE020: 実行環境の抽象化は、HOST、Docker、SSHの各実装を交換可能に設計されなければならない
- REQ-EE021: 実行環境のインターフェースは、接続・切断・コマンド実行・状態確認を含まなければならない
- REQ-EE022: 環境タイプ（type）フィールドは拡張可能な列挙型として設計されなければならない

## 非機能要件

### 性能

- NFR-EE001: 実行環境一覧の取得は1秒以内に完了しなければならない
- NFR-EE002: Docker実行環境の状態チェック（デーモン起動確認）は3秒以内に完了しなければならない

### セキュリティ

- NFR-EE003: 各Docker実行環境の認証情報は、他の環境からアクセスできてはならない
- NFR-EE004: 認証情報ディレクトリのパーミッションは700（所有者のみ）でなければならない
- NFR-EE005: Volume設定においてホストの任意のパスへのアクセスを防止しなければならない

### データ整合性

- NFR-EE006: 実行環境の削除時、関連するセッションの`environment_id`はNULLに設定されなければならない
- NFR-EE007: セッションの`environment_id`がNULLの場合、システムはデフォルト環境（HOST）を使用しなければならない

### 拡張性

- NFR-EE008: 新しい実行環境タイプ（SSH等）を追加する際、既存のコードへの影響を最小限に抑えられなければならない

## 制約条件

### 技術的制約

- C-EE001: 既存のSessionモデルとの互換性を維持する（`docker_mode`と`container_id`は段階的に非推奨化）
- C-EE002: 既存のDockerService、DockerPTYAdapterを再利用・拡張する
- C-EE003: 環境タイプはHOST、DOCKERの2種類から開始し、将来SSHを追加できる設計とする

### 運用上の制約

- C-EE004: Dockerがインストールされていない環境でもHOST実行環境は利用可能
- C-EE005: 環境ごとの認証情報ディレクトリは`data/environments/<env-id>/`に配置

### 移行制約

- C-EE006: 既存の`docker_mode=true`のセッションは、マイグレーション時にDocker環境に自動マッピング

## 用語定義

| 用語 | 定義 |
|------|------|
| 実行環境（Execution Environment） | Claude Codeを実行する環境の抽象化。HOST、Docker、SSHなど |
| HOST環境 | ローカルホスト上で直接Claude Codeを実行する環境 |
| Docker環境 | Dockerコンテナ内でClaude Codeを実行する環境 |
| SSH環境（将来） | SSHでリモートサーバーに接続してClaude Codeを実行する環境 |
| 環境認証情報ディレクトリ | 各Docker環境専用の認証情報を保存するディレクトリ |
| デフォルト環境 | 環境が指定されない場合に使用されるHOST環境 |

## 優先度

| 優先度 | 要件ID | 説明 |
|--------|--------|------|
| P0（必須） | REQ-EE001, REQ-EE002, REQ-EE003, REQ-EE004, REQ-EE005, REQ-EE006, REQ-EE007 | コア機能 |
| P1（重要） | REQ-EE008, REQ-EE009, REQ-EE010, REQ-EE011, REQ-EE012, REQ-EE013, REQ-EE014 | 環境管理・永続化 |
| P2（推奨） | REQ-EE015, REQ-EE016, REQ-EE017, REQ-EE018, REQ-EE019 | 状態確認 |
| P3（将来） | REQ-EE020, REQ-EE021, REQ-EE022 | SSH拡張準備 |
| P1（重要） | REQ-EE023, REQ-EE024, REQ-EE025, REQ-EE026, REQ-EE027, REQ-EE028, REQ-EE029 | Dockerイメージ設定 |
