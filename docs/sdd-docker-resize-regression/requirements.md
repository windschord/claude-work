# 要件定義書: Docker環境ターミナルリサイズ回帰修正

## 背景

PR#87でDocker環境のターミナル描画不具合（遅延リサイズ）を修正したが、PR#91でDocker環境のターミナル入力不能を修正した際に、PR#87の問題が再発した。Docker環境でClaude Code起動時にASCIIアートのみ表示され、入力プロンプトが描画されない。

## 根本原因分析

3つの独立した問題が重なって発生している:

1. **WebSocketメッセージ競合**: `claude-ws.ts`のメッセージハンドラー登録前にクライアントのリサイズメッセージが到着・破棄される
2. **遅延リサイズのガード条件**: 初回出力時に`lastKnownCols`/`lastKnownRows`が未設定の場合、遅延リサイズがスケジュールされない
3. **restartSessionでのリサイズ情報消失**: セッション再作成時に旧セッションのリサイズ情報が引き継がれない

## ユーザーストーリー

Docker環境でClaude Codeセッションを使用するユーザーとして、
セッション作成時および再起動時に、ターミナルの入力プロンプトが正しく表示されることを望む。
それにより、Claude Codeとの対話を中断なく行える。

## 機能要件

### REQ-001: WebSocketリサイズメッセージの早期バッファリング

WebSocket接続時、セッション作成の`await`処理より前に`ws.on('message', ...)`ハンドラーを登録し、リサイズメッセージをバッファリングしなければならない。セッション作成完了後、バッファされたリサイズを適用しなければならない。

**受入基準:**
- WebSocket接続直後のリサイズメッセージが消失しない
- セッション作成前に到着したリサイズが、作成後に適用される
- input/restart等の他メッセージタイプも正しく処理される

### REQ-002: 遅延リサイズの無条件スケジューリング

Docker環境（非shellMode）の初回出力受信時、`lastKnownCols`/`lastKnownRows`の設定状態に関わらず、遅延リサイズをスケジュールしなければならない。値のチェックはsetTimeoutコールバック内で行う。

**受入基準:**
- 初回出力受信時に`lastKnownCols`/`lastKnownRows`が未設定でも遅延リサイズがスケジュールされる
- 1秒後のコールバック実行時に値が設定されていればリサイズが適用される
- shellModeセッションでは遅延リサイズがスケジュールされない

### REQ-003: restartSessionでのリサイズ情報保存・復元

`restartSession()`は、旧セッションの`lastKnownCols`/`lastKnownRows`を保存し、新セッション作成後に復元しなければならない。

**受入基準:**
- restartSession実行後、新セッションに旧セッションのリサイズ情報が引き継がれる
- 旧セッションにリサイズ情報がない場合はエラーにならない
- shellModeのrestartでもリサイズ情報が引き継がれる

## 非機能要件

### NFR-001: HOST環境への非影響

HOST環境（HostAdapter）の動作に影響を与えてはならない。

### NFR-002: 既存テストの非回帰

既存のDockerAdapter/HostAdapterテストが全てパスしなければならない。

### NFR-003: タイミング制約

遅延リサイズのタイムアウト（1秒）は変更しない。
