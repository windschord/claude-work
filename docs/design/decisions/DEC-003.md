# DEC-003: タイムアウトを5分にする理由

## ステータス
承認済み

## コンテキスト

git clone処理のデフォルトタイムアウト値を決定する必要がある。

### 考慮事項
- リポジトリのサイズは様々（小規模: 10MB、中規模: 100MB、大規模: 1GB以上）
- ネットワーク速度はユーザーごとに異なる
- Docker環境では初回イメージpullのオーバーヘッドがある
- タイムアウトが短すぎると、大規模リポジトリのcloneが失敗する
- タイムアウトが長すぎると、失敗時のフィードバックが遅れる

## 決定事項

**git clone処理のデフォルトタイムアウト値を5分（300秒）にする。**

ただし、ユーザーが設定で変更可能（1分〜30分）。

## 理由

### 1. 中規模リポジトリに十分な時間

**中規模リポジトリ（100MB）の場合**:
- ホスト環境: 1〜2分
- Docker環境（初回イメージpull含む）: 2〜3分

**5分のタイムアウトであれば**:
- 中規模リポジトリのcloneが安定して成功
- Docker環境のオーバーヘッドも吸収

### 2. Docker環境のオーバーヘッドを考慮

**Docker環境でのオーバーヘッド**:
- alpine/gitイメージのpull（初回のみ）: 10〜30秒
- コンテナ起動: 2〜5秒
- ボリュームI/O: ホスト環境と同等

**5分のタイムアウト**:
- 初回イメージpullを含めても、中規模リポジトリのcloneが完了

### 3. 失敗時のフィードバックを適切に

**タイムアウトが短すぎる場合（例: 1分）**:
- 中規模リポジトリでもタイムアウトする可能性
- Docker環境では確実にタイムアウト

**タイムアウトが長すぎる場合（例: 30分）**:
- 失敗時のフィードバックが遅れる
- ユーザーが長時間待たされる

**5分のバランス**:
- 中規模リポジトリのcloneに十分
- 失敗時も適切な時間でフィードバック

### 4. ユーザーの要望

ユーザーからの明示的な要望:
> default5分で設定で可変に出来るようにして欲しい

### 5. 設定で変更可能

**大規模リポジトリの場合**:
- ユーザーが設定でタイムアウトを10分、20分などに変更可能
- 柔軟性を保ちつつ、デフォルト値は妥当な範囲に設定

## 代替案

### 案A: デフォルト1分
**メリット**:
- 小規模リポジトリで高速フィードバック

**デメリット**:
- 中規模リポジトリでタイムアウトする可能性が高い
- Docker環境ではほぼ確実にタイムアウト

**却下理由**: Docker環境のデフォルトとの整合性がないため。

### 案B: デフォルト10分
**メリット**:
- 大規模リポジトリにも対応

**デメリット**:
- 失敗時のフィードバックが遅れる
- 多くのケースでオーバースペック

**却下理由**: 5分で十分なケースが多く、10分は長すぎるため。

### 案C: デフォルトなし（ユーザーに選択を強制）
**メリット**:
- ユーザーが明示的に選択

**デメリット**:
- 初心者に優しくない
- デフォルト値がないと判断に迷う

**却下理由**: ユーザーエクスペリエンスが損なわれるため。

## 影響

### ポジティブ
- 中規模リポジトリのcloneが安定して成功
- Docker環境でのオーバーヘッドを吸収
- 失敗時のフィードバックが適切な時間で得られる

### ネガティブ
- 大規模リポジトリ（1GB以上）の場合、設定変更が必要

### リスク緩和
- 設定変更のUIを提供
- タイムアウトエラー時に設定変更へのリンクを表示
- ドキュメントに推奨値を記載

## 実装

### 設定ファイル（data/settings.json）
```json
{
  "git_clone_timeout_minutes": 5
}
```

### バリデーション
```typescript
function validateTimeoutMinutes(minutes: number): boolean {
  return minutes >= 1 && minutes <= 30;
}
```

### タイムアウト処理
```typescript
const timeout = getTimeoutMinutes() * 60 * 1000; // ミリ秒に変換
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), timeout);

try {
  await execFile('git', ['clone', url, path], {
    signal: controller.signal
  });
} catch (error) {
  if (error.name === 'AbortError') {
    throw new GitOperationError(
      `git clone timed out after ${getTimeoutMinutes()} minutes`,
      environment,
      'clone',
      true // recoverable
    );
  }
} finally {
  clearTimeout(timeoutId);
}
```

## 注記

### ネットワーク速度の影響
デフォルト値（5分）は、一般的なブロードバンド接続（10Mbps以上）を前提としている。低速なネットワーク環境では、タイムアウト値の調整が必要。

### リポジトリサイズの影響
デフォルト値（5分）は、中規模リポジトリ（100MB以下）を前提としている。大規模リポジトリ（1GB以上）では、タイムアウト値の調整が必要。

### 将来の改善
- リポジトリサイズに基づく自動的なタイムアウト値の調整
- ネットワーク速度を考慮したタイムアウト値の推奨

## 参照

- requirements/stories/US-006.md: タイムアウト設定の管理
- requirements/nfr/performance.md: パフォーマンス要件
- design/components/config-service.md: 設定管理
