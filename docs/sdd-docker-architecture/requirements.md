# 要件定義: Dockerコンテナオーケストレーション型アーキテクチャ移行

## 概要

ClaudeWorkのアーキテクチャを、従来の「npxによるローカル直接実行モデル」から「Dockerコンテナオーケストレーション型（Cloud IDEモデル）」へ移行する。

### 目的

1. **環境の隔離**: 複数のClaude Codeセッションを並列実行しても、ファイルシステムやプロセスが競合しない
2. **環境の再現性**: ホストOSの汚れを排除し、常にクリーンな状態で作業を開始
3. **権限の安全な委譲**: ホスト側の認証情報を安全に引き継ぎつつ、破壊的操作の影響をコンテナ内に封じ込める

---

## ユーザーストーリー

### ストーリー1: セッション作成

**私は** ClaudeWorkユーザーとして
**〜したい** GitHubリポジトリURLとブランチ名を入力してセッションを作成
**なぜなら** 隔離された環境でClaude Codeを使ってコーディングしたいから

#### 受入基準（EARS記法）

- **REQ-001**: ユーザーがリポジトリURLとブランチ名を入力してセッション作成ボタンをクリックした時、システムは新しいDockerコンテナを起動し、指定されたリポジトリをクローンしなければならない
- **REQ-002**: コンテナ起動が完了した時、システムはWebSocket経由でターミナル接続を確立し、ユーザーにシェルプロンプトを表示しなければならない
- **REQ-003**: もしリポジトリURLが不正な場合、システムはエラーメッセージを表示しなければならない
- **REQ-004**: もしDockerデーモンが起動していない場合、システムはDocker起動を促すエラーメッセージを表示しなければならない

### ストーリー2: 認証情報の引き継ぎ

**私は** ClaudeWorkユーザーとして
**〜したい** ホストの認証情報（Claude、Git、SSH）をコンテナ内で利用
**なぜなら** 追加の認証設定なしでClaude CodeとGitを使いたいから

#### 受入基準（EARS記法）

- **REQ-005**: コンテナ起動時、システムはホストの`~/.claude/`ディレクトリを読み取り専用でマウントしなければならない
- **REQ-006**: コンテナ起動時、システムはホストの`~/.gitconfig`を読み取り専用でマウントしなければならない
- **REQ-007**: コンテナ起動時、システムはSSH Agent Socketをフォワードしなければならない
- **REQ-008**: コンテナ内で`claude`コマンドを実行した時、ホストのClaude認証情報を使用して動作しなければならない
- **REQ-009**: コンテナ内で`git push`を実行した時、SSH Agent経由でGitHubに認証されなければならない

### ストーリー3: 並列セッション実行

**私は** ClaudeWorkユーザーとして
**〜したい** 複数のセッションを同時に実行
**なぜなら** 異なるリポジトリやブランチで並行して作業したいから

#### 受入基準（EARS記法）

- **REQ-010**: ユーザーが新しいセッションを作成した時、システムは既存セッションに影響を与えずに独立したコンテナを起動しなければならない
- **REQ-011**: 各セッションの間、ファイルシステムとプロセスは完全に隔離されなければならない
- **REQ-012**: セッション一覧画面において、システムはすべてのアクティブセッションを表示しなければならない

### ストーリー4: セッション終了とレジューム

**私は** ClaudeWorkユーザーとして
**〜したい** セッションを終了しても作業内容を保持し、後でレジューム
**なぜなら** 作業を中断しても続きから再開したいから

#### 受入基準（EARS記法）

- **REQ-013**: セッションのワークディレクトリはDocker Volumeに永続化され、コンテナ再起動後も保持されなければならない
- **REQ-014**: ユーザーがセッションを終了しようとした時、もし未コミットの変更がある場合、システムは警告を表示しなければならない
- **REQ-015**: ユーザーがセッションを終了しようとした時、もし未プッシュのコミットがある場合、システムは警告を表示しなければならない
- **REQ-016**: ユーザーが停止済みセッションを選択した時、システムはコンテナを再起動して前回の状態からレジュームできなければならない

### ストーリー5: セッション削除

**私は** ClaudeWorkユーザーとして
**〜したい** 不要なセッションを完全に削除
**なぜなら** ディスク容量を解放したいから

#### 受入基準（EARS記法）

- **REQ-017**: ユーザーがセッション削除を実行した時、システムはコンテナと関連するVolumeを削除しなければならない
- **REQ-018**: 削除前に、もし未プッシュの変更がある場合、システムは確認ダイアログを表示しなければならない

---

## 非機能要件

### 性能要件

- **NFR-001**: コンテナの起動時間は、リポジトリクローンを除いて10秒以内でなければならない
- **NFR-002**: システムは同時に最低5つのセッション（コンテナ）をサポートしなければならない
- **NFR-003**: WebSocketのレイテンシは100ms以下でなければならない

### セキュリティ要件

- **NFR-004**: ホストの認証情報は読み取り専用でマウントされなければならない
- **NFR-005**: コンテナはホストのルートファイルシステムにアクセスできてはならない
- **NFR-006**: アプリケーション層での認証は実装せず、外部レイヤー（プロキシ/VPN）での保護を前提とする

### 信頼性要件

- **NFR-007**: コンテナがクラッシュした場合、システムはエラーを検知してユーザーに通知しなければならない
- **NFR-008**: ホストが再起動した場合、既存のVolumeは保持され、セッションを再作成できなければならない

### ユーザビリティ要件

- **NFR-009**: Dockerが未インストールの場合、システムはインストール手順を案内しなければならない
- **NFR-010**: コンテナ起動中、システムは進捗状況を表示しなければならない

---

## 依存関係

| 依存関係 | 説明 |
|---------|------|
| Docker Engine | ホストマシンにDockerがインストールされていること |
| Node.js 22 LTS | ホスト側のNext.jsサーバー実行環境 |
| dockerode | Node.js用Docker SDK |
| node-pty | ターミナルセッション管理 |
| SSH Agent | SSHキーの認証転送に必要 |
| Claude CLI | コンテナ内でClaude Codeを実行するため |

---

## スコープ外

以下は本仕様に含まれない：

1. **アプリケーション層での認証機能** - 外部プロキシ/VPNで保護される前提
2. **既存のGit Worktreeベースの実装** - 完全に置き換える（削除）
3. **コンテナ内でのBridge Server** - docker exec経由で接続するため不要
4. **Kubernetes対応** - 将来の拡張として検討
5. **リモートDockerホスト対応** - ローカルDockerのみを対象

---

## 用語集

| 用語 | 定義 |
|-----|------|
| Control Plane | Next.jsサーバー。コンテナのライフサイクル管理を担当 |
| Data Plane | セッションごとのDockerコンテナ。Claude Code実行環境 |
| Session | 1つのリポジトリ/ブランチに対応する作業環境（＝1コンテナ） |
| Volume | Docker永続ボリューム。セッションのワークディレクトリを保存 |
