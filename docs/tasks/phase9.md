# フェーズ9: マージ後バグ修正

*推定期間: 95分（AIエージェント作業時間）*
*MVP: Yes*

## 概要

Phase 8のマージ後に発見された3つの問題を修正します。
すべてのタスクはTDD（テスト駆動開発）で実装します。

**参照**: `post-merge-review-findings.md`

---

## タスク9.1: トースト通知の表示修正

**優先度**: High
**推定工数**: 20分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

react-hot-toastは実装されているが、Toasterコンポーネントが配置されていないため、トースト通知が画面に表示されない問題を修正します。

**ファイル**: `src/app/layout.tsx`

**現在の状態**:
- react-hot-toastがインストール済み
- コンポーネント内で`toast.error()`や`toast.success()`を呼び出しているが、画面に表示されない
- `<Toaster />`コンポーネントが配置されていない

**期待される動作**:
- プロジェクト追加成功時にトースト通知が表示される
- エラー発生時にトースト通知が表示される
- トースト通知はreact-hot-toastのデフォルト設定（上部中央）を使用

### 実装手順（TDD）

1. **テスト作成**: `src/app/layout.test.tsx`にテストケースを作成
   - レイアウトに`<Toaster />`コンポーネントが含まれていることを検証
2. **テスト実行**: テストが失敗することを確認
3. **テストコミット**: テストのみをコミット（`test: Toasterコンポーネント配置のテストを追加`）
4. **実装**: `src/app/layout.tsx`にToasterコンポーネントを追加
   ```typescript
   import { Toaster } from 'react-hot-toast';

   export default function RootLayout({ children }: { children: React.ReactNode }) {
     return (
       <html lang="ja">
         <body>
           {children}
           <Toaster />
         </body>
       </html>
     );
   }
   ```
5. **テスト実行**: すべてのテストが通過することを確認
6. **実装コミット**: 実装をコミット（`fix: Toasterコンポーネントを配置してトースト通知を表示`）

### 受入基準

- [ ] `src/app/layout.test.tsx`が存在する
- [ ] テストにToasterコンポーネントの存在確認が含まれている
- [ ] テストのみのコミットが存在する
- [ ] `src/app/layout.tsx`に`<Toaster />`コンポーネントが追加されている
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザでプロジェクト追加時にトースト通知が表示される
- [ ] 実装のコミットが存在する

### 依存関係

なし

---

## タスク9.2: プロジェクト「開く」ボタンの修正

**優先度**: High
**推定工数**: 35分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

プロジェクト一覧画面の「開く」ボタンをクリックしてもセッション管理画面に遷移しない問題を修正します。

**関連ファイル**: `src/components/projects/`配下のプロジェクトカードコンポーネント

**現在の動作**:
- プロジェクト一覧の「開く」ボタンをクリックしても何も起こらない
- サイドバーの「セッション」ボタンからは正常に遷移できる
- コンソールエラーなし

**期待される動作**:
- 「開く」ボタンをクリックすると `/projects/{project_id}` に遷移する
- クリック時にローディング状態を表示（オプション）

### 実装手順（TDD）

1. **コンポーネント特定**: `src/components/projects/`配下でプロジェクトカードコンポーネントを探す
   - Grepで「開く」ボタンの実装箇所を特定
2. **テスト作成**: 該当コンポーネントのテストファイルにテストケースを追加
   - 「開く」ボタンクリック時に`router.push()`が呼び出されることを検証
   - 正しいパス（`/projects/{project_id}`）に遷移することを検証
3. **テスト実行**: テストが失敗することを確認
4. **テストコミット**: テストのみをコミット（`test: プロジェクト開くボタンのナビゲーションテストを追加`）
5. **実装**: クリックハンドラーを修正
   ```typescript
   import { useRouter } from 'next/navigation';

   const router = useRouter();

   const handleOpen = () => {
     router.push(`/projects/${project.id}`);
   };

   <button onClick={handleOpen}>開く</button>
   ```
6. **テスト実行**: すべてのテストが通過することを確認
7. **実装コミット**: 実装をコミット（`fix: プロジェクト開くボタンのナビゲーションを修正`）

### 受入基準

- [ ] プロジェクトカードコンポーネントが特定されている
- [ ] コンポーネントのテストファイルにテストケースが2つ以上追加されている
- [ ] テストのみのコミットが存在する
- [ ] 「開く」ボタンのクリックハンドラーが実装されている
- [ ] `useRouter`を使用して正しいパスに遷移する
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザで「開く」ボタンをクリックするとセッション管理画面に遷移する
- [ ] 実装のコミットが存在する

### 依存関係

なし

---

## タスク9.3: Claude Codeパス設定機能の追加

**優先度**: High
**推定工数**: 40分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

Claude Codeコマンドが見つからない問題に対応し、環境変数でClaude Codeのパスを指定可能にします。また、エラーメッセージをより分かりやすく改善します。

**関連ファイル**: プロセスマネージャー（`src/services/`配下）

**現在の動作**:
```
⨯ uncaughtException: [Error: spawn claude ENOENT] {
  errno: -2,
  code: 'ENOENT',
  syscall: 'spawn claude',
  path: 'claude',
  spawnargs: [Array]
}
Failed to start Claude Code process
```

**期待される動作**:
- 環境変数`CLAUDE_CODE_PATH`でClaude Codeのパスを指定可能
- デフォルトは`'claude'`（PATHから探す）
- Claude Codeが見つからない場合、「Claude Codeが見つかりません。環境変数を確認してください」というエラーメッセージを表示

### 実装手順（TDD）

1. **プロセスマネージャー特定**: `src/services/`配下でClaude Codeプロセスを起動している箇所を探す
   - Grepで`spawn`を検索し、該当ファイルを特定
2. **テスト作成**: プロセスマネージャーのテストファイルにテストケースを追加
   - `CLAUDE_CODE_PATH`環境変数が設定されている場合、その値を使用することを検証
   - `CLAUDE_CODE_PATH`が未設定の場合、デフォルト値`'claude'`を使用することを検証
   - ENOENTエラー発生時、適切な日本語エラーメッセージがスローされることを検証
3. **テスト実行**: テストが失敗することを確認
4. **テストコミット**: テストのみをコミット（`test: Claude Codeパス設定とエラーハンドリングのテストを追加`）
5. **実装**: プロセスマネージャーを修正
   ```typescript
   const claudeCodePath = process.env.CLAUDE_CODE_PATH || 'claude';

   try {
     const process = spawn(claudeCodePath, args, options);
   } catch (error) {
     if (error.code === 'ENOENT') {
       throw new Error(
         'Claude Codeが見つかりません。環境変数CLAUDE_CODE_PATHを確認してください'
       );
     }
     throw error;
   }
   ```
6. **環境変数ドキュメント更新**: `.env.example`に`CLAUDE_CODE_PATH`の説明を追加
7. **テスト実行**: すべてのテストが通過することを確認
8. **実装コミット**: 実装をコミット（`fix: Claude Codeパスの環境変数設定とエラーメッセージを改善`）

### 受入基準

- [ ] プロセスマネージャーファイルが特定されている
- [ ] テストファイルにテストケースが3つ以上追加されている
- [ ] テストのみのコミットが存在する
- [ ] 環境変数`CLAUDE_CODE_PATH`が実装されている
- [ ] デフォルト値として`'claude'`が使用されている
- [ ] ENOENTエラー時に適切な日本語メッセージがスローされる
- [ ] `.env.example`に`CLAUDE_CODE_PATH`の説明が追加されている
- [ ] すべてのテストが通過する（`npm test`）
- [ ] 実装のコミットが存在する

### 依存関係

なし

---

## フェーズ完了条件

- [ ] すべてのタスク（9.1〜9.3）が完了している
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザでトースト通知が表示される
- [ ] プロジェクト一覧の「開く」ボタンが動作する
- [ ] Claude Codeパスが環境変数で設定可能になっている
- [ ] 各タスクのコミットメッセージがConventional Commitsに従っている
- [ ] TDDサイクル（テストコミット→実装コミット）が守られている

## 備考

### TDDの重要性

このフェーズではすべてのタスクでTDD（テスト駆動開発）を採用します。
バグ修正において、テストを先に書くことで：
- バグの再現条件を明確にできる
- 修正後の回帰を防げる
- 修正の妥当性を検証できる

### エラーメッセージの一貫性

すべてのエラーメッセージは日本語で統一します。
ユーザー向けメッセージとして分かりやすさを重視します。

### 環境変数のドキュメント

`.env.example`ファイルに新しい環境変数を必ず記載し、設定方法を明確にします。

### ブラウザでの動作確認

各タスク完了後、必ずブラウザで実際に動作を確認してください：
- タスク9.1: プロジェクト追加時にトースト通知が表示されるか
- タスク9.2: 「開く」ボタンでセッション管理画面に遷移するか
- タスク9.3: （Claude Codeがインストールされている環境で）セッション作成が成功するか、または適切なエラーメッセージが表示されるか
