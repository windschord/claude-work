# フェーズ10: 動作確認で発見されたバグ修正

*推定期間: 120分（AIエージェント作業時間）*
*MVP: Yes*

## 概要

Phase 9のマージ後、nodejs-architectureブランチでの動作確認で発見された問題を修正します。
すべてのタスクはTDD（テスト駆動開発）で実装します。

**参照**: `verification-report.md`

---

## タスク10.1: セッション作成500エラーの原因調査

**優先度**: Critical
**推定工数**: 30分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

セッション作成リクエスト（POST /api/projects/{project_id}/sessions）が500エラーで失敗する問題の原因を調査します。

**エラー詳細**:
```
POST http://localhost:3000/api/projects/bb75e609-4e1a-4167-a11e-0e461a878934/sessions
Status: 500 Internal Server Error

Request Body:
{
  "name": "テストセッション",
  "prompt": "Hello, Claude! これはテストです。",
  "model": "auto"
}

Response Body:
{
  "error": "Internal server error"
}
```

**調査項目**:
1. サーバーログの確認（コンソールまたはログファイル）
2. データベース接続の確認
3. Git worktree作成の成否確認
4. 環境変数の設定確認（CLAUDE_CODE_PATH、DATABASE_URLなど）
5. Prismaクライアントの初期化状態確認

### 実装手順

1. **サーバーログ確認**: 実行中のサーバープロセスのログを確認
   ```bash
   # サーバープロセスのログを確認
   # コンソールに出力されているエラーを記録
   ```

2. **データベース確認**: Prismaクライアントの動作確認
   ```bash
   # データベースファイルの存在確認
   ls -la prisma/data/dev.db

   # Prismaスタジオでデータを確認
   npx prisma studio
   ```

3. **環境変数確認**: 必要な環境変数が設定されているか確認
   ```bash
   # .envファイルの内容確認
   cat .env

   # 必須環境変数
   # - DATABASE_URL
   # - CLAUDE_CODE_PATH（オプション）
   ```

4. **Git worktree確認**: Git worktreeディレクトリの作成権限確認
   ```bash
   # worktreeディレクトリの確認
   ls -la .worktrees/

   # 作成権限の確認
   mkdir -p .worktrees/test-session
   rmdir .worktrees/test-session
   ```

5. **エラー原因の特定**: 上記調査結果から根本原因を特定
   - ログに記録されているスタックトレースを分析
   - エラーが発生している行番号とファイルを特定
   - エラーの種類（データベースエラー、ファイルシステムエラー、プロセス起動エラーなど）を分類

6. **調査レポート作成**: `session-creation-error-investigation.md`に調査結果を記録
   ```markdown
   # セッション作成エラー調査レポート

   ## エラー概要
   [エラーの概要]

   ## 調査結果
   ### サーバーログ
   [ログの内容]

   ### データベース状態
   [データベースの状態]

   ### 環境変数
   [環境変数の設定状況]

   ### Git worktree
   [worktreeの状態]

   ## 根本原因
   [特定された原因]

   ## 推奨される修正方法
   [修正方法の提案]
   ```

### 受入基準

- [ ] サーバーログが確認され、エラーメッセージが記録されている
- [ ] データベース接続が確認されている
- [ ] 環境変数の設定状況が確認されている
- [ ] Git worktreeディレクトリの権限が確認されている
- [ ] 根本原因が特定されている
- [ ] `session-creation-error-investigation.md`に調査結果が記録されている
- [ ] 次のタスク（10.2）に必要な情報が揃っている

### 依存関係

なし

---

## タスク10.2: セッション作成機能の修正

**優先度**: Critical
**推定工数**: 40分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

タスク10.1で特定された原因に基づき、セッション作成機能を修正します。

**ファイル**: `src/app/api/projects/[project_id]/sessions/route.ts`、関連ファイル

**期待される動作**:
- セッション作成リクエストが正常に処理される
- Git worktreeとブランチが正しく作成される
- セッション情報がデータベースに保存される
- 201ステータスコードとセッション情報が返される

### 実装手順（TDD）

1. **テスト作成**: `src/app/api/projects/[project_id]/sessions/__tests__/route.test.ts`にテストケースを作成
   - セッション作成が成功するテスト
   - 必須パラメータ（name, prompt）が欠けている場合のテスト
   - プロジェクトが存在しない場合のテスト
2. **テスト実行**: テストが失敗することを確認
3. **テストコミット**: テストのみをコミット（`test: セッション作成APIのテストを追加`）
4. **実装**: タスク10.1で特定された原因に応じて修正
   - データベース接続の修正
   - Git worktree作成処理の修正
   - エラーハンドリングの改善
   - 環境変数の適切な読み込み
5. **テスト実行**: すべてのテストが通過することを確認
6. **実装コミット**: 実装をコミット（`fix: セッション作成時の[原因]を修正`）

### 受入基準

- [ ] テストファイルが作成され、テストケースが3つ以上含まれている
- [ ] テストのみのコミットが存在する
- [ ] セッション作成APIが正常に動作する
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザでセッション作成フォームから送信すると、セッションが正常に作成される
- [ ] 作成されたセッションがセッション一覧に表示される
- [ ] 実装のコミットが存在する

### 依存関係

- タスク10.1（原因調査）が完了していること

---

## タスク10.3: /projectsから/へのリダイレクト実装

**優先度**: Medium
**推定工数**: 20分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

URL http://localhost:3000/projects にアクセスした時に、プロジェクト一覧ページ（http://localhost:3000/）にリダイレクトする機能を実装します。

**現在の動作**:
- /projects にアクセスすると404エラー

**期待される動作**:
- /projects にアクセスすると / にリダイレクトされる（301 Permanent Redirect）
- ユーザーはプロジェクト一覧を見ることができる

### 実装手順（TDD）

1. **テスト作成**: `src/app/projects/__tests__/page.test.tsx`にテストケースを作成
   - /projects にアクセスすると redirect() が呼び出されることを検証
2. **テスト実行**: テストが失敗することを確認（page.tsxが存在しないため）
3. **テストコミット**: テストのみをコミット（`test: /projectsリダイレクトのテストを追加`）
4. **実装**: `src/app/projects/page.tsx`を作成
   ```typescript
   import { redirect } from 'next/navigation';

   export default function ProjectsPage() {
     redirect('/');
   }
   ```
5. **テスト実行**: すべてのテストが通過することを確認
6. **実装コミット**: 実装をコミット（`feat: /projectsから/へのリダイレクトを実装`）

### 受入基準

- [ ] `src/app/projects/page.tsx`が作成されている
- [ ] `src/app/projects/__tests__/page.test.tsx`にテストが含まれている
- [ ] テストのみのコミットが存在する
- [ ] `redirect('/')`が実装されている
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザで /projects にアクセスすると / にリダイレクトされる
- [ ] 実装のコミットが存在する

### 依存関係

なし

---

## タスク10.4: 設定ページのレイアウト修正

**優先度**: Medium
**推定工数**: 30分（AIエージェント作業時間）
**ステータス**: `TODO`

### 説明

プロジェクト設定ページ（/projects/{id}/settings）にナビゲーションバーとサイドバーが表示されない問題を修正します。

**現在の動作**:
- 設定ページにアクセスすると、ヘッダーとサイドバーが表示されない
- 「プロジェクト設定」タイトルとランスクリプトセクションのみ表示される

**期待される動作**:
- 設定ページでもヘッダー（ClaudeWorkロゴ、テーマ切り替え、ログアウト）が表示される
- サイドバー（プロジェクト一覧）が表示される
- セッション管理ページと同じレイアウトが適用される

### 実装手順（TDD）

1. **現状確認**: `src/app/projects/[id]/`ディレクトリの構造を確認
   - layout.tsxが存在するか確認
   - 存在する場合、その内容を確認
2. **テスト作成**: `src/app/projects/[id]/__tests__/layout.test.tsx`にテストケースを作成
   - レイアウトにナビゲーションバーが含まれていることを検証
   - レイアウトにサイドバーが含まれていることを検証
3. **テスト実行**: テストが失敗することを確認
4. **テストコミット**: テストのみをコミット（`test: プロジェクトレイアウトのテストを追加`）
5. **実装**: `src/app/projects/[id]/layout.tsx`を作成または修正
   ```typescript
   import { ReactNode } from 'react';
   import { Header } from '@/components/layout/Header';
   import { Sidebar } from '@/components/layout/Sidebar';

   interface LayoutProps {
     children: ReactNode;
     params: Promise<{ id: string }>;
   }

   export default async function ProjectLayout({ children, params }: LayoutProps) {
     const { id } = await params;

     return (
       <div className="flex h-screen">
         <Sidebar projectId={id} />
         <div className="flex-1 flex flex-col">
           <Header />
           <main className="flex-1 overflow-auto">
             {children}
           </main>
         </div>
       </div>
     );
   }
   ```
6. **テスト実行**: すべてのテストが通過することを確認
7. **実装コミット**: 実装をコミット（`fix: プロジェクト設定ページのレイアウトを修正`）

### 受入基準

- [ ] `src/app/projects/[id]/layout.tsx`が作成または修正されている
- [ ] レイアウトテストが作成されている
- [ ] テストのみのコミットが存在する
- [ ] レイアウトにHeaderとSidebarコンポーネントが含まれている
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザで設定ページにアクセスすると、ヘッダーとサイドバーが表示される
- [ ] セッション管理ページと同じレイアウトが適用されている
- [ ] 実装のコミットが存在する

### 依存関係

なし

---

## フェーズ完了条件

- [ ] すべてのタスク（10.1〜10.4）が完了している
- [ ] すべてのテストが通過する（`npm test`）
- [ ] ブラウザでセッション作成が正常に動作する
- [ ] /projects にアクセスすると / にリダイレクトされる
- [ ] 設定ページにナビゲーションバーとサイドバーが表示される
- [ ] 各タスクのコミットメッセージがConventional Commitsに従っている
- [ ] TDDサイクル（テストコミット→実装コミット）が守られている
- [ ] verification-report.mdで指摘された3つの問題がすべて解決されている

## 備考

### 優先順位

このフェーズのタスクは以下の優先順位で実装してください：

1. **Critical**: タスク10.1, 10.2（セッション作成機能）- アプリケーションのコア機能が動作しないため最優先
2. **Medium**: タスク10.3, 10.4（URL構造とレイアウト）- UX改善

### TDDの重要性

このフェーズではすべてのタスクでTDD（テスト駆動開発）を採用します。
特にバグ修正において、テストを先に書くことで：
- バグの再現条件を明確にできる
- 修正後の回帰を防げる
- 修正の妥当性を検証できる

### 調査タスクの重要性

タスク10.1の調査は、タスク10.2の修正内容を決定するために不可欠です。
調査を省略せず、根本原因を正確に特定してから修正を進めてください。

### ブラウザでの動作確認

各タスク完了後、必ずブラウザで実際に動作を確認してください：
- タスク10.2: セッション作成フォームからセッションが作成できるか
- タスク10.3: /projects にアクセスすると / にリダイレクトされるか
- タスク10.4: 設定ページでヘッダーとサイドバーが表示されるか

### Next.js 15の注意点

このプロジェクトはNext.js 15を使用しています。
以下の点に注意してください：

- App Routerを使用している
- `params`は非同期（Promise）として扱う必要がある
- `redirect()`はServer Componentでのみ使用可能
- Client ComponentでのリダイレクトはuseRouterを使用する
