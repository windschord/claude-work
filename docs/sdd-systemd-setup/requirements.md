# 要件定義書: systemd 自動起動セットアップ

## 概要

Ubuntu システムで ClaudeWork を systemd サービスとして自動起動させるためのセットアップ手順をドキュメント化する。

## ユーザーストーリー

システム管理者として、サーバー再起動後も ClaudeWork が自動的に起動するようにしたい。
これにより、手動でのサービス起動作業を不要にし、システムの可用性を向上させる。

---

## 機能要件

### REQ-001: 専用システムユーザーの作成手順

システム管理者がセットアップを行う時、システムは `claude-work` 専用ユーザーを作成する手順を提供しなければならない。

**受入基準**:
- [x] ユーザー作成コマンドが記載されている
- [x] ホームディレクトリの設定が記載されている
- [x] 必要な権限設定が記載されている

### REQ-002: systemd ユニットファイルの提供

システムは `claude-work.service` ユニットファイルのテンプレートを提供しなければならない。

**受入基準**:
- [x] サービス定義ファイルが提供されている
- [x] 環境変数の設定方法が記載されている
- [x] 作業ディレクトリの設定が記載されている
- [x] 再起動ポリシーが設定されている

### REQ-003: サービス有効化手順

システムは systemd サービスの有効化手順を提供しなければならない。

**受入基準**:
- [x] `systemctl enable` コマンドが記載されている
- [x] `systemctl start` コマンドが記載されている
- [x] ステータス確認方法が記載されている

### REQ-004: ログ確認手順

システムはサービスログの確認手順を提供しなければならない。

**受入基準**:
- [x] `journalctl` によるログ確認方法が記載されている
- [x] リアルタイムログ監視方法が記載されている

### REQ-005: アンインストール手順

システムはサービスの無効化・削除手順を提供しなければならない。

**受入基準**:
- [x] サービス停止手順が記載されている
- [x] サービス無効化手順が記載されている
- [x] ユニットファイル削除手順が記載されている
- [x] 専用ユーザー削除手順（オプション）が記載されている

### REQ-006: npx パッケージにビルド成果物を含める

npx github:windschord/claude-work でインストールする時、パッケージにはビルド済みの成果物（`.next/`, `dist/`）が含まれなければならない。

**受入基準**:
- [x] `.npmignore` が存在し、`.next/` と `dist/` を除外していない
- [x] `.gitignore` で除外されているビルド成果物が npx パッケージには含まれる
- [x] 不要な開発ファイル（テスト、ドキュメント等）はパッケージから除外されている

### REQ-007: Claude Code CLI パスの柔軟な検出

システムは CLAUDE_CODE_PATH 環境変数に絶対パスだけでなくコマンド名も受け付け、`which` コマンドで自動解決しなければならない。

**受入基準**:
- [x] 絶対パス指定時はファイル存在チェックで検証する
- [x] コマンド名指定時は `which` で解決を試みる
- [x] 未設定時は `which claude` で自動検出する
- [x] いずれの方法でも見つからない場合は適切なエラーメッセージを表示する

---

## 非機能要件

### NFR-001: セキュリティ

サービスは最小権限の原則に従い、専用の非特権ユーザーで実行しなければならない。

**受入基準**:
- [x] root 権限での実行を避けている
- [x] 専用ユーザーは必要最小限の権限のみ持つ

### NFR-002: 信頼性

サービスは異常終了時に自動的に再起動しなければならない。

**受入基準**:
- [x] `Restart=on-failure` または同等の設定がある
- [x] 再起動間隔の設定がある

### NFR-003: 可観測性

サービスのログは systemd journal に統合されなければならない。

**受入基準**:
- [x] 標準出力/エラーが journal に記録される
- [x] ログレベルが適切に設定されている

---

## 制約事項

- 対象 OS: Ubuntu 20.04 LTS 以降
- systemd バージョン: 245 以降
- Node.js: 20 以上がインストール済みであること

---

## 成果物

| 成果物 | 説明 |
| -------- | ------ |
| docs/SYSTEMD_SETUP.md | セットアップ手順ドキュメント |
| systemd/claude-work.service | systemd ユニットファイルテンプレート |
| systemd/claude-work.env.example | 環境変数ファイルテンプレート |
| .npmignore | npm パッケージのファイル除外制御 |
| src/lib/env-validation.ts | CLI パス検出ロジック（detectClaudePath） |
