# 要件定義書

## 概要

ClaudeWorkは、stravu/crystalのWeb版として、ブラウザからClaude Codeの複数セッションをGit worktreeベースで並列管理するアプリケーションである。ホームラボ環境にデプロイし、外出先からリモートアクセスして開発作業を行うことを主目的とする。

## プロジェクト名

**ClaudeWork**

## 背景と目的

- stravu/crystalはElectronベースのデスクトップアプリであり、リモートアクセスに対応していない
- ホームラボのサーバーにデプロイし、外出先やモバイルデバイスからブラウザ経由でアクセスしたい
- 複数のClaude Codeセッションを並列Git worktreeで管理し、効率的な開発ワークフローを実現する

## ユーザーストーリー

### ストーリー1: プロジェクト管理

**私は** 開発者として
**〜したい** 複数のGitリポジトリをプロジェクトとして登録・管理
**なぜなら** 様々なプロジェクトでClaude Codeを活用したいから

#### 受入基準（EARS記法）

- REQ-001: ユーザーが「プロジェクト追加」をクリックした時、システムはローカルGitリポジトリのパスを入力するフォームを表示しなければならない
- REQ-002: 指定されたパスがGitリポジトリでない場合、システムは「Gitリポジトリではありません」とエラーメッセージを表示しなければならない
- REQ-003: プロジェクトが正常に追加された時、システムはプロジェクト一覧に新しいプロジェクトを表示しなければならない
- REQ-004: ユーザーがプロジェクトを選択した時、システムはそのプロジェクトのセッション一覧を表示しなければならない
- REQ-005: ユーザーがプロジェクトを削除した時、システムは関連するworktreeを削除せず、プロジェクト登録のみを解除しなければならない
- REQ-006: ユーザーがプロジェクト設定を開いた時、システムはランスクリプト（テスト・ビルドコマンド）の設定フォームを表示しなければならない
- REQ-007: ユーザーがランスクリプトを保存した時、システムはそのプロジェクトの全セッションで使用可能なコマンドとして登録しなければならない

### ストーリー2: セッション作成と管理

**私は** 開発者として
**〜したい** プロンプトを入力してClaude Codeセッションを新しいGit worktreeで開始
**なぜなら** 複数のタスクを並列で進めたいから

#### 受入基準（EARS記法）

- REQ-008: ユーザーが「新規セッション」をクリックした時、システムはセッション名とプロンプトを入力するフォームを表示しなければならない
- REQ-009: セッション作成フォームにおいて、システムは作成するセッション数（1〜10）を選択できるオプションを提供しなければならない
- REQ-010: 複数セッション作成が選択された時、システムは番号付きセッション名（例: feature-1, feature-2, feature-3）を自動生成しなければならない
- REQ-011: セッション作成が実行された時、システムは新しいGit worktreeを作成し、そのworktree内でClaude Codeを起動しなければならない
- REQ-012: worktree作成に失敗した場合、システムはエラーメッセージを表示し、セッションを作成しないでなければならない
- REQ-013: セッションが作成された時、システムはセッション一覧に新しいセッションをステータス「初期化中」で表示しなければならない
- REQ-112: セッションが作成された時、システムは作成されたセッションの詳細ページに自動的に遷移しなければならない
- REQ-113: セッションが削除された時、システムはセッション一覧を即座に更新して削除されたセッションを非表示にしなければならない
- REQ-014: ユーザーがセッションを選択した時、システムはそのセッションのClaude Code出力をリアルタイムで表示しなければならない
- REQ-015: セッション一覧において、システムは各セッションのステータス（初期化中/実行中/入力待ち/完了/エラー）をアイコンで表示しなければならない
- REQ-016: セッション一覧において、システムは各セッションのGit状態（未コミット変更あり/クリーン）をインジケーターで表示しなければならない

### ストーリー3: プロンプト履歴

**私は** 開発者として
**〜したい** 過去に使用したプロンプトを保存・再利用
**なぜなら** 効率的にセッションを作成したいから

#### 受入基準（EARS記法）

- REQ-017: セッション作成時、システムは使用されたプロンプトをプロンプト履歴に保存しなければならない
- REQ-018: ユーザーがプロンプト入力フィールドをクリックした時、システムは過去のプロンプト履歴をドロップダウンで表示しなければならない
- REQ-019: ユーザーが履歴からプロンプトを選択した時、システムはそのプロンプトを入力フィールドに挿入しなければならない
- REQ-020: ユーザーがプロンプト履歴を削除した時、システムは選択されたプロンプトを履歴から削除しなければならない

### ストーリー4: Claude Codeとの対話

**私は** 開発者として
**〜したい** ブラウザからClaude Codeに追加の指示を送信
**なぜなら** 対話的に開発を進めたいから

#### 受入基準（EARS記法）

- REQ-021: セッションが実行中の間、システムはユーザーからの入力をClaude Codeプロセスに送信できなければならない
- REQ-022: Claude Codeが応答を出力した時、システムは500ms以内にブラウザに表示しなければならない
- REQ-023: Claude Codeの出力において、システムはマークダウン形式でレンダリングし、コードブロックにはシンタックスハイライトを適用しなければならない
- REQ-024: Claude Codeがサブエージェントタスクを実行した時、システムはサブエージェントの出力を折りたたみ可能なセクションで表示しなければならない
- REQ-025: Claude Codeが権限確認を要求した時、システムはユーザーに承認/拒否のUIを表示しなければならない
- REQ-026: ユーザーが承認/拒否を選択した時、システムはその選択をClaude Codeプロセスに送信しなければならない
- REQ-027: セッションが終了した時、システムはセッションステータスを「完了」に更新しなければならない
- REQ-028: Claude Codeプロセスが異常終了した時、システムはセッションステータスを「エラー」に更新し、エラー内容を表示しなければならない
- REQ-109: Claude Codeから`user`タイプのstream-jsonメッセージを受信した時、システムはそれをチャット画面に表示してはならない
- REQ-110: Claude Codeから認識されないタイプのstream-jsonメッセージを受信した時、システムはJSON文字列をチャット画面に表示してはならない
- REQ-111: 認識されないメッセージタイプはデバッグログに記録しなければならない（トラブルシューティングのため）

### ストーリー5: モデル選択

**私は** 開発者として
**〜したい** Claude Codeで使用するモデルを選択
**なぜなら** タスクに応じて適切なモデルを使い分けたいから

#### 受入基準（EARS記法）

- REQ-029: セッション作成時、システムはモデル選択オプション（Auto/Opus/Sonnet/Haiku）を表示しなければならない
- REQ-030: 「Auto」が選択された場合、システムはClaude Codeにモデル選択を委任しなければならない
- REQ-031: 特定のモデルが選択された場合、システムはClaude Code起動時にそのモデルを指定しなければならない
- REQ-032: プロジェクト設定において、システムはデフォルトモデルを設定できなければならない

### ストーリー6: ランスクリプト実行

**私は** 開発者として
**〜したい** worktree内でテストやビルドコマンドを実行
**なぜなら** 変更をマージする前に動作確認したいから

#### 受入基準（EARS記法）

- REQ-033: ユーザーが「実行」ボタンをクリックした時、システムはプロジェクトに設定されたランスクリプトをworktree内で実行しなければならない
- REQ-034: ランスクリプト実行中、システムは出力をリアルタイムで専用のログタブに表示しなければならない
- REQ-035: ランスクリプトの出力において、システムはフィルター機能（info/warn/error）を提供しなければならない
- REQ-036: ランスクリプトの出力において、システムはテキスト検索機能を提供しなければならない
- REQ-037: ランスクリプトが終了した時、システムは終了コードと実行時間を表示しなければならない
- REQ-038: ユーザーが実行中のランスクリプトを停止した時、システムはプロセスを終了しなければならない

### ストーリー7: コミット履歴と復元

**私は** 開発者として
**〜したい** セッション内のコミット履歴を確認し、任意のコミットに戻る
**なぜなら** Claude Codeの変更を段階的にレビューし、必要に応じて戻りたいから

#### 受入基準（EARS記法）

- REQ-039: ユーザーがコミット履歴タブを開いた時、システムはworktree内の全コミットを時系列で表示しなければならない
- REQ-040: コミット一覧において、システムは各コミットのハッシュ、メッセージ、日時、変更ファイル数を表示しなければならない
- REQ-041: ユーザーがコミットを選択した時、システムはそのコミットの変更内容（diff）を表示しなければならない
- REQ-042: ユーザーが「このコミットに戻る」をクリックした時、システムは確認ダイアログを表示しなければならない
- REQ-043: ユーザーが確認した時、システムはgit resetを実行し、worktreeを選択したコミットの状態に戻さなければならない

### ストーリー8: 変更差分の確認

**私は** 開発者として
**〜したい** Claude Codeが行った変更のdiffを確認
**なぜなら** マージ前にコード変更を確認したいから

#### 受入基準（EARS記法）

- REQ-044: ユーザーが「Diff表示」をクリックした時、システムはworktreeとmainブランチの差分を表示しなければならない
- REQ-045: diff表示中、システムは追加行を緑色、削除行を赤色でハイライトしなければならない
- REQ-046: ユーザーがファイルを選択した時、システムはそのファイルのdiffのみを表示しなければならない
- REQ-047: diff表示において、システムは変更されたファイル一覧をサイドバーに表示しなければならない

### ストーリー9: Git操作

**私は** 開発者として
**〜したい** worktreeの変更をmainブランチにマージ
**なぜなら** 完成した機能を統合したいから

#### 受入基準（EARS記法）

- REQ-048: ユーザーが「mainから取り込み」をクリックした時、システムはmainブランチの最新変更をworktreeにrebaseしなければならない
- REQ-049: rebase中にコンフリクトが発生した場合、システムはコンフリクトの発生を通知し、手動解決を促さなければならない
- REQ-050: ユーザーが「スカッシュしてマージ」をクリックした時、システムはコミットメッセージ入力フォームを表示しなければならない
- REQ-051: マージが実行された時、システムはworktree内の全コミットをスカッシュし、mainブランチにマージしなければならない
- REQ-052: マージが成功した時、システムはworktreeを削除するかどうかユーザーに確認しなければならない
- REQ-053: ユーザーがworktree削除を確認した時、システムはworktreeとセッションを削除しなければならない

### ストーリー10: リモートアクセスとセキュリティ

**私は** 開発者として
**〜したい** 外出先から安全にCrystal WebUIにアクセス
**なぜなら** 場所を選ばず開発を続けたいから

#### 受入基準（EARS記法）

- REQ-054: システムは認証なしでのアクセスを拒否しなければならない
- REQ-055: ユーザーがログインページにアクセスした時、システムはトークンベースの認証フォームを表示しなければならない
- REQ-056: 正しいトークンが入力された時、システムはセッションを開始し、ダッシュボードにリダイレクトしなければならない
- REQ-057: 認証済みセッションの有効期限が切れた時、システムはユーザーをログインページにリダイレクトしなければならない

### ストーリー11: ターミナル統合

**私は** 開発者として
**〜したい** worktree内でターミナルを直接操作
**なぜなら** 細かい操作や確認作業を行いたいから

#### 受入基準（EARS記法）

- REQ-058: ユーザーが「ターミナル」タブをクリックした時、システムはworktreeをカレントディレクトリとしたターミナルを表示しなければならない
- REQ-059: ターミナルにおいて、システムはXTerm.jsを使用した対話的なシェルを提供しなければならない
- REQ-060: ターミナルセッションにおいて、システムはユーザーの入力をサーバー側のPTYプロセスに送信しなければならない
- REQ-061: ターミナルにおいて、システムはANSIエスケープシーケンスを正しくレンダリングしなければならない
- REQ-062: ユーザーがセッションを切り替えた時、システムはターミナルセッションを維持しなければならない

### ストーリー12: モバイル対応

**私は** 開発者として
**〜したい** スマートフォンからセッション状態を確認・操作
**なぜなら** 移動中でも開発の進捗を把握したいから

#### 受入基準（EARS記法）

- REQ-063: 画面幅が768px未満の場合、システムはモバイル向けレイアウトで表示しなければならない
- REQ-064: モバイル表示中、システムはセッション一覧をカード形式で表示しなければならない
- REQ-065: モバイル表示中、システムはタッチ操作でセッション選択・入力ができなければならない

### ストーリー13: テーマ設定

**私は** 開発者として
**〜したい** ライト/ダークモードを切り替え
**なぜなら** 環境や好みに合わせて表示を調整したいから

#### 受入基準（EARS記法）

- REQ-066: ユーザーが初めてアクセスした時、システムはOSのテーマ設定に従ってライト/ダークモードを適用しなければならない
- REQ-067: ユーザーがテーマ切り替えボタンをクリックした時、システムはライト/ダークモードを切り替えなければならない
- REQ-068: システムはユーザーのテーマ選択をローカルストレージに保存しなければならない
- REQ-069: ユーザーが再アクセスした時、システムは保存されたテーマ設定を適用しなければならない

### ストーリー14: Claude Code CLIの自動検出

**私は** システム管理者として
**〜したい** claude コマンドのパスを自動検出してほしい
**なぜなら** 環境変数を手動で設定する手間を省きたいから

#### 受入基準（EARS記法）

- REQ-070: サーバー起動時、CLAUDE_CODE_PATH環境変数が設定されていない場合、システムはPATH環境変数からclaudeコマンドのパスを自動検出しなければならない
- REQ-071: サーバー起動時、CLAUDE_CODE_PATH環境変数が既に設定されている場合、システムはそのパスの有効性を検証しなければならない
- REQ-072: claudeコマンドが見つからない場合、システムはエラーメッセージを表示してサーバー起動を停止しなければならない
- REQ-073: CLAUDE_CODE_PATHが無効なパスの場合、システムはエラーメッセージを表示してサーバー起動を停止しなければならない
- REQ-074: claudeコマンドが正常に検出された時、システムは検出されたパスをログに出力しなければならない
- REQ-075: システムはmacOSとLinuxでwhichコマンドを使用してclaude コマンドを検出しなければならない
- REQ-076: システムはWindows環境での動作をサポートしなければならない（将来的な拡張のため、現状はエラーで停止）

### ストーリー15: 既存セッションのClaude Codeプロセス再起動

**私は** 開発者として
**〜したい** 既存セッションでClaude Codeプロセスが停止している場合に再起動できるようにしたい
**なぜなら** サーバー再起動後も既存セッションで作業を継続したいから

#### 背景

- Claude Codeプロセスはセッション作成時のみ起動される
- サーバー再起動後、既存セッションにアクセスしてもプロセスは自動的には再起動されない
- プロセスがないセッションにメッセージを送信しても何も起きない（エラーも出ない）

#### 受入基準（EARS記法）

- REQ-077: セッション詳細ページを表示した時、システムはClaude Codeプロセスの状態（実行中/停止）をUIで表示しなければならない
- REQ-078: Claude Codeプロセスが停止している場合、システムは「プロセス再起動」ボタンを表示しなければならない
- REQ-079: ユーザーが「プロセス再起動」ボタンをクリックした時、システムはそのセッションのworktree_pathを使用してClaude Codeプロセスを起動しなければならない
- REQ-080: プロセスが正常に起動した時、システムはプロセス状態表示を「実行中」に更新しなければならない
- REQ-081: プロセスの起動に失敗した場合、システムはエラーメッセージをユーザーに表示しなければならない
- REQ-082: メッセージ送信時にプロセスが停止している場合、システムはエラーメッセージを表示し、プロセス再起動を促さなければならない
- REQ-083: セッション詳細ページでWebSocket接続が確立された時、システムはプロセス状態を自動的に確認しなければならない

### ストーリー16: ブラウザ通知

**私は** 開発者として
**〜したい** Claude Codeのイベント発生時にブラウザ通知を受け取りたい
**なぜなら** 他のタブで作業中でもセッションの状態変化に気づきたいから

#### 背景

- 長時間実行されるタスクの完了を見逃すことがある
- 権限要求に気づかずセッションが待機状態のままになることがある
- 複数セッションを並列で実行する場合、すべてを監視し続けるのは困難

#### 受入基準（EARS記法）

- REQ-084: ユーザーが初めてセッションページにアクセスした時、システムはブラウザ通知の許可を要求しなければならない
- REQ-085: Claude Codeプロセスが完了した時、システムはOS通知「タスク完了: [セッション名]」を送信しなければならない
- REQ-086: Claude Codeが権限確認を要求した時、システムはOS通知「アクション要求: [セッション名]」を送信しなければならない
- REQ-087: Claude Codeプロセスがエラーで終了した時、システムはOS通知「エラー発生: [セッション名]」を送信しなければならない
- REQ-088: ブラウザタブがアクティブな場合、システムはOS通知の代わりにアプリ内toast通知を表示しなければならない
- REQ-089: ブラウザタブがバックグラウンドの場合、システムはOS通知を送信しなければならない
- REQ-090: ユーザーがOS通知をクリックした時、システムは該当セッションのページにフォーカスしなければならない
- REQ-091: システムは通知設定（イベント別オン/オフ）をローカルストレージに保存しなければならない
- REQ-092: ユーザーが通知設定を変更した時、システムは即座に設定を適用しなければならない
- REQ-093: 通知設定において、システムはタスク完了/権限要求/エラーそれぞれのオン/オフを個別に設定できなければならない

## 非機能要件

### パフォーマンス

- NFR-001: システムはClaude Codeの出力を500ms以内にブラウザに表示しなければならない
- NFR-002: システムは10個の並列セッションを同時に管理できなければならない
- NFR-003: APIレスポンスは95パーセンタイルで200ms以内でなければならない

### セキュリティ

- NFR-004: システムはすべての通信をHTTPS経由で行わなければならない（リバースプロキシ想定）
- NFR-005: システムは認証トークンをハッシュ化して保存しなければならない
- NFR-006: システムはセッション情報をサーバー側で管理し、クライアントには最小限の情報のみ送信しなければならない
- NFR-014: 環境変数`ALLOWED_PROJECT_DIRS`が設定されている場合、システムは指定されたディレクトリ配下のパスのみをプロジェクトとして登録許可しなければならない
- NFR-015: システムは既に登録されているパスでプロジェクトを追加しようとした時、409 Conflictエラーと「このパスは既に登録されています」というメッセージを返さなければならない

### エラーハンドリング

- NFR-016: システムはAPIエラーが発生した時、ユーザーに分かりやすい日本語のエラーメッセージをトースト通知で表示しなければならない
- NFR-017: システムはエラー発生時も、アプリケーション全体がクラッシュせず、正常に動作し続けなければならない

### 可用性

- NFR-007: システムはサーバー再起動後も既存のworktree情報を復元できなければならない
- NFR-008: システムはClaude Codeプロセスがクラッシュした場合、セッションステータスを「エラー」に更新しなければならない

### 運用性

- NFR-009: システムは`npx claude-work`コマンドで簡単に起動できなければならない
- NFR-010: システムは環境変数で主要な設定を変更できなければならない
- NFR-011: システムはログをJSON形式で出力しなければならない

### 互換性

- NFR-012: システムはChrome、Firefox、Safari、Edgeの最新版で動作しなければならない
- NFR-013: システムはiOS Safari、Android Chromeで動作しなければならない

### ストーリー17: プロセスライフサイクル管理

**私は** システム管理者として
**〜したい** Claude Codeプロセスが自動的に停止・再開されるようにしたい
**なぜなら** サーバーリソースを効率的に管理し、孤児プロセスの発生を防ぎたいから

#### 背景

- サーバー停止時にClaude Codeプロセスが残り続ける問題がある
- 長時間使用されていないプロセスがリソースを消費し続ける
- セッション復帰時にプロセスを手動で再起動する必要がある

#### 受入基準（EARS記法）

##### サーバー停止時の自動クリーンアップ

- REQ-094: サーバーがSIGTERM/SIGINTシグナルを受信した時、システムは管理しているすべてのClaude Codeプロセスを終了しなければならない
- REQ-095: サーバーシャットダウン時、システムはプロセス終了を最大10秒間待機し、タイムアウトした場合はSIGKILLで強制終了しなければならない
- REQ-096: サーバーシャットダウン時、システムは終了したプロセス数をログに記録しなければならない

##### アイドルタイムアウトによる自動停止

- REQ-097: システムはPROCESS_IDLE_TIMEOUT_MINUTES環境変数でアイドルタイムアウト時間（分）を設定できなければならない（デフォルト: 30分）
- REQ-098: セッションが最後のアクティビティからPROCESS_IDLE_TIMEOUT_MINUTES分経過した時、システムはそのClaude Codeプロセスを自動停止しなければならない
- REQ-099: アクティビティとは、メッセージ送信、WebSocket接続中のハートビート、またはプロセス出力の受信を指す
- REQ-100: プロセスが自動停止された時、システムはセッションのステータスを「一時停止」に更新しなければならない
- REQ-101: プロセスが自動停止される前に、システムはWebSocket経由で接続中のクライアントに警告通知を送信しなければならない

##### セッション復帰時の自動再開

- REQ-102: ユーザーが一時停止中のセッションにアクセスした時、システムは「セッションを再開」ボタンを表示しなければならない
- REQ-103: ユーザーが「セッションを再開」をクリックした時、システムはClaude Codeの--resumeオプションを使用してプロセスを再起動しなければならない
- REQ-104: --resumeオプションでの再起動時、システムはworktree_pathとsession_idを使用してClaude Codeの会話を復元しなければならない
- REQ-105: セッション再開が成功した時、システムはセッションのステータスを「実行中」に更新しなければならない
- REQ-106: セッション再開に失敗した場合、システムはエラーメッセージを表示し、通常の再起動オプションを提示しなければならない

##### 状態管理

- REQ-107: システムは各セッションの最終アクティビティ時刻をメモリ上で管理しなければならない
- REQ-108: システムは1分ごとにアイドルチェックを実行し、タイムアウトしたプロセスを停止しなければならない

## 用語定義

| 用語 | 定義 |
|------|------|
| セッション | 1つのGit worktreeに紐づくClaude Codeプロセスとその会話履歴 |
| アイドルタイムアウト | 最後のアクティビティから一定時間経過後にプロセスを自動停止する機能 |
| アクティビティ | メッセージ送信、WebSocket接続中のハートビート、プロセス出力の受信 |
| プロジェクト | 管理対象のGitリポジトリ |
| worktree | Git worktree機能で作成された独立した作業ディレクトリ |
| スカッシュ | 複数のコミットを1つにまとめる操作 |
| ランスクリプト | プロジェクトに設定されたテスト・ビルドなどの実行コマンド |
| サブエージェント | Claude Codeが内部で起動する補助的なAIタスク |
| PTY | 疑似端末（Pseudo Terminal）、ターミナルエミュレータとシェル間の通信を提供 |
| OS通知 | ブラウザのNotification APIを使用したデスクトップ通知 |
| toast通知 | アプリケーション内に表示される一時的な通知メッセージ |

## 制約事項

- Claude Code CLIがPATH環境変数からアクセス可能であること（自動検出される）
- Claude Code CLIが認証済みであること
- Gitがインストールされていること
- Node.js 18以上がインストールされていること
- macOSまたはLinux環境であること（Windowsは現在未対応）
- `npx claude-work`コマンドで起動できること
