# 要件定義書: Claudeターミナル操作性改善

## 1. 概要

Claudeタブのターミナル(XTerm.js)の操作性を改善する。フォーカス状態の視認性向上、キーバインドによるコピー&ペースト、SHIFT+ENTERによる改行入力、CTRL+Vによる画像添付を実装する。

## 2. ユーザーストーリー

### US-001: フォーカス状態の視認性
ユーザーとして、ターミナルにフォーカスがあたっているかどうかを視覚的に判断したい。
それにより、入力がターミナルに届いているか確認できる。

### US-002: キーボードによるコピー&ペースト
ユーザーとして、キーボードショートカットでターミナルのテキストをコピー&ペーストしたい。
それにより、マウス操作なしで効率的にテキストを扱える。

### US-003: 改行入力
ユーザーとして、SHIFT+ENTERで改行文字を入力したい。
それにより、複数行の入力をClaude Codeに送れる。

### US-004: クリップボード画像の添付
ユーザーとして、CTRL+Vでクリップボード内の画像をClaude Codeに渡したい。
それにより、スクリーンショット等を簡単にClaude Codeに送れる。

## 3. 機能要件

### REQ-001: フォーカスインジケーター
ターミナルにフォーカスがあたっている時、システムはターミナルの枠に緑色の縁取り(border)を表示しなければならない。
フォーカスが外れた時、システムは緑色の縁取りを非表示にしなければならない。

**受入基準:**
- AC-001-1: ターミナルをクリックするとターミナル領域の周囲に緑色のborderが表示される
- AC-001-2: ターミナル外をクリックすると緑色のborderが消える
- AC-001-3: フォーカス状態の変化はCSSトランジションでスムーズに切り替わる

### REQ-002: CTRL+Cによるコピー
ターミナル内でテキストが選択されている時にCTRL+Cが押された場合、システムは選択テキストをクリップボードにコピーしなければならない。
テキストが選択されていない時にCTRL+Cが押された場合、システムは通常のSIGINT(割り込み信号)をPTYに送信しなければならない。

**受入基準:**
- AC-002-1: テキスト選択状態でCTRL+Cを押すと選択テキストがクリップボードにコピーされる
- AC-002-2: テキスト未選択状態でCTRL+Cを押すとSIGINT(^C)がPTYに送信される
- AC-002-3: コピー後に選択が解除される

### REQ-003: CTRL+Vによるテキストペースト
CTRL+Vが押され、クリップボードにテキストがある場合、システムはテキストをターミナルにペーストしなければならない。

**受入基準:**
- AC-003-1: CTRL+Vでクリップボードのテキストがターミナルに入力される
- AC-003-2: 複数行テキストも正しくペーストされる

### REQ-004: SHIFT+ENTERによる改行
SHIFT+ENTERが押された場合、システムは改行文字(\n)をPTYに送信しなければならない。

**受入基準:**
- AC-004-1: SHIFT+ENTERで改行文字がPTYに送信される
- AC-004-2: 通常のENTERの動作は変更されない

### REQ-005: CTRL+Vによる画像添付
CTRL+Vが押され、クリップボードに画像がある場合、システムは画像を一時ファイルとして保存し、そのファイルパスをターミナルに入力しなければならない。

**受入基準:**
- AC-005-1: クリップボードに画像がある状態でCTRL+Vを押すと画像がサーバーに送信される
- AC-005-2: サーバーが画像をセッションのworktreeディレクトリ内の一時ディレクトリに保存する
- AC-005-3: 保存された画像のファイルパスがターミナルに入力される
- AC-005-4: CTRL+Vでテキストと画像の両方がクリップボードにある場合、画像を優先する
- AC-005-5: 画像保存失敗時にエラーメッセージがターミナルに表示される

## 4. 非機能要件

### NFR-001: パフォーマンス
画像添付処理は3秒以内に完了しなければならない（一般的なスクリーンショットサイズ: 5MB以下）。

### NFR-002: セキュリティ
画像保存先はセッションのworktreeディレクトリ内に限定し、パストラバーサルを防止しなければならない。

### NFR-003: ユーザビリティ
キーバインドはブラウザの一般的なショートカットと一致し、ユーザーが追加の学習なしに使用できなければならない。

### NFR-004: 互換性
既存のターミナル動作（XTerm.jsのデフォルト動作）を可能な限り維持しなければならない。

## 5. 制約事項

- XTerm.jsの`attachCustomKeyEventHandler`を使用してキーイベントをカスタマイズする
- 画像はWebSocket経由でバイナリ送信し、サーバー側でファイルに保存する
- 保存先はセッションのworktreeパス配下の`.claude-images/`ディレクトリとする
- フォーカス管理はXTerm.jsの`onFocus`/`onBlur`イベントを使用する

## 6. 用語集

| 用語 | 説明 |
|------|------|
| PTY | 疑似ターミナル。Claude Codeプロセスの入出力を中継する |
| worktree | Git worktree。セッションごとに分離された作業ディレクトリ |
| XTerm.js | ブラウザ上でターミナルをエミュレートするライブラリ |
| SIGINT | 割り込み信号。CTRL+Cで送信される通常の制御シグナル |
