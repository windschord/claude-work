# US-002: destroySession無限再帰解消

## ユーザーストーリー

**私は** ClaudeWorkの開発者・メンテナーとして
**〜したい** destroySessionメソッドの無限再帰を解消したい
**なぜなら** 無限再帰により「RangeError: Maximum call stack size exceeded」エラーが発生し、サーバーがクラッシュしているため

## 受入基準(EARS記法)

### 機能要件

- **REQ-002-001**: セッション破棄時、システムはPTYSessionManager → HostAdapter → ClaudePTYManager → PTYSessionManager(再帰)という循環的な呼び出しチェーンを実行してはならない
- **REQ-002-002**: PTYSessionManager.destroySession()が呼び出される時、システムはadapter.destroySession()を1回のみ呼び出さなければならない
- **REQ-002-003**: HostAdapter.destroySession()が呼び出される時、システムはPTYSessionManager.destroySession()を再度呼び出してはならない
- **REQ-002-004**: セッション破棄処理中、システムは呼び出しスタックの深さを監視し、異常な深さを検出した場合はエラーログを出力しなければならない

### 検証要件

- **REQ-002-005**: セッションを破棄する時、システムはスタックオーバーフローエラーを発生させてはならない
- **REQ-002-006**: セッション破棄時、システムはpm2-error.logに「Maximum call stack size exceeded」エラーを記録してはならない
- **REQ-002-007**: セッション破棄後、システムは正常に次のセッションを作成できなければならない

## 技術要件

- destroySession()の呼び出しチェーンを一方向に限定する
- ClaudePTYManager.destroySession()がPTYSessionManager.destroySession()を呼び出す構造を削除する
- HostAdapter.destroySession()はPTY固有のクリーンアップ(ptyProcess.kill()等)のみを実行する

## 現状の問題

```
PTYSessionManager.destroySession()
  → adapter.destroySession() (HostAdapter)
    → claudePtyManager.destroySession()
      → ptySessionManager.destroySession() ← 無限再帰！
```

この無限再帰により、コールスタックが限界に達し、サーバーがクラッシュする。pm2-error.logに複数回記録されている(2026-02-13から2026-02-15のタイムスタンプ)。

## 関連ストーリー

- [US-001](US-001.md) @US-001.md: Circular delegation解消 - 同じ循環参照の問題
- [US-004](US-004.md) @US-004.md: 共通PTYロジック抽出 - クリーンアップ処理の共通化

## 関連ドキュメント

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則 C2: レイヤー境界を明確にする
  - 原則 L4: ライフサイクルイベントは状態遷移前に発火する

## 備考

- pm2-error.logに複数のクラッシュ記録あり(2026-02-13から2026-02-15)
- サーバークラッシュの直接的な原因
- US-001のCircular delegation解消により、この問題も同時に解決される可能性が高い
- ただし、destroySession固有のクリーンアップロジックは明示的に検証する必要がある
