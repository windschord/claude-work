# US-003: cols/rows伝播の欠落解消

## ユーザーストーリー

**私は** ClaudeWorkのユーザーとして
**〜したい** HOST環境でのターミナルサイズ(cols/rows)が正しくPTYプロセスに伝播されることを確認したい
**なぜなら** 現在HOST環境ではターミナルサイズが80x24にハードコードされており、ブラウザのターミナルサイズと一致しないため

## 受入基準(EARS記法)

### 機能要件

- **REQ-003-001**: HOST環境でセッションを作成する時、システムはWebSocketから受信したcols/rows値をpty.spawn()に渡さなければならない
- **REQ-003-002**: もしWebSocketからcols/rowsが指定されていない場合、システムはデフォルト値(80x24)を使用しなければならない
- **REQ-003-003**: ターミナルリサイズイベントを受信した時、システムはptyProcess.resize(cols, rows)を呼び出さなければならない
- **REQ-003-004**: HOST環境とDOCKER環境の両方で、システムは同じcols/rows伝播ロジックを使用しなければならない

### 検証要件

- **REQ-003-005**: HOST環境でセッションを作成した時、システムはブラウザのターミナルサイズと同じcols/rowsでPTYを初期化しなければならない
- **REQ-003-006**: ブラウザでターミナルをリサイズした時、システムはPTYプロセスのサイズを即座に更新しなければならない
- **REQ-003-007**: DOCKER環境でのcols/rows伝播が引き続き正常に動作しなければならない(回帰防止)

## 技術要件

- HostAdapterのcreateSession()で、options.cols/rowsをpty.spawn()に渡す
- ClaudePTYManagerが現在ハードコードしている80x24を削除する
- DockerAdapterと同じcols/rows初期化パターンを適用する

## 現状の問題

**HOST環境(ClaudePTYManager):**
```typescript
// claude-pty-manager.ts:139-147
const ptyProcess = pty.spawn(claudeCommand, [], {
  name: 'xterm-256color',
  cols: 80,  // ← ハードコード
  rows: 24,  // ← ハードコード
  env: { ...process.env, TERM: 'xterm-256color', COLORTERM: 'truecolor' },
  cwd: options.cwd,
});
```

**DOCKER環境(DockerAdapter) - 正しい実装:**
```typescript
// docker-adapter.ts:471-489
const initialCols = options?.cols ?? 80;
const initialRows = options?.rows ?? 24;
const ptyProcess = pty.spawn('docker', args, {
  name: 'xterm-256color',
  cols: initialCols,  // ← 正しく伝播
  rows: initialRows,  // ← 正しく伝播
  env: { ...process.env, TERM: 'xterm-256color', COLORTERM: 'truecolor' },
});
```

## 関連ストーリー

- [US-001](US-001.md) @US-001.md: Circular delegation解消 - HostAdapterがnode-ptyを直接呼び出すことで、cols/rowsも正しく伝播可能になる
- [US-004](US-004.md) @US-004.md: 共通PTYロジック抽出 - cols/rows初期化ロジックを共通化

## 関連ドキュメント

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則 D2: cols/rowsを適切に初期化する
- Issue #101: Docker環境でのPTY terminal display問題(修正済み)

## 備考

- DOCKER環境では既にIssue #101で修正済み(docker-adapter.ts:471-489)
- HOST環境でも同じパターンを適用することで、統一的な実装となる
- ClaudePTYManagerの80x24ハードコードは、過去の暫定的な実装である可能性が高い
- 設計原則D2「PTY初期化時にcols/rowsを適切に設定する」に準拠
