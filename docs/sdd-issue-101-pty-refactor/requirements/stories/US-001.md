# US-001: Circular Delegation解消

## ユーザーストーリー

**私は** ClaudeWorkの開発者・メンテナーとして
**〜したい** PTYSessionManager、HostAdapter、ClaudePTYManagerの間の循環的な委譲チェーンを解消したい
**なぜなら** 循環参照により「Session already exists」エラーが発生し、ターミナルが黒い画面のまま表示されない問題が発生しているため

## 受入基準(EARS記法)

### 機能要件

- **REQ-001-001**: HOST環境でセッションを作成する時、システムはPTYSessionManager → HostAdapter → ClaudePTYManager → PTYSessionManager(再帰)という循環的な呼び出しチェーンを実行してはならない
- **REQ-001-002**: HostAdapterがcreateSession()を呼び出す時、システムはnode-ptyを直接呼び出さなければならない
- **REQ-001-003**: ClaudePTYManager.createSession()が呼び出される時、システムはPTYSessionManagerを経由せずに処理を完了しなければならない
- **REQ-001-004**: もしClaudePTYManagerが廃止される場合、システムはHostAdapterに必要な機能を直接実装しなければならない

### 検証要件

- **REQ-001-005**: HOST環境でセッションを作成した時、システムはターミナル画面を正常に表示しなければならない
- **REQ-001-006**: セッション作成時、システムは「Session already exists」エラーを出力してはならない
- **REQ-001-007**: HOST環境でのセッション作成時、システムはcreateSession()を1回のみ呼び出さなければならない

## 技術要件

- HostAdapterはnode-ptyを直接importし、pty.spawn()を呼び出す
- ClaudePTYManagerへの依存を完全に削除する
- PTYSessionManager.createSession()の呼び出しは、HostAdapter内部で発生しない

## 現状の問題

```
PTYSessionManager.createSession()
  → adapter.createSession() (AdapterFactory経由でHostAdapter)
    → claudePtyManager.createSession()
      → ptySessionManager.createSession() ← 循環！
```

この循環により、2回目のcreateSession()呼び出し時に`sessions.has(sessionId)`チェックが`true`となり、エラーがスローされる。

## 関連ストーリー

- [US-004](US-004.md) @US-004.md: 共通PTYロジック抽出 - HostAdapterの新しい実装で共通ロジックを使用

## 関連ドキュメント

- 設計原則: [docs/design-principles-pty-session-management.md](../../../design-principles-pty-session-management.md)
  - 原則 A2: 依存は常に上位から下位へ(一方向)
  - 原則 C1: 呼び出しチェーンを明示的に文書化する

## 備考

- 過去11個のPRでPTY問題が再発している根本原因の一つ
- ClaudePTYManagerは元々「PTYSessionManagerへの薄いラッパー」として作成されたが、HostAdapterがさらにそのラッパーとなり、3層の不必要な委譲チェーンが形成された
- 設計原則A1「各レイヤーは1つの責務のみを持つ」に違反している
