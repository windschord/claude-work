# 信頼性要件

> 非機能要件カテゴリ: 信頼性

## 概要

PTYアーキテクチャリファクタリングにより、サーバークラッシュを防止し、ターミナル表示の安定性を向上させる。Circular delegationとdestroySession無限再帰を解消し、信頼性の高いPTYセッション管理を実現する。

## 要件一覧

### NFR-REL-001: サーバークラッシュの防止

**EARS記法**: セッションライフサイクル操作時(作成、破棄、リサイズ)、システムはスタックオーバーフローエラーによりクラッシュしてはならない

**測定基準**:
- 指標: サーバークラッシュ発生回数
- 目標値: 0回(7日間の連続運用)
- 測定方法: pm2-error.logの監視、自動再起動回数のカウント

**関連する機能要件**: REQ-002-001, REQ-002-002, REQ-002-003

**優先度**: 高(Critical)

**検証方法**:
- [ ] セッション作成→破棄を100回連続実行してクラッシュが発生しないことを確認
- [ ] pm2-error.logに"Maximum call stack size exceeded"エラーが記録されないことを確認
- [ ] 7日間のストレステスト(自動セッション作成・破棄)でクラッシュが発生しないことを確認

---

### NFR-REL-002: ターミナル表示の安定性

**EARS記法**: HOST環境でセッションを作成した時、システムは100%の確率でターミナル画面を正常に表示しなければならない

**測定基準**:
- 指標: ターミナル正常表示率
- 目標値: 100%(黒い画面が表示される確率0%)
- 測定方法: 自動E2Eテスト(Playwright)による画面キャプチャと検証

**関連する機能要件**: REQ-001-005, REQ-001-006

**優先度**: 高

**検証方法**:
- [ ] HOST環境でセッションを50回作成し、全てでターミナルが表示されることを確認
- [ ] "Session already exists"エラーが発生しないことを確認
- [ ] XTerm.jsのDOM要素が正しくレンダリングされることを確認
- [ ] PTYプロセスからのデータがターミナルに表示されることを確認

---

### NFR-REL-003: エラーハンドリングの完全性

**EARS記法**: PTY操作でエラーが発生した時、システムは適切なエラーメッセージをログに記録し、セッション状態を正しく更新しなければならない

**測定基準**:
- 指標: エラー発生時の適切な処理率
- 目標値: 100%(全てのエラーが適切に処理される)
- 測定方法: エラー注入テストによる検証

**関連する機能要件**: REQ-004-004

**優先度**: 中

**検証方法**:
- [ ] PTYプロセスが異常終了した場合のエラーハンドリングをテスト
- [ ] Docker接続エラー時のエラーハンドリングをテスト
- [ ] リサイズエラー時のエラーハンドリングをテスト
- [ ] 全てのエラーケースでログが記録されることを確認
- [ ] 全てのエラーケースでセッション状態がTERMINATEDまたはERRORに遷移することを確認
