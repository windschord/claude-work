name: Test

on:
  push:
    branches: [ main, nodejs-architecture ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Lint job - runs quickly in parallel
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup project
      uses: ./.github/actions/setup
      with:
        skip-db-setup: 'true'

    - name: Run linter
      run: pnpm run lint

    - name: Install systemd-linter
      if: hashFiles('systemd/*.service') != ''
      uses: baptiste0928/cargo-install@v3
      with:
        crate: systemd-linter

    - name: Lint systemd unit files
      if: hashFiles('systemd/*.service') != ''
      run: systemd-linter systemd/*.service

  # Backend tests - API routes, services, libs
  test-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: file:./data/test.db

    steps:
    - uses: actions/checkout@v4

    - name: Setup project
      uses: ./.github/actions/setup

    - name: Run backend tests
      # Note: Some tests are excluded due to node-pty native module issues in CI environment.
      # Integration tests and PTY-related tests should be run locally.
      # See: https://github.com/windschord/claude-work/pull/96
      run: |
        pnpm exec vitest run src/app/api src/lib src/services src/bin \
          --exclude='**/*.integration.test.ts' \
          --exclude='**/docker-adapter.test.ts' \
          --exclude='**/docker-adapter-git.test.ts' \
          --exclude='src/services/__tests__/pty-session-manager.test.ts' \
          --reporter=verbose
      timeout-minutes: 8

  # Frontend tests - components, pages, hooks
  test-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: file:./data/test.db

    steps:
    - uses: actions/checkout@v4

    - name: Setup project
      uses: ./.github/actions/setup

    - name: Run frontend tests
      run: |
        # Run vitest with a 5-minute timeout - if it hangs after tests pass, timeout will kill it
        set +e
        timeout --signal=SIGKILL 300 pnpm exec vitest run src/components src/hooks src/store src/app --exclude='src/app/api/**' --reporter=verbose 2>&1 | tee vitest-output.txt
        VITEST_EXIT_CODE=$?

        # Check if tests passed (look for success message in output)
        if grep -q "Test Files.*passed" vitest-output.txt && ! grep -q "Test Files.*failed" vitest-output.txt; then
          echo "All tests passed"
          exit 0
        elif [ $VITEST_EXIT_CODE -eq 137 ]; then
          # SIGKILL timeout (128 + 9 = 137) - check if tests passed before hang
          if grep -q "Test Files.*passed" vitest-output.txt && ! grep -q "Test Files.*failed" vitest-output.txt; then
            echo "Tests passed but process hung - treating as success"
            exit 0
          fi
          echo "Tests may have failed or hung before completing"
          exit 1
        else
          exit $VITEST_EXIT_CODE
        fi
      timeout-minutes: 8

  # E2E tests - CLI installation tests (browser tests require Claude CLI)
  test-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Setup project
      uses: ./.github/actions/setup
      with:
        skip-db-setup: 'true'

    - name: Cache CLI E2E package
      uses: actions/cache@v4
      id: cli-package-cache
      with:
        path: /tmp/cli-e2e-package
        key: cli-e2e-pkg-${{ runner.os }}-${{ hashFiles('package.json', 'pnpm-lock.yaml', 'src/**', 'server.ts', 'tsconfig*.json', 'next.config.js', 'tailwind.config.*', 'postcss.config.*', '.npmignore') }}

    - name: Build CLI E2E package
      if: steps.cli-package-cache.outputs.cache-hit != 'true'
      run: |
        set -e
        echo "=== npm pack ==="
        TARBALL_NAME=$(npm pack --ignore-scripts | tail -1)
        echo "Created tarball: $TARBALL_NAME"

        echo "=== Extract tarball ==="
        mkdir -p /tmp/cli-e2e-package
        tar -xzf "$TARBALL_NAME" -C /tmp/cli-e2e-package
        rm -f "$TARBALL_NAME"

        echo "=== npm install (triggers prepare/build) ==="
        cd /tmp/cli-e2e-package/package
        npm install
        echo "=== Build complete ==="
      timeout-minutes: 8

    - name: Verify CLI package
      run: |
        test -f /tmp/cli-e2e-package/package/dist/src/bin/cli.js
        test -d /tmp/cli-e2e-package/package/.next

    - name: Run CLI E2E tests
      run: SKIP_WEBSERVER=true CLI_PACKAGE_DIR=/tmp/cli-e2e-package/package pnpm exec playwright test --project=cli
      timeout-minutes: 3

  # Build job - runs in parallel with tests
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: file:./data/test.db

    steps:
    - uses: actions/checkout@v4

    - name: Setup project
      uses: ./.github/actions/setup

    - name: Build
      run: pnpm run build

  # Final check - ensures all jobs passed
  ci-check:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    needs: [lint, test-backend, test-frontend, test-e2e, build]
    if: always()

    steps:
    - name: Check all jobs passed
      run: |
        if [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.test-backend.result }}" != "success" ] || \
           [ "${{ needs.test-frontend.result }}" != "success" ] || \
           [ "${{ needs.test-e2e.result }}" != "success" ] || \
           [ "${{ needs.build.result }}" != "success" ]; then
          echo "One or more jobs failed"
          exit 1
        fi
        echo "All jobs passed successfully"
