# Gemini PR Review Workflow
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«Gemini APIã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã¾ã™
# ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ã¯ GEMINI.md ã‚’å‚ç…§ï¼ˆSingle Source of Truthï¼‰

name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# åŒã˜PRã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
concurrency:
  group: gemini-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã®åˆ¤å®šã¨PRç•ªå·ã®å–å¾—
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check trigger condition
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -e

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "âœ… Triggered by pull_request event"

          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            if [[ -z "$PR_NUMBER" ]]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "âŒ Could not determine PR number"
              exit 0
            fi

            if [[ "$COMMENT_BODY" == *"@gemini-cli"* ]] && [[ "$COMMENT_BODY" == *"/review"* ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "âœ… Triggered by pull_request_review_comment with @gemini-cli /review"
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment does not contain @gemini-cli /review"
            fi

          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ -z "${{ github.event.issue.pull_request }}" ]]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment is on an issue, not a pull request"
              exit 0
            fi

            PR_NUMBER="${{ github.event.issue.number }}"

            if [[ "$COMMENT_BODY" == *"@gemini-cli"* ]] && [[ "$COMMENT_BODY" == *"/review"* ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "âœ… Triggered by issue_comment with @gemini-cli /review"
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment does not contain @gemini-cli /review"
            fi

          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Unknown event type"
          fi

  review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/head
          fetch-depth: 0

      - name: Get PR diff and review guidelines
        id: prepare
        run: |
          echo "Getting diff for PR #${PR_NUMBER}"
          gh pr diff "${PR_NUMBER}" > pr_diff.txt 2>&1 || echo "Could not get diff" > pr_diff.txt

          echo "--- PR Diff Preview (first 50 lines) ---"
          head -50 pr_diff.txt
          echo "--- End of preview ---"

          # GEMINI.mdã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "GEMINI.md" ]; then
            REVIEW_GUIDELINES=$(cat GEMINI.md)
          else
            REVIEW_GUIDELINES="ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚"
          fi

          # PRã®å·®åˆ†ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœ€å¤§10000æ–‡å­—ï¼‰
          PR_DIFF=$(head -c 10000 pr_diff.txt)

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
          cat > prompt.txt << 'PROMPT_EOF'
          ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å°‚é–€å®¶ã§ã™ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–
          PROMPT_EOF

          echo "$REVIEW_GUIDELINES" >> prompt.txt

          cat >> prompt.txt << 'PROMPT_EOF'

          ## PRã®å·®åˆ†
          ä»¥ä¸‹ã®PRã®å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

          ```diff
          PROMPT_EOF

          echo "$PR_DIFF" >> prompt.txt

          cat >> prompt.txt << 'PROMPT_EOF'
          ```

          ä¸Šè¨˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ã«å¾“ã£ã¦ã€æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
          PROMPT_EOF

          echo "Prompt prepared successfully"

      - name: Call Gemini API
        id: gemini
        run: |
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§JSONç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          PROMPT_CONTENT=$(cat prompt.txt | jq -Rs .)

          # Gemini APIã‚’å‘¼ã³å‡ºã—
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": ${PROMPT_CONTENT}
                }]
              }]
            }")

          echo "API Response received"

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$REVIEW_TEXT" ]; then
            echo "âŒ Failed to get review from Gemini API"
            echo "Response: $RESPONSE"
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "Error: $ERROR_MSG"
            exit 1
          fi

          echo "âœ… Review generated successfully"

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$REVIEW_TEXT" > review_result.txt

      - name: Post review comment
        if: success()
        run: |
          echo "Posting Gemini review to PR #${PR_NUMBER}"

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’èª­ã¿è¾¼ã¿
          REVIEW_CONTENT=$(cat review_result.txt)

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment "${PR_NUMBER}" --body "## ğŸ¤– Gemini Code Review

          ${REVIEW_CONTENT}"

          echo "âœ… Review posted successfully"
