# Gemini PR Review Workflow
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«Gemini CLIã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã¾ã™

name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# åŒã˜PRã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
concurrency:
  group: gemini-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆã€@gemini-cli ã‚³ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check trigger condition
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "issue_comment" || "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            if [[ "$COMMENT_BODY" == *"@gemini-cli"* && "$COMMENT_BODY" == *"/review"* ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "::error::GEMINI_API_KEY is not set. Please add it to repository secrets."
            exit 1
          fi
          echo "GEMINI_API_KEY is configured"

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          echo "Getting diff for PR #${PR_NUMBER}"
          gh pr diff ${PR_NUMBER} > pr_diff.txt 2>&1 || echo "Could not get diff" > pr_diff.txt
          echo "--- PR Diff ---"
          head -100 pr_diff.txt
          echo "--- End of preview (first 100 lines) ---"

      - name: Run Gemini CLI Review
        id: gemini
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å°‚é–€å®¶ã§ã™ã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            PRç•ªå·: #${{ github.event.pull_request.number || github.event.issue.number }}

            ã¾ãšã€catã‚³ãƒãƒ³ãƒ‰ã§pr_diff.txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚“ã§ã€PRã®å·®åˆ†ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            ãã®å¾Œã€ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚

            ## å¿…é ˆãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹

            ### 1. è¨­è¨ˆæ›¸ã¨ã®æ•´åˆæ€§
            - docs/design.md ã«è¨˜è¼‰ã•ã‚ŒãŸè¨­è¨ˆã«æ²¿ã£ãŸå®Ÿè£…ã‹
            - docs/requirements.md ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹

            ### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
            - ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ï¼ˆSQLã€XSSã€ã‚³ãƒãƒ³ãƒ‰ï¼‰
            - æ©Ÿå¯†æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
            - å…¥åŠ›å€¤æ¤œè¨¼
            - ğŸ”´ Criticalã¨ã—ã¦å ±å‘Š

            ## é‡è¦åº¦ãƒ¬ãƒ™ãƒ«
            - ğŸ”´ Critical: å¿…é ˆä¿®æ­£
            - ğŸŸ  High: å¼·ãæ¨å¥¨
            - ğŸŸ¡ Medium: æ¨å¥¨
            - ğŸŸ¢ Low: ææ¡ˆ

      - name: Post review comment
        if: always()
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"

          # Geminiã®å‡ºåŠ›ã‚’å–å¾—
          SUMMARY="${{ steps.gemini.outputs.summary }}"

          if [ -n "$SUMMARY" ]; then
            echo "Posting Gemini review to PR #${PR_NUMBER}"
            gh pr comment ${PR_NUMBER} --body "## ğŸ¤– Gemini Code Review

          ${SUMMARY}"
          else
            echo "No summary output from Gemini"
            # ä»£æ›¿: .geminiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
            if [ -d ".gemini" ]; then
              ls -la .gemini/
            fi
          fi
