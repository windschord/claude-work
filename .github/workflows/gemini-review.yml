# Gemini PR Review Workflow
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«Gemini CLIã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã¾ã™
# ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ã¯ GEMINI.md ã‚’å‚ç…§ï¼ˆSingle Source of Truthï¼‰

name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# åŒã˜PRã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
concurrency:
  group: gemini-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã®åˆ¤å®šã¨PRç•ªå·ã®å–å¾—
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check trigger condition
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -e

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "âœ… Triggered by pull_request event"

          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            # pull_request_review_comment ã®å ´åˆã¯ github.event.pull_request.number ã‚’ä½¿ç”¨
            PR_NUMBER="${{ github.event.pull_request.number }}"
            if [[ -z "$PR_NUMBER" ]]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "âŒ Could not determine PR number"
              exit 0
            fi

            # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç’°å¢ƒå¤‰æ•°çµŒç”±ã§å®‰å…¨ã«å‡¦ç†ï¼‰
            if [[ "$COMMENT_BODY" == *"@gemini-cli"* ]] && [[ "$COMMENT_BODY" == *"/review"* ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "âœ… Triggered by pull_request_review_comment with @gemini-cli /review"
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment does not contain @gemini-cli /review"
            fi

          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # issue_comment ãŒPRã«å¯¾ã™ã‚‹ã‚‚ã®ã‹ãƒã‚§ãƒƒã‚¯
            if [[ -z "${{ github.event.issue.pull_request }}" ]]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment is on an issue, not a pull request"
              exit 0
            fi

            PR_NUMBER="${{ github.event.issue.number }}"

            # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç’°å¢ƒå¤‰æ•°çµŒç”±ã§å®‰å…¨ã«å‡¦ç†ï¼‰
            if [[ "$COMMENT_BODY" == *"@gemini-cli"* ]] && [[ "$COMMENT_BODY" == *"/review"* ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "âœ… Triggered by issue_comment with @gemini-cli /review"
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping: Comment does not contain @gemini-cli /review"
            fi

          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Unknown event type"
          fi

  review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/head
          fetch-depth: 0

      - name: Get PR diff and info
        id: pr_info
        run: |
          echo "Getting diff for PR #${PR_NUMBER}"
          gh pr diff "${PR_NUMBER}" > pr_diff.txt 2>&1 || echo "Could not get diff" > pr_diff.txt

          # PRã®æƒ…å ±ã‚‚å–å¾—
          gh pr view "${PR_NUMBER}" --json title,body > pr_info.json 2>&1 || echo "{}" > pr_info.json

          echo "--- PR Diff Preview (first 50 lines) ---"
          head -50 pr_diff.txt
          echo "--- End of preview ---"

      - name: Run Gemini CLI Review
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å°‚é–€å®¶ã§ã™ã€‚

            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            PRç•ªå·: #${{ needs.check-trigger.outputs.pr_number }}

            ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
            1. GEMINI.md ã‚’èª­ã‚“ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ã‚’ç¢ºèª
            2. pr_diff.txt ã‚’èª­ã‚“ã§PRã®å·®åˆ†ã‚’ç¢ºèª
            3. æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›

      - name: Post review comment
        if: always()
        env:
          GEMINI_SUMMARY: ${{ steps.gemini.outputs.summary }}
        run: |
          if [ -n "$GEMINI_SUMMARY" ]; then
            echo "Posting Gemini review to PR #${PR_NUMBER}"
            gh pr comment "${PR_NUMBER}" --body "## ğŸ¤– Gemini Code Review

          $GEMINI_SUMMARY"
          else
            echo "âš ï¸ No summary output from Gemini"
            # ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
            echo "Gemini outputs:"
            echo "summary: ${{ steps.gemini.outputs.summary }}"
            echo "error: ${{ steps.gemini.outputs.error }}"
          fi
